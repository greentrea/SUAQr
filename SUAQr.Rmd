---
title: "Projekt"
author: "Stefan Graf"
date: "28 3 2020"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### GITHUB 
## Loading environment / libraries

# Todo:
# Activity mittels Liste aus word herauslesen oder die levels des 2017/18 sheets nutzen. Mittels grepl etc. dann wird es auch automatisch mit activity in 2017/18 verknüpft

# Follow Type --> Besser umschreiben bis jetzt mit regex gearbeitet. Grosse 2 Buchstaben geparsed vielleicht eher mit grepl arbeiten. Siehe abschnitt beim einlesen des Followtypes --> bereits entwurf vorhanden.

# Auseinandernehmen von FoodtypeOrIndividualOrDirection /SpeciesOrDistance  attribute in 2017/18 daten

# Data handling
# Zeiten kontrollieren ob bei Originaldatei in den Tracks (anhand Dateiname) teilweise GPS Messungen mit viel späterem Zeitpunkt zwischendrin vorkommen


# Get rid of points in camp

# Maybe find out whats wrong with points which are not in bounding box (see Processing script end) --> Probably Northing and easting is the same but why and which follow?

# Filter out impossible steplengths and steps


# Markings:
#### Quality check: --> are quality checks of chunks executed before
########### DELETE ############--> are chunks to delete
## Title --> are titles for sections
### explanations of the following chunk
##### SUAQ TRACKS 2018 & 2019 ##### --> Code sections to understand code better

```{r import, echo= 'F',results='hide'}
# CLASSICAL PACKAGE IMPORTER (Stefan Graf & Tobias Frey)
packages_checker <- function(packages_list){
  for (package in packages_list){
    if (!require(package, character.only = T)) {
      install.packages(package)
    }
    library(package, character.only = T)
  }
}
packages_checker(
  c('tmaptools',# read_gpx function
    'plotKML',# read GPX to dataframe
    'lubridate',
    'zoo',
    'data.tree',
    'hR',# making realtionships of orangutans
    'dbplyr',
    'plyr',
    'dplyr',
    'tidyr',
    'tidyverse',
    'sf', # Simple feature --> super spatial data handling structure
    'raster', # For raster data
    'ggspatial',
    'rgdal',
    'data.table',
    'RColorBrewer', # color schemas from color brewer web
    'ggraph', # visualization
    'igraph',
    'tmap',
    'scales',
    'trajr',
    'plotly', # zoomable, pannable ggplot
    'mapview',
    'ggmap', # easier interactive ggmaps 
    'leaflet', # Javascript library (originally) for plotting on a maptile interactive map
    'tmap',
    'stringr',
    'remotes', # geom_convexhull function
    'magrittr',
    'ggridges',
    'forcats',
    'move',# Brownian Bridge Movement Model
    'adehabitatHR',
    'ggpubr',
    'htmlwidgets'
    ))
rm(list = ls())
getwd()


### CUSTOM FUNCTIONS ###
clockS = function(t){hour(t)*3600+minute(t)*60+second(t)}
st_kde <- function(points,cellsize, bandwith, extent = NULL){
  require(MASS)
  require(raster)
  require(sf)
  if(is.null(extent)){
    extent_vec <- st_bbox(points)[c(1,3,2,4)]
  } else{
    extent_vec <- st_bbox(extent)[c(1,3,2,4)]
  }
  
  n_y <- ceiling((extent_vec[4]-extent_vec[3])/cellsize)
  n_x <- ceiling((extent_vec[2]-extent_vec[1])/cellsize)
  
  extent_vec[2] <- extent_vec[1]+(n_x*cellsize)-cellsize
  extent_vec[4] <- extent_vec[3]+(n_y*cellsize)-cellsize
  
  coords <- st_coordinates(points)
  matrix <- kde2d(coords[,1],coords[,2],h = bandwith,n = c(n_x,n_y),lims = extent_vec)
  raster(matrix)
}

test<- st_read("/Users/stefgr/Nextcloud/12_Semester/20200313_Masterthesis/R/data/20200717_All_stedit/gpx/20190113_Lisa_Saidi_NN.gpx", layer = "track_points")
class(test)
test_df<- as.data.frame(test)
test_df<- as.data.frame( sf::st_coordinates(test))
plot(test)

st_read_GPX_followertracks <- function(flnm){
    out <- tryCatch(
        { message("Try to read file")
            file <- data.frame()
            start <- Sys.time()
            file <- as.data.frame(st_read(flnm,layer = "track_points")) # better than read_GPX
            #if(class(file)[1]=="list"){file <- file$waypoints} # only use if read_GPX is used
            end <- Sys.time()
            processduration <- end-start
            file <- file %>% #Skip the first 16 rows because see below
              mutate(fileN=substr(flnm, 33,(nchar(flnm)+1)-5))
            
            return(file)
        },
        error=function(cond) {
            message(paste("File seems not to exist: ", flnm))
            message("Here's the original error message:")
            message(cond)
            # Choose a return value in case of error
            return(data.frame()) # use dataframe as return instead of NA --> See here why, without it throws an error. https://stackoverflow.com/questions/48512461/error-in-bind-rows-x-id-argument-1-must-have-names-using-map-df-in-purrr
        },
        warning=function(cond) {
            message(paste("Loading file didn't work", flnm))
            message("Here's the original warning message:")
            message(cond)
            # Choose a return value in case of warning
            return(data.frame())
        },
        finally={
            message(paste("Processed URL: ", flnm," Duration: ",processduration))
            message("Finished")
        }
    )    
    return(out)
}


st_read_GPX_waypoints <- function(flnm){
    out <- tryCatch(
        { message("Try to read file")
            file <- data.frame()
            start <- Sys.time()
            file <- st_read(flnm,layer = "waypoints") # better than read_GPX
            #if(class(file)[1]=="list"){file <- file$waypoints} # only use if read_GPX is used
            end <- Sys.time()
            processduration <- end-start
            file <- file %>% #Skip the first 16 rows because see below
              mutate(fileN=substr(flnm, 33,(nchar(flnm)+1)-5))
            
            return(file)
        },
        error=function(cond) {
            message(paste("File seems not to exist", flnm))
            message("Here's the original error message:")
            message(cond)
            # Choose a return value in case of error
            return(data.frame()) # use dataframe as return instead of NA --> See here why, without it throws an error. https://stackoverflow.com/questions/48512461/error-in-bind-rows-x-id-argument-1-must-have-names-using-map-df-in-purrr
        },
        warning=function(cond) {
            message(paste("Loading file didn't work", flnm))
            message("Here's the original warning message:")
            message(cond)
            # Choose a return value in case of warning
            return(data.frame())
        },
        finally={
            message(paste("Processed URL: ", flnm," Duration: ",processduration))
            message("Finished")
        }
    )    
    return(out)
}
```

#### SUAQ research site
## Preprocessing
1. Getting data from excel/csv files
2. Getting data from gpx files, clean and order it
3. Merge Files
```{r GPS Processing}

## 0. Loading metadatasets
### 0.1 FollowLog
SUAQ_followlog<- read_csv2("data/202003_SUAQ_FollowLog.csv")
SUAQ_followlog <-
  SUAQ_followlog %>% 
  mutate(Date = as.Date(Date, format = "%d.%m.%Y"),
         FocalName = tolower(FocalName),
         SexFocal = tolower(SexFocal),
         ClassFocal = tolower(ClassFocal),
         Observer1 = tolower(Observer1),
         Observer2 = tolower(Observer2),
         Observer3 = tolower(Observer3),
         Observer4 = tolower(Observer4),
         Observer5 = tolower(Observer5),
         ClassFocal = if_else(ClassFocal=="fl. male","fl.male",ClassFocal),
         FocalName = if_else(grepl("\\(prob\\)",FocalName),
                             str_remove(FocalName,"\\(prob\\)"),FocalName)
         )
SUAQ_followlog <- SUAQ_followlog %>%
  mutate(Date =if_else(is.na(Date),as.Date(paste(as.numeric(Day),as.numeric(Month),as.numeric(Year)),format = "%d %m %Y"),Date))
SUAQ_followlog<- SUAQ_followlog %>% filter(!is.na(FollowNumber)&!is.na(Date)) ## only keep if one of the 2 attributes are available
SUAQ_followlog <- SUAQ_followlog[,(colSums(is.na(SUAQ_followlog))<nrow(SUAQ_followlog))]

#### How many GPS follows should be available? How many do I have? because 140 are not found automatically in the followlog.
SUAQ_followlog %>% filter(.$Date>as_date("01-01-2010")) %>% nrow()



### 0.2 Orangutans names and information
SUAQ_orangutans<- read_csv2("data/20200920_Orangutan_ID.csv")
SUAQ_orangutans<- SUAQ_orangutans[rowSums(is.na(SUAQ_orangutans)) != ncol(SUAQ_orangutans),]
#### delete empty collumns of orangutan list
SUAQ_orangutans <- SUAQ_orangutans[,(colSums(is.na(SUAQ_orangutans))<nrow(SUAQ_orangutans))]
#### make list lowercase especially names
SUAQ_orangutans %<>% 
  mutate(`Orangutan name`= tolower(`Orangutan name`),
         Sex=tolower(Sex),
         Mother=tolower(.$Mother),
         Class=tolower(.$Class),
         `Age class`=tolower(`Age class`))
SUAQ_orangutans <- SUAQ_orangutans %>% 
  rename(c("AgeClass"="Age class",
           "orangutanname"="Orangutan name",
           "KeyFeatures"="Key features",
           "Facecolour"="Face colour",
           "FaceColour"="Face colour",
           "FaceShape"="Face shape",
           "facialMarks"="facial marks",
           "ThroatSac"="Throat sac",
           "hairOnTopOfHead"="hair on top of head",
           "hairOnSideOfHead"="hair on side of head",
           "HairOnChin"="Hair on chin",
           "OverallBodyColour"="Overall body colour",
           "OverallBodyShape"="Overall body shape",
           "BaldPatches"="Bald patches",
           "FirstRecordedBy"="First recorded by",
           "FirstTrailSeenOn"="First trail seen on",
           "DateFirstSeen"="Date First seen",
           "EstimatedBirthFromFileOnCampHD"="Estimated birth from file on camp HD",
           "SetBirthDateForAnalyses"="Set birth date for analyses",
           "FeetOrToes"="Feet/toes")
         )
#### Adding occurences of other unofficial orangutannames written in the followlog
##### Look what combinations are available for sex and name combinations. Result has f.e. double occuring OU where the sex was falsly categorized but also general annotations like "infant, male" & "infant, female" therefore we wanna keep the alias which were used for f.e. infant both male and female but we wanna get rid of double occuring names with two sexes.
SUAQ_followlog_orangutanlevels_sex<-SUAQ_followlog %>% 
  mutate(FocalName=tolower(.$FocalName),SexFocal=tolower(.$SexFocal)) %>% 
  filter(!grepl("(prob)|(guess)",FocalName)) %>% 
  group_by(FocalName,SexFocal) %>% 
  summarise(n=n())
SUAQ_OUnames_uniquetofollowlog<-as.data.frame(
    setdiff(
      SUAQ_followlog_orangutanlevels_sex$FocalName,
      SUAQ_orangutans$orangutanname
    )
  ) %>% rename(FocalName = 1) %>% mutate(SUAQ_nameonlyoccurredinfollowlog =
                                           TRUE) %>% right_join(SUAQ_followlog_orangutanlevels_sex,
                                                                by = c("FocalName" = "FocalName") ) %>% 
filter(.$SUAQ_nameonlyoccurredinfollowlog) # if new NAME (not any alias which mainly descirbes orangutan like infant, adoloscent etc) occur with two types of sexes it takes just the second gender it doesn't control on number of occurences.
##### Adding all orangutannames and sexes which are not in the official orangutan list. If two names and 
for(i in c(1:nrow(SUAQ_OUnames_uniquetofollowlog))) {
  if (!(SUAQ_OUnames_uniquetofollowlog$FocalName[i] %in% SUAQ_orangutans$orangutanname)) {
    print(
      paste(
        "Adding Orangutan: ",
        SUAQ_OUnames_uniquetofollowlog$FocalName[i],
        "with sex: ",
        SUAQ_OUnames_uniquetofollowlog$SexFocal[i]
      )
    )
    SUAQ_orangutans <-
      SUAQ_orangutans %>% add_row(orangutanname = SUAQ_OUnames_uniquetofollowlog$FocalName[i],
                                  Sex = SUAQ_OUnames_uniquetofollowlog$SexFocal[i],
                                  Comments = "automatically added from followlog")
  }
}
SUAQ_OUnames_uniquetofollowlog <- NA
SUAQ_followlog_orangutanlevels_ex <- NA

### 0.3 GPX of path network in SUAQ

SUAQ_pathnetwork<- read_GPX(file="data/SUAQ_Peta_WithLines.GPX",layers = c("routes"))

## 1. Getting data from excel/csv files for year 2017/18
SUAQ_waypoints_17_18 <- read_csv2("data/20200415_Master_GPS_Suaq_2017_Mar18_SH.csv")
SUAQ_waypoints_17_18<- SUAQ_waypoints_17_18[,1:16] # drop last collumns
SUAQ_waypoints_17_18 <- SUAQ_waypoints_17_18 %>% mutate(Focal=tolower(Focal), source="Excel data from Caroline 2017 & 2018")

##### CRS Code: EPSG 32647
##### Create SF Points
SUAQ_waypoints_17_18_sf <-  st_as_sf(SUAQ_waypoints_17_18, 
                          coords = c("X","Y"), 
                          crs = 32647)
coordinates_tmp <- st_coordinates(SUAQ_waypoints_17_18_sf)
colnames(coordinates_tmp) <- c("E","N")
SUAQ_waypoints_17_18_sf <- cbind(SUAQ_waypoints_17_18_sf,coordinates_tmp)
SUAQ_waypoints_17_18 <- st_drop_geometry(SUAQ_waypoints_17_18_sf)


## 2.  SUAQ TRACKS DATA 2020
### 2.1 Getting data from gpx files, clean and order it
##### Create a list of all gpx files
suaq_gpx_list<- list.files(path = "./data/20200717_All_stedit/gpx/",pattern = "*.gpx",full.names = T)
##### import gpx files from files list, only retrieving waypoints (no automatically saved trackpoints) and adding the filename as attribute
start_time <- Sys.time()
SUAQ_waypoints_11_20<- suaq_gpx_list%>% 
  map_df(~st_read_GPX_waypoints(.))
end_time <- Sys.time()
print(start_time-end_time)
##### Two follows throw an error --> 20200225_Lois_Ahmad_FN, 20200225_Otto_Armas_FN are empty --> deleted from data files (not from delivery files)

start_time <- Sys.time()
SUAQ_followertracks_11_20<- suaq_gpx_list%>% 
  map_df(~st_read_GPX_followertracks(.))
end_time <- Sys.time()
print(start_time-end_time)

### 2.2 Tidying the attributes and values
##### extract the 5 attributes from filename: filedate, orangutanname, infant name, followername, followtype. "Adress" in the first field is left in the list to identify the start of a new list.

SUAQ_waypoints_11_20 <-
  SUAQ_waypoints_11_20 %>% mutate(
    source="GPX files for follows of 2010-2020 (without 2017 & 2018)",
    filedate = str_extract(fileN, "\\d{8}"),
    orangutanname = tolower(substr(
      str_extract(fileN, "\\d{8}_[A-Z][a-z]+"),
      10,
      nchar(str_extract(fileN, "\\d{8}_[A-Z][a-z]+"))
    )),
    # Testing
    orangutannameInFollowlog = if_else(grepl(paste(SUAQ_orangutans$orangutanname, collapse="|"), fileN),str_extract(fileN,paste(SUAQ_orangutans$orangutanname, collapse="|")),orangutanname), # Get orangutanname from followlog
    infantname = tolower(substr(
      str_extract(fileN, "_[A-Z][a-z]+(\\([A-Z][a-z]+\\)|[A-Z][a-z]+)"),
      2 + nchar(orangutanname),
      nchar(
        str_extract(fileN, "_[A-Z][a-z]+(\\([A-Z][a-z]+\\)|[A-Z][a-z]+)")
      )
    )),
    followername = tolower(substr( # better approach split by underlines take third argument and test for names occuring in followlog (or a list of employees/ research assistance)
      str_extract(fileN, "_[A-Z][a-z_]+_[A-Z]{2}"),
      2,
      nchar(str_extract(fileN, "_[A-Z][a-z_]+_[A-Z]{2}")) - 3
    )),
    followtype = substr(
      str_extract(fileN, "_[A-Z][a-z_]+_[A-Z]{2}"),
      nchar(str_extract(fileN, "_[A-Z][a-z_]+_[A-Z]{2}")) - 1,
      nchar(str_extract(fileN, "_[A-Z][a-z_]+_[A-Z]{2}"))
    ),
    
    ## BESSER? --> following 
    #followtype = ifelse(grepl("_NL", fileN),"_NL",NA),
    #followtype = ifelse(grepl("_NN", fileN),"NN",followtype),
    #followtype = ifelse(grepl("_FL", fileN),"FL",followtype),
    #followtype = ifelse(grepl("_NL", fileN),"NL",followtype),
    #followtype = ifelse(grepl("_J", fileN),"F",followtype),
    #followtype = ifelse(grepl("_Jg", fileN),"F?",followtype),
    #followtype = ifelse(grepl("_FN", fileN),"_FN",followtype)
)
#### 2.2.1 get rid of empty collumns
SUAQ_waypoints_11_20 <-SUAQ_waypoints_11_20 %>% slice(1:nrow(SUAQ_waypoints_11_20)) # BUG: some kind of bug related to the rbind of rows of sf data frames, when applying the function read_gpx with map_df is causing a problem. The sf df are not index-able and dropping the geometry is also not possible
st_geometry(SUAQ_waypoints_11_20) <- SUAQ_waypoints_11_20$geometry
SUAQ_waypoints_11_20 <- SUAQ_waypoints_11_20[,(colSums(is.na(SUAQ_waypoints_11_20))<nrow(SUAQ_waypoints_11_20))]
#### 2.2.3 creating automatic Datetime (from gps collumn time or collumn cmt) and manual Datetime (from input user GPS Device and from name of Data file)
SUAQ_waypoints_11_20 <-
  SUAQ_waypoints_11_20 %>%
  mutate(
    cmt = dmy_hms(cmt, tz = "Asia/Pontianak"),
    automaticDatetime = ymd_hms(time, tz = "Asia/Pontianak"),
    manualDatetime = as.POSIXct(
      paste0(ymd(filedate), " ", str_extract(name, "^\\d{4}")),
      format = "%Y-%m-%d %H%M",
      tz = "Asia/Pontianak"
    ),
    # matching string start following 4 digits. Nameing datetime but changeing afterwards (to a real datetime). Just for ordering purposes
    manualDate = date(as.POSIXct(ymd(filedate),
                            format = "%Y-%m-%d",
                            tz = "Asia/Pontianak")),
    manualTime = hms::as_hms(manualDatetime),
    automaticDate = date(automaticDatetime),
    automaticTime = hms::as_hms(automaticDatetime),
    name=str_extract(name, "[^\\d{4} ].*") # not matching the digits in the beginning plus whitespace but everything after
  )
##### adding automatic datetime if 
SUAQ_waypoints_11_20[is.na(SUAQ_waypoints_11_20$automaticDatetime),] %<>% mutate(automaticDatetime = cmt) # piping forth and back. In documentation its written x %<>% foo %>% bar,  its the same as x <- x %>% foo %>% bar. In this case thats not correct!
##### manual adjustment for follows which aren't matching a record in the followlog or have slight differences f.e. focal name is different.
SUAQ_waypoints_11_20<- SUAQ_waypoints_11_20 %<>%mutate(
    orangutanname = if_else(orangutanname=="jebi","pauline",orangutanname),
    orangutanname = if_else(orangutanname=="lilli","lilly",orangutanname),
    orangutanname = if_else(orangutanname=="cissi","cissy",orangutanname),
    orangutanname = if_else(orangutanname=="julia","yulia",orangutanname),
    orangutanname = if_else(orangutanname=="zackey","zacky",orangutanname),
    orangutanname = if_else(fileN=="20130317_Dodi_Unk_FL","adol.female",orangutanname),# manual adjustment for follows which aren't matching a record in the followlog or have slight differences f.e. focal name is different.
    orangutanname = if_else(fileN=="20130508_Unk_Unk_FN","pauline",orangutanname),
    orangutanname = if_else(fileN=="20130502_FlMale_Caco_FL","pluto",orangutanname),
    orangutanname = if_else(fileN=="20130510_Jebi_UNK_NL","pauline",orangutanname),
    orangutanname = if_else(fileN=="20130518_UnflMale_Unk_FL","unid.ind.",orangutanname),
    orangutanname = if_else(fileN=="20130925_Ulysses_Toni_NN","unfl.male",orangutanname),
    orangutanname = if_else(fileN=="20130926_Ulysses_Mudini_NN","unfl.male",orangutanname),
    orangutanname = if_else(fileN=="20130508_Unk_Unk_FN","pauline",orangutanname),
    orangutanname = if_else(fileN=="20191002_UnflUnid(U1200)_FL","fez",orangutanname),
    orangutanname = if_else(fileN=="20191129_UnflH1050_Ulil_FN","gura",orangutanname),
    orangutanname = if_else(orangutanname=="caeser","caesar",orangutanname)
  )
SUAQ_waypoints_11_20<- SUAQ_waypoints_11_20 %>% mutate(
  tmp_delete= if_else(
    fileN=="20110128_Karma_Unk_NN"|
    fileN=="20110130_Friska_Wiebe_NL"|
    fileN=="20130317_Dodi(prob)_Unk_FL"|
    fileN=="20130510_Jebi(prob)_UNK_NL",TRUE,FALSE)
) %>% filter(tmp_delete==FALSE)
#### 2.2.4 Extracting information from Name field: PtType--> Type of point: Longcall, Nest etc. See GPS processing information sheet. 
##### To lowercase name collumn
SUAQ_waypoints_11_20<- SUAQ_waypoints_11_20 %>% mutate(name=tolower(name)) # reduces complexity by around 277 combinations to total 897
#### See what are all possible combinations of the name fields (all levels)
SUAQ_wp_namecollumn_levels<- SUAQ_waypoints_11_20 %>% group_by(.$name,.$sym) %>% summarise(count=n())
##### Making naveaid green symbols same as green circles. Probably meant the same. Baseline for this categorization is the excel "Dateneckdaten" there are the main information on how many special cases there are and how they are handled.Manual corrections (for values which are otherwise uncategorizable):
SUAQ_waypoints_11_20$name[SUAQ_waypoints_11_20$name == "<100m 221 degrees"] <- "lc <100m 221 degrees"

SUAQ_waypoints_11_20 <-
  SUAQ_waypoints_11_20 %>% mutate(
    PtType = ifelse((sym == "Circle, Green" |sym == "Navaid, Green") &
                      (grepl("bangun", name)|
                         grepl("arrive", name)|
                         grepl("jumpa", name)|
                         grepl("ketemu", name)|
                         grepl("found", name)|
                         grepl("jmp", name)|
                         grepl("jmpa", name)),
                    "found", # two falsly classified with navaid symbol
                    "unknown"),
    PtType = ifelse((sym == "Circle, Green" |
                       sym == "Navaid, Green") &
                      (grepl("sp", name) | # all with criteria Green + sp are morning nests not something else parsed with sp.
                       grepl("pagi", name)),
                    "mornnest",
                    PtType),
    PtType = ifelse((sym == "Circle, Green" |
                       sym == "Navaid, Green") &
                      (grepl("lost", name)|
                         grepl("lepas", name)|
                         grepl("dilepas", name)|
                         grepl("hilang", name)),
                    "lost", # two falsly classified with navaid symbol
                    PtType),
    PtType = ifelse((sym == "Circle, Green" |
                       sym == "Navaid, Green") &
                      (grepl("sm", name) | 
                         grepl("malam", name)),
                    "nightnest",
                    PtType),
    PtType = ifelse((sym == "Circle, Green" |
                       sym == "Navaid, Green"|
                       sym == "Light") & # single exception
                      (
                        grepl("ss", name) |
                        grepl("play nest", name) | # single exeception
                        grepl("ss1", name) | 
                        grepl("ss2", name) |  
                        grepl("siang", name)
                      ),
                    "daynest",
                    # maximum 3 daynests
                    PtType
    ),
    
    
    
##### Task: --> change every pttype variable above to a different attribute. See which are categorized in multiple groups!
    
    PtType = ifelse((sym == "Block, Blue" ) & (grepl("lch", name)|grepl("lc", name)), # Metainformation for some lch and lcg are not considered because there are only written down for very less points(10-20 points). Information about call direction is given in the activity table
                    "lch",
                    PtType),
    PtType = ifelse((sym == "Block, Blue" ) & grepl("lcg", name),
                    "lcg",
                    PtType),
    PtType = ifelse((sym == "Block, Red" |
                       sym == "Circle, Red") & grepl("dna", name),
                    "DNA sample taken",
                    PtType),
    PtType = ifelse((sym == "Circle, Blue" |
                   sym == "Navaid, Blue"),
                    # until now these symbols are all right categorized 
                    # two falsly classified with navaid symbol
                    "party",
                    PtType),
    PtType_individual = ifelse((sym == "Circle, Blue" |
                   sym == "Navaid, Blue")&
                    grepl(paste(as.vector(SUAQ_orangutans$orangutanname)
, collapse="|"), name),
                    # until now these symbols are all right categorized 
                    # two falsly classified with navaid symbol
                    str_match_all(SUAQ_waypoints_11_20$name,gsub("\\?","\\\\?",paste(as.vector(SUAQ_orangutans$orangutanname),collapse="|"))), # retrieving elements where its matchs an orangutan name in the list and getting the last element of the name string description. (Problem is "s?" in orangutanname list because its used in regex of the grepl function and matches more because the questionmark is not escaped.)
                    NA),
    PtType = ifelse(grepl("exp", name),
                    "experiments", # two falsly classified with navaid symbol
                    PtType),
    PtType = ifelse((sym == "Flag" | sym == "Flag, Green"),
                    "tree", # two falsly classified with navaid symbol
                    PtType),
    PtType = ifelse((sym == "Mine")&grepl("tool", name),
                    "tool", # two falsly classified with navaid symbol
                    PtType),
    PtType = ifelse((sym == "Flag, Red"),
                    "range", # two falsly classified with navaid symbol
                    PtType)
)
SUAQ_waypoints_11_20<- SUAQ_waypoints_11_20 %>%  mutate(
  PtType_individual = ifelse((sym == "Circle, Green" |sym == "Navaid, Green"),
                                 str_match_all(SUAQ_waypoints_11_20$name, 
                                               gsub("\\?", "\\\\?",
                                                  paste(as.vector(SUAQ_orangutans$orangutanname), collapse ="|")
                                                  )
                                               ),
                                 PtType_individual
    ),
  PtType_individual_1=map2_chr(PtType_individual, 1,~.x[.y]),
  PtType_individual_2=map2_chr(PtType_individual, 2,~.x[.y]),
  PtType_individual_3=map2_chr(PtType_individual, 3,~.x[.y]),
  PtType_direction = ifelse(PtType=="lcg" |PtType=="lch",
                            str_extract(name,"\\d+(?!\\d*m)"),NA),
  PtType_distance = ifelse(PtType=="lcg" |PtType=="lch",
                            str_extract(name,"\\d+(?=m)"),NA),
) %>% dplyr::select(-PtType_individual)


## 3.  SUAQ TRACKS DATA 2020 for males
SUAQ_waypoints_11_20_male <- read_csv("data/20201020_MaleGPSToAdd.csv")

SUAQ_waypoints_11_20_male <-
  SUAQ_waypoints_11_20_male %>% mutate(
    PtType="range",
    source = "Male GPS from Caroline for 2018",
    focal = tolower(Focal),
    automaticDatetime = parse_date_time(timestamp,orders=c("%d.%m.%y %H%M","%m/%d/%y %H%M"),tz = "Asia/Pontianak"), # takes two different formats which are occuring in the given excelsheet
    automaticDate=date(automaticDatetime),
    automaticTime=hms::as_hms(automaticDatetime))%>% 
  mutate(fileN=group_indices(.,automaticDate,focal)) %>% mutate(fileN=as.character(fileN)) %>% 
  dplyr::select(-timestamp,-Focal,-sensor.type )

#CREATE SF OBJECT
SUAQ_waypoints_11_20_male_sf<- st_as_sf(SUAQ_waypoints_11_20_male, 
                          coords = c("location.long","location.lat"), 
                          crs = 4326)

SUAQ_waypoints_11_20_male_sf <- st_transform(SUAQ_waypoints_11_20_male_sf,32647)
coordinates_tmp <- st_coordinates(SUAQ_waypoints_11_20_male_sf)
colnames(coordinates_tmp) <- c("E","N")
SUAQ_waypoints_11_20_male_sf <- cbind(SUAQ_waypoints_11_20_male_sf,coordinates_tmp)
SUAQ_waypoints_11_20_male<- st_drop_geometry(SUAQ_waypoints_11_20_male_sf)


## 4. Combine Datasets 
### 4.1. Merging 2017-2018 data with the rest
##### CRS Code: EPSG 32647
##### Create SF Points Dataset Waypoints 2010-2020
SUAQ_waypoints_11_20<- st_set_crs(SUAQ_waypoints_11_20,4326)
SUAQ_waypoints_11_20_sf <- st_transform(SUAQ_waypoints_11_20,32647)
coordinates_tmp <- st_coordinates(SUAQ_waypoints_11_20_sf)
colnames(coordinates_tmp) <- c("E","N")
SUAQ_waypoints_11_20_sf <- cbind(SUAQ_waypoints_11_20_sf,coordinates_tmp)
SUAQ_waypoints_11_20<- st_drop_geometry(SUAQ_waypoints_11_20_sf)


##### Create SF Points Dataset trackpoinst 2010-2020
SUAQ_followertracks_11_20<- st_as_sf(SUAQ_followertracks_11_20, 
                          crs = 4326)
SUAQ_followertracks_11_20_sf <- st_transform(SUAQ_followertracks_11_20,32647)
coordinates_tmp <- st_coordinates(SUAQ_followertracks_11_20_sf)
colnames(coordinates_tmp) <- c("E","N")
SUAQ_followertracks_11_20_sf <- cbind(SUAQ_followertracks_11_20_sf,coordinates_tmp)
SUAQ_followertracks_11_20<- st_drop_geometry(SUAQ_followertracks_11_20_sf)


##### Preparing 2017-18 dataset (is already in right coordinate system)

SUAQ_waypoints_17_18 <- SUAQ_waypoints_17_18 %>% 
  mutate(automaticDatetime=dmy_hms(paste(.$Date,.$Actual.Time), tz = "Asia/Pontianak"),
         manualDatetime=dmy_hms(paste(.$Date,.$Time), tz = "Asia/Pontianak"),
         manualDate=date(manualDatetime),
         manualTime=hms::as_hms(manualDatetime),
         automaticDate=date(automaticDatetime),
         automaticTime=hms::as_hms(automaticDatetime),
         Follow..=as.character(Follow..),
         fileN=as.character(Follow..),
         Point.Type=tolower(Point.Type),
         Age.Sex=tolower(Age.Sex),
         Activity=tolower(Activity),
         Focal = if_else(Focal=="caeser","caesar",Focal)
         ) %>% 
  rename(c("follow"="Follow..",
           "followtype"="Follow.Type",
           "altitude"="Altitude",
           "PtType"="Point.Type",
           "SpeciesOrDistance"="Species...Distance",
           "FoodtypeOrIndividualOrDirection"="Food.Type...Individual...Direction",
           "focal"="Focal",
           "FollowIndData"="Follow..IndData.",
           "AgeSex"="Age.Sex")) %>%
  mutate(
    PtType = if_else(PtType == "jumpa", "found", PtType),
    PtType = if_else(PtType == "path", "range", PtType) # PATH values in the data of 2017 to 2018 means ranging points
  ) %>% 
  dplyr::select(-Actual.Time,-Time)
SUAQ_waypoints_11_20 <-
  SUAQ_waypoints_11_20 %>% 
  rename(
    c("altitude"="ele",
      )
  )%>% 
  mutate(
    "focal" = orangutanname,
    "follow"= NA,
    "AgeSex"= NA) %>% 
  mutate(
    "altitude"=as.character(altitude)
  ) %>% 
dplyr::select(-orangutanname)

SUAQ_waypoints_11all20<- SUAQ_waypoints_11_20 %>%  bind_rows(SUAQ_waypoints_17_18) %>% bind_rows(SUAQ_waypoints_11_20_male)
SUAQ_waypoints_11all20 <- SUAQ_waypoints_11all20%>%
  dplyr::select(-Date,
         -FollowIndData,
         -cmt,
         -desc
         )

# Adding unique identifier
id <- rownames(SUAQ_waypoints_11all20)
SUAQ_waypoints_11all20 <- cbind(id=id, SUAQ_waypoints_11all20)

## 5. ADDING FOLLOWNUMBER (JOIN) 
### 5.2. Joining 2011-2020 data with followlog and add information to gps file
##### for the first two follows which are not joined with the followlog it seams the date in the filename is wrong! --> should be 2011 not 2010. This is the case for many more! maybe look on the automatic date!
##### PROBLEMS
specs_AutomaticManualDateNotEqual<- SUAQ_waypoints_11all20 %>% filter(.$manualDate!=.$automaticDate) %>% group_by(.$fileN) %>%   summarise(count=n()) # date automatic and manual not the same


# Temporary files from followlog for joining follownumber (all only checking on two attributes)
# would there be a better approach? Need an algorithm/function which takes several attributes and looks if there is a match for all, all-1,all-2,all-3 until a minima f.e. matching at least followname and followdate.
tmp6 <- SUAQ_followlog[,c(2,4,14,19)] %>% mutate(tmp_FollowNumber_M_focal_followname=FollowNumber) %>%
  dplyr::select(-FollowNumber)
tmp7 <- SUAQ_followlog[,c(2,4,14,20)] %>% mutate(tmp_FollowNumber_M_focal_followname2=.$FollowNumber) %>%
  dplyr::select(-FollowNumber)
tmp8 <- SUAQ_followlog[,c(2,5,6,7,14)] %>% mutate(tmp_FollowNumber_M_focal_concDate=.$FollowNumber)  %>% 
  mutate(Date=as.Date(paste0(Year,"-",Month,"-",Day),format = "%Y-%m-%d",tz = "Asia/Pontianak"))%>%
  dplyr::select(-FollowNumber,-Day,-Month,-Year)
tmp<- SUAQ_followlog[,c(2,4,14)] %>% mutate(tmp_FollowNumber_M_focal=.$FollowNumber) %>%
  dplyr::select(-FollowNumber)
tmp2<- SUAQ_followlog[,c(2,4,14)] %>% mutate(tmp_FollowNumber_M_focal_automatic=.$FollowNumber) %>% dplyr::select(-FollowNumber)
tmp3<- SUAQ_followlog[,c(2,4,14)] %>% mutate(tmp_FollowNumber_M_infant=.$FollowNumber) %>%
  dplyr::select(-FollowNumber)
tmp4<- SUAQ_followlog[,c(2,4,19)] %>% mutate(tmp_FollowNumber_M_followname=.$FollowNumber) %>%
  dplyr::select(-FollowNumber)
tmp5<- SUAQ_followlog[,c(2,4,20)] %>% mutate(tmp_FollowNumber_M_followname2=.$FollowNumber) %>%
  dplyr::select(-FollowNumber)

##### Join followlog 
SUAQ_waypoints_11all20 <- SUAQ_waypoints_11all20 %>%
  left_join(y=tmp6,by=c("manualDate"="Date","focal"="FocalName","followername"="Observer1"),keep = FALSE,na_matches = "never")
SUAQ_waypoints_11all20 <- SUAQ_waypoints_11all20 %>%
  left_join(y=tmp7,by=c("manualDate"="Date","focal"="FocalName","followername"="Observer2"),keep = FALSE,na_matches = "never")
SUAQ_waypoints_11all20 <- SUAQ_waypoints_11all20 %>% 
  left_join(y=tmp,by=c("manualDate"="Date","focal"="FocalName"),na_matches = "never") # Problem some of them match with multiple points (n=+114) adding more hirarchy see above if matching 3 attributes --> more sure which one. "2019-02-08	yulia" n=40 entries also + 20 welche nicht existierten. Follow existiert ähnlich zwei mal aber observername unterschied sich --> Lösung tmp6 und tmp7 zur unterscheidung dieser sehr ähnlichen Followdaten.
SUAQ_waypoints_11all20 <- SUAQ_waypoints_11all20 %>% 
  left_join(y=tmp8,by=c("manualDate"="Date","focal"="FocalName"),na_matches = "never")
SUAQ_waypoints_11all20 <- SUAQ_waypoints_11all20 %>%
  left_join(y=tmp2,by=c("automaticDate"="Date","focal"="FocalName"),keep = FALSE,na_matches = "never")
SUAQ_waypoints_11all20 <- SUAQ_waypoints_11all20 %>%
  left_join(y=tmp3,by=c("manualDate"="Date","infantname"="FocalName"),keep = FALSE,na_matches = "never")
SUAQ_waypoints_11all20 <- SUAQ_waypoints_11all20 %>%
  left_join(y=tmp4,by=c("manualDate"="Date","followername"="Observer1"),keep = FALSE,na_matches = "never")
SUAQ_waypoints_11all20 <- SUAQ_waypoints_11all20 %>%
  left_join(y=tmp5,by=c("manualDate"="Date","followername"="Observer2"),keep = FALSE,na_matches = "never")


temp <- SUAQ_waypoints_11all20 %>% filter(id %in% c(12184,12185,12186,12187,12188,12189,12190,12191,12192,12193,12194,12195,12196,12197,12198,12199,12200,12201,12202,12203,12204,29043,29044,29045,29046,29047,29048,29049,29050,4743,4744,4745,4746,4747,4748,4749))


SUAQ_waypoints_11all20 <- SUAQ_waypoints_11all20 %>%
  mutate(follow=as.numeric(follow)) %>%
  mutate(follow=if_else(is.na(follow),as.numeric(tmp_FollowNumber_M_focal_followname),follow)) %>%
  dplyr::select(-tmp_FollowNumber_M_focal_followname) %>%
  mutate(follow=if_else(is.na(follow),as.numeric(tmp_FollowNumber_M_focal_followname2),follow)) %>%
  dplyr::select(-tmp_FollowNumber_M_focal_followname2) %>%
  mutate(follow=if_else(is.na(follow),as.numeric(tmp_FollowNumber_M_focal_concDate),follow)) %>%
  dplyr::select(-tmp_FollowNumber_M_focal_concDate) %>% 
  mutate(follow=if_else(is.na(follow),as.numeric(tmp_FollowNumber_M_focal),follow)) %>%
  dplyr::select(-tmp_FollowNumber_M_focal) %>% 
  mutate(follow=if_else(is.na(follow),as.numeric(tmp_FollowNumber_M_focal_automatic),follow)) %>%
  dplyr::select(-tmp_FollowNumber_M_focal_automatic) %>% 
  mutate(follow=if_else(is.na(follow),tmp_FollowNumber_M_infant,follow)) %>%
  dplyr::select(-tmp_FollowNumber_M_infant) %>% 
  mutate(follow=if_else(is.na(follow),tmp_FollowNumber_M_followname,follow)) %>% 
  dplyr::select(-tmp_FollowNumber_M_followname) %>% 
  mutate(follow=if_else(is.na(follow),tmp_FollowNumber_M_followname2,follow)) %>% 
  dplyr::select(-tmp_FollowNumber_M_followname2)

SUAQ_waypoints_11all20<- SUAQ_waypoints_11all20 %>% distinct() # 60 GPS points are added because of the above joins. This means that some added Follownumbers match multiple GPS points in the waypoints dataset.

#### Delete manually wrongly duplicated follows where multiple followlogs matched (better would be to make the regex etc and descripton or database better not having these problems)
##### find duplicates
temp <- SUAQ_waypoints_11all20 %>% group_by(id) %>% summarise(gpscount=n())
temp<- temp %>% filter(as.integer(gpscount)>1)
##### delete them
SUAQ_waypoints_11all20 <- SUAQ_waypoints_11all20 %>% 
  filter(!(id %in% c(15620,15621,15622,15623,15624,15625,15626,15627,15628,15629,15630,15631,15632,15633,15634,15635,15636,15637,15638,15639) & follow==2897)) %>% 
  filter(!(id %in% c(4743,4744,4745,4746,4747,4748,4749) & follow==1107))
  

##### manually adding follownumber for cases where join with followlog didn't retrieve one

SUAQ_waypoints_11all20 <-SUAQ_waypoints_11all20 %>% 
  mutate(
    follow=if_else(fileN=="20100921_Ibu_Unk_NL",1000001,follow),
    follow=if_else(fileN=="20110128_Karma_Sahrol_NL",717,follow),# müsste in followlog angepasst werden
    follow=if_else(fileN=="20110129_Friska_Unk_FN",1000002,follow),
    follow=if_else(fileN=="20110130_Friska_Wiebe_NL",1000003,follow),
    follow=if_else(fileN=="20130317_Dodi_Unk_FL",951,follow),
    follow=if_else(fileN=="20130502_FlMale_Caco_FL",970,follow),
    follow=if_else(fileN=="20130508_Unk_Unk_FN",971,follow),
    follow=if_else(fileN=="20130518_Ellie_Armas_F",1000004,follow),
    follow=if_else(fileN=="20130518_UnflMale_Unk_FL",1000005,follow),
    follow=if_else(grepl("20130603_FriskaFrankie",fileN),1000006,follow),
    follow=if_else(fileN=="20130627_FriskaFrankie_Caco_F",1000007,follow),
    follow=if_else(fileN=="20130630_FriskaFrankieFredy_Raja_F",1000008,follow),
    follow=if_else(fileN=="20130925_Ulysses_Toni_NN",1108,follow),
    follow=if_else(fileN=="20130926_Ulysses_Mudini_NN",1109,follow),
    follow=if_else(fileN=="20150210_UnflMale(R1200)_P1LisaLois_FN_Fikar",1439,follow),
    follow=if_else(fileN=="20190112_Lisa_Fikar_NN",2559,follow),
    follow=if_else(fileN=="20130925_Ulysses_Toni_NN",1108,follow),
    follow=if_else(fileN=="20190117_Rakus(prob)_Saidi_J",1000009,follow),
    follow=if_else(fileN=="20190303_Tiara_Saidi_FN",2599,follow),
    follow=if_else(fileN=="20190330_Kopi_Adami_NN",2621,follow),
    follow=if_else(fileN=="20190331_Kopi_Adami_NN",2622,follow),
    follow=if_else(fileN=="20190614_Lois_Ulil_NN",2685,follow),
    follow=if_else(fileN=="20190729_FlMale_Luz_J",1000010,follow),
    follow=if_else(fileN=="20190801_Cinnamon_Miftah_J",1000011,follow),
    follow=if_else(fileN=="20190917_Ellie_Saidi_J",1000012,follow),
    follow=if_else(fileN=="20190922_Balu_Luz_J",1000013,follow),
    follow=if_else(fileN=="20191002_UnflUnid(U1200)_FL",2810,follow),
    follow=if_else(fileN=="20191011_Aqra_Lara_J",1000014,follow),
    follow=if_else(fileN=="20191110_Marjo_J",1000013,follow),
    follow=if_else(fileN=="20190922_Balu_Luz_J",1000015,follow),
    follow=if_else(fileN=="20191110_Sakura_J",1000016,follow),
    follow=if_else(fileN=="20191125_Ellie_Adami_J",1000017,follow),
    follow=if_else(fileN=="20191129_UnflH1050_Ulil_FN",2873,follow),
    follow=if_else(fileN=="20200117_Balu_Tri_J",1000018,follow),
    follow=if_else(fileN=="20130510_Jebi_UNK_NL",1335,follow),
    follow=if_else(fileN=="20190209_Yulia_Ulil_NN",2582,follow)
    )
names(SUAQ_followlog) <- paste0("SUAQ_followlog.", names(SUAQ_followlog))
SUAQ_waypoints_11all20 <- SUAQ_waypoints_11all20 %>%
  left_join(SUAQ_followlog[,c(2,4,14,16,17,19,20,21,22,23,25,29,30,31,32,33,34,35,36,38,39,40,41,42,43,46,55,56,57,58,59,60,61,62,63,64,65,66,67:74)],by=c("follow"="SUAQ_followlog.FollowNumber"),suffix = c("", "_fromFollowlog"))


#### Finding potential falsly joined follownumbers
##### FN with multiple dates. Only FN: 9999 which is wrong has fuzzy dates
specs_FNwithUnUniqueDatesAfterJoin <- SUAQ_waypoints_11all20[FALSE,]
for(i in levels(as.factor(SUAQ_waypoints_11all20$follow))){
  df <- SUAQ_waypoints_11all20 %>% filter(SUAQ_waypoints_11all20$follow==i)
  print(paste0("Follownumber to check if unique: ",i))
  print((length(unique(df$manualDate)) == 1))
  if(length(unique(df$manualDate)) != 1){specs_FNwithUnUniqueDatesAfterJoin <- specs_FNwithUnUniqueDatesAfterJoin %>% bind_rows(df)}
}



## 6. Adding informative attributes and finishing data frame
### 6.1. Joining orangutans info
names(SUAQ_orangutans) <- paste0("SUAQ_orangutans.", names(SUAQ_orangutans))
SUAQ_waypoints_11all20 <-
  SUAQ_waypoints_11all20 %>% left_join(SUAQ_orangutans[,1:10], by = c("focal" = "SUAQ_orangutans.orangutanname"))

### 6.2. Create new variables like Sinuosity, DJL, Edge Speed
#SUAQ_waypoints_11all20 <- SUAQ_waypoints_11all20 %>% left_join()
SUAQ_waypoints_11all20<- SUAQ_waypoints_11all20 %>%  
  mutate(focal=if_else(is.na(focal),SUAQ_followlog.FocalName,focal)) # get missing focal names from SUAQ followlog.

### 6.3. Only keep gps points within Bounding box of 330000-360000N / 323000-328000E because some points are wrong probably the N and the E variable are the same (accidently copied)
SUAQ_waypoints_11all20 <- SUAQ_waypoints_11all20 %>% filter(E>323000 & 
                                                            E<328000 & 
                                                            N>330000 & 
                                                            N<360000)

#### For trackpoints aswell
SUAQ_followertracks_11_20 <-
  SUAQ_followertracks_11_20 %>% filter(E > 323000 &
                                         E < 328000 &
                                         N > 336000 &
                                         N < 365000)

### 6.4. Cleaning important attributes
##### Sexes overview
levels(as.factor(SUAQ_waypoints_11all20$SUAQ_followlog.ClassFocal))
levels(as.factor(SUAQ_waypoints_11all20$SUAQ_followlog.SexFocal))
levels(as.factor(SUAQ_waypoints_11all20$SUAQ_orangutans.Sex))
levels(as.factor(SUAQ_waypoints_11all20$SUAQ_orangutans.Class))
levels(as.factor(SUAQ_waypoints_11all20$SUAQ_orangutans.AgeClass))
                  
SUAQ_waypoints_11all20<- SUAQ_waypoints_11all20 %>% mutate(SUAQ_followlog.ClassFocal=if_else(SUAQ_followlog.ClassFocal=="ad.female","adult female",SUAQ_followlog.ClassFocal))
SUAQ_waypoints_11all20<- SUAQ_waypoints_11all20 %>% mutate(SUAQ_followlog.ClassFocal=if_else(SUAQ_followlog.ClassFocal=="fl.male","flanged male",SUAQ_followlog.ClassFocal))
SUAQ_waypoints_11all20<- SUAQ_waypoints_11all20 %>% mutate(SUAQ_followlog.ClassFocal=if_else(SUAQ_followlog.ClassFocal=="unfl.male","unflanged male",SUAQ_followlog.ClassFocal))






#SUAQ_waypoints_11all20<- SUAQ_waypoints_11all20 %>% mutate(SUAQ_followlog.ClassFocal=if_else(SUAQ_followlog.ClassFocal=="mother","adult female",SUAQ_followlog.ClassFocal))
##### To do: if ClassFocal is unk --> get Class from Orangutan information

for (i in c(1:nrow(SUAQ_waypoints_11all20))) {
  targetcol <- "SUAQ_followlog.ClassFocal"
  replaceterm <- "unk"
  look_at_id <- SUAQ_waypoints_11all20$id[i]
  if(SUAQ_waypoints_11all20$SUAQ_followlog.ClassFocal[i]%in%c(replaceterm)){
    print(paste("found",counter,". row with term to replace with id:", i))
    replacevalue <- own_valuefinder(
                                          df = SUAQ_waypoints_11all20,
                                          pk = look_at_id,
                                          pkcol = "id",
                                          replaceterm = "unk",
                                          startcol = "focal",
                                          targetcol = "SUAQ_followlog.ClassFocal",
                                          lookuptype = "temporally",
                                          datecol = "manualDate"
                                        )
    SUAQ_waypoints_11all20$SUAQ_followlog.ClassFocal[i]<- replacevalue
    print(paste("replaced with value",replacevalue))
    counter<- counter+1
  }
}



test<- SUAQ_waypoints_11all20 %>% filter(SUAQ_followlog.ClassFocal%in%c("unk"))
print("Hello")


SUAQ_waypoints_11all20 <-
  SUAQ_waypoints_11all20 %>% # replace any SexClass value which is unk or NA to the temporally nearest other Sex Class value for this orangutan
  mutate(
    SUAQ_followlog.ClassFocal = if_else((SUAQ_followlog.ClassFocal%in%c("unk")),
                                        own_valuefinder(
                                          SUAQ_waypoints_11all20,
                                          id,
                                          "id",
                                          "unk",
                                          "focal",
                                          "SUAQ_followlog.ClassFocal",
                                          "temporally",
                                          "manualDate"
                                        ),
                                        SUAQ_followlog.ClassFocal
    )
  )





# test<- own_valuefinder(df=SUAQ_waypoints_11all20,pk=4876,pkcol="id",replaceterm="unk",startcol = "focal",targetcol="SUAQ_followlog.ClassFocal",lookuptype="temporally",datecol="manualDate")



own_valuefinder <- function(df,pk,pkcol,replaceterm,startcol,targetcol,lookuptype,datecol){
    out <- tryCatch(
        { message("Try to find value in target collumn which as temporally/tabullary nearest and not the mentioned to 'replaceterm' or is the most abundant value")
          pk <- as.integer(pk)
          print(pk)
          targetvalue <- replaceterm
            if(missing(datecol)) {
              print("Searching in df distance")
              if(lookuptype=="frequency"){
                print("freq search")
                df_forcorrsponvalue<- df %>% filter(targetcol==df$targetcol[which(df$id == pk),])
                targetvalue <- tail(names(sort(table(df_forcorrsponvalue$targetcol))), 1)
              }
              if(lookuptype=="next"){
                print("next row search")
                df_forcorrsponvalue<- df %>% filter(targetcol==df$targetcol[which(df$id == pk),])
                index <- which(df_forcorrsponvalue$pkcol == pk)
                for(i in c(1:(nrow(df_forcorrsponvalue)-index))){
                  if(is.na(targetvalue)|(targetvalue==replaceterm)){targetvalue<- df_forcorrsponvalue[index+i,targetcol]
                  paste(print("found target value"),targetvalue)
                  }
                }
              }
              if(lookuptype=="last"){
                print("last row search")
                df_forcorrsponvalue<- df %>% filter(targetcol==df$targetcol[which(df$id == pk),])
                index <- which(df_forcorrsponvalue$pkcol == pk)
                for(i in c(1:(index-1))){
                  if(is.na(targetvalue)|(targetvalue==replaceterm)){targetvalue<- df_forcorrsponvalue[index-i,targetcol]
                  paste(print("found target value"),targetvalue)
                  }
                }
              }
            } else {
              if(lookuptype=="temporally"){
                date<- df[id==pk,datecol]
                df_row <- df[id==pk,]
                startcol_value <- df_row[,startcol]
                df_forcorrsponvalue<- df %>% filter(df$focal==startcol_value)
                df_forcorrsponvalue <-  df_forcorrsponvalue %>% mutate(diff_todate=abs(date-df_forcorrsponvalue[,datecol]))
                df_forcorrsponvalue <-  df_forcorrsponvalue %>% arrange(diff_todate)
                for(i in c(1:nrow(df_forcorrsponvalue))){
                  if(is.na(targetvalue)|(targetvalue==replaceterm)){
                    targetvalue<- df_forcorrsponvalue[i,targetcol]
                    }
                }
              }
            }
          
            return(targetvalue)
        },
        error=function(cond) {
            message("Error")
            message("Here's the original error message:")
            message(cond)
            # Choose a return value in case of error
            return(replaceterm) # use dataframe as return instead of NA --> See here why, without it throws an error. https://stackoverflow.com/questions/48512461/error-in-bind-rows-x-id-argument-1-must-have-names-using-map-df-in-purrr
        },
        warning=function(cond) {
            message("Warning")
            message("Here's the original warning message:")
            message(cond)
            # Choose a return value in case of warning
            return(replaceterm)
        },
        finally={
            if(targetvalue%in%c(replaceterm)){message("Didn't found a value")}
            if(!(targetvalue%in%c(replaceterm))){message(paste("found target value",targetvalue))}
            message("Finished")
        }
    )    
    return(out)
}

"jello"%in%c(NA)

abs(SUAQ_waypoints_11all20$manualDate[1]-SUAQ_waypoints_11all20[SUAQ_waypoints_11all20$focal=="sarabi",]$manualDate)
which.min(abs(SUAQ_waypoints_11all20$manualDate[1]-SUAQ_waypoints_11all20[SUAQ_waypoints_11all20$focal=="sarabi",]$manualDate))
SUAQ_waypoints_11all20$SUAQ_followlog.ClassFocal[which.min(abs(SUAQ_waypoints_11all20$manualDate[1]-SUAQ_waypoints_11all20[SUAQ_waypoints_11all20$focal=="sarabi",]$manualDate))]
SUAQ_waypoints_11all20$SUAQ_followlog.ClassFocal[which.min(abs(SUAQ_waypoints_11all20$manualDate[1]-SUAQ_waypoints_11all20[SUAQ_waypoints_11all20$focal=="sarabi",]$manualDate))]


temp<- SUAQ_waypoints_11all20 %>% filter(is.na(SUAQ_followlog.ClassFocal))

temp<- SUAQ_waypoints_11all20 %>% filter((SUAQ_followlog.ClassFocal=="unk")|is.na(SUAQ_followlog.ClassFocal))


#inspect
specs_FollowlogOrangutanlog_sexdifference <- SUAQ_waypoints_11all20 %>% group_by(follow,focal,manualDate,SUAQ_followlog.SexFocal,SUAQ_orangutans.Sex) %>% summarise(count=n()) %>%  filter(SUAQ_followlog.SexFocal!=SUAQ_orangutans.Sex) # there are 788 difference in sex between joined info
specs_FollowlogOrangutanlog_ClassDifference <- SUAQ_waypoints_11all20 %>% group_by(follow,focal,manualDate,SUAQ_followlog.ClassFocal,SUAQ_orangutans.Class) %>% summarise(count=n()) %>% filter(SUAQ_followlog.ClassFocal!=SUAQ_orangutans.Class) 


tmp<- SUAQ_followlog %>% filter(SUAQ_followlog.FollowNumber==1638)


### 6.5. Create project Master-Dataframes
##### save all waypoints as sf
SUAQ_waypoints_11all20_sf <-  st_as_sf(SUAQ_waypoints_11all20, 
                          coords = c("E","N"), 
                          crs = 32647)
##### waypoints of female orangutans in SUAQ (attention here the defined gender by the followlog is taken)
SUAQ_waypoints_fem_sf<- SUAQ_waypoints_11all20_sf %>% filter(SUAQ_orangutans.Sex=="female")
SUAQ_waypoints_fem <- SUAQ_waypoints_11all20 %>% filter(SUAQ_orangutans.Sex=="female")


##### Shiny
write_csv(SUAQ_waypoints_11all20,path="shinyapp/orangapp/data/SUAQ_waypoints_11all20_backup.csv")

temp<- SUAQ_waypoints_11all20 %>% filter(is.na(follow))


```


```{r R-specific preparation}
##### DATA WRANGLING ######
# Create timelag
SUAQ_waypoints_11all20_sf<- SUAQ_waypoints_11all20_sf %>% 
  group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
  mutate(timelag=as.numeric(difftime(lead(as.POSIXlt(manualTime)),as.POSIXlt(manualTime),units = "secs"))) # change datetime to time, see analysis below
specs_neg_timelag <- SUAQ_waypoints_11all20_sf %>% filter(timelag<0)
SUAQ_waypoints_11all20_sf %>% ggplot(aes(.$timelag))+geom_histogram(binwidth = 30)+scale_y_log10()
##### Set a GPS Tracking Laufnummer oder Lösung des Zeitproblems ##### 
# Begründung: In den Tracks kommen teilweise Punkte vor welche zu einer viel späteren Zeit gemacht wurden. Oder wurde Zeit falsch gespeichert (bzw. lief umwandlung in Indonesische Zeitzone falsch)
#suaq_orangutan_follows_2020_sf<- suaq_orangutan_follows_2020_sf %>%  arrange(desc(datetime))
#SUAQ_data<- SUAQ_data %>%  arrange(desc(.$CreationTime))
#### Laufnummer für GPS Punkt erstellen
SUAQ_waypoints_11all20_sf %>% ggplot(aes(manualTime))+geom_histogram()
SUAQ_waypoints_11all20_sf %>% filter(is.na(manualTime)) %>% ggplot(aes(hms::as_hms(automaticTime)))+geom_histogram() # time before conversion
specs_follows_points_in_night<- SUAQ_waypoints_11all20_sf %>% filter(manualTime<lubridate::hms("04:00:00")) # probably one outlier and one track in the night. Or wrong time settings
```


### Analysis
## First visuals SUAQ
```{r Visualization social relationships}
##### VISUALIZE ######
#### number of follows
result_numoffollows<- SUAQ_waypoints_11all20 %>% group_by(follow,focal) %>% summarize(count=n()) %>% group_by(focal) %>% summarize(count=n())

result_totnumfollows <- SUAQ_waypoints_11all20 %>% 
  group_by(follow) %>% summarise(count=n()) # 1206 Follows
result_totnumNNfollows <- SUAQ_waypoints_11all20 %>% filter(followtype=="NN") %>% 
  group_by(follow) %>% summarise(count=n()) # 636 Follows

#### number of points per individual no matter if its as a infant or focal
SUAQ_tracksperorangutanfocal_sf <-
  SUAQ_waypoints_11all20_sf %>% 
  group_by(follow,focal,infantname) %>% 
  summarise(count =n()) %>%
  ungroup() %>%
  group_by(focal) %>%
  summarize(count_focal = sum(count))
SUAQ_tracksperorangutaninfant_sf <-
  SUAQ_waypoints_11all20_sf %>% 
  group_by(follow,focal,infantname) %>% 
  summarise(count =n()) %>%
  ungroup() %>%
  group_by(infantname) %>%
  summarize(count_infant = sum(count))
SUAQ_tracksperorangutanfocal<- st_drop_geometry(SUAQ_tracksperorangutanfocal_sf)
SUAQ_tracksperorangutaninfant<- st_drop_geometry(SUAQ_tracksperorangutaninfant_sf)
SUAQ_tracksperorangutan<- SUAQ_tracksperorangutanfocal %>% left_join(SUAQ_tracksperorangutaninfant,by=c("focal"="infantname")) %>% mutate(NumPointsPerFocal=ifelse(is.na(.$count_infant),.$count_focal,.$count_infant+.$count_focal))
#### Orangutan hirarchy
SUAQ_family<- data.frame(SUAQ_orangutans$SUAQ_orangutans.orangutanname, 
                         SUAQ_orangutans$SUAQ_orangutans.Mother,
                         SUAQ_orangutans$SUAQ_orangutans.Sex,stringsAsFactors = FALSE)
 names(SUAQ_family) <- c("name","mother","sex")
SUAQ_family <- SUAQ_family %>%
  left_join(SUAQ_tracksperorangutan,by=c("name"="focal"))
SUAQ_family <- SUAQ_family%>%
  left_join(SUAQ_tracksperorangutan[,c(1,4)],by=c("mother"="focal"),na_matches="never")
SUAQ_family <-
  SUAQ_family %>% mutate(
    sex = ifelse(sex == "male","#b2df8a","#a6cee3"),
    name = ifelse(
      is.na(NumPointsPerFocal.x),
      name,
      paste(name, "[", NumPointsPerFocal.x,"]")
    ),
    mother = ifelse(
      is.na(NumPointsPerFocal.y),
      mother,
      paste(mother, "[", NumPointsPerFocal.y,"]")
    )
  )
SUAQ_family<- SUAQ_family %>% filter(mother!="NA  : [ NA ]")
network <- graph_from_data_frame(d=SUAQ_family, directed=F) 
layout <- layout.reingold.tilford(network, circular=T)
#layout <- layout_(network,as_tree())
V(network)[SUAQ_family$mother]$color = "#1f78b4"
V(network)[SUAQ_family$name]$color = SUAQ_family$sex
plot.igraph(network, layout=layout,edge.width=2,edge.size=2,vertex.size=5,vertex.label.dist=1,vertex.label.cex=1, label.degree=-pi/4,main="SUAQ Orangutans July 2020 \n (Mother = dark blue, Male = Green, Female = Blue)",vertex.label.color="black")
```

```{r Visualization observation duration}
tmp<- SUAQ_waypoints_11all20 %>% 
  filter(!is.na(.$SUAQ_followlog.SexFocal),is.na(.$SUAQ_orangutans.Sex))
#### Visualize Observation duration for individuals
specs_orangutan_tot_num_of_gps <-SUAQ_waypoints_11all20 %>% 
  group_by(focal) %>%
  summarise(n()) %>% left_join(result_numoffollows,by=c('focal'='focal'))
colnames(specs_orangutan_tot_num_of_gps) <- c("focal",
                                           "orangutan_tot_num_of_gps","orangutan_num_of_follows")
#### Number of GPS points
tmp_SUAQ_waypoints_11all20 <- SUAQ_waypoints_11all20
tmp<- specs_orangutan_tot_num_of_gps
tmp_SUAQ_waypoints_11all20 <-tmp_SUAQ_waypoints_11all20 %>% 
  left_join(tmp,by = c("focal" = "focal"))
tmp_SUAQ_waypoints_11all20 <-
  tmp_SUAQ_waypoints_11all20 %>%  mutate(focal = paste(focal," [#GPS: ", orangutan_tot_num_of_gps,"] [#Follows: ",orangutan_num_of_follows,"]"))
tmp_SUAQ_waypoints_11all20$focal = with(tmp_SUAQ_waypoints_11all20,
                                        reorder(focal, orangutan_tot_num_of_gps, length))
plot_orangutan_followperiods <- tmp_SUAQ_waypoints_11all20 %>%
  filter(!is.na(focal)) %>%
  filter(SUAQ_orangutans.Sex=="female") %>% 
  ggplot(aes(manualDate, focal)) +
  geom_point(aes(colour = focal)) +
  labs(title = "Duration of observation for \n female orangutans", x = "date", y =
         "orangutanname") +
  theme(legend.position = "none")
plot_orangutan_followperiods
ggplotly(plot_orangutan_followperiods)
#### Histogram of orangutans and their number of follows
specs_orangutan_tot_num_of_gps<- specs_orangutan_tot_num_of_gps %>%
  left_join(SUAQ_orangutans[,c(1:5)],by=c("focal"="SUAQ_orangutans.orangutanname"))
specs_orangutan_tot_num_of_gps %>% 
  filter(.$SUAQ_orangutans.Sex=="female") %>%
  ggplot(aes(reorder(focal, -orangutan_num_of_follows),x =orangutan_num_of_follows))+
  geom_bar(stat="identity")
#### Histogram of number of gps per individual
plot_orangutan_followhisto<- tmp_SUAQ_waypoints_11all20 %>%
  filter(!is.na(focal)) %>%
  filter(SUAQ_orangutans.Sex=="female") %>% 
  ggplot(aes(manualDate, focal,fill=focal)) +
  geom_density_ridges(alpha=0.6,
                      scale=0.95, 
                      stat="binline", 
                      bins=120,
                      jittered_points=TRUE,
                      draw_baseline = FALSE,
                      color = "Black") + # bin for every 3 months
  theme_ridges() +
  labs(title = "Duration of observation for \n female orangutans", x = "date", y =
         "orangutanname [number of GPS observations]") +
  theme(legend.position = "none")
plot_orangutan_followhisto
#### Histogram of number of gps per individual for the 10
plot_orangutan_followhisto_best<- tmp_SUAQ_waypoints_11all20 %>%
  filter(!is.na(focal)) %>%
  filter(SUAQ_orangutans.Sex=="female") %>% 
  filter(.$orangutan_tot_num_of_gps>200) %>% 
  ggplot(aes(manualDate,focal,fill=focal)) +
  geom_density_ridges(alpha=0.6,
                      scale=0.95, 
                      stat="binline", 
                      bins=120,
                      jittered_points=TRUE,
                      draw_baseline = FALSE,
                      color = "Black") + # bin for every 3 months
  theme_ridges() +
  labs(title = "Duration of observation for \n female orangutans", x = "date", y =
         "orangutanname [number of GPS observations]") +
  theme(legend.position = "none")
plot_orangutan_followhisto_best
```


```{r Visualization gps on map}
#


# Grouping and visualize it
plot1<- SUAQ_waypoints_11all20 %>%
  group_by(follow) %>%
  ggplot(aes(E,N))+
  geom_point(aes(color=SUAQ_waypoints_11all20$focal),size=0.3)+
  geom_path(aes(color=SUAQ_waypoints_11all20$focal), alpha = 0.2,size=0.3)+
  theme(legend.position = "none")
plot1
# Zoom-Panable map of tracks
plot2<- SUAQ_waypoints_11all20 %>%
  group_by(follow) %>%
  ggplot(aes(E,N))+
  geom_point(aes(color=SUAQ_waypoints_11all20$focal),size=0.3)+
  geom_path(aes(color=SUAQ_waypoints_11all20$focal), alpha = 0.2,size=0.3)
ggplotly(plot2)
#### FEMALE: Map of female gps tracks
# Zoom-Panable map of tracks of females with over 200 GPS points
tmp_SUAQ_mosttrackedfemales <- SUAQ_waypoints_11all20 %>%
  filter(!(SUAQ_orangutans.Sex == "male")) %>%
  filter(
    focal %in% c(
      "lisa",
      "friska",
      "ellie",
      "cissy",
      "lilly"
    )
  )
tmp_SUAQ_mosttrackedfemales_sf <- SUAQ_waypoints_11all20_sf %>%
  filter(!(SUAQ_orangutans.Sex == "male")) %>%
  filter(
    focal %in% c(
      "lisa",
      "friska",
      "ellie",
      "cissy",
      "lilly",
      "yulia",
      "raffi",
      "sarabi",
      "trident",
      "alice",
      "cinnamon"
    )
  )
#### Plot most tracked females OU
plot2<-tmp_SUAQ_mosttrackedfemales %>% 
  group_by(follow) %>%
  ggplot(aes(E,N))+
  geom_point(aes(color=focal),size=0.3)+
  geom_path(aes(color=focal), alpha = 0.2,size=0.3)
ggplotly(plot2)


#### create convex hulls on points of each most tracked female orangutan
tmp_SUAQ_mosttrackedfemales_chulls <- tmp_SUAQ_mosttrackedfemales_sf %>%
  group_by(focal) %>% 
  summarise(geometry = st_combine(geometry) ) %>%
  st_convex_hull()
tmp_SUAQ_mosttrackedfemales_centroid <- tmp_SUAQ_mosttrackedfemales_sf %>%
  group_by(focal) %>% 
  summarise(geometry = st_combine(geometry) ) %>%
  st_centroid()
plot_SUAQ_mosttrackedfemales_chulls_centroid <-
  ggplot(tmp_SUAQ_mosttrackedfemales_chulls) + 
  geom_sf(data = tmp_SUAQ_mosttrackedfemales_chulls,
                                               aes(colour = focal, alpha = 1),
                                               fill = NA)+
  #geom_sf(data = tmp_SUAQ_mosttrackedfemales_centroid,aes(colour = focal, alpha = 1))+
  geom_sf(data = SUAQ_pathnetwork,
                                               aes(colour = "black", alpha = 1),
                                               fill = NA,colour = "black")
ggplotly(plot_SUAQ_mosttrackedfemales_chulls_centroid)

#### Create MCP with percentage
tmp_SUAQ_waypoints_morethan50gps_11all20<- SUAQ_waypoints_11all20 %>% 
  left_join(specs_orangutan_tot_num_of_gps[,c(1:3)],by=c("focal"="focal"))%>% 
  filter(orangutan_tot_num_of_gps>=50)
tmp_SUAQ_waypoints_morethan50gps_11all20.sp<- tmp_SUAQ_waypoints_morethan50gps_11all20 %>% 
  dplyr::select(focal,E,N)
coordinates(tmp_SUAQ_waypoints_morethan50gps_11all20.sp) <- c("E","N")
proj4string(tmp_SUAQ_waypoints_morethan50gps_11all20.sp) <- CRS( "+proj=utm +zone=47 +datum=WGS84 +units=m +no_defs" )

tmp_SUAQ_waypoints_morethan50gps_11all20.mcp<- mcp(tmp_SUAQ_waypoints_morethan50gps_11all20.sp,percent = 95)

tmp_SUAQ_waypoints_morethan50gps_11all20.spgeo <- spTransform(tmp_SUAQ_waypoints_morethan50gps_11all20.sp, CRS("+proj=longlat"))
tmp_SUAQ_waypoints_morethan50gps_11all20.mcpgeo <- spTransform(tmp_SUAQ_waypoints_morethan50gps_11all20.mcp, CRS("+proj=longlat"))

mybasemap <- get_stamenmap(bbox = c(left = min(tmp_SUAQ_waypoints_morethan50gps_11all20.spgeo@coords[,1])-0.005, 
                                    bottom = min(tmp_SUAQ_waypoints_morethan50gps_11all20.spgeo@coords[,2])-0.005, 
                                    right = max(tmp_SUAQ_waypoints_morethan50gps_11all20.spgeo@coords[,1])+0.005, 
                                    top = max(tmp_SUAQ_waypoints_morethan50gps_11all20.spgeo@coords[,2])+0.005), 
                           zoom = 12)

tmp_SUAQ_waypoints_morethan50gps_11all20.geo <- data.frame(tmp_SUAQ_waypoints_morethan50gps_11all20.spgeo@coords, 
                          id = tmp_SUAQ_waypoints_morethan50gps_11all20.spgeo@data$focal )

mcp_map_95 <- ggmap(mybasemap) + 
  geom_polygon(data =     fortify(tmp_SUAQ_waypoints_morethan50gps_11all20.mcpgeo),  
               # Polygon layer needs to be "fortified" to add geometry to the dataframe
              aes(long, lat, colour = id, fill = id),
              alpha = 0.3) + # alpha sets the transparency
  geom_point(data = tmp_SUAQ_waypoints_morethan50gps_11all20.geo, 
             aes(x = tmp_SUAQ_waypoints_morethan50gps_11all20.geo$E, y = tmp_SUAQ_waypoints_morethan50gps_11all20.geo$N, colour = 
                   tmp_SUAQ_waypoints_morethan50gps_11all20.geo$id))  +
  theme(legend.position = c(0.15, 0.80)) +
  labs(x = "Longitude", y = "Latitude")
mcp_map_95

mcp(tmp_SUAQ_waypoints_morethan50gps_11all20.sp,percent = 95)
graphics.off() 
par("mar") 
par(mar=c(1,1,1,1))
mcp.area(tmp_SUAQ_waypoints_morethan50gps_11all20.sp, percent = seq(20, 100, by = 5))
hrs


#### Plot mcp with ggplot
mcp_map_95 <- ggmap(mybasemap) +
  geom_polygon(
    data =     fortify(tmp_SUAQ_waypoints_morethan50gps_11all20.mcpgeo),
    # Polygon layer needs to be "fortified" to add geometry to the dataframe
    aes(long, lat, colour = id, fill = id),
    alpha = 0.3
  ) + # alpha sets the transparency
  geom_point(
    data = tmp_SUAQ_waypoints_morethan50gps_11all20.geo,
    aes(
      x = E,
      y = N,
      colour =
        id
    )
  )  +
  theme(legend.position = c(0.15, 0.80)) +
  labs(x = "Longitude", y = "Latitude")
ggplotly(mcp_map_95)



#### Create kernelUD
SUAQ_HR_kernelUD<- kernelUD(tmp_SUAQ_waypoints_morethan50gps_11all20.sp, h = "href", grid = 60,
             same4all = FALSE, hlim = c(0.1, 1.5),
             kern = c("bivnorm", "epa"), extent = 1,
             boundary = NULL)
plot(SUAQ_HR_kernelUD$ellie)


#### Create dBBMM
tmp_SUAQ_mosttrackedfemales_test <- tmp_SUAQ_mosttrackedfemales %>%
  filter(!is.na(.$manualDatetime) &
           !is.na(focal)) %>% group_by(follow) %>%
  arrange(manualDatetime) %>%
  group_by(focal) %>%
  distinct(manualDatetime, focal, .keep_all = TRUE)
tmp_SUAQ_mosttrackedfemales_test <-
  tmp_SUAQ_mosttrackedfemales_test %>%
  group_by(focal)
data2 <- move(
  x = tmp_SUAQ_mosttrackedfemales_test$E,
  y = tmp_SUAQ_mosttrackedfemales_test$N,
  time = tmp_SUAQ_mosttrackedfemales_test$manualDatetime,
  proj = CRS("+proj=utm +zone=47 +datum=WGS84 +units=m +no_defs"),
  animal = tmp_SUAQ_mosttrackedfemales_test$focal
)
plot(data, type = "b", pch = 20)



#### GENDER:
plot_gender_map<- SUAQ_waypoints_11all20 %>%
  group_by(follow) %>%
  ggplot(aes(E,N))+
  geom_point(aes(color=SUAQ_orangutans.Sex),size=0.3)+
  geom_path(aes(color=SUAQ_orangutans.Sex), alpha = 0.2,size=0.3)
ggplotly(plot_gender_map)



# Map with tiles (leaflet)
pal <- colorFactor(get_palette(palette = "default", 42), domain = levels(as.factor(SUAQ_waypoints_11all20_sf$focal)))

plot2<- leaflet(data = st_transform(SUAQ_waypoints_11all20_sf, crs = 4326)) %>% 
  addProviderTiles(providers$Esri.WorldImagery) %>% 
  addCircleMarkers(color = ~pal(SUAQ_waypoints_11all20_sf$focal),
                   fillOpacity = 1,
                   radius = 1,
                   opacity = 1)
plot2



## next idea homerange per month or year (need more years!)
# suaq_orangutan_chulls_month <- suaq_orangutan_follows_2020_sf %>%
#   group_by(orangutanname) %>%
#   summarise(geometry = st_combine(geometry)) %>%
#   st_convex_hull()
# rownames(suaq_orangutan_chulls_month) <- suaq_orangutan_chulls_month$orangutanname
# 
# suaq_orangutan_chulls_january <- suaq_orangutan_follows_2020_sf %>%
#   filter(between(datetime, as.Date("2019-01-01"),as.Date("2019-01-31"))) %>% 
#   group_by(orangutanname) %>%
#   summarise(geometry = st_combine(geometry)) %>%
#   st_convex_hull()
# colnames(suaq_orangutan_chulls_january)[2]
# class(suaq_orangutan_chulls_january$geometry[1])
# 
# suaq_orangutan_chulls_month<-bind_cols(suaq_orangutan_chulls_month, suaq_orangutan_chulls_january,by = c("orangutanname" = "orangutanname"))
# ?full_join
# 
# suaq_orangutan_chulls %>% ggplot()+
#     geom_polygon(suaq_orangutan_chulls$geometry)
# plot_tmp<- ggplot(suaq_orangutan_chulls) + geom_sf(data = suaq_orangutan_chulls, aes(colour = orangutanname,alpha=1),fill=NA)
# ggplotly(plot_tmp)

```
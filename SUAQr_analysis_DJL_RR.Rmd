---
title: "Projekt"
author: "Stefan Graf"
date: "28 3 2020"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Markings:
#### Quality check: --> are quality checks of chunks executed before
########### DELETE ############--> are chunks to delete
## Title --> are titles for sections
### explanations of the following chunk
##### SUAQ TRACKS 2018 & 2019 ##### --> Code sections to understand code better

```{r import, echo= 'F',results='hide'}
# CLASSICAL PACKAGE IMPORTER (Stefan Graf & Tobias Frey)
options(digits=10)
packages_checker <- function(packages_list){
  for (package in packages_list){
    if (!require(package, character.only = T)) {
      install.packages(package)
    }
    library(package, character.only = T)
  }
}
packages_checker(
  c('sjstats', # further statistics : infos:https://bookdown.org/animestina/phd_july_19/simple-linear-model-and-mixed-methods.html#multilevel-modelling-with-random-intercepts-and-slopes
    'lmtest', # further statistics
    'rstatix', # friedmann test level 3
    'sjPlot',
    'texreg', # tidy overview of lmer models
    'remotes',
    'mdthemes',
    'stargazer',
    'xtable',
    'pastecs', # descriptive statistics
    'viridis', # function pal
    'ctmm',
    'tmaptools',# read_gpx function
    'plotKML',# read GPX to dataframe
    'lubridate',
    'zoo',
    'data.tree',
    'hR',# making realtionships of orangutans
    'dbplyr',
    'plyr',
    'dplyr',
    'tidyr',
    'tidyverse',
    'sf', # Simple feature --> super spatial data handling structure
    'raster', # For raster data
    'ggspatial',
    'rgdal',
    'data.table',
    'RColorBrewer', # color schemas from color brewer web
    'ggraph', # visualization
    'igraph',
    'tmap',
    'vioplot',
    'scales',
    'trajr',
    'plotly', # zoomable, pannable ggplot
    'mapview',
    'ggmap', # easier interactive ggmaps 
    'leaflet', # Javascript library (originally) for plotting on a maptile interactive map
    'tmap',
    'stringr',
    'remotes', # geom_convexhull function
    'magrittr',
    'ggridges',
    'forcats',
    'move',# Brownian Bridge Movement Model
    'adehabitatHR',
    'ggpubr',
    'htmlwidgets',
    'gridExtra',# additional to ggplot, can add a density plot on the side of a histogram "marginal plot"
    'grid',
    'ggExtra',
    'lme4',
    'nlme',
    'ggfortify',
    'readr',
    'dplyr',
    'ggplot2',
    'tidyr',
    'tidyverse',
    'skimr',
    'viridis',
    'ggstatsplot',
    'ggpubr',
    'GGally',
    'ggfortify', #check linear regression assumptions
    'lindia', # linear regression tools z.b gg_rehist()
    'MuMIn',
    'MASS',
    'GGally', # usefull pairs function to create many scatterplots
    'maptools',# used in move package
    'circular', # used in move package
    'hrbrthemes',
    'viridis',
    'lmerTest'
    ))
rm(list = ls())
getwd()

library(knitr)
write_bib(c("ggplot2"))
### CUSTOM FUNCTIONS ###

# Function for displaying scale labels in ggplot not as f.e. 4e+05
fancy_scientific <- function(l) {
     # turn in to character string in scientific notation
     l <- format(l, scientific = TRUE)
     # quote the part before the exponent to keep all the digits
     l <- gsub("^(.*)e", "'\\1'e", l)
     # turn the 'e+' into plotmath format
     l <- gsub("e", "%*%10^", l)
     # return this as an expression
     parse(text=l)
}


clockS = function(t){hour(t)*3600+minute(t)*60+second(t)}
st_kde <- function(points,cellsize, bandwith, extent = NULL){
  require(MASS)
  require(raster)
  require(sf)
  if(is.null(extent)){
    extent_vec <- st_bbox(points)[c(1,3,2,4)]
  } else{
    extent_vec <- st_bbox(extent)[c(1,3,2,4)]
  }
  
  n_y <- ceiling((extent_vec[4]-extent_vec[3])/cellsize)
  n_x <- ceiling((extent_vec[2]-extent_vec[1])/cellsize)
  
  extent_vec[2] <- extent_vec[1]+(n_x*cellsize)-cellsize
  extent_vec[4] <- extent_vec[3]+(n_y*cellsize)-cellsize
  
  coords <- st_coordinates(points)
  matrix <- kde2d(coords[,1],coords[,2],h = bandwith,n = c(n_x,n_y),lims = extent_vec)
  raster(matrix)
}




#### Custom functions for analysis
clockS = function(t){hour(t)*3600+minute(t)*60+second(t)}


euclid <- function(x1,y1,x2,y2){
  return(sqrt((x1-x2)^2+(y1-y2)^2))
}

turning_angle <- function(x,y,lead_lag = 1){ 
  if(length(x) < 3){return(NA)}
  if(length(x) != length(y)){stop("x and y must be of the same length")}
  p1x <- lag(x,lead_lag)
  p1y <- lag(y,lead_lag)
  p2x <- x
  p2y <- y
  p3x <- lead(x,lead_lag)
  p3y <- lead(y,lead_lag)
  p12 <- euclid(p1x,p1y,p2x,p2y)
  p13 <- euclid(p1x,p1y,p3x,p3y)
  p23 <- euclid(p2x,p2y,p3x,p3y)
  rad <- acos((p12^2+p23^2-p13^2)/(2*p12*p23))
  grad <- (rad*180)/pi
  grad[p12 == 0 | p23 == 0] <- NA
  d <-  (p3x-p1x)*(p2y-p1y)-(p3y-p1y)*(p2x-p1x)
  d <- ifelse(d == 0,1,d)
  d[d>0] <- 1
  d[d<0] <- -1
  d[d==0] <- 1
  turning <- grad*d*-1+180
  return(turning)
}

# Source https://exploratory.io/note/kanaugust/1701090969905358
calculate_mode <- function(x) {
  uniqx <- unique(na.omit(x))
  uniqx[which.max(tabulate(match(x, uniqx)))]
}

Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}
# Statistics from here: https://github.com/aufrank/R-hacks/blob/master/mer-utils.R
vif.mer <- function (fit) {
    ## adapted from rms::vif

    v <- vcov(fit)
    nam <- names(fixef(fit))

    ## exclude intercepts
    ns <- sum(1 * (nam == "Intercept" | nam == "(Intercept)"))
    if (ns > 0) {
        v <- v[-(1:ns), -(1:ns), drop = FALSE]
        nam <- nam[-(1:ns)]
    }

    d <- diag(v)^0.5
    v <- diag(solve(v/(d %o% d)))
    names(v) <- nam
    v
}

give.n <- function(x){
 return(c(y = mean(x), label = length(x))) 
# experiment with the multiplier to find the perfect position
}


setwd("/Users/stefgr/Nextcloud/UZH/12_Semester/20200313_Masterthesis/R/")

```

#### SUAQ research site
## Preprocessing
1. Getting data from excel/csv files
2. Getting data from gpx files, clean and order it
3. Merge Files

```{r GPS Loader,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
### Load Project variables ### 
##### waypoints ##### "data/Processed_data/SUAQ_waypoints_11all20.csv"
##### find newest written dataset
mostrecent <- list.files(path = "data/Processed_data/", full.names = FALSE, recursive = FALSE)
mostrecent <- as.data.frame(mostrecent)
mostrecent <- mostrecent %>% filter(grepl("SUAQ_waypoints_11all20",mostrecent)) %>% 
  mutate(date=as.numeric(str_extract(mostrecent,"\\d{8}"))) %>% arrange(desc(date)) %>% top_n(1,date)

##### Load data
SUAQ_waypoints_11all20_loc <-
  read_csv(paste0("data/Processed_data/",mostrecent$date[1],"_SUAQ_waypoints_11all20.csv"),guess_max = min(10000, 30000))
SUAQ_waypoints_11all20_loc <- SUAQ_waypoints_11all20_loc %>% mutate(monthYearDate=format(as.Date(manualDate), "%Y-%m"))
SUAQ_waypoints_11all20_loc <- SUAQ_waypoints_11all20_loc %>% mutate(automaticDatetime=with_tz(automaticDatetime,tz = "Asia/Pontianak"))
SUAQ_waypoints_11all20_loc <- SUAQ_waypoints_11all20_loc %>% mutate(manualDatetime=with_tz(manualDatetime,tz = "Asia/Pontianak"))

SUAQ_waypoints_11all20_loc_test <- SUAQ_waypoints_11all20_loc %>% filter(focal!=SUAQ_followlog.FocalName)
SUAQ_waypoints_11all20_loc_test2 <- SUAQ_waypoints_11all20_loc %>% filter(!is.na(ageOfCurrentOffspring))


##### Weather and FAI #####
SUAQ_weather <- read_csv("data/Processed_data/SUAQ_weather.csv")
SUAQ_fai <- read_csv("data/Processed_data/SUAQ_fai.csv")
SUAQ_weather$SUAQ_weather.month <-  factor(SUAQ_weather$SUAQ_weather.month, levels = month.name)
#### get the sums for water percp change
SUAQ_weather_monthly_sum<-SUAQ_weather %>% dplyr::select(SUAQ_weather.year,SUAQ_weather.month,SUAQ_weather.rainfall_tot,SUAQ_weather.waterlevel_change) %>% 
  group_by(SUAQ_weather.year,SUAQ_weather.month) %>% 
  summarise_all(funs(sum))
#### get the means for temps.
SUAQ_weather_monthly<-SUAQ_weather %>%
  group_by(SUAQ_weather.year,SUAQ_weather.month) %>% 
  summarise_all(funs(mean))
#### join them
SUAQ_weather_monthly<- SUAQ_weather_monthly %>% 
  dplyr::select(-SUAQ_weather.weather_id,-SUAQ_weather.day,-SUAQ_weather.daymonthyear, -SUAQ_weather.rainfall_tot,-SUAQ_weather.waterlevel_change) %>%  # deselect water level change and rainfall total --> because we need the sum not the mean there
  left_join(SUAQ_weather_monthly_sum,by=c("SUAQ_weather.year"="SUAQ_weather.year","SUAQ_weather.month"="SUAQ_weather.month"))

##### Adding the southern oscillation index (enso: https://www.ncdc.noaa.gov/teleconnections/enso/)
SUAQ_southeroscizllation_SOI <-  read_csv("data/external/enso_southernoscillationindex.csv") 
colnames(SUAQ_southeroscizllation_SOI)<- c("date","SOI")
SUAQ_southeroscizllation_SOI <- SUAQ_southeroscizllation_SOI %>% mutate(year=as.numeric(str_extract(date, "^[0-9]{4}")),month=str_extract(date, ".{2}$")) %>% dplyr::select(-date) 
SUAQ_southeroscizllation_SOI<- SUAQ_southeroscizllation_SOI%>% mutate(month=month.name[as.numeric(month)])

##### Adding SST aswell other nino index (main index)
SUAQ_southeroscizllation_SST <-  read_delim("data/external/Nino_3_4_SST_Index.csv",delim=";") %>% gather("month","SST",2:13)

SUAQ_weather_fai_soi_monthly <- SUAQ_weather_monthly %>% left_join(SUAQ_southeroscizllation_SOI,by=c("SUAQ_weather.month"="month","SUAQ_weather.year"="year")) %>% 
  left_join(SUAQ_fai,by=c("SUAQ_weather.month"="SUAQ_fai.month","SUAQ_weather.year"="SUAQ_fai.year")) %>% left_join(SUAQ_southeroscizllation_SST,by=c("SUAQ_weather.month"="month","SUAQ_weather.year"="year"))
SUAQ_weather_fai_soi_monthly <- SUAQ_weather_fai_soi_monthly %>% mutate(yearmonth=parse_date_time(paste0(SUAQ_weather.month,"-",SUAQ_weather.year), "%m-%Y",tz = "Asia/Pontianak")) %>% mutate(SUAQ_fai.fai=as.numeric(SUAQ_fai.fai))


SUAQ_weather_fai_soi_monthly$ENSO_cat <- cut(SUAQ_weather_fai_soi_monthly$SUAQ_weather.year, 
                   breaks=c(2000,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020), 
                   labels=c("strong la niña","moderate la niña","neutral","neutral","weak el niño","very strong niño", "weak la niña","weak la niña","weak el niño","neutral","moderate la niña"))



##### path network ##### 
SUAQ_pathnetwork<- as.data.frame(read_GPX(file="data/SUAQ_Peta_WithLines.GPX",layers = c("routes")))
colnames(SUAQ_pathnetwork)[15]<- "geometry"
SUAQ_pathnetwork_sf_wgs<- st_as_sf(SUAQ_pathnetwork,crs=4326)
SUAQ_pathnetwork_sf_loc <- st_transform(SUAQ_pathnetwork_sf_wgs,crs = 23867)

##### location network ##### 
SUAQ_locationnetwork_sf_wgs <- st_read("data/20201201_StudyBalimbingStudyArea_points.GPX")
SUAQ_locationnetwork_sf_loc <- st_transform(SUAQ_locationnetwork_sf_wgs,crs = 23867)

##### for locale coordinate system
coordinates_tmp <- st_coordinates(SUAQ_locationnetwork_sf_loc)
colnames(coordinates_tmp) <- c("E","N")
SUAQ_locationnetwork_sf_loc <- cbind(SUAQ_locationnetwork_sf_loc,coordinates_tmp)
SUAQ_locationnetwork_loc <- st_drop_geometry(SUAQ_locationnetwork_sf_loc)

##### Selection only pointtypes which are taken on the orangutan way? is this true for all? ##### 
SUAQ_rangepoints_11all20_loc <- SUAQ_waypoints_11all20_loc %>% filter(PtType %in% c("daynest","found","lost","mornnest","nightnest","range","tree")) # get rid of lcg lch abnormally off points camppoints points and

##### Change trackpoint_id and total num of GPS per follow
###### trackpoint ID 
SUAQ_rangepoints_11all20_loc <- SUAQ_rangepoints_11all20_loc %>% group_by(follow) %>% dplyr::select(-trackpoint_id) %>% mutate(trackpoint_id = row_number())
###### Definitive number of gps per follow
result_totnumfollows <- SUAQ_rangepoints_11all20_loc %>% 
  group_by(follow) %>% summarise(follow_totNumOfGPSpoints=n()) # 1323 Follows
SUAQ_rangepoints_11all20_loc <- SUAQ_rangepoints_11all20_loc %>%dplyr::select(-follow_totNumOfGPSpoints) %>% left_join(result_totnumfollows,by=c("follow"="follow"))
###### orangutan number of points ID 
result_numoffollows<- SUAQ_rangepoints_11all20_loc %>% group_by(follow,focal) %>% summarise(count=n()) %>% group_by(focal) %>% summarise(count=n())

specs_orangutan_tot_num_of_gps <-SUAQ_rangepoints_11all20_loc %>% 
  group_by(focal) %>%
  summarise(n()) %>% left_join(result_numoffollows,by=c('focal'='focal'))
colnames(specs_orangutan_tot_num_of_gps) <- c("focal",
                                           "orangutan_tot_num_of_gps","orangutan_num_of_follows")
tmp<- specs_orangutan_tot_num_of_gps
SUAQ_rangepoints_11all20_loc <-SUAQ_rangepoints_11all20_loc %>% dplyr::select(-orangutan_num_of_follows,-orangutan_tot_num_of_gps) %>% 
  left_join(tmp,by = c("focal" = "focal"))




##### Recalculate edge lengths etc. based on new point selection for rangepoints dataframe
SUAQ_rangepoints_11all20_loc<- SUAQ_rangepoints_11all20_loc %>% 
  group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
  mutate(timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         speed_last = manual_distTolast/timelag,
         speed_next = manual_distToNext/timelag_lead,
         turningAngle=turning_angle(E,N),
         altitudediff_next=altitude-lead(altitude),
         )





##### WGS84 file
SUAQ_rangepoints_11all20_loc_sf <-  st_as_sf(SUAQ_rangepoints_11all20_loc, 
                          coords = c("E","N"), 
                          crs = 23867) # can also do that in the new sricpts
SUAQ_rangepoints_11all20_loc_sf_wgs <- st_transform(SUAQ_rangepoints_11all20_loc_sf,4326)
coordinates_tmp <- st_coordinates(SUAQ_rangepoints_11all20_loc_sf_wgs)
colnames(coordinates_tmp) <- c("long","lat")
SUAQ_rangepoints_11all20_loc_wgs <- cbind(SUAQ_rangepoints_11all20_loc_sf_wgs,coordinates_tmp)
SUAQ_rangepoints_11all20_loc_wgs<- st_drop_geometry(SUAQ_rangepoints_11all20_loc_wgs)


##### Selection only females / most tracked females ##### 
SUAQ_rangepoints_11all20_loc_females <-
  SUAQ_rangepoints_11all20_loc %>%   filter(!(SUAQ_orangutans.Sex == "male"))
SUAQ_rangepoints_11all20_loc_females_12 <-
  SUAQ_rangepoints_11all20_loc %>%   filter(!(SUAQ_orangutans.Sex == "male")) %>% filter(
    focal %in% c(
      "lisa",
      "friska",
      "ellie",
      "cissy",
      "lilly",
      "yulia",
      "raffi",
      "sarabi",
      "trident",
      "alice",
      "mocca",
      "cinnamon"
    )
  )
```

### Analysis
## Statistics

```{r Static analysis DJL RR,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
##### Create analysis DF #####
DJL_follows <- SUAQ_rangepoints_11all20_loc %>%
  filter(followtype == "NN") %>%
  group_by(
    follow,
    focal,
    ageFromDOB,
    ClassFocal,
    SUAQ_weather.rainfall_ml_evening,
    SUAQ_weather.river_waterlevel_morning,
    SUAQ_weather.river_waterlevel_evening,
    SUAQ_weather.rainfall_ml_morning,
    SUAQ_weather.avg_temperature_tot,
    SUAQ_weather.max_temp_average,
    SUAQ_weather.min_temp_average,
    SUAQ_weather.temperature_max_morning,
    SUAQ_weather.temperature_min_morning,
    SUAQ_weather.temperature_max_evening,
    SUAQ_weather.temperature_min_evening,
    SUAQ_weather.rainfall_tot_daysbefore,
    SUAQ_weather.temp_max_daysbefore,
    SUAQ_fai.fai,
    ageOfCurrentOffspring,
    monthYearDate,
    follow_totNumOfGPSpoints
  ) %>%
  summarise(DJL = sum(as.numeric(manual_distTolast), na.rm = TRUE), count =
              n(), turningAngleSum=sum(as.numeric(turningAngle), na.rm = TRUE), meanTimelag=mean(timelag_lead,na.rm=TRUE), medianTimelag=median(timelag_lead,na.rm=TRUE),original_followlength=mean(SUAQ_followlog.LengthFollow,na.rm=TRUE),gps_followlength=sum(timelag,na.rm=TRUE)) %>% mutate(speed=(DJL/gps_followlength)*3.6) %>%  ungroup() 

colnames(DJL_follows) <- c("follow","focal","ageFromDOB","ClassFocal","rain_eve","watlevel_mo","walevel_eve","rain_mo","avg_temp_tot","max_temp_average","min_temp_average","temp_max_mo","temp_min_mo","temp_max_eve","temp_min_eve","tot_rain_before","mmax_temp_before","fai","ageOfCurrentOffspring","monthYearDate","numOfPoints","DJL","count","turningAngleSum","meanTimelag","medianTimelag","original_followlength","gps_followlength","speed")


##### Adding total displacement distance
TDD_follows <- SUAQ_rangepoints_11all20_loc[order(SUAQ_rangepoints_11all20_loc$manualDatetime , decreasing = TRUE ),] %>% 
  filter(followtype == "NN") %>% 
  group_by(follow) %>% 
  summarise(firstE=first(E),firstN=first(N),lastE=last(E),lastN=last(N)) %>% 
  mutate(TDD=sqrt((firstE-lastE)^2+(firstN-lastN)^2))


DJL_follows <- DJL_follows %>% 
  left_join(TDD_follows,by=c("follow"="follow")) %>%
  mutate(RR=TDD/DJL) %>% 
  ungroup()

# ##### Adding category number
# DJL_follows<- DJL_follows%>%
#   mutate(ClassFocalID=if_else(ClassFocal=="juvenile",1,1))%>% 
#   mutate(ClassFocalID=if_else(ClassFocal=="adult female",2,ClassFocalID))%>% 
#   mutate(ClassFocalID=if_else(ClassFocal=="unflanged male",3,ClassFocalID))%>% 
#   mutate(ClassFocalID=if_else(ClassFocal=="flanged male",4,ClassFocalID))



# sind ok follows c(2284, 745)
# sind nicht ok follows c(1874)

### New variables f.e. other Tortuosity  variables

##### Adding total number of fruit trees
Tree_rangepoints<- SUAQ_rangepoints_11all20_loc %>%
  filter(PtType%in%c("mornnest","nightnest","tree")) %>% 
  group_by(follow)%>% 
  arrange(manualDatetime,.by_group = TRUE) %>% 
  mutate(tree_timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         tree_timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         tree_manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         tree_manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         tree_speed_last = manual_distTolast/timelag,
         tree_speed_next = manual_distToNext/timelag_lead,
         tree_turningAngle=turning_angle(E,N))

Tree_follows <- Tree_rangepoints %>%
  filter(followtype == "NN") %>%
  group_by(
    follow,
    focal,
    ageFromDOB,
    ClassFocal,
    SUAQ_weather.rainfall_ml_evening,
    SUAQ_weather.river_waterlevel_morning,
    SUAQ_weather.river_waterlevel_evening,
    SUAQ_weather.rainfall_ml_morning,
    SUAQ_weather.avg_temperature_tot,
    SUAQ_weather.max_temp_average,
    SUAQ_weather.min_temp_average,
    SUAQ_weather.temperature_max_morning,
    SUAQ_weather.temperature_min_morning,
    SUAQ_weather.temperature_max_evening,
    SUAQ_weather.temperature_min_evening,
    SUAQ_fai.fai,
    ageOfCurrentOffspring,
    monthYearDate,
    follow_totNumOfGPSpoints
  ) %>%
  summarise(tree_DJL = sum(as.numeric(tree_manual_distTolast), na.rm = TRUE), tree_numoftrees =
              n()-2, tree_turningAngleSum=sum(as.numeric(tree_turningAngle), na.rm = TRUE), tree_meanTimelag=mean(tree_timelag_lead,na.rm=TRUE), tree_medianTimelag=median(tree_timelag_lead,na.rm=TRUE)) %>% ungroup() 

colnames(Tree_follows) <- c("follow","focal","ageFromDOB","ClassFocal","rain_eve","watlevel_mo","walevel_eve","rain_mo","avg_temp_tot","max_temp_average","min_temp_average","temp_max_mo","temp_min_mo","temp_max_eve","temp_min_eve","fai","ageOfCurrentOffspring","monthYearDate","tree_numOfPoints","tree_DJL","tree_numoftrees","tree_turningAngleSum","tree_meanTimelag","tree_medianTimelag")

Tree_follows_count <- SUAQ_rangepoints_11all20_loc[order(SUAQ_rangepoints_11all20_loc$manualDatetime , decreasing = TRUE ),] %>%
  filter(followtype == "NN") %>% 
  filter(PtType=="tree") %>% 
  group_by(follow) %>% 
  summarise(fruittreecount=n())

TDD_tree_follows <- SUAQ_rangepoints_11all20_loc[order(SUAQ_rangepoints_11all20_loc$manualDatetime , decreasing = TRUE ),] %>% 
  filter(followtype == "NN") %>%
  filter(PtType%in%c("mornnest","nightnest","tree")) %>% 
  group_by(follow) %>% 
  summarise(firstE=first(E),firstN=first(N),lastE=last(E),lastN=last(N)) %>% 
  mutate(tree_TDD=sqrt((firstE-lastE)^2+(firstN-lastN)^2)) %>% 
  dplyr::select(-firstE,-firstN,-lastE,-lastN)


Tree_follows <- Tree_follows %>% 
  left_join(TDD_tree_follows,by=c("follow"="follow")) %>%
  mutate(tree_RR=tree_TDD/tree_DJL) %>%
  ungroup() %>% 
  left_join(Tree_follows_count,by=c("follow"="follow")) %>% 
  dplyr::select(c("follow","tree_numOfPoints","tree_DJL","tree_RR","tree_numoftrees","tree_turningAngleSum","tree_meanTimelag","tree_medianTimelag"))

DJL_follows <- DJL_follows %>% 
  left_join(Tree_follows,by=c("follow"="follow")) %>% 
  left_join(Tree_follows_count,by=c("follow"="follow")) %>% 
  mutate(fruittreecount=if_else(is.na(fruittreecount),as.integer(0),fruittreecount))

### Add a season marker
DJL_follows <-   DJL_follows %>%
  mutate(month=as.factor(month(lubridate::ym(monthYearDate)))) %>% 
  mutate(monthname=month.name[month])%>%
  mutate(year=as.character(year(lubridate::ym(monthYearDate))))%>%
  mutate(rainyseason=ifelse(month %in% c(10,11,12),"rainy","normal"))


##### Additional: Create analysis DF with all follows #####
DJL_follows_noNN <- SUAQ_rangepoints_11all20_loc %>%
  group_by(
    follow,
    focal,
    ageFromDOB,
    ClassFocal,
    SUAQ_weather.rainfall_ml_evening,
    SUAQ_weather.river_waterlevel_morning,
    SUAQ_weather.river_waterlevel_evening,
    SUAQ_weather.rainfall_ml_morning,
    SUAQ_weather.avg_temperature_tot,
    SUAQ_weather.max_temp_average,
    SUAQ_weather.min_temp_average,
    SUAQ_weather.temperature_max_morning,
    SUAQ_weather.temperature_min_morning,
    SUAQ_weather.temperature_max_evening,
    SUAQ_weather.temperature_min_evening,
    SUAQ_weather.rainfall_tot_daysbefore,
    SUAQ_weather.temp_max_daysbefore,
    SUAQ_fai.fai,
    ageOfCurrentOffspring,
    monthYearDate,
    follow_totNumOfGPSpoints
  ) %>%
  summarise(DJL = sum(as.numeric(manual_distTolast), na.rm = TRUE), count =
              n(), turningAngleSum=sum(as.numeric(turningAngle), na.rm = TRUE), meanTimelag=mean(timelag_lead,na.rm=TRUE), medianTimelag=median(timelag_lead,na.rm=TRUE),original_followlength=mean(SUAQ_followlog.LengthFollow,na.rm=TRUE),gps_followlength=sum(timelag,na.rm=TRUE)) %>% mutate(speed=(DJL/gps_followlength)*3.6) %>%  ungroup() 

colnames(DJL_follows_noNN) <- c("follow","focal","ageFromDOB","ClassFocal","rain_eve","watlevel_mo","walevel_eve","rain_mo","avg_temp_tot","max_temp_average","min_temp_average","temp_max_mo","temp_min_mo","temp_max_eve","temp_min_eve","tot_rain_before","mmax_temp_before","fai","ageOfCurrentOffspring","monthYearDate","numOfPoints","DJL","count","turningAngleSum","meanTimelag","medianTimelag","original_followlength","gps_followlength","speed")

TDD_follows_noNN <- SUAQ_rangepoints_11all20_loc[order(SUAQ_rangepoints_11all20_loc$manualDatetime , decreasing = TRUE ),] %>% 
  group_by(follow) %>% 
  summarise(firstE=first(E),firstN=first(N),lastE=last(E),lastN=last(N)) %>% 
  mutate(TDD=sqrt((firstE-lastE)^2+(firstN-lastN)^2))

DJL_follows_noNN <- DJL_follows_noNN %>% 
  left_join(TDD_follows_noNN,by=c("follow"="follow")) %>%
  mutate(RR=TDD/DJL) %>% 
  ungroup()

DJL_follows_noNN <- DJL_follows_noNN %>%
  mutate(month=as.factor(month(lubridate::ym(monthYearDate)))) %>% 
  mutate(monthname=month.name[month])%>% 
  mutate(rainyseason=ifelse(month %in% c(10,11,12),"rainy","normal"))

```

## First visuals SUAQ
```{r Weather & basic Visuals and analysis,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
##### Visualization of Weather ######
plot_weather_avgRainfall<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather.rainfall_tot))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="steelblue",na.value = NA) +
  labs(title = "Average rainfall total",x="",y="") + labs(fill='rainfall [ml]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))
plot_weather_avgRainfall

plot_weather_moRainfall<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather.rainfall_ml_morning))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="steelblue",na.value = NA) +
  labs(title = "Average rainfall morning",x="",y="") + labs(fill='rainfall [ml]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_eveRainfall<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather_monthly$SUAQ_weather.rainfall_ml_evening))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="steelblue",na.value = NA) +
  labs(title = "Average rainfall evening",x="",y="") + labs(fill='rainfall [ml]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_moWaterLevel<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather_monthly$SUAQ_weather.river_waterlevel_morning))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="steelblue",na.value = NA) +
  labs(title = "Waterlevel morning",x="",y="") + labs(fill='waterlevel [cm?]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_eveWaterLevel<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather_monthly$SUAQ_weather.river_waterlevel_evening))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="steelblue",na.value = NA) +
  labs(title = "Waterlevel evening",x="",y="") + labs(fill='waterlevel [cm?]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_Avgtemp<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>%
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= avg_temperature_tot))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="deeppink3",na.value = NA) +
  labs(title = "Average temperature",x="",y="") + labs(fill='temperature [C°]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))

plot_weather_AvgMaxtemp<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>%
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather.max_temp_average))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="deeppink3",na.value = NA) +
  labs(title = "Average maximum temperature",x="",y="") + labs(fill='temperature [C°]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_AvgMintemp<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather.min_temp_average))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="deeppink3",na.value = NA) +
  labs(title = "Average minimum temperature",x="",y="") + labs(fill='temperature [C°]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_avgRainfall
plot_weather_moRainfall
plot_weather_eveRainfall
plot_weather_moWaterLevel
plot_weather_eveWaterLevel
plot_weather_AvgMaxtemp
plot_weather_AvgMintemp
plot_weather_Avgtemp

##### Visualization of FAI ######
plot_weather_AvgMintemp<-SUAQ_fai %>% 
  mutate(SUAQ_fai.month = fct_relevel(SUAQ_fai.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_fai, as.factor(SUAQ_fai.year), fill= SUAQ_fai$SUAQ_fai.fai))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="deeppink3",na.value = NA) +
  labs(title = "Average minimum temperature",x="",y="") + labs(fill='temperature [C°]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))

##### Visualization of FAI ######
SUAQ_fai <- SUAQ_fai %>% mutate(SUAQ_fai.fai=if_else((SUAQ_fai.year==2011)&(SUAQ_fai.monthnum==10),0.0,as.double(SUAQ_fai.fai)))
plot_FAI<-SUAQ_fai %>% 
  mutate(SUAQ_fai.month = fct_relevel(SUAQ_fai.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(as.factor(SUAQ_fai.month), as.factor(SUAQ_fai.year), fill= SUAQ_fai$SUAQ_fai.fai))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="chartreuse4",na.value = NA) +
  labs(title = "Fruit availability index",x="",y="") + labs(fill='FAI')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))
plot_FAI


##### Visualization of all different variables
custom.col <- c("#FFDB6D", "#C4961A", "#F4EDCA", 
                "#D16103", "#C3D7A4", "#52854C", "#4E84C4", "#293352")
colourCount <-  length(unique(SUAQ_weather_fai_soi_monthly$SUAQ_weather.year))
getPalette <- colorRampPalette(brewer.pal(10, "Paired"))

SUAQ_weather_fai_soi_monthly %>%  ggplot(aes(yearmonth,SUAQ_fai.fai))+geom_line()+ labs(x="time [month]",y="fruit availability")
SUAQ_weather_fai_soi_monthly %>%  ggplot(aes(yearmonth,SOI))+geom_line()+ labs(x="time [month]",y="SOI")
SUAQ_weather_fai_soi_monthly <- SUAQ_weather_fai_soi_monthly %>% mutate(year_ENSO=as.factor(paste0(SUAQ_weather.year," (",ENSO_cat,")")))
SUAQ_weather_fai_soi_monthly$SUAQ_weather.month <-  factor(SUAQ_weather_fai_soi_monthly$SUAQ_weather.month, levels = month.name)

plot_year_perciptation<- SUAQ_weather_fai_soi_monthly %>%  
  ggplot(aes(x=SUAQ_weather.month,SUAQ_weather.rainfall_tot,color=year_ENSO,group=SUAQ_weather.year))+
  geom_boxplot(aes(x=SUAQ_weather.month,y=SUAQ_weather.rainfall_tot,group=SUAQ_weather.month),color="grey")+
  geom_line(size=0.7)+ 
  labs(y="total rainfall [mm]")+
  theme(axis.text.x = element_text(angle = 60,vjust = 0.5),legend.title = element_blank(),axis.title.x = element_blank())+
  scale_color_manual(values=getPalette(colourCount))

plot_year_perc_temp_enso <- SUAQ_weather_fai_soi_monthly %>% ggplot(mapping = aes(x = SUAQ_weather.month, y = SUAQ_weather.rainfall_tot,color=year_ENSO, group = SUAQ_weather.year)) +
  geom_line(mapping = aes(y = (SUAQ_weather.max_temp_average)^2 ) , color="#d7191c", fill="#d7191c", size = 0.2,linetype="twodash",alpha=0.3) +
  geom_line(mapping = aes(y = (SUAQ_weather.avg_temperature_tot)^2 ) , color="black", fill="black", size = 0.2,linetype="twodash",alpha=0.3) + 
  geom_line(mapping = aes(y = (SUAQ_weather.min_temp_average)^2 ) , color="#2c7bb6", fill="#2c7bb6", size = 0.2,linetype="twodash",alpha=0.3) + 
  geom_boxplot(aes(x=as.factor(SUAQ_weather.month),y=SUAQ_weather.rainfall_tot,group=SUAQ_weather.month),color="grey",witdh = 0.1)+
  geom_point(data= DJL_follows,mapping =aes(x=monthname,y=fruittreecount,group=monthname),color="grey",witdh = 0.1)+
  geom_line(stat = "identity",width = 0.5,size=0.7)+
  labs(y="total rainfall [mm]")+ 
  scale_y_continuous("total rainfall [mm]", sec.axis = sec_axis(~sqrt(.), name = "temperature [°C]",breaks = seq(23,29,1)))+
  theme(axis.text.x = element_text(angle = 60,vjust = 1,hjust = 1),legend.title = element_blank(),axis.title.x = element_blank())+
  scale_color_manual(values=getPalette(colourCount))+
  theme(axis.title.y.right = element_text(vjust=2))
plot_year_perc_temp_enso
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_year_perc_temp_enso",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_year_perc_temp_enso, width = 19,height = 10,units="cm")

#### Simple climate diagram for Suaq
plot_year_climate_diagram <- SUAQ_weather_fai_soi_monthly %>% group_by(SUAQ_weather.month) %>% summarise(percip=mean(SUAQ_weather.rainfall_tot,na.rm=TRUE),temp=mean(SUAQ_weather.avg_temperature_tot,na.rm=TRUE)) %>% 
  ggplot(mapping = aes(x = SUAQ_weather.month, y =percip,color="black",fill="black",group=1)) + 
  geom_bar(stat = "identity",width = 0.5,size=0.7,fill="blue",color="blue")+
  geom_line(mapping = aes(y = (temp)*10),color="red", size=0.5) + 
  labs(y="total rainfall [mm]", title=expression(bold("Suaq Balimbing 2010-2020")),subtitle ="3° 42' N, 97° 26' E, ~75 m a.s.l. \n 26.79°C, 290.8 mm " ,caption = expression(italic("Reference: only morning and evening measurements")))+
  scale_y_continuous("total rainfall [mm]", sec.axis = sec_axis(~./10, name = "temperature [°C]",breaks = seq(0,40,3)),breaks = seq(0,600,50))+
  theme(axis.text.x = element_text(angle = 60,vjust = 1,hjust = 1),legend.title = element_blank(),axis.title.x = element_blank())+
  theme(axis.title.y.right = element_text(vjust=2,))

plot_year_climate_diagram

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_year_climate_diagram_classic",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_year_climate_diagram, width = 10,height = 12,units="cm")


#### Visuals temperature change over years and temperature max, min average
SUAQ_weather_fai_soi_monthly$ENSO_cat <-  factor(SUAQ_weather_fai_soi_monthly$ENSO_cat, levels = c("strong la niña","moderate la niña","weak la niña","neutral","weak el niño","very strong niño"))

SUAQ_weather_fai_overyears<- SUAQ_weather_fai_soi_monthly %>%  ggplot(aes(yearmonth,group = SUAQ_weather.year))+
  geom_boxplot(aes(y=SUAQ_fai.fai,color="FAI",fill=ENSO_cat,group=SUAQ_weather.year),width=.15,alpha=0.6)+
  geom_line(aes(y=SUAQ_fai.fai,color="FAI",group=SUAQ_weather.year))+
  geom_line(aes(y=SUAQ_weather.temperature_max_morning,color="Max. morning"))+
  geom_line(aes(y=SUAQ_weather.temperature_min_morning,color="Min. morning"))+
  geom_line(aes(y=SUAQ_weather.avg_temperature_tot,color="Avg. of means"))+
  geom_line(aes(y=SUAQ_weather.temperature_min_evening,color="Min. evening"))+
  geom_line(aes(y=SUAQ_weather.temperature_max_evening,color="Max. evening"))+
  scale_x_datetime(date_breaks = "1 years")+
  guides(colour = guide_legend(order = 1))+
  scale_fill_manual("",
                      breaks = c("strong la niña","moderate la niña","weak la niña","neutral","weak el niño","very strong niño"),
                      values = c("#2166ac","#67a9cf","#d1e5f0","#fddbc7","#ef8a62","#b2182b"))+
  labs(x="time [year]",y="fruit availability     /      temparature [°C]")+
  scale_colour_manual("",
                      breaks = c("Max. evening","Max. morning","Avg. of means","Min. evening","Min. morning","FAI"),
                      values = c("#d7191c","#fdae61","black","#abd9e9","#2c7bb6", "darkgreen"))+
  theme(axis.text.x = element_text(angle = 60,vjust = 1,hjust = 1),legend.title = element_blank(),axis.title.x = element_blank())

SUAQ_weather_fai_overyears
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "SUAQ_weather_fai_overyears",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = SUAQ_weather_fai_overyears, width = 16,height = 10,units="cm")



#### Statistics see if rainfall is significantly different between months
ggplot(SUAQ_weather_fai_soi_monthly,aes(sqrt(SUAQ_weather.rainfall_tot)))+geom_histogram()
shapiro.test(sqrt(SUAQ_weather_fai_soi_monthly$SUAQ_weather.rainfall_tot))
lm_month_percp<- lm(sqrt(SUAQ_weather.rainfall_tot)~SUAQ_weather.month,SUAQ_weather_fai_soi_monthly) # differences between months
autoplot(lm_month_percp) # normal distribution not completly fullfilled but other assumptions are
summary(lm_month_percp) 
summary(SUAQ_weather_fai_soi_monthly$SUAQ_weather.max_temp_average)

#### Statistics see if temp is significantly different between months
ggplot(SUAQ_weather_fai_soi_monthly,aes(SUAQ_weather.max_temp_average))+geom_histogram()
shapiro.test(SUAQ_weather_fai_soi_monthly$SUAQ_weather.max_temp_average)
lm_month_temp<- lm(sqrt(SUAQ_weather.max_temp_average)~as.factor(SUAQ_weather.year),SUAQ_weather_fai_soi_monthly) # differences between months
autoplot(lm_month_temp)
summary(lm_month_temp)
summary(SUAQ_weather_fai_soi_monthly$SUAQ_weather.max_temp_average)

#### Statistics see how fai is explainable
ggplot(SUAQ_weather_fai_soi_monthly,aes(as.factor(SUAQ_weather.year),SUAQ_weather.avg_temperature_tot))+geom_boxplot()
shapiro.test(SUAQ_weather_fai_soi_monthly$SUAQ_fai.fai)
lm_month_weather_fai<- lm(SUAQ_fai.fai~SUAQ_weather.month,SUAQ_weather_fai_soi_monthly) # differences between months
autoplot(lm_month_weather_fai) 
summary(lm_month_weather_fai)
summary(SUAQ_weather_fai_soi_monthly$SUAQ_fai.fai)

#### FAI explained --> looking at a big model which variables are maybe interesting?
temp<- SUAQ_weather_fai_soi_monthly %>% dplyr::select("yearmonth","SUAQ_weather.rainfall_ml_morning","SUAQ_weather.rainfall_ml_evening","SUAQ_weather.temperature_max_evening","SUAQ_weather.avg_temperature_tot","SUAQ_weather.rainfall_tot_before_d1","SUAQ_weather.max_temp_average_before_d1","SUAQ_weather.rainfall_tot_before_d2","SUAQ_weather.max_temp_average_before_d2","SUAQ_weather.rainfall_tot_daysbefore","SUAQ_weather.temp_max_daysbefore","SUAQ_weather.rainfall_tot","SUAQ_weather.waterlevel_change","SOI","SUAQ_fai.fai","SST","SUAQ_weather.year","SUAQ_weather.month","ENSO_cat","SUAQ_weather.max_temp_average")

lm_month_weather_fai_big<- lmer(SUAQ_fai.fai~SUAQ_weather.rainfall_ml_morning+SUAQ_weather.rainfall_ml_evening+SUAQ_weather.avg_temperature_tot+SUAQ_weather.waterlevel_change+SST+SOI+(1|SUAQ_weather.month)+(1|SUAQ_weather.year),temp) # differences between months
lm_month_weather_fai_ENSO<- lm(SUAQ_fai.fai~SOI,temp) # differences between months
summary(lm_month_weather_fai_ENSO)
shapiro.test(log(temp$SST))
cor(temp$SUAQ_fai.fai, temp$SST)

lmer_month_weather_fai_ENSO<- lmer(SUAQ_fai.fai~SST+(1|yearmonth),temp) # differences between months
lm_month_weather_fai_ENSO_empty<- lmer(SUAQ_fai.fai~(1|SUAQ_weather.year),temp) # differences between months
vif.mer(lm_month_weather_fai_ENSO)

summary(lmer_month_weather_fai_ENSO)
summary(lm_month_weather_fai_ENSO)
anova(lm_month_weather_fai_ENSO_empty,lm_month_weather_fai_ENSO)

#### FAI explained by ENSO?
SUAQ_weather_fai_soi_monthly %>% ggplot(aes(yearmonth,SOI)) +geom_point()+geom_smooth(method="lm")

#### FAI and year as explanatory variable / FAI and a model of selected variables
SUAQ_weather_fai_soi_monthly_noNA <- SUAQ_weather_fai_soi_monthly %>% dplyr::select(SUAQ_fai.fai,SUAQ_weather.max_temp_average,SUAQ_weather.rainfall_tot,SST,SUAQ_weather.rainfall_tot_daysbefore,SUAQ_weather.temp_max_daysbefore,SUAQ_weather.rainfall_tot_before_d1,SUAQ_weather.max_temp_average_before_d1,SUAQ_weather.month,SUAQ_weather.year) %>% drop_na()
SUAQ_weather_fai_soi_monthly_noNA$id <- rownames(SUAQ_weather_fai_soi_monthly_noNA)


lm_month_weather_fai<- lmer(SUAQ_fai.fai~SUAQ_weather.rainfall_tot_daysbefore+SUAQ_weather.temp_max_daysbefore+(1|SUAQ_weather.month)+(1|SUAQ_weather.year),SUAQ_weather_fai_soi_monthly_noNA) # differences between months
lm_month_weather_empty<- lmer(SUAQ_fai.fai~(1|SUAQ_weather.month)+(1|SUAQ_weather.year),SUAQ_weather_fai_soi_monthly_noNA)
anova(lm_month_weather_fai,lm_month_weather_empty)
summary(lm_month_weather_fai)



# mean temperature and perciptation SOI etc.
temp_yearly_temp_percp<- SUAQ_weather_fai_soi_monthly %>% group_by(SUAQ_weather.year) %>%
  summarise(meanannualtemp=mean(SUAQ_weather.avg_temperature_tot,na.rm = TRUE),
            meanperciptperday=mean(as.numeric(SUAQ_weather.rainfall_tot),na.rm = TRUE)) %>% 
  mutate(tot_calc_percipitation=meanperciptperday*365)

##### Visualization of annual perciptation and temperature
view(format(stat.desc(temp_yearly_temp_percp$tot_calc_percipitation), scientific = FALSE))

### Analysis of study duration using the calculated duration of follow
SUAQ_rangepoints_11all20_loc <- SUAQ_rangepoints_11all20_loc
test2 <- SUAQ_rangepoints_11all20_loc %>% ungroup() %>%
  arrange(manualDatetime) %>%
  filter(row_number() == 1 | row_number() == n()) %>% ungroup()
(test2$manualDate[2] - test2$manualDate[1])

test <- SUAQ_rangepoints_11all20_loc %>%
  group_by(follow) %>%
  arrange(manualDatetime) %>%
  filter(row_number() == 1 | row_number() == n()) %>% ungroup()
test <-
  test %>% group_by(follow) %>% mutate(firstOrlast = row_number()) %>% dplyr::select(follow, manualDatetime, firstOrlast, followtype, ClassFocal,SUAQ_weather.rainfall_tot,focal)
temp_start <- test %>% filter(firstOrlast == 1)
temp_end <- test %>% filter(firstOrlast == 2)
startend <-
  temp_start %>% dplyr::select(-ClassFocal) %>%  left_join(temp_end, by = c("follow" = "follow"))
startend <-
  startend %>% mutate(observation_duration = difftime(manualDatetime.y, manualDatetime.x)) %>% filter(!(is.na(observation_duration)|is.na(ClassFocal)|is.na(followtype.x)|is.na(SUAQ_weather.rainfall_tot.x)))

ggplot(startend, aes(observation_duration, followtype.x)) + geom_boxplot()+facet_grid()

plot_startend<- startend %>% 
  group_by(follow,followtype.x,observation_duration,ClassFocal) %>% mutate(observation_duration=as.numeric(observation_duration)) %>% 
  ggplot(aes(x =followtype.x,y=observation_duration)) + geom_boxplot() +
  geom_violin(alpha = 0.3,
              fill = "red",
              color = NA) + labs(x = "Class of focal", y = "duration of follow [seconds]") +
  stat_summary(fun.data = give.n, geom = "text", hjust = 0.5,vjust=0,position = position_dodge(2),aes(y = 45000)) +
  facet_grid(followtype.x~ ClassFocal)+
  theme(axis.title.x = element_blank())+
  ylim(0,50000)
plot_startend
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_SUAQ_observationduration_perfollowtype_focalClass",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_startend,width = 24,height = 15,units="cm")





#### Statistics
startend_NN <- startend %>% filter(followtype.x=="NN")
anova_rainfall_obsdur<- aov(as.numeric(observation_duration) ~ ClassFocal,data=startend_NN)
summary(anova_rainfall_obsdur)
anova_rainfall_obsdur


### Using the follow length argument from followlog (choose this method over the self calculated one but results are similar)
SUAQ_rangepoints_11all20_loc_filtered <-
  SUAQ_rangepoints_11all20_loc %>% 
  filter(followtype != "character(0)") %>% 
  group_by(SUAQ_followlog.LengthFollow, follow,focal, followtype,ClassFocal,SUAQ_weather.rainfall_tot) %>%  summarise() %>% filter(followtype=="NN")


SUAQ_rangepoints_11all20_loc_filtered_NN<- SUAQ_rangepoints_11all20_loc_filtered %>% filter(followtype != "character(0)") %>% filter(followtype=="NN")
SUAQ_rangepoints_11all20_loc_filtered_NN %>% 
  group_by(follow,followtype,SUAQ_followlog.LengthFollow,ClassFocal) %>% 
  ggplot(aes(x =followtype,y=SUAQ_followlog.LengthFollow)) + geom_boxplot() +
  geom_violin(alpha = 0.3,
              fill = "red",
              color = NA) + labs(x = "Class of focal", y = "duration of follow [time]") +
  stat_summary(fun.data = give.n, geom = "text", hjust = 0.5,vjust=-3) +
  facet_grid(~ ClassFocal)+
  theme(axis.title.x = element_blank())

SUAQ_rangepoints_11all20_loc_filtered %>% 
  dplyr::select(follow, followtype, SUAQ_followlog.LengthFollow) %>% 
  mutate(SUAQ_followlog.LengthFollow = as.integer(SUAQ_followlog.LengthFollow)) %>%  
  split(.$followtype) %>% 
  map(summary)



#### Statistics test of follow length is significantly different between focal classes
anova_followLengthfromOrig_NN<- aov(as.numeric(SUAQ_followlog.LengthFollow) ~ ClassFocal,data=SUAQ_rangepoints_11all20_loc_filtered)
summary(anova_followLengthfromOrig_NN)

lmer_followLengthfromOrig_NN <-
  lmer(as.numeric(SUAQ_followlog.LengthFollow) ~ SUAQ_weather.rainfall_tot+(1|focal), data = SUAQ_rangepoints_11all20_loc_filtered)
summary(lmer_followLengthfromOrig_NN)
anova(lmer_followLengthfromOrig_NN)



#### Look how much the sampling rate differes f.e. between orangutans
SUAQ_rangepoints_11all20_loc
plot_SUAQ_samplingintervalbias_equaldistribution<- SUAQ_rangepoints_11all20_loc %>% ggplot(aes(x=manualTime,y=timelag,group=ClassFocal,colour=ClassFocal)) + 
  geom_point(size=0.4)+ 
  geom_line(size=0.07)+
  theme(axis.text.x = element_text(angle = 60,vjust = 0.5)) +
  labs(x="daytime", y="timelag to last point [s]")+
  ylim(c(0,10000))+
  theme(legend.title = element_blank())
plot_SUAQ_samplingintervalbias_equaldistribution

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_SUAQ_samplingintervalbias_equaldistribution",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_SUAQ_samplingintervalbias_equaldistribution,width = 24,height = 15,units="cm")

```

```{r RR level 3 distance/movement per day-hour,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
SUAQ_rangepoints_11all20_loc_tree<- SUAQ_rangepoints_11all20_loc[order(SUAQ_rangepoints_11all20_loc$manualDatetime , decreasing = TRUE ),] %>% 
  filter(PtType=="tree")
SUAQ_rangepoints_11all20_loc_tree %>% ggplot(aes(manualTime))+geom_histogram()

SUAQ_rangepoints_11all20_loc %>% filter(SUAQ_weather.rainfall_ml_morning>0) %>% ggplot(aes(manualTime))+geom_histogram()
SUAQ_rangepoints_11all20_loc %>% filter(SUAQ_weather.rainfall_ml_morning==0) %>% ggplot(aes(manualTime))+geom_histogram()

SUAQ_rangepoints_11all20_loc %>% filter(SUAQ_weather.rainfall_ml_evening>0) %>% ggplot(aes(manualTime))+geom_histogram()
SUAQ_rangepoints_11all20_loc %>% filter(SUAQ_weather.rainfall_ml_evening==0) %>% ggplot(aes(manualTime))+geom_histogram()

SUAQ_rangepoints_11all20_loc_tree %>% ggplot(aes(trackpoint_id))+geom_histogram()


#### Movememnt and weather on level 3. Resampling by hourly time
SUAQ_rangepoints_11all20_loc_NN <- SUAQ_rangepoints_11all20_loc
follows <- SUAQ_rangepoints_11all20_loc_NN %>% group_by(follow) %>% summarise()
SUAQ_hourly_dist <- data.frame()
timeinterval <- 1800
data_split<- SUAQ_rangepoints_11all20_loc_NN %>% mutate(manualDatetime=force_tz(manualDatetime,tzone = Sys.timezone())) %>% 
    filter(follow!="1100967") # follow has only one point at same location --> cant be interpolated

#### Find points every full hour. (Attention timezone is UTC used!! add 5 hours but only works if time is not before. traj uses the locale of the used machine so change if not in CET zone)

#### Per hour
for(j in temp_ClassFocal){
  data_split<- SUAQ_rangepoints_11all20_loc_NN %>% mutate(manualDatetime=force_tz(manualDatetime,tzone = Sys.timezone())) %>% 
    filter(follow!="1100967") # follow has only one point at same location --> cant be interpolated
  data_split <- data_split %>% filter(ClassFocal==j)
  
  for(i in as_vector(follows)){
    data<- data_split %>% filter(follow%in%c(i)) 
    print(i)
    if(nrow(data)>1){
      data_follow_simple <- data %>% dplyr::select(x=E,y=N,manualDatetime) %>% 
      mutate(time=TrajConvertTime(strftime(manualDatetime, format="%H:%M:%S"), sep = ":", factors = c(60 * 60, 60, 1))) %>% 
      ungroup() %>%  
      dplyr::select(-manualDatetime)
      trj <- TrajFromCoords(data_follow_simple, xCol = "x",yCol = "y")
      resampled <- TrajResampleTime(trj, 1)
      for(hours in c(timeinterval*c(1:96))){
        if((hours %in% resampled$time)&((hours+timeinterval) %in% resampled$time)){
          indexfirst<- match(c(hours),resampled$time)
          indexsecond<- match(c(hours+timeinterval),resampled$time)
          distance<- TrajDistance(resampled, startIndex = indexfirst, endIndex = indexsecond)
          SUAQ_hourly_dist <- SUAQ_hourly_dist %>% bind_rows(c(Start_E=resampled$x[indexfirst],Start_N=resampled$y[indexfirst],End_E=resampled$x[indexsecond],End_N=resampled$y[indexsecond],from=hms::as_hms(hours), to=hms::as_hms(hours+timeinterval), distance=distance, follow=i,class=j,focal=data$focal))
        }
        
      }
    }
  }
}

ref_date <- ymd("2017-01-01", tz = "UTC")
SUAQ_hourly_dist<- SUAQ_hourly_dist %>% 
  mutate(class = factor(class, levels = c("adult female", "flanged male","unflanged male", "juvenile","infant")))
SUAQ_hourly_dist_mean <- SUAQ_hourly_dist %>%  
  # filter(from>=18000) %>%
  # filter(from>=69300) %>%
  group_by(from,class) %>% 
  summarise(meandist=mean(as.numeric(distance),na.rm=TRUE,trim=0.05),mediandist=median(as.numeric(distance),na.rm=TRUE), sample_n=n()) %>% 
  mutate(from=format(ref_date + as.numeric(from), "%H:%M")) %>% 
  filter(class!="character(0)")

plot_SUAQ_hourlydistmean_histo<- SUAQ_hourly_dist_mean %>% ggplot(aes(x=as.numeric(meandist))) + geom_histogram(aes(size=sample_n))+ 
  theme(axis.text.x = element_text(angle = 60,vjust = 0.5)) +
  labs(x="average distance [m]")+
  facet_wrap(~class, ncol = 1)
plot_SUAQ_hourlydistmean_histo

plot_SUAQ_hourlydistmean_class<- SUAQ_hourly_dist_mean %>% ggplot(aes(x=from,y=as.numeric(meandist),group=class,colour=class)) + 
  geom_point(aes(size=sample_n,alpha=0.5))+ 
  geom_line()+
  theme(axis.text.x = element_text(angle = 60,vjust = 0.5)) +
  labs(x="daytime", y="average of 95% of distances observed [m]")
plot_SUAQ_hourlydistmean_class

plot_SUAQ_hourlydistmean_class_boxplot<- SUAQ_hourly_dist_mean %>% ggplot(aes(y=as.numeric(meandist),colour=class)) + 
  geom_boxplot()+ 
  labs(x="", y="average of 95% of distances observed [m]")

plot_SUAQ_hourlydistmedian_class<- SUAQ_hourly_dist_mean %>% ggplot(aes(x=from,y=as.numeric(mediandist),group=class,colour=class)) + 
  geom_point(aes(size=sample_n,alpha=0.5))+
  geom_line()+
  theme(axis.text.x = element_text(angle = 60,vjust = 0.5)) +
  labs(x="daytime", y="average distance [m]")





ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_SUAQ_hourlydistmean95percent_class_quarterly_NNonly_line",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_SUAQ_hourlydistmean_class,width = 24,height = 15,units="cm")

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_SUAQ_hourlydistmedian95percent_class_quarterly_NNonly_line",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_SUAQ_hourlydistmedian_class,width = 24,height = 15,units="cm")




## Analyse weather and start of movements
#### Testing analysing quartely movement and influencing variables
temp_hourly_weather<- SUAQ_rangepoints_11all20_loc_NN %>% group_by(follow,
                                          manualDate,
                                          SUAQ_fai.fai,
                                          SUAQ_weather.avg_temperature_tot,
                                          SUAQ_weather.rainfall_ml_morning,
                                          SUAQ_weather.rainfall_ml_evening,
                                          SUAQ_weather.rainfall_tot,
                                          SUAQ_weather.river_waterlevel_morning,
                                          SUAQ_weather.river_waterlevel_evening,
                                          SUAQ_weather.temperature_min_morning,
                                          SUAQ_weather.temperature_min_evening,
                                          SUAQ_weather.temperature_max_evening,
                                          SUAQ_weather.temperature_max_morning,
                                          SUAQ_weather.max_temp_average,
                                          SUAQ_weather.min_temp_average,
                                          ClassFocal
                                          ) %>% summarise() %>% mutate(follow=as.character(follow))
SUAQ_hourly_dist <- SUAQ_hourly_dist %>% left_join(temp_hourly_weather,by=c("follow"="follow")) %>% mutate(distance=as.numeric(distance))
SUAQ_hourly_dist <- SUAQ_hourly_dist %>% group_by(follow) %>% mutate(trackpoint_id = row_number())

SUAQ_hourly_dist$number <- as.numeric(factor(SUAQ_hourly_dist$from))
SUAQ_hourly_dist$timenum <- match(SUAQ_hourly_dist$from, unique(SUAQ_hourly_dist$from))


#### STATISTICS
glm_full <-lmer(distance ~ from+SUAQ_weather.rainfall_ml_morning+ SUAQ_weather.temperature_min_morning+ClassFocal+SUAQ_fai.fai +(1 | follow)   + (1 | manualDate), # random effects to correct for
  data = SUAQ_hourly_dist
  )
summary(glm_full)

##### Are the class means different from each other
# Compute the analysis of variance
res.aov <- aov(meandist ~ class, data = SUAQ_hourly_dist_mean)
# Summary of the analysis
summary(res.aov)

glm_full <-lm(distance ~ class, # random effects to correct for
  data = SUAQ_hourly_dist
  )
summary(glm_full)
anova(glm_full)



#### VISUALIZING
##### Hourly cumulative distances travelled in average
test<- SUAQ_hourly_dist %>% group_by(follow) %>% top_n(1, desc(from))
testplot<- test %>% filter(!is.na(SUAQ_weather.rainfall_ml_evening)&(SUAQ_weather.rainfall_ml_evening!=0)) %>%  ggplot(aes(x=from,y=as.numeric(distance),colour=log(SUAQ_weather.rainfall_ml_evening))) + geom_jitter(size=2)+ 
  theme(axis.text.x = element_text(angle = 60,vjust = 0.5)) +
  labs(x="daytime", y="average distance [m]")
testplot


SUAQ_hourly_dist_meantrackpart <- SUAQ_hourly_dist %>%  group_by(trackpoint_id,class) %>% summarise(meandist=mean(as.numeric(distance),na.rm=TRUE), sample_n=n())
test<- SUAQ_hourly_dist_meantrackpart %>% ggplot(aes(x=trackpoint_id,y=as.numeric(meandist),colour=class)) + geom_point()+ 
  theme(axis.text.x = element_text(angle = 60,vjust = 0.5)) +
  labs(x="trackpoint_id", y="distance [m]")
test

plot_SUAQ_hourlydistmean_class
plot_SUAQ_hourlydistmean_class_boxplot





#### Calculating the same harmonized data but not already grouped per age sex class
SUAQ_rangepoints_11all20_loc_NN <- SUAQ_rangepoints_11all20_loc
follows <- SUAQ_rangepoints_11all20_loc_NN %>% group_by(follow) %>% summarise()
SUAQ_full_inter_dist <- data.frame()
timeinterval <- 1800
data_split<- SUAQ_rangepoints_11all20_loc_NN %>% mutate(manualDatetime=force_tz(manualDatetime,tzone = Sys.timezone())) %>% 
    filter(follow!="1100967") # follow has only one point at same location --> cant be interpolated


for(i in as_vector(follows)){
    data<- SUAQ_rangepoints_11all20_loc_NN %>% mutate(manualDatetime=force_tz(manualDatetime,tzone = Sys.timezone())) %>% filter(follow%in%c(i)) 
    print(i)
    if(nrow(data)>1){
      data_follow_simple <- data %>% dplyr::select(x=E,y=N,manualDatetime) %>% 
      mutate(time=TrajConvertTime(strftime(manualDatetime, format="%H:%M:%S"), sep = ":", factors = c(60 * 60, 60, 1))) %>% 
      ungroup() %>%  
      dplyr::select(-manualDatetime)
      trj <- TrajFromCoords(data_follow_simple, xCol = "x",yCol = "y")
      resampled <- TrajResampleTime(trj, 1)
      for(hours in c(timeinterval*c(1:96))){
        if((hours %in% resampled$time)&((hours+timeinterval) %in% resampled$time)){
          indexfirst<- match(c(hours),resampled$time)
          indexsecond<- match(c(hours+timeinterval),resampled$time)
          distance<- TrajDistance(resampled, startIndex = indexfirst, endIndex = indexsecond)
          SUAQ_full_inter_dist <- SUAQ_full_inter_dist %>% bind_rows(c(Start_E=resampled$x[indexfirst],Start_N=resampled$y[indexfirst],End_E=resampled$x[indexsecond],End_N=resampled$y[indexsecond],from=hms::as_hms(hours), to=hms::as_hms(hours+timeinterval), distance=distance, follow=i,class=data$ClassFocal[1],focal=data$focal[1]))
        }
        
      }
    }
  }
SUAQ_full_inter_dist<- SUAQ_full_inter_dist %>% 
  mutate(class = factor(class, levels = c("adult female", "flanged male","unflanged male", "juvenile","infant")))

#### plot mean dist for every follow
DJL_follows_temp <- DJL_follows_noNN
DJL_follows_temp$longfollow <- cut(as.numeric(DJL_follows_temp$DJL),
                   breaks=c(0,400,1100,1700,10000), 
                   labels=c("low","average","high","very high")) 
DJL_follows_temp<- DJL_follows_temp%>% dplyr::select(follow,longfollow) %>% mutate(follow=as.character(follow))
plot_SUAQ_hourlydistmean_followlengthclasses<- SUAQ_full_inter_dist %>%
  left_join(DJL_follows_temp,by=c("follow"="follow")) %>% 
  filter(!is.na(class)) %>% 
  #mutate(longfollow=ifelse(follow %in% higherthan1000,"short [1000m]","long [>1000m]")) %>%
  group_by(from,longfollow,class) %>% 
  summarise(meandist=mean(as.numeric(distance),na.rm=TRUE,trim=0.05),mediandist=median(as.numeric(distance),na.rm=TRUE),sample_n=n()) %>% 
  mutate(from=format(ref_date + as.numeric(from), "%H:%M")) %>% 
  ggplot(aes(x=from,y=as.numeric(meandist),group=longfollow,colour=as.factor(longfollow))) + 
  geom_point(aes(size=sample_n),alpha=0.5)+ 
  geom_line()+ 
  theme(axis.text.x = element_text(angle = 60,vjust = 0.5)) +
  labs(x="daytime", y="average of 95% of distances observed [m]",alpha=FALSE,colour="Follow length",size="number of follows")
plot_SUAQ_hourlydistmean_followlengthclasses

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_SUAQ_hourlydistmean_followlengthclasses",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_SUAQ_hourlydistmean_followlengthclasses,width = 24,height = 15,units="cm")



#### plot mean dist for grouped every orangutan
SUAQ_full_inter_grouped <- SUAQ_full_inter_dist %>%  
  filter(from>=18000) %>%
  filter(from<=69300) %>%
  group_by(from,class) %>% 
  summarise(meandist=mean(as.numeric(distance),na.rm=TRUE,trim=0.05),mediandist=median(as.numeric(distance),na.rm=TRUE), sample_n=n()) %>% 
  mutate(from=format(ref_date + as.numeric(from), "%H:%M")) 

higherthan1000<- DJL_follows_noNN[DJL_follows_noNN$DJL>1000,]$follow
plot_SUAQ_hourlydistmean_class<- SUAQ_full_inter_grouped %>% filter(!is.na(class)) %>% 
  ggplot(aes(x=from,y=as.numeric(meandist),group=class,colour=class)) + 
  geom_point(aes(size=sample_n),alpha=0.5)+ 
  geom_line()+
  theme(axis.text.x = element_text(angle = 60,vjust = 0.5)) +
  labs(x="daytime", y="average of 95% of distances observed [m]",alpha=FALSE,fill="age sex class",size="number of follows")
plot_SUAQ_hourlydistmean_class


ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_SUAQ_hourlydistmean_class",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_SUAQ_hourlydistmean_class,width = 24,height = 15,units="cm")



```

```{r RR level 3 tree directness + visuals + stats,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
##### Adding total number of fruit trees
SUAQ_treedirectness<- SUAQ_rangepoints_11all20_loc %>%
  filter(PtType%in%c("tree")) %>% 
  group_by(follow)%>% 
  arrange(manualDatetime,.by_group = TRUE) %>% 
  mutate(
         tree_DD_last=sqrt((E-lag(E))^2+(N-lag(N))^2),
         tree_DD_next=sqrt((E-lead(E))^2+(N-lead(N))^2),
         tree_timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         tree_timelag_lag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")))
temp_morethanonetree <- SUAQ_treedirectness %>% group_by(follow) %>% summarise(tot=n()) %>% filter(tot>1)
summary(temp_morethanonetree)
SUAQ_treedirectness <- SUAQ_treedirectness %>% filter(follow%in%temp_morethanonetree$follow) # filter only follows with multiple trees to calculated inbetween tree directness

### Calculate all the distances travelled between trees.
##### Progressbar
pb <-  txtProgressBar(min = 0, max = NROW(temp_morethanonetree), initial = 0) 
stepi <-0
follows<- pull(temp_morethanonetree,follow)
SUAQ_treedirectness$tree_betweentime <- NA_real_
SUAQ_treedirectness$tree_betweentravelled <- NA_real_
SUAQ_treedirectness$tree_betweennumgps <- NA_integer_
SUAQ_treedirectness_calc <- data.frame()
i <- 617
tree <- 1
test<- SUAQ_rangepoints_11all20_loc %>% filter(follow==617)
for (i in follows){
  followdf <- SUAQ_treedirectness[SUAQ_treedirectness$follow==i,]
  for (tree in c(1:(nrow(followdf)-1))){
    temp_gpsdf<-SUAQ_rangepoints_11all20_loc[((SUAQ_rangepoints_11all20_loc$follow == i)&(SUAQ_rangepoints_11all20_loc$trackpoint_id %in% c(followdf$trackpoint_id[tree]:followdf$trackpoint_id[tree+1]))), c("manual_distToNext","timelag_lead")]
    
    temp_gpsdf_trj<-SUAQ_rangepoints_11all20_loc[((SUAQ_rangepoints_11all20_loc$follow == i)&(SUAQ_rangepoints_11all20_loc$trackpoint_id %in% c(followdf$trackpoint_id[tree]:followdf$trackpoint_id[tree+1]))), c("N","E","manualDatetime","manual_distToNext","timelag_lead")]
    
    temp_gpsdf_trj <- temp_gpsdf_trj %>% dplyr::select(x=E,y=N,manualDatetime) %>% 
    mutate(time=TrajConvertTime(strftime(manualDatetime, format="%H:%M:%S"), sep = ":", factors = c(60 * 60, 60, 1))) %>% 
    ungroup() %>%  
    dplyr::select(-manualDatetime)
    trj <- TrajFromCoords(temp_gpsdf_trj, xCol = "x",yCol = "y")
    trj_sinuosity <- TrajSinuosity2(trj)
    
    
    temp_gpsdf <- temp_gpsdf[1:(nrow(temp_gpsdf)-1),] # delete distance to next from the last element/tree
    tree_row <- followdf[tree,]
    tree_row$tree_betweentime[1] <- sum(temp_gpsdf$timelag_lead)
    tree_row$tree_betweentravelled[1] <- sum(temp_gpsdf$manual_distToNext)
    tree_row$tree_betweennumgps[1] <- nrow(temp_gpsdf)-1 # anzahl GPS between plus start & endtree, therefire subtract start end tree because end tree already deleted only minus 1
    tree_row$tree_sinuosity <- trj_sinuosity
    tree_row <- tree_row %>% ungroup()
    
    
    
    SUAQ_treedirectness_calc <-  rbind(SUAQ_treedirectness_calc,tree_row)
  }
  setTxtProgressBar(pb,stepi) # change progress bar
  stepi <-  stepi + 1
}

SUAQ_treedirectness <- SUAQ_treedirectness_calc %>% mutate(tree_betweendirectness=tree_DD_next/tree_betweentravelled)


### renaming and selecting for stats analysis
SUAQ_treedirectness_stats <- SUAQ_treedirectness %>%
  dplyr::select(follow,focal,SUAQ_orangutans.matriline,ageFromDOB,ClassFocal,SUAQ_weather.rainfall_ml_evening,SUAQ_weather.river_waterlevel_morning,SUAQ_weather.river_waterlevel_evening,SUAQ_weather.rainfall_ml_morning,SUAQ_weather.avg_temperature_tot,SUAQ_weather.max_temp_average,SUAQ_weather.min_temp_average,SUAQ_weather.temperature_max_morning,SUAQ_weather.temperature_min_morning,SUAQ_weather.temperature_max_evening,SUAQ_weather.temperature_min_evening,SUAQ_fai.fai,ageOfCurrentOffspring,monthYearDate,follow_totNumOfGPSpoints,tree_betweentravelled,tree_betweendirectness,tree_sinuosity,tree_betweennumgps,manualDate,tree_betweentime)
colnames(SUAQ_treedirectness_stats) <-
  c("follow","focal","matriline","ageFromDOB","ClassFocal","rain_eve","watlevel_mo","walevel_eve","rain_mo","avg_temp_tot","max_temp_average","min_temp_average","temp_max_mo","temp_min_mo","temp_max_eve","temp_min_eve","fai","ageOfCurrentOffspring","monthYearDate","tree_numOfPoints","tree_betweentravelled","tree_betweendirectness","tree_sinuosity","tree_betweennumgps","manualDate","tree_betweentime")
## take a random sample with same "gps" distances as the between tree gps points.
### Calculate all the distance travelled between trees.
##### Adding total number of fruit trees
random_window_sizes<- SUAQ_treedirectness %>% pull(tree_betweennumgps)
pb <-  txtProgressBar(min = 0, max = NROW(random_window_sizes), initial = 0) 
stepi <-0
SUAQ_randomdirectness <- data.frame()
for(i in random_window_sizes){
  windowsize <- i+2 # plus two because thats the window size (Start end tree is not counted in the tree_betweennumgps)
  points_available<- SUAQ_rangepoints_11all20_loc %>% ungroup() %>% 
    filter(as.numeric(follow_totNumOfGPSpoints)>as.numeric(windowsize)) 
  points_available_start_anti<- points_available %>% arrange(desc(trackpoint_id)) %>% 
    group_by(follow) %>% 
    top_n((windowsize-1),trackpoint_id) # select last i+1 or windowsize-1 objects these are not appropriate startpoints because they are too short till followend
  points_available_start<- setdiff(points_available,points_available_start_anti)
    # find follwos which have enough elements
  random_start <- points_available_start %>%ungroup() %>%  sample_n(1)
  random_startid<- pull(random_start,trackpoint_id)
  random_end <- points_available %>% filter(follow%in%c(random_start$follow)) %>%  filter(trackpoint_id==(random_startid+i+1)) # adding one because of indexing
  random_endid<- pull(random_end,trackpoint_id)
  windowselected <- points_available %>% filter(follow%in%c(random_start$follow)) %>% 
    filter(trackpoint_id%in%c(random_startid:random_endid))
  temp_trj<- windowselected %>% dplyr::select(x=E,y=N,manualDatetime) %>% 
    mutate(time=TrajConvertTime(strftime(manualDatetime, format="%H:%M:%S"), sep = ":", factors = c(60 * 60, 60, 1))) %>% 
    ungroup() %>%  
    dplyr::select(-manualDatetime)
    temp_trj <- TrajFromCoords(temp_trj, xCol = "x",yCol = "y")
    trj_sinuosity_temp <- TrajSinuosity2(temp_trj)
  
  random_start$random_betweentravelled <- sum(windowselected[1:(nrow(windowselected)-1),]$manual_distToNext,na.rm = TRUE)
  random_start$DD <- sqrt((random_start$E-random_end$E)^2+(random_start$N-random_end$N)^2)
  random_start$random_betweennumgps <- i
  random_start$random_timetravelled <- sum(windowselected[1:(nrow(windowselected)-1),]$timelag_lead,na.rm = TRUE)
  random_start$random_sinuosity <- trj_sinuosity_temp
  SUAQ_randomdirectness <- SUAQ_randomdirectness %>% rbind(random_start)
  
  # change progress bar
  setTxtProgressBar(pb,stepi) 
  stepi <-  stepi + 1
}
SUAQ_randomdirectness <- SUAQ_randomdirectness %>% mutate(random_betweendirectness=DD/random_betweentravelled)



### renaming and selecting for stats analysis
SUAQ_randomdirectness_stats <- SUAQ_randomdirectness %>%
  dplyr::select(follow,focal,SUAQ_orangutans.matriline,ageFromDOB,ClassFocal,SUAQ_weather.rainfall_ml_evening,SUAQ_weather.river_waterlevel_morning,SUAQ_weather.river_waterlevel_evening,SUAQ_weather.rainfall_ml_morning,SUAQ_weather.avg_temperature_tot,SUAQ_weather.max_temp_average,SUAQ_weather.min_temp_average,SUAQ_weather.temperature_max_morning,SUAQ_weather.temperature_min_morning,SUAQ_weather.temperature_max_evening,SUAQ_weather.temperature_min_evening,SUAQ_fai.fai,ageOfCurrentOffspring,monthYearDate,follow_totNumOfGPSpoints,random_betweentravelled,random_betweendirectness,random_sinuosity,random_betweennumgps,manualDate,random_timetravelled)
colnames(SUAQ_randomdirectness_stats) <-
  c("follow","focal","matriline","ageFromDOB","ClassFocal","rain_eve","watlevel_mo","walevel_eve","rain_mo","avg_temp_tot","max_temp_average","min_temp_average","temp_max_mo","temp_min_mo","temp_max_eve","temp_min_eve","fai","ageOfCurrentOffspring","monthYearDate","random_numOfPoints","random_betweentravelled","random_betweendirectness","random_sinuosity","random_betweennumgps","manualDate","random_betweentime")

## test if random vs. tree-tree movements are different
t.test(SUAQ_randomdirectness$random_betweentravelled,SUAQ_treedirectness$tree_betweentravelled)
#wilcox.test(travelled~class, data = test, exact = FALSE, correct = FALSE, conf.int = FALSE)
t.test(SUAQ_randomdirectness$random_timetravelled,SUAQ_treedirectness$tree_betweentime)
t.test(SUAQ_randomdirectness$random_betweentravelled,SUAQ_treedirectness$tree_betweentravelled)

#assumptions normality
shapiro.test((SUAQ_randomdirectness$random_betweentravelled[0:5000]))
shapiro.test(SUAQ_treedirectness$tree_betweentime)
shapiro.test(SUAQ_treedirectness$tree_betweentravelled)
#variances equal
bartlett.test(travelled~class,test)

test <- data.frame(class="random",travelled=SUAQ_randomdirectness$random_betweentravelled) %>% bind_rows(data.frame(class="tree",travelled=SUAQ_treedirectness$tree_betweentravelled))
test %>% ggplot(aes(log(travelled),fill=class))+geom_boxplot()
levene(weight ~ group)

autoplot(test)

## Visuals
plot_BetweenTreeDirectnessxClassFocal<- SUAQ_treedirectness %>% 
  ggplot( aes(x=sqrt(tree_betweentravelled), y=sqrt(tree_betweendirectness))) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="blue", size=2, alpha=0.2) +
    geom_jitter(data=SUAQ_randomdirectness_stats,aes(sqrt(random_betweentravelled),sqrt(random_betweendirectness)),color="red", size=2, alpha=0.2) +
    theme_ipsum() +
    theme(
      #legend.position="none",
      plot.title = element_text(size=11)
    ) +
    labs(x="distance travelled [m]",y="SI")+
  ylim(0,1)+
  geom_smooth(data=SUAQ_randomdirectness_stats,aes(sqrt(random_betweentravelled),sqrt(random_betweendirectness)),color="red")+
  geom_smooth()
plot_BetweenTreeDirectnessxClassFocal


plot_BetweenTreeSinuosityxClassFocal<- SUAQ_treedirectness %>% 
  ggplot( aes(x=sqrt(tree_betweentravelled), y=tree_sinuosity)) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="blue", size=1, alpha=0.2) +
    geom_jitter(data=SUAQ_randomdirectness_stats,aes(sqrt(random_betweentravelled),random_sinuosity),color="red", size=1, alpha=0.2) +
    theme_ipsum() +
    theme(
      #legend.position="none",
      plot.title = element_text(size=11)
    ) +
    labs(x="distance travelled [m]",y="Sinuosity index")+
  ylim(0,1)+
  geom_smooth(data=SUAQ_randomdirectness_stats,aes(sqrt(random_betweentravelled),random_sinuosity),color="red")+
  geom_smooth()
plot_BetweenTreeSinuosityxClassFocal


ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_BetweenTreeDirectnessxClassFocal",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_BetweenTreeDirectnessxClassFocal)

### Statistics analysing scatterplots
plot_FAIxTREESIN <-
  SUAQ_treedirectness_stats %>% ggplot(aes(fai,log(tree_sinuosity))) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(x = "FAI", y = "Tree sinuosity")+
  geom_point(data=SUAQ_randomdirectness_stats,aes(fai,log(random_sinuosity)),color="red", size=1, alpha=0.2) +
  geom_smooth(data=SUAQ_randomdirectness_stats,aes(fai,log(random_sinuosity)),color="red")+
  geom_smooth(method="lm")
plot_FAIxTREESIN

plot_MATRxTREESIN <-
  SUAQ_treedirectness_stats %>% ggplot(aes(matriline,log(tree_sinuosity),group=matriline)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_boxplot() + labs(x = "matriline", y = "tree sinuosity")
plot_MATRxTREESIN

SUAQ_treedirectness_stats_temp <- SUAQ_treedirectness_stats %>% mutate(sample="tree sample")
SUAQ_randomdirectness_stats_temp <- SUAQ_randomdirectness_stats %>% mutate(sample="random sample")
colnames(SUAQ_randomdirectness_stats_temp) <- colnames(SUAQ_treedirectness_stats_temp)
SUAQ_randomdirectness_stats_temp <- SUAQ_randomdirectness_stats_temp%>% dplyr::select(-manualDate)
SUAQ_treedirectness_full <- SUAQ_treedirectness_stats_temp %>% dplyr::select(-manualDate) %>% rbind(SUAQ_randomdirectness_stats_temp)
SUAQ_treedirectness_full %>% ggplot(aes(log(tree_sinuosity),sample))+geom_boxplot()+labs(x="logarithmic sinuosity index")



### Statistics
# Simple statistics
summary(SUAQ_treedirectness$tree_betweentravelled)
sd(SUAQ_randomdirectness$random_betweentravelled)
sd(SUAQ_randomdirectness$random_betweennumgps)
#### Check if random and tree directness is the same
wilcox.test(SUAQ_treedirectness_stats$tree_betweentravelled,SUAQ_randomdirectness_stats$tree_betweentravelled)
wilcox.test(SUAQ_treedirectness_stats$tree_sinuosity,SUAQ_randomdirectness_stats$random_sinuosity)
wilcox.test(SUAQ_treedirectness_stats$tree_betweendirectness,SUAQ_randomdirectness_stats$random_betweendirectness)


#### Filter NA's for different stats
SUAQ_treedirectness_stats <-   SUAQ_treedirectness_stats %>%
  mutate(month=as.factor(month(lubridate::ym(monthYearDate)))) %>% 
  mutate(monthname=month.name[month])%>%
  mutate(year=as.character(year(lubridate::ym(monthYearDate))))%>%
  mutate(rainyseason=ifelse(month %in% c(10,11,12),"rainy","normal"))
SUAQ_treedirectness_stats_naomit_minimum <- SUAQ_treedirectness_stats %>% dplyr::select(tree_betweennumgps,ClassFocal,manualDate,tree_betweendirectness,tree_sinuosity,fai,tree_betweentime,focal,rainyseason,tree_betweentravelled) %>% na.omit()
SUAQ_treedirectness_stats_naomit_mother <- SUAQ_treedirectness_stats %>% dplyr::select(focal,tree_betweennumgps,ClassFocal,manualDate,tree_betweendirectness,tree_sinuosity,rain_eve,walevel_eve,rain_mo,temp_min_eve,temp_min_mo,avg_temp_tot,fai,ageOfCurrentOffspring,matriline,ageFromDOB,tree_betweentime,rainyseason,tree_betweentravelled) %>% na.omit()
SUAQ_treedirectness_stats_naomit <- SUAQ_treedirectness_stats %>% dplyr::select(tree_betweennumgps,ClassFocal,manualDate,tree_betweendirectness,tree_sinuosity,rain_eve,walevel_eve,rain_mo,temp_min_eve,temp_min_mo,avg_temp_tot,fai,tree_betweentime,focal,rainyseason,tree_betweentravelled) %>% na.omit()

#### Random effects day and number of gps between
glm_SIN_FTD_ClassFocal <- lmer(tree_sinuosity~ClassFocal +(1 | tree_betweennumgps)+ (1 | manualDate),data=SUAQ_treedirectness_stats_naomit_minimum) # problem colinearity
glm_SIN_FTD_focal <- lmer(tree_sinuosity~focal +(1 | tree_betweennumgps)+ (1 | manualDate),data=SUAQ_treedirectness_stats_naomit_minimum) # problem colinearity
glm_SIN_FTD_minimum_onlyrandom<- lmer(tree_sinuosity~ (1 | tree_betweennumgps)+ (1 | manualDate),data=SUAQ_treedirectness_stats_naomit_minimum)
lm_SIN_FTD_random_effect <- lm(tree_sinuosity~ tree_betweennumgps+ 
                           manualDate,data=SUAQ_treedirectness_stats_naomit_minimum)
anova(lm_SIN_FTD_random_effect)
r.squaredGLMM(lm_SIN_FTD_random_effect)
anova(glm_SIN_FTD_minimum_onlyrandom,glm_SIN_FTD_ClassFocal,glm_SIN_FTD_focal)
anova(glm_ClassFocal)
anova(glm_minimum_onlyrandom)
vif.mer(glm_ClassFocal)

#### looking at further explanatory variables
glm_SIN_FTD_fai <- lmer(tree_sinuosity~fai +(1|focal) +(1 | tree_betweennumgps)+ (1 | manualDate)+(1|tree_betweentime),data=SUAQ_treedirectness_stats_naomit) # problem colinearity
glm_SIN_FTD_full <- lmer(tree_sinuosity~rain_eve+rain_mo+avg_temp_tot+fai+ClassFocal+(1|focal) +(1 | tree_betweennumgps)+ (1 | manualDate)+(1|tree_betweentime),data=SUAQ_treedirectness_stats_naomit)
glm_SIN_FTD_empty <- lmer(tree_sinuosity~ (1|focal) +(1 | tree_betweennumgps)+ (1 | manualDate)+(1|tree_betweentime),data=SUAQ_treedirectness_stats_naomit)
anova(glm_SIN_FTD_full,glm_SIN_FTD_empty,glm_SIN_FTD_fai)
anova(glm_SIN_FTD_full)
summary(glm_SIN_FTD_full)
ranova(glm_SIN_FTD_full)
vif.mer(glm_SIN_FTD_full)
r.squaredGLMM(glm_SIN_FTD_full)

#### Check the same for sinuosity
glm_SIN_FTD_backward<- step(glm_SIN_FTD_full,direction="backward")
glm_SIN_FTD_backward<- get_model(glm_SIN_FTD_backward)

summary(glm_SIN_FTD_backward)
anova(glm_SIN_FTD_full,glm_SIN_FTD_backward,glm_SIN_FTD_empty)


#### looking at females only
SUAQ_treedirectness_stats_naomit %>% ggplot(aes(ClassFocal,tree_betweendirectness))+geom_boxplot()
SUAQ_treedirectness_stats_naomit_mother %>% ggplot(aes(as.character(matriline),tree_betweendirectness))+geom_boxplot()

aov_treedirectness_class<- kruskal.test(SUAQ_treedirectness_stats_naomit$tree_sinuosity~SUAQ_treedirectness_stats_naomit$ClassFocal)
aov_treedirectness_matriline<- kruskal.test(SUAQ_treedirectness_stats_naomit_mother$tree_sinuosity~SUAQ_treedirectness_stats_naomit_mother$matriline)
aov_treedirectness_focal<- kruskal.test(SUAQ_treedirectness_stats_naomit_mother$tree_sinuosity~SUAQ_treedirectness_stats_naomit_mother$focal)
aov_treedirectness_class
aov_treedirectness_focal
aov_treedirectness_matriline


glm_SIN_FTD_mothers <- lmer(tree_sinuosity~rain_eve+rain_mo+avg_temp_tot+fai+ ageFromDOB+ageOfCurrentOffspring+matriline+(1 | tree_betweennumgps)+ (1 | manualDate),data=SUAQ_treedirectness_stats_naomit_mother)
glm_SIN_FTD_mothers_empty <- lmer(tree_sinuosity~ (1|focal) +(1 | tree_betweennumgps)+ (1 | manualDate)+(1|tree_betweentime),data=SUAQ_treedirectness_stats_naomit_mother)

anova(glm_SIN_FTD_mothers_empty,glm_SIN_FTD_mothers, test="Chisq")
anova(glm_focal_diff)
summary(glm_SIN_FTD_mothers)
lrtest(glm_SIN_FTD_mothers_empty, glm_SIN_FTD_mothers)



#### Plot and tables
###### OVERVIEW OF MODEL RESULTS
screenreg(list(glm_SIN_FTD_empty,glm_SIN_FTD_full,glm_SIN_FTD_mothers_empty,glm_SIN_FTD_mothers),digits=5)
qqnorm(residuals(glm_SIN_selected))

###### TEXTREG --> LATEX EXPORT
r.squaredGLMM(glm_SIN_FTD_full)
ranova(glm_SIN_FTD_backward)

texreg(list(glm_SIN_FTD_empty,glm_SIN_FTD_full,glm_SIN_FTD_mothers_empty,glm_SIN_FTD_mothers),
       digits=5,
          custom.model.names = c("Only random","Selected","Only random females","Selected only females"),
          custom.coef.names = c("intercept","day rain", "night rain","average temperature", "FAI", "Class: flanged male", "Class: infant","Class: juvenile","Class: unflanged male","age","age of offspring","matriline"),
          return.string=TRUE,
          use.packages=FALSE,
          single.row=TRUE)

```

```{r Sinuosity calculation ,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
##### MSSI function see: 
SUAQ_rangepoints_11all20_loc_SIN <- SUAQ_rangepoints_11all20_loc
follows <- SUAQ_rangepoints_11all20_loc_SIN %>% group_by(follow) %>% summarise()
SUAQ_sinuosity <- data.frame()
temp_ClassFocal<- as.vector(levels(as.factor(SUAQ_rangepoints_11all20_loc_SIN$ClassFocal)))

for(i in as_vector(follows)){
    data<- SUAQ_rangepoints_11all20_loc_SIN %>% filter(follow%in%c(i)) 
    print(i)
    if(nrow(data)>1){
      data_follow_simple <- data %>% dplyr::select(x=E,y=N,manualDatetime) %>% 
      mutate(time=TrajConvertTime(strftime(manualDatetime, format="%H:%M:%S"), sep = ":", factors = c(60 * 60, 60, 1))) %>% 
      ungroup() %>%  
      dplyr::select(-manualDatetime)
      trj <- TrajFromCoords(data_follow_simple, xCol = "x",yCol = "y")
      trj_sinuosity <- TrajSinuosity2(trj)
      #trj_emax <- TrajEmax(trj)
      trj_TDD <- TrajDistance(trj)
      trj_EMAX <- TrajEmax(trj)
      trj_DJL <- TrajLength(trj)
      trj_MeanTurningA <- TrajMeanVectorOfTurningAngles(trj) # in radians
      trj_expNSD <- TrajExpectedSquareDisplacement(trj)
      #trj_MSSI <-  calculate_MSSI(trj)
      print(paste0(i,": ",trj_sinuosity))
      SUAQ_sinuosity <- SUAQ_sinuosity %>% rbind(c(i,as.numeric(c(trj_sinuosity,trj_TDD,trj_DJL,trj_MeanTurningA,trj_expNSD,trj_EMAX))))
      }
  }

colnames(SUAQ_sinuosity) <- c("follow","trj_sinuosity","trj_distance","trj_DJL","trj_MeanTurningA","trj_expNSD","trj_EMAX")
SUAQ_sinuosity %>% ggplot(aes(trj_sinuosity))+geom_histogram(bins = 100)

DJL_follows <-  DJL_follows %>% left_join(SUAQ_sinuosity,by=c("follow"="follow"))

DJL_follows <-   DJL_follows %>% 
  mutate(month=as.factor(month(lubridate::ym(monthYearDate))),fruittreecount_normalized=fruittreecount/DJL) %>% 
  mutate(monthname=month.name[month])

DJL_follows_nozerotree <- DJL_follows %>% filter(fruittreecount>0)
```

```{r visuals of DJL and explanatory variables ,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
##### Plot female DJL
DJL_follows_females_10<- SUAQ_rangepoints_11all20_loc_females_12 %>% 
  filter(followtype=="NN") %>% 
  group_by(follow,focal,SUAQ_followlog.ClassFocal) %>% 
  summarise(DJL=sum(as.numeric(manual_distTolast), na.rm = TRUE),count=n()) %>% 
  arrange(SUAQ_followlog.ClassFocal) %>% ungroup() %>% 
  mutate(focal = fct_reorder(focal, SUAQ_followlog.ClassFocal))


plot_FemaleDJL<- DJL_follows_females_10 %>% 
  ggplot( aes(x=focal, y=DJL)) +
    geom_jitter(color="coral4", size=0.7, alpha=0.9, shape = 4)+ # add  aes(x=focal, y=DJL) to see which follow it is on a plotly although colors are wrong then... little hack
    geom_boxplot(aes(x=focal, y=DJL, fill=focal),outlier.fill = focal,outlier.stroke= focal) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    ggtitle("Day journey length for Nest-to-Nest follows in Suaq grouped by orangutans") +
    xlab("")+
    ylab("DJL [m]")+
    coord_cartesian(ylim=c(0, 5000))+
    theme(legend.position = "none")+
    theme(axis.text.x = element_text(angle = 90))
ggplotly(plot_FemaleDJL)

##### Scatterplots #####
plot_ClassxDJL <-
  DJL_follows %>% ggplot(aes(ClassFocal,DJL,colour=ClassFocal)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(title = "Histogram of focal classes", x = "focal class", y = "DJL [m]")
plot_ClassxDJL

with(DJL_follows , vioplot( 
  DJL[ClassFocal=="flanged male"] , DJL[ClassFocal=="unflanged male"], DJL[ClassFocal=="infant"],DJL[ClassFocal=="juvenile"],DJL[ClassFocal=="adult female"],
  col=rgb(0.1,0.4,0.7,0.7) , names=c("flanged male","unflanged male","infant","juvenile","adult female") 
))

plot_DJLxClassFocal<- DJL_follows %>%
  ggplot( aes(x=ClassFocal, y=DJL, fill=ClassFocal)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="black", size=0.4, alpha=0.3) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("Class focal and day journey length") +
    ylab("DJL [m]")+
  ylim(0,2500)
plot_DJLxClassFocal

plot_RRxClassFocal<- DJL_follows %>%
  ggplot( aes(x=ClassFocal, y=RR, fill=ClassFocal)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="black", size=0.4, alpha=0.3) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("Class focal and straightness index") +
    ylab("SI")+
  ylim(0,1)
plot_RRxClassFocal

plot_TDDxClassFocal<- DJL_follows %>%
  ggplot( aes(x=ClassFocal, y=TDD, fill=ClassFocal)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="black", size=0.4, alpha=0.3) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    )+
  ylab("TDD")
plot_TDDxClassFocal

plot_SINxClassFocal<- DJL_follows %>%
  ggplot( aes(x=ClassFocal, y=trj_sinuosity, fill=ClassFocal)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="black", size=0.4, alpha=0.3) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("Class focal and sinuosity index") +
    ylab("Sinuosity index")+
  ylim(0,0.5)
plot_SINxClassFocal

plot_expNSDxClassFocal<- DJL_follows %>%
  ggplot( aes(x=ClassFocal, y=trj_expNSD, fill=ClassFocal)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="black", size=0.4, alpha=0.3) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("Class focal and expected squared displacement") +
    ylab("Expected squared displacement")+
  ylim(0,500000)
plot_expNSDxClassFocal

plot_EMAXxClassFocal<- DJL_follows %>%
  ggplot( aes(x=ClassFocal, y=trj_EMAX, fill=ClassFocal)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="black", size=0.4, alpha=0.3) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("Class focal and emax") +
    ylab("Emax")
plot_EMAXxClassFocal

plot_FruittreexClassFocalxDJL<- DJL_follows %>%
  ggplot( aes(x=log(DJL), y=log(fruittreecount),colour=ClassFocal, fill=ClassFocal)) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(size=1, alpha=1) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("Class focal and number of fruit trees") +
    ylab("fruit trees")+
  xlab("DJL [m]")
plot_FruittreexClassFocalxDJL

### Expected meaningless tree to tree follows analysis
plot_FAIxTREEDJL <-
  DJL_follows %>% ggplot(aes(fai,tree_DJL)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(x = "FAI", y = "Tree cartesian distances")+
  geom_smooth(method="lm")
plot_FAIxTREEDJL


### FAI and DJL
plot_FAIxDJL <-
  DJL_follows %>% ggplot(aes(fai,DJL)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(title = "Scatterplot of FAI and DJL", x = "FAI", y = "DJL [m]")+
  geom_smooth(method="lm")
plot_FAIxDJL

### Sinuosity and DJL
plot_FAIxDJL <-
  DJL_follows %>% ggplot(aes(trj_sinuosity,DJL)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(title = "Scatterplot of sinuosity index and DJL", x = "Sinuosity index", y = "DJL [m]")+
  geom_smooth(method="lm")
plot_FAIxDJL

### Season and DJL
plot_SEASONxDJL <-
  DJL_follows %>% ggplot(aes(rainyseason,DJL)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(title = "Scatterplot of rainy season and DJL", x = "Season", y = "DJL [m]")+
  geom_boxplot()
plot_SEASONxDJL

### Season and RR
plot_SEASONxRR <-
  DJL_follows %>% ggplot(aes(rainyseason,RR)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(title = "Scatterplot of rainy season and SI", x = "Season", y = "SI")+
  geom_boxplot()
plot_SEASONxRR

### Rain morning and RR
plot_RAINMOxRR <-
  DJL_follows %>% ggplot(aes(rain_mo,RR)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + 
  labs(title = "Scatterplot of night rain and SI", x = "night rain [mm]", y = "SI")+
  geom_smooth(method="lm")
plot_RAINMOxRR

### Season and SIN
plot_SEASONxSIN <-
  DJL_follows %>% ggplot(aes(rainyseason,trj_sinuosity)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(title = "Scatterplot of rainy season and sinuosity index", x = "Season", y = "Sinuosity index")+
  geom_boxplot()
plot_SEASONxRR

### DJL and sinuosity
plot_DJLxSINUOSITY <-
  DJL_follows %>% ggplot(aes(trj_sinuosity,DJL)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(x = "Sinuosity index", y = "DJL [m]")+
  geom_smooth()
plot_DJLxSINUOSITY

### RR and sinuosity
plot_RRxSIN2 <-
  DJL_follows %>% 
  ggplot(aes(trj_sinuosity,RR,color=as.factor(follow),group=as.factor(follow))) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(data=DJL_follows,mapping=aes(trj_sinuosity,group=as.factor(follow),RR,alpha=0.1),alpha=0.1,color="black")+
  geom_point(size = 3) + 
  labs(x = "Sinuosity index", y = "SI",colour="")
ggplotly(plot_RRxSIN2)

### RR and sinuosity
plot_RRxSIN <-
  DJL_follows %>% 
  ggplot(aes(trj_sinuosity,RR)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point() + 
  labs(x = "Sinuosity index", y = "SI")+
  geom_smooth(method="lm")
plot_RRxSIN

### TDD and sinuosity
plot_TDDxSIN <-
  DJL_follows %>% ggplot(aes(trj_sinuosity,TDD)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(x = "Sinuosity index", y = "TDD [m]")+
  geom_smooth()
plot_TDDxSIN

### DJL and TDD
plot_DJLxTDD <-
  DJL_follows %>% ggplot(aes(TDD,DJL)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(x = "TDD [m]", y = "DJL [m]")+
  geom_smooth(method="lm")
plot_DJLxTDD

### SI and TDD
plot_SIxTDD <-
  DJL_follows %>% ggplot(aes(TDD,RR)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(y = "SI", x = "TDD [m]")+
  geom_smooth()
plot_SIxTDD

### DJL and TDD
plot_WALEVxTDD <-
  DJL_follows %>% ggplot(aes(TDD,watlevel_mo)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(title = "Scatterplot of TDD and water level", x = "TDD [m]", y = "water level")+
  geom_smooth(method="lm")+
  facet_wrap(.~ ClassFocal)
plot_WALEVxTDD

### DJL and RR
plot_DJLxRR <-
  DJL_follows %>% ggplot(aes(RR,DJL)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(x = "SI", y = "DJL [m]")+
  geom_smooth(method="lm")
plot_DJLxRR

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_FAIxTREEDJL",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_FAIxTREEDJL)

### Timelag and RR
plot_TimelagxRR <-
  DJL_follows %>% ggplot(aes(meanTimelag,RR)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(title = "Scatterplot of straightness and mean timelag", x = "SI", y = "mean timelag [s]")+
  geom_smooth(method="lm")
plot_TimelagxRR

### Timelag and SIN
plot_TimelagxSIN <-
  DJL_follows %>% ggplot(aes(meanTimelag,trj_sinuosity)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(title = "Scatterplot of sinuosity and mean timelag", x = "sinuosity", y = "mean timelag [s]")+
  geom_smooth(method="lm")
plot_TimelagxSIN

### AgeOfOffspring and SIN
plot_AOCOxSIN <-
  DJL_follows %>% ggplot(aes(ageOfCurrentOffspring,trj_sinuosity)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(y = "sinuosity index", x = "age of current offspring [y]")+
  geom_smooth()
plot_AOCOxSIN

### AgeOfOffspring and SIN
plot_AOCOxTDD <-
  DJL_follows %>% ggplot(aes(ageOfCurrentOffspring,TDD)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(y = "TDD [m]", x = "age of current offspring [y]")+
  geom_smooth()
plot_AOCOxTDD

### AgeOfOffspring and SIN
plot_AOCOxRR <-
  DJL_follows %>% ggplot(aes(ageOfCurrentOffspring,RR)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(y = "SI", x = "age of current offspring [y]")+
  geom_smooth()
plot_AOCOxRR

### AgeOfOffspring and Feeding trees
plot_AOCOxFTC <-
  DJL_follows %>% ggplot(aes(ageOfCurrentOffspring,log(fruittreecount))) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(y = "visited feeding trees", x = "age of current offspring [y]")+
  geom_smooth(method="lm")
plot_AOCOxFTC

### TDD and RR
plot_TDDxRR <-
  DJL_follows %>% ggplot(aes(RR,TDD)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(title = "Scatterplot of straightness and TDD", x = "SI", y = "TDD [m]")+
  geom_smooth(method="lm")
plot_TDDxRR

### FTC and TIMELAG
plot_FTCxTL <-
  DJL_follows %>% ggplot(aes(fruittreecount,meanTimelag)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point() + 
  labs(x = "fruit trees", y = "mean sampling interval [s]")+
  geom_smooth(method="lm")
plot_FTCxTL

### FTC only without zero tree counts 
plot_FTCOxSIN <-
  DJL_follows_nozerotree %>% ggplot(aes(fruittreecount,trj_sinuosity)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point() + 
  labs(x = "fruit trees", y = "sinuosity index")+
  geom_smooth(method="lm")
plot_FTCOxSIN

### FTC and TIMELAG
plot_FTCxFAI <-
  DJL_follows %>% ggplot(aes(fruittreecount,fai)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point() + 
  labs(x = "fruit trees", y = "FAI")+
  geom_smooth(method="lm")+
  xlim(0,30)
c


### SIN and FTC
plot_SINxFTC <-
  DJL_follows %>% 
  filter(!(follow%in%c("661","663","671","682","685","687","689","718","719","733","735","738","743","745","746","748","751","753","754","765","767","773","805","807","808","810","816"))) %>% 
  ggplot(aes(fruittreecount,trj_sinuosity)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(y = "sinuosity index", x = "fruit tree count")+
  geom_smooth(method="lm")
plot_SINxFTC

### RR and FTC
plot_RRxFTC <-
  DJL_follows %>% ggplot(aes(fruittreecount,RR)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(y = "SI", x = "fruit tree count")+
  geom_smooth(method="lm")
plot_RRxFTC

### DJL and FTC
plot_DJLxFTC <-
  DJL_follows %>% 
  filter(!(follow%in%c("661","663","671","682","685","687","689","718","719","733","735","738","743","745","746","748","751","753","754","765","767","773","805","807","808","810","816"))) %>% 
  ggplot(aes(fruittreecount,DJL)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(y = "DJL", x = "fruit tree count")+
  geom_smooth(method="lm")
plot_DJLxFTC



### Age of offspring
plot_AgeCurrentOffspringxDJL <-
  DJL_follows %>% ggplot(aes(ageOfCurrentOffspring,DJL,colour=as.character(meanTimelag))) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(title = "Scatterplot of DJL and Age of current offspring", x = "Age of current offspring [years]", y = "DJL [m]")+
  geom_smooth(method="lm")+theme(legend.position="none")
plot_AgeCurrentOffspringxDJL

plot_AgeFocalxDJL <-
  DJL_follows  %>%  ggplot(aes(ageFromDOB,DJL)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(title = "Scatterplot of DJL and Age of focal", x = "Approximate Age [years]", y = "DJL [m]")+
  geom_smooth()
plot_AgeFocalxDJL

plot_AgeOffspringxDJL <-
  DJL_follows  %>%  ggplot(aes(ageOfCurrentOffspring,DJL)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(x = "age of current offspring [y]", y = "DJL [m]")+
  geom_smooth()
plot_AgeOffspringxDJL

#### Random effects single
plot_monthYearDate_x_DJL_randomEffects <-
  DJL_follows %>% ggplot(aes(monthYearDate,DJL,colour=focal)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + 
  labs(title = "Scatterplot of DJL and the random effect of months", x = "Year and Month", y = "DJL [m]")+
  theme(axis.text.x = element_text(angle = 45))+
  geom_smooth()
plot_monthYearDate_x_DJL_randomEffects

##### Save important plots
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_DJLxFTC",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_RRxFTC)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_AgeFocalxDJL",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_AgeFocalxDJL,width = 24,height = 15,units="cm")
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_RRxSIN",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_RRxSIN,width = 24,height = 15,units="cm")
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_AOCOxSIN",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_AOCOxSIN,width = 24,height = 15,units="cm")

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_", 
    "plot_DJLxRR",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_DJLxRR)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_TDDxSIN",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_TDDxSIN)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_RRxSIN",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_RRxSIN,width = 24,height = 15,units="cm")
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_DJLxTDD",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_DJLxTDD)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_DJLxSINUOSITY",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_DJLxSINUOSITY)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_TDDxRR",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_TDDxRR)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_AgeOffspringxDJL",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_AgeOffspringxDJL)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_DJLxClassFocal",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_DJLxClassFocal)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_RRxClassFocal",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_RRxClassFocal)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_TimelagxSIN",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_TimelagxSIN)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_FAIxDJL_ungrouped",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_FAIxDJL,width = 24,height = 15,units="cm")
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_AgeCurrentOffspringxDJL",
    sep = ""
  ),
  "png",
  sep = "."
), plot = plot_AgeCurrentOffspringxDJL,width = 24,height = 15,units="cm")


##### Plot all
plot_Allscatter <-
  DJL_follows %>% ungroup() %>% dplyr::select(
    follow,
    ageFromDOB,
    turningAngleSum,
    ClassFocal,
    watlevel_mo,
    walevel_eve,
    rain_mo,
    rain_eve,
    avg_temp_tot,
    max_temp_average,
    min_temp_average,
    temp_max_mo,
    temp_min_mo,
    temp_max_eve,
    temp_min_eve,
    fai,
    ageOfCurrentOffspring,
    DJL,
    TDD,
    RR,
    fruittreecount,
    tree_DJL,
    tree_RR)

plot_Allscatter<- plot_Allscatter%>% GGally::ggpairs(echo=FALSE, message=FALSE, cardinality_threshold = 62)

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_Allscatter",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_Allscatter,dpi=300,width = 60,height = 60,units="cm")

##### Plot all
plot_scatter_all <-
  DJL_follows %>% ungroup() %>% dplyr::select(
    ageFromDOB,
    turningAngleSum,
    ClassFocal,
    watlevel_mo,
    walevel_eve,
    rain_mo,
    rain_eve,
    avg_temp_tot,
    fai,
    ageOfCurrentOffspring,
    DJL,
    TDD,
    RR,
    speed,
    fruittreecount,
    rainyseason,
    trj_sinuosity,
    trj_expNSD)


plot_scatter_all<- plot_scatter_all%>% GGally::ggpairs(echo=FALSE, message=FALSE, cardinality_threshold = 62)

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_Allscatter",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_scatter_all,dpi=300,width = 60,height = 60,units="cm")


##### Plot all weather variables
plot_AllscatterWeather <- DJL_follows %>% ungroup() %>% 
  dplyr::select(rain_eve,watlevel_mo,walevel_eve,rain_mo,avg_temp_tot,max_temp_average,min_temp_average,temp_max_mo,temp_min_mo,temp_max_eve,temp_min_eve)
plot_AllscatterWeather<- plot_AllscatterWeather%>% GGally::ggpairs(echo=FALSE, message=FALSE)

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_AllscatterWeather",
    sep = ""
  ),
  "pdf",
  sep = "." 
), plot = plot_AllscatterWeather,dpi=300,width = 60,height = 60,units="cm")

##### Plot offspring age and DJL
plot_DJLxAgeOffspring <-
  DJL_follows %>% 
  mutate(ageOfCurrentOffspring=round(ageOfCurrentOffspring,digits = 0)) %>% 
  ggplot(aes(ageOfCurrentOffspring,RR,colour=focal)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_boxplot(aes(group=ageOfCurrentOffspring)) + 
  labs(title = "Scatterplot of the SI and the age of the offspring", x = "Age of offspring rounded [year]", y = "Straightnes index")+
  theme(axis.text.x = element_text(angle = 45))
  #geom_smooth()
plot_DJLxAgeOffspring

##### Plot month and DJL
plot_DJLxMonth <-
  DJL_follows %>% mutate(month=as.factor(month(lubridate::ym(monthYearDate)))) %>% 
  group_by(month,ClassFocal) %>% 
  summarise(meanDJL=mean(DJL,na.rm=TRUE),"n-follows"=n()) %>% 
  ggplot(aes(month,meanDJL,colour=ClassFocal)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_path(aes(group=ClassFocal))+
  geom_point(aes(size=`n-follows`)) + 
  labs(x = "mean DJL [m]", y = "month")+
  theme(axis.text.x = element_text(angle = 45))
  #geom_smooth()
plot_DJLxMonth

plot_DJLxMonth2 <-
  DJL_follows %>% mutate(month=as.factor(month(lubridate::ym(monthYearDate)))) %>% 
  ggplot(aes(month,DJL,colour=ClassFocal)) +
  #scale_y_log10(labels=fancy_scientific) +
  #geom_path(aes(group=ClassFocal))+
  geom_boxplot() + 
  labs(y = "mean DJL [m]", x = "month")+
  theme(axis.text.x = element_text(angle = 45),legend.position = "none")+
  stat_summary(mapping = aes(month,DJL,group=ClassFocal,colour=ClassFocal),fun.data = give.n, geom = "text", fun.y = median,
                  position = position_dodge(width = 0.75),hjust = -5,vjust=0.5,angle=90)+
  facet_wrap(~ClassFocal, ncol = 5)
  #geom_smooth()
plot_DJLxMonth2
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_DJLxMonth2",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_DJLxMonth2,width = 24,height =  7.5,units="cm")

plot_DJLxYear <-
  DJL_follows %>% mutate(month=as.factor(month(lubridate::ym(monthYearDate))),year=as.character(year(lubridate::ym(monthYearDate)))) %>% 
  ggplot(aes(year,DJL,colour=ClassFocal)) +
  #scale_y_log10(labels=fancy_scientific) +
  #geom_path(aes(group=ClassFocal))+
  geom_boxplot() + 
  labs(y = "mean DJL [m]", x = "year")+
  theme(axis.text.x = element_text(angle = 45),legend.position = "none")+
  stat_summary(mapping = aes(year,DJL,group=ClassFocal,colour=ClassFocal),fun.data = give.n, geom = "text", fun.y = median,
                  position = position_dodge(width = 0.75),hjust = -5,vjust=0.5,angle=90)+
  facet_wrap(~ClassFocal, ncol = 5)
  #geom_smooth()
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_DJLxYear2",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_DJLxYear,width = 24,height =  7.5,units="cm")

### Compare movement parameters during months
plot_RRxMonth <-
  DJL_follows %>% mutate(month=as.factor(month(lubridate::ym(monthYearDate)))) %>% 
  ggplot(aes(month,RR,colour=ClassFocal)) +
  #scale_y_log10(labels=fancy_scientific) +
  #geom_path(aes(group=ClassFocal))+
  geom_boxplot() + 
  labs(y = "SI", x = "month")+
  theme(axis.text.x = element_text(angle = 45),legend.position = "none")+
  stat_summary(mapping = aes(month,RR,group=ClassFocal,colour=ClassFocal),fun.data = give.n, geom = "text", fun.y = median,
                  position = position_dodge(width = 0.75),hjust = -5,vjust=0.5,angle=90)+
  facet_wrap(~ClassFocal, ncol = 5)+
  ylim(0,1)
  #geom_smooth()
plot_RRxMonth
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_RRxMonth",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_RRxMonth,width = 24,height =  7.5,units="cm")

plot_SINxMonth <-
  DJL_follows %>% mutate(month=as.factor(month(lubridate::ym(monthYearDate)))) %>% 
  ggplot(aes(month,trj_sinuosity,colour=ClassFocal)) +
  #scale_y_log10(labels=fancy_scientific) +
  #geom_path(aes(group=ClassFocal))+
  geom_boxplot() + 
  labs(y = "sinuosity index", x = "month")+
  theme(axis.text.x = element_text(angle = 45),legend.position = "none")+
  stat_summary(mapping = aes(month,trj_sinuosity,group=ClassFocal,colour=ClassFocal),fun.data = give.n, geom = "text", fun.y = median,
                  position = position_dodge(width = 0.75),hjust = -5,vjust=0.5,angle=90)+
  facet_wrap(~ClassFocal, ncol = 5)+
  ylim(0,1)
  #geom_smooth()
plot_SINxMonth
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_SINxMonth",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_SINxMonth,width = 24,height =  7.5,units="cm")

plot_TDDxMonth <-
  DJL_follows %>% mutate(month=as.factor(month(lubridate::ym(monthYearDate)))) %>% 
  ggplot(aes(month,TDD,colour=ClassFocal)) +
  #scale_y_log10(labels=fancy_scientific) +
  #geom_path(aes(group=ClassFocal))+
  geom_boxplot() + 
  labs(y = "TDD [m]", x = "month")+
  theme(axis.text.x = element_text(angle = 45),legend.position = "none")+
  stat_summary(mapping = aes(month,TDD,group=ClassFocal,colour=ClassFocal),fun.data = give.n, geom = "text", fun.y = median,
                  position = position_dodge(width = 0.75),hjust = -5,vjust=0.5,angle=90)+
  facet_wrap(~ClassFocal, ncol = 5)
  #geom_smooth()
plot_TDDxMonth
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_TDDxMonth",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_TDDxMonth,width = 24,height =  7.5,units="cm")

plot_FTCxMonth <-
  DJL_follows %>% mutate(month=as.factor(month(lubridate::ym(monthYearDate)))) %>% 
  ggplot(aes(month,log(fruittreecount),colour=ClassFocal)) +
  #scale_y_log10(labels=fancy_scientific) +
  #geom_path(aes(group=ClassFocal))+
  geom_boxplot() + 
  labs(y = "logarithmic fruit tree count", x= "month")+
  theme(axis.text.x = element_text(angle = 45),legend.position = "none")+
  stat_summary(mapping = aes(month,fruittreecount,group=ClassFocal,colour=ClassFocal),fun.data = give.n, geom = "text", fun.y = median,
                  position = position_dodge(width = 0.75),hjust = -3,vjust=0.5,angle=90)+
  facet_wrap(~ClassFocal, ncol = 5)
  #geom_smooth()
plot_FTCxMonth
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_FTCxMonth_log",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_FTCxMonth,width = 24,height =  7.5,units="cm")

plot_FTCxYear <-
  DJL_follows %>% mutate(month=as.factor(month(lubridate::ym(monthYearDate))),year=as.character(year(lubridate::ym(monthYearDate)))) %>% 
  ggplot(aes(year,fruittreecount,group=as.integer(year),colour=ClassFocal)) +
  #scale_y_log10(labels=fancy_scientific) +
  #geom_path(aes(group=ClassFocal))+
  geom_boxplot() + 
  labs(y = "fruit tree count", x= "year")+
  theme(axis.text.x = element_text(angle = 45),legend.position = "none")+
  stat_summary(mapping = aes(year,fruittreecount,group=year,colour=ClassFocal),fun.data = give.n, geom = "text", fun.y = median,
                  position = position_dodge(width = 0.75),hjust = -3,vjust=0.5,angle=90)+
  facet_wrap(~ClassFocal, ncol = 5)
  #geom_smooth()
plot_FTCxYear
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_FTCxYear",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_FTCxYear,width = 24,height = 7.5,units="cm")

plot_DJLxMonthYear <-
  DJL_follows %>% mutate(month=month(lubridate::ym(monthYearDate)),year=as.factor(year(lubridate::ym(monthYearDate)))) %>% 
  group_by(monthYearDate,ClassFocal) %>% 
  summarise(meanDJL=mean(DJL,na.rm=TRUE,trim=0.05),"n-follows"=n()) %>% 
  ggplot(aes(monthYearDate,meanDJL,colour=ClassFocal)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_path(aes(group=ClassFocal))+
  geom_point(aes(size=`n-follows`)) + 
  labs(y = "mean DJL [m]", x = "month")+
  theme(axis.text.x = element_text(angle = 45))
  #geom_smooth()
plot_DJLxMonthYear


plot_FAIxMonth <-
  DJL_follows %>% mutate(month=as.factor(month(lubridate::ym(monthYearDate))),year=as.factor(year(lubridate::ym(monthYearDate)))) %>% 
  ggplot(aes(month,fai)) +
  #scale_y_log10(labels=fancy_scientific) +
  #geom_path(aes(group=ClassFocal))+
  geom_boxplot() + 
  labs(y = "FAI", x= "month")+
  theme(axis.text.x = element_text(angle = 45),legend.position = "none")+
  stat_summary(mapping = aes(month,fai),fun.data = give.n, geom = "text", fun.y = median,
                  position = position_dodge(width = 0.75),hjust = -3,vjust=0.5,angle=90)+
  facet_wrap(~year)
  #geom_smooth()
plot_FAIxMonth
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_FAIxMonth",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_FAIxMonth,width = 24,height =  7.5,units="cm")

plot_FAIxFTCxMonthYear <-
  DJL_follows %>% mutate(month=month(lubridate::ym(monthYearDate)),year=year(lubridate::ym(monthYearDate))) %>% 
  filter(fruittreecount>0) %>% 
  filter(!(follow%in%c("661","663","671","682","685","687","689","718","719","733","735","738","743","745","746","748","751","753","754","765","767","773","805","807","808","810","816"))) %>% 
  #group_by(monthYearDate,ClassFocal) %>% 
  #summarise(meanDJL=mean(DJL,na.rm=TRUE,trim=0.05),
            #meanRR=mean(RR,na.rm=TRUE,trim=0.05),
            #meanSIN=mean(trj_sinuosity,na.rm=TRUE,trim=0.05),
            #"n-follows"=n()) %>% 
  ggplot(aes(monthYearDate,fruittreecount,group=monthYearDate)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_line(mapping = aes(x=monthYearDate,y=fai,group=1),color="blue") + 
  geom_boxplot()+
  labs(y = "fruit tree count", x = "month")+
  theme(axis.text.x = element_text(angle = 45))+
  scale_y_continuous(sec.axis = sec_axis(~(.), name = "FAI",breaks = seq(0,20,1)))+
  stat_summary(mapping = aes(x=monthYearDate,y=fruittreecount),fun.data = give.n, geom = "text", fun.y = median,
                  position = position_dodge(width = 0.75),hjust = -12,vjust=0.5,angle=90)
  #geom_smooth()
  #geom_smooth()
plot_FAIxFTCxMonthYear
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_FAIxFTCxMonthYear",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_FAIxFTCxMonthYear,width = 24,height =  15,units="cm")


#### Change of female RR and DJL over years with only 95% of values
plot_DJLxRRxSINxMonthYear_females <-
  DJL_follows %>% mutate(month=month(lubridate::ym(monthYearDate)),year=year(lubridate::ym(monthYearDate))) %>% 
  filter(ClassFocal=="adult female") %>% 
  filter(!(follow%in%c("661","663","671","682","685","687","689","718","719","733","735","738","743","745","746","748","751","753","754","765","767","773","805","807","808","810","816"))) %>% 
  #group_by(monthYearDate,ClassFocal) %>% 
  #summarise(meanDJL=mean(DJL,na.rm=TRUE,trim=0.05),
            #meanRR=mean(RR,na.rm=TRUE,trim=0.05),
            #meanSIN=mean(trj_sinuosity,na.rm=TRUE,trim=0.05),
            #"n-follows"=n()) %>% 
  ggplot(aes(monthYearDate,RR,group=monthYearDate)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_boxplot(aes(x=monthYearDate,y=trj_sinuosity),color="blue")+
  geom_point(aes(x=monthYearDate,y=trj_sinuosity),color="blue") + 
  geom_boxplot()+
  geom_point() + 
  geom_boxplot(mapping=aes(y=DJL/500,group=monthYearDate),color="darkgreen")+
  geom_point(mapping=aes(y=DJL/500),color="darkgreen") +
  labs(y = "Tortuosity mean 95%", x = "month")+
  theme(axis.text.x = element_text(angle = 45))+
  scale_y_continuous("Tortuosity", sec.axis = sec_axis(~(.*500), name = "DJL [m]",breaks = seq(0,4000,100)))
  #geom_smooth()
plot_DJLxRRxSINxMonthYear_females

 #### Change of average value per year
plot_DJLxYear <-
  DJL_follows %>% mutate(month=month(lubridate::ym(monthYearDate)),year=as.factor(year(lubridate::ym(monthYearDate)))) %>% 
  ggplot(aes(year,DJL,colour=ClassFocal)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_boxplot()+
  labs(y = "mean DJL [m]", x = "month")+
  theme(axis.text.x = element_text(angle = 45))+
  stat_summary(mapping = aes(year,DJL,group=ClassFocal,colour=ClassFocal),fun.data = give.n, geom = "text", fun.y = median,
                  position = position_dodge(width = 0.75),hjust = -12,vjust=0.5,angle=90)
plot_DJLxYear

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_DJLxRRxSINxMonthYear_females",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_DJLxRRxSINxMonthYear_females,width = 24,height = 15,units="cm")


### Plot fruittreecounts
plot_fruittreecount <-
  DJL_follows %>% mutate(month=as.factor(month(lubridate::ym(monthYearDate))),fruittreecount_normalized=fruittreecount/DJL) %>% 
  ggplot(aes(month,fruittreecount)) +
  #scale_y_log10(labels=fancy_scientific) +
  #geom_path(aes(group=ClassFocal))+
  geom_boxplot() + 
  labs(x = "mean DJL [m]", y = "month")+
  theme(axis.text.x = element_text(angle = 45))+
  stat_summary(fun.data = give.n, geom = "text", fun.y = median,
                  position = position_dodge(width = 0.75))
  #geom_smooth()
plot_fruittreecount
DJL_follows_test <- DJL_follows %>% mutate(month=as.character(month))
test<- kruskal.test(fruittreecount ~ month,DJL_follows)
chisq.test()
test<- glm(fruittreecount~month, family = poisson(link = "log"),data = DJL_follows)
autoplot(test)
summary(test)

### Overview of Mother Offspring age
plot_MotherXOffspring <-
  DJL_follows %>% mutate(month=as.factor(month(lubridate::ym(monthYearDate)))) %>% filter(focal%in%c("ellie","friska","lisa")) %>% 
  group_by(monthYearDate,focal,ageOfCurrentOffspring) %>% 
  summarise(meanDJL=mean(DJL,na.rm=TRUE),"n-follows"=n()) %>% 
  ggplot(aes(ageOfCurrentOffspring,meanDJL,colour=focal,group=focal)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_path(aes(group=focal))+
  geom_point(aes(size=`n-follows`)) + 
  labs(x = "mean DJL [m]", y = "month")+
  theme(axis.text.x = element_text(angle = 45))
  #geom_smooth()
plot_MotherXOffspring

### Overview of DJL, Sinuosity and months
plot_DJLxRRxMonth<-
  DJL_follows %>% mutate(month=as.factor(month(lubridate::ym(monthYearDate)))) %>% 
  group_by(monthYearDate,focal,ClassFocal) %>% 
  summarise(meanDJL=mean(DJL,na.rm=TRUE),"n-follows"=n()) %>% 
  ggplot(aes(monthYearDate,meanDJL,colour=focal,group=focal)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_path(aes(group=focal))+
  geom_point(aes(size=`n-follows`)) + 
  labs(x = "mean DJL [m]", y = "month")+
  theme(axis.text.x = element_text(angle = 45))+
  facet_wrap(~ ClassFocal, scales = "free")
  #geom_smooth()
plot_DJLxRRxMonth
plotly(plot_DJLxRRxMonth)

### Overview of weather and DJL
plot_DJLxAVG_temp<-
  DJL_follows %>% mutate(month=as.factor(month(lubridate::ym(monthYearDate)))) %>% 
  ggplot(aes(temp_max_eve,DJL)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point() + 
  labs(x = "avg temp", y = "DJL [m]")+
  geom_smooth()
#geom_smooth()
plot_DJLxAVG_temp
```

```{r tree food sources analysis: }
#### On ggplot
plotly_treeAll <- SUAQ_rangepoints_11all20_loc[order(SUAQ_rangepoints_11all20_loc$manualDatetime , decreasing = TRUE ),] %>%
  filter(PtType=="tree") %>% 
  ggplot()+
  geom_point(aes(E,N,colour=focal),size=1)
  #geom_point(data = temp_duplicates,aes(E,N,fill=as.factor(follow)),size=2)+
  #geom_path(aes(E,N,color=as.factor(follow)), alpha = 0.7,size=0.5)
ggplotly(plotly_treeAll)

#### On a leaflet

SUAQ_rangepoints_11all20_loc_sf_wgs_treesonly<- SUAQ_rangepoints_11all20_loc_sf_wgs[order(SUAQ_rangepoints_11all20_loc_sf_wgs$manualDatetime , decreasing = TRUE ),] %>% filter(PtType=="tree") 
pal_pttype <- colorFactor(get_palette(palette = "default", 7), domain = SUAQ_rangepoints_11all20_loc_sf_wgs$PtType)
pal_focal <- colorFactor(get_palette(palette = "default", 109), domain = SUAQ_rangepoints_11all20_loc_sf_wgs_treesonly$focal)

leaflet_SUAQ_all_tree<- leaflet(data = st_transform(SUAQ_rangepoints_11all20_loc_sf_wgs_treesonly, crs = 4326)) %>% 
  addProviderTiles(providers$Esri.WorldImagery) %>% 
  addCircleMarkers(color = ~pal_focal(SUAQ_rangepoints_11all20_loc_sf_wgs_treesonly$focal),
                   fillOpacity = 1,
                   radius = 0.6,
                   opacity = 1) %>%
  addPolylines(weight = 1,
  opacity = 0.5,
    data = SUAQ_pathnetwork_sf_wgs
  ) 

leaflet_SUAQ_all_tree


```

```{r Statistics DJL RR,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
### Simple follow desriptions
histogram(DJL_follows$fruittreecount)

#### Duration
summary(DJL_follows$gps_followlength)
hist(DJL_follows$gps_followlength)
sd(DJL_follows$gps_followlength)

kruskal.test(original_followlength~ClassFocal,data = DJL_follows)
DJL_follows %>% ggplot(aes(ClassFocal,gps_followlength))+geom_boxplot()
DJL_follows %>% ggplot(aes(ClassFocal,original_followlength))+geom_boxplot()


summary(as.numeric(DJL_follows$original_followlength))
hist(as.numeric(DJL_follows$original_followlength))
sd(as.numeric(DJL_follows$original_followlength))

#### FAI
kruskal.test(SUAQ_fai.fai~SUAQ_fai.month,data = SUAQ_fai)
SUAQ_fai %>% mutate(SUAQ_fai.month=as.factor(SUAQ_fai.month)) %>%  
  ggplot(aes(SUAQ_fai.monthnum,as.numeric(SUAQ_fai.fai),color=as.factor(SUAQ_fai.year),group=as.factor(SUAQ_fai.year)))+
  geom_path()
  
summary(as.numeric(SUAQ_fai$SUAQ_fai.fai))

### avg time lags influenced by class? NO
kruskal.test(meanTimelag~ClassFocal,data = DJL_follows)
DJL_follows %>% ggplot(aes(ClassFocal,meanTimelag))+geom_boxplot()


### avg turning angles influenced by class? NO
kruskal.test(turningAngleSum~ClassFocal,data = DJL_follows)
DJL_follows %>% ggplot(aes(ClassFocal,turningAngleSum))+geom_boxplot()

### avg TDD influenced by class? NO slightly
kruskal.test(TDD~ClassFocal,data = DJL_follows)
DJL_follows %>% ggplot(aes(ClassFocal,TDD))+geom_boxplot()

### avg DJL influenced by class? YES
kruskal.test(DJL~ClassFocal,data = DJL_follows)
DJL_follows %>% ggplot(aes(ClassFocal,DJL))+geom_boxplot()
histogram(DJL_follows[DJL_follows$ClassFocal=="adult female",]$DJL)
sd(DJL_follows$DJL)

### avg SI influenced by class? YES
kruskal.test(RR~ClassFocal,data = DJL_follows)
DJL_follows %>% ggplot(aes(ClassFocal,RR))+geom_boxplot()
wilcox.test(travelled~class, data = test, exact = FALSE, correct = FALSE, conf.int = FALSE)
aov_SI<- aov(RR~ClassFocal,data = DJL_follows)

summary(aov_SI)
autoplot(aov_SI)

### avg speed influenced by class? YES
kruskal.test(speed~ClassFocal,data = DJL_follows)
DJL_follows %>% ggplot(aes(ClassFocal,speed))+geom_boxplot()

### avg speed influenced by class? YES
kruskal.test(fruittreecount~ClassFocal,data = DJL_follows)
DJL_follows %>% ggplot(aes(ClassFocal,fruittreecount))+geom_boxplot()
summary(glm(fruittreecount ~ ClassFocal, family=poisson,data = DJL_follows))


### avg time lags influenced by class?
summary(DJL_follows$numOfPoints)
histogram(DJL_follows$numOfPoints)


#### DJL table overview for every age class
table_overview_DJLdata_class<- DJL_follows %>% group_by("class"=ClassFocal) %>% summarise("# follows"=n(),
            "age" =as.character(round(mean(ageFromDOB,na.rm=TRUE),1)),
            "offsp. age" =as.character(round(mean(ageOfCurrentOffspring,na.rm=TRUE),1)), 
            "DJL*" =paste0(as.character(round(mean(DJL,na.rm=TRUE))),"±",as.character(round(sd(DJL,na.rm=TRUE)))), 
            "TDD*" =paste0(as.character(round(mean(TDD,na.rm=TRUE))),"±",as.character(round(sd(TDD,na.rm=TRUE)))),
            "SI" =paste0(as.character(round(mean(RR,na.rm=TRUE),2)),"±",as.character(round(sd(RR,na.rm=TRUE),2))),
            "Sinuosity" =paste0(as.character(round(mean(trj_sinuosity,na.rm=TRUE),2)),"±",as.character(round(sd(trj_sinuosity,na.rm=TRUE),2))),
            "speed**"=paste0(as.character(round(mean(speed,na.rm=TRUE),3)),"±",as.character(round(sd(RR,na.rm=TRUE),2))),
            "length gps derived" =as.character(as.character(hms::as_hms(round(mean(gps_followlength,na.rm=TRUE))))),
            "original length" =as.character(as.character(hms::as_hms(round(mean(as.numeric(original_followlength),na.rm=TRUE))))),
            "turn angle***" =as.character(round(mean(turningAngleSum,na.rm=TRUE),0)),
            "trees" =as.character(round(mean(fruittreecount,na.rm=TRUE)),1),
            "points"=as.character(round(mean(numOfPoints,na.rm=TRUE),1)),
            "sampling rate" =as.character(as.character(hms::as_hms(round(mean(meanTimelag,na.rm=TRUE)))))) %>% 
  arrange(desc(class))
view(table_overview_DJLdata_class)

#-latex output
print(xtable(table_overview_DJLdata_class, type = "latex",caption=c("Overview of travel distance data")), include.rownames = FALSE, booktabs = TRUE, file = "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/tables/table_overview_DJLdata_class_2.tex")


#### DJL table overview full for every focal
table_overview_DJLdata_focal<- DJL_follows %>% 
  group_by(focal,"class"=ClassFocal) %>% 
  summarise("# follows"=n(),
            "age" =as.character(round(mean(ageFromDOB,na.rm=TRUE),1)),
            "offsp. age" =as.character(round(mean(ageOfCurrentOffspring,na.rm=TRUE),1)), 
            "DJL*" =paste0(as.character(round(mean(DJL,na.rm=TRUE))),"±",as.character(round(sd(DJL,na.rm=TRUE)))), 
            "TDD*" =paste0(as.character(round(mean(TDD,na.rm=TRUE))),"±",as.character(round(sd(TDD,na.rm=TRUE)))),
            "SI" =paste0(as.character(round(mean(RR,na.rm=TRUE),2)),"±",as.character(round(sd(RR,na.rm=TRUE),2))),
            "Sinuosity" =paste0(as.character(round(mean(trj_sinuosity,na.rm=TRUE),2)),"±",as.character(round(sd(trj_sinuosity,na.rm=TRUE),2))),
            "speed**"=paste0(as.character(round(mean(speed,na.rm=TRUE),3)),"±",as.character(round(sd(RR,na.rm=TRUE),2))),
            "length" =as.character(as.character(hms::as_hms(round(mean(gps_followlength,na.rm=TRUE))))),
            "turn angle***" =as.character(round(mean(turningAngleSum,na.rm=TRUE),0)),
            "trees" =as.character(round(mean(fruittreecount,na.rm=TRUE)),1),
            "points"=as.character(round(mean(numOfPoints,na.rm=TRUE),1)),
            "sampling interv." =as.character(as.character(hms::as_hms(round(mean(meanTimelag,na.rm=TRUE)))))) %>% 
  arrange(desc(class))
view(table_overview_DJLdata_focal)

#-latex output
print(xtable(table_overview_DJLdata_focal, type = "latex"),include.rownames = FALSE, booktabs = TRUE, file = "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/tables/table_overview_DJLdata_focal_3.tex")


##### overview stats
DJL_follows %>% dplyr::select(DJL,meanTimelag,follow,focal,ageFromDOB,ageOfCurrentOffspring,ClassFocal,rain_eve,walevel_eve,watlevel_mo,rain_mo,avg_temp_tot,max_temp_average,min_temp_average,temp_max_mo,temp_min_mo,temp_max_eve,temp_min_eve,fai,monthYearDate,turningAngleSum,RR) %>% 
  keep(is.numeric) %>% 
  gather() %>% 
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free") +
    geom_histogram()

summary(SUAQ_rangepoints_11all20_loc[SUAQ_rangepoints_11all20_loc$ClassFocal=="adult female",]$timelag)




```

```{r glm's DJL RR,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}

## GLM #####
### DJL models


# lm see autoplot ?
lm<-
  lm(
    DJL ~ 
      ClassFocal,
    data = DJL_follows
  )
autoplot(lm)
summary(lm)

#### Focal as an effect DJL
DJL_follows_naomit_full<- DJL_follows %>% dplyr::select(DJL,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount) %>% na.omit()
glm_full <-lmer(DJL ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ClassFocal +  (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_full_plusfruittreecount <-lmer(DJL ~ ClassFocal+(1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_full_randomeffects <-lmer(DJL ~ (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_full
  )
anova(glm_full_plusfruittreecount,glm_full_randomeffects)
summary(glm_full_plusfruittreecount)
drop1(glm_full_plusfruittreecount)

#### Focal as an effect RR
RR_follows_naomit_full<- DJL_follows %>% dplyr::select(RR,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount) %>% na.omit() 
glm_full <-lmer(RR ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ClassFocal +  (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = RR_follows_naomit_full
  )
glm_full_plusfruittreecount <-lmer(RR ~ ClassFocal+(1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = RR_follows_naomit_full
  )
glm_full_randomeffects <-lmer(RR ~ (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = RR_follows_naomit_full
  )
anova(glm_full_plusfruittreecount,glm_full_randomeffects)
summary(glm_full_plusfruittreecount)
drop1(glm_full_plusfruittreecount)



#### Random effects single glm
DJL_follows_naomit_mother <- DJL_follows %>% ungroup() %>%  dplyr::select(DJL,ageFromDOB,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, ageOfCurrentOffspring, monthYearDate,focal,meanTimelag,numOfPoints,turningAngleSum) %>% na.omit() # That should be only mothers

lm_monthYearDate <- lm(DJL~ monthYearDate,DJL_follows)
lm_ageOfCurrent <- lm(DJL~ ageOfCurrentOffspring,DJL_follows)
lm_meanTimelag <- lm(DJL~ meanTimelag,DJL_follows)


#### Testing significance of random effects
lmer_numOfPoints <- lmer(DJL~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot + fai + ageOfCurrentOffspring +(1 | numOfPoints),DJL_follows_naomit_mother,REML=FALSE)
lmer_meanTimelag <- lmer(DJL~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageOfCurrentOffspring +(1 | meanTimelag),DJL_follows_naomit_mother,REML=FALSE)
lmer_monthYearDate <- lmer(DJL~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot 
                           + fai + ageOfCurrentOffspring +(1 | monthYearDate),DJL_follows_naomit_mother,REML=FALSE)
lmer_focal <- lmer(DJL~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageOfCurrentOffspring +(1 | focal),DJL_follows_naomit_mother,REML=FALSE)

lm_selected <- lm(DJL~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageOfCurrentOffspring,DJL_follows_naomit_mother,REML=FALSE)
anova(lmer_numOfPoints,lmer_meanTimelag,lmer_monthYearDate,lmer_focal,lm_selected) ## two sequential tests


#### Testing full vs. empty model
glm_selected <- lmer(DJL~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageOfCurrentOffspring + ageFromDOB +(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_naomit_mother)
glm_selected_ageInteraction <- lmer(DJL~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot + ageFromDOB + fai + ageOfCurrentOffspring +(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_naomit_mother)
glm_randomEffects <- lmer(DJL~ (1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_naomit_mother)
anova(glm_selected,glm_randomEffects)
anova(glm_selected)
coefs <- data.frame(coef(summary(glm_selected)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

### Full model mit NA's
DJL_follows_naomit_full<- DJL_follows %>% dplyr::select(ageFromDOB,DJL,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount) %>% na.omit()
glm_full <-lmer(DJL ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ClassFocal + ageFromDOB+  (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_full_plusfruittreecount <-lmer(DJL ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai +ClassFocal + ageFromDOB+ fruittreecount + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_full_randomeffects <-lmer(DJL ~ (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_full
  )
anova(glm_full,glm_full_randomeffects)
drop1(glm_full)
vif.mer(glm_full)

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_full)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

##### Testing: Add Age of Focal
DJL_follows_naomit_age <- DJL_follows %>% dplyr::select(ageFromDOB,DJL,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, ageOfCurrentOffspring, monthYearDate,focal,meanTimelag,numOfPoints) %>% na.omit()
glm_full_age <-lmer(DJL ~ fai+ ClassFocal + ageFromDOB  + ageOfCurrentOffspring +rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_age
  )
glm_only_age <-lmer(DJL ~ ageFromDOB*ageOfCurrentOffspring + (1 | monthYearDate) + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_age
  )
glm_randomEffects <- lmer(DJL~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_naomit_age)

anova(glm_full_age)
anova(glm_only_age,glm_randomEffects)



### Stepwise selection
DJL_follows_naomit_step <- DJL_follows %>% dplyr::select(ageFromDOB,DJL,rain_eve, walevel_eve,watlevel_mo,max_temp_average,min_temp_average,temp_max_mo, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount) %>% na.omit()
glm_step <-lmer(DJL ~ rain_eve + rain_mo + watlevel_mo + walevel_eve + max_temp_average + min_temp_average 
                    +temp_max_mo+temp_min_mo+avg_temp_tot + ClassFocal + fai +meanTimelag  +fruittreecount+ (1 | monthYearDate)
                    + (1 | focal) , # random effects to correct for
  data = DJL_follows_naomit_step
  )

ranova(glm_step)
step_result_backward<- step(glm_step)
get_model(step_result_backward,direction="backward")

step_result_forward<- step(glm_step,direction="forward")
get_model(step_result_forward)

#### backward
glm_best_backward <-lmer(DJL ~ rain_mo + walevel_eve + max_temp_average + min_temp_average +  
    avg_temp_tot + ClassFocal + meanTimelag + fruittreecount +      (1 | monthYearDate), # random effects to correct for
  data = DJL_follows
  )

##### Create P values for lm
summary(glm_best_backward)
coefs <- data.frame(coef(summary(glm_best_backward)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

vif.mer(glm_best_backward)

#### forward
glm_best_forward <-lmer(DJL ~ rain_mo + walevel_eve + max_temp_average + min_temp_average +  
    avg_temp_tot + ClassFocal + meanTimelag + fruittreecount +      (1 | monthYearDate), # random effects to correct for
  data = DJL_follows
  )

##### Create P values for lm
summary(glm_best_forward)
coefs <- data.frame(coef(summary(glm_best_forward)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs
vif.mer(glm_best_backward)

##### Best model plus fai
glm_best_plusFAI <-lmer(DJL ~ max_temp_average + min_temp_average + avg_temp_tot + ageOfCurrentOffspring + (1 | monthYearDate)
                    + (1 | focal), # random effects to correct for
  data = DJL_follows
  )


##### Create P values for lm
summary(glm_best_plusFAI)
coefs <- data.frame(coef(summary(glm_best_plusFAI)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs
vif.mer(glm_best_plusFAI)


### Manual deletion of effects
glm3 <-lmer(DJL ~ rain_eve + rain_mo + watlevel_mo + walevel_eve + max_temp_average + min_temp_average 
                    +temp_max_mo+temp_min_mo+avg_temp_tot + ClassFocal + fai +ageOfCurrentOffspring + (1 | monthYearDate)
                    + (1 | focal), # random effects to correct for
  data = DJL_follows
  )
glm4 <-lmer(DJL ~ rain_eve*walevel_eve + rain_mo*watlevel_mo + max_temp_average + min_temp_average 
                    +temp_max_mo+temp_min_mo+avg_temp_tot + ClassFocal*ageOfCurrentOffspring + fai + (1 | monthYearDate)
                    + (1 | focal), # random effects to correct for
  data = DJL_follows
  )
anova(glm1,  glm4)



autoplot(glm_rainfall)

install.packages("mulcomp")
library(multcomp)
cftest
pt(q=2.361, df=315, lower.tail=FALSE)
df.residual(glm_rainfall)
summary(glm_rainfall)
anova(glm_rainfall)

ctable <- coef(summary(glm_rainfall))
pvals <- pt(abs(ctable[, "t value"]), df.residual(glm_rainfall), lower.tail = FALSE)
cbind(ctable, pvals)

qqnorm(resid(glm_rainfall))

##### Weather which variable is most explained by the other variables





### Tortuosity: Rambling Ratios
#### Random effects single glm
DJL_follows_naomit_rr <- DJL_follows %>% ungroup() %>%  dplyr::select(RR,ageFromDOB,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, ageOfCurrentOffspring, monthYearDate,focal,meanTimelag,numOfPoints) %>% na.omit() # only mothers are considered because they have offspring


#### Testing significance of random effects
lmer_RR_numOfPoints <- lmer(RR~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageOfCurrentOffspring +(1 | numOfPoints),DJL_follows_naomit_rr,REML=FALSE)

lmer_RR_meanTimelag <- lmer(RR~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageOfCurrentOffspring +(1 | meanTimelag),DJL_follows_naomit_rr,REML=FALSE)

lmer_RR_monthYearDate <- lmer(RR~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot + fai + ageOfCurrentOffspring +(1 | monthYearDate),DJL_follows_naomit_rr,REML=FALSE)

lmer_RR_focal <- lmer(RR~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot +  fai + ageOfCurrentOffspring +(1 | focal),DJL_follows_naomit_rr,REML=FALSE)

lm_RR_selected <- lm(RR~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot +  fai + ageOfCurrentOffspring,DJL_follows_naomit_rr,REML=FALSE)

anova(lmer_RR_numOfPoints,lmer_RR_meanTimelag,lmer_RR_monthYearDate,lmer_RR_focal,lm_RR_selected) ## two sequential tests

#### Testing full vs. empty model
glm_RR_selected <- lmer(RR~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot +  fai + ageOfCurrentOffspring + ageFromDOB +(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_naomit_rr)
glm_RR_selected_ageInteraction <- lmer(RR~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot +  fai + ageOfCurrentOffspring*ageFromDOB +(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_naomit_rr)
glm_RR_randomEffects <- lmer(RR~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_naomit_rr)
anova(glm_RR_selected,glm_RR_selected_ageInteraction,glm_RR_randomEffects)

### Full model mit NA's
glm_full <-lmer(RR ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot + ClassFocal + fai + ageOfCurrentOffspring + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows
  )
anova(glm_full)
drop1(glm_full)
vif.mer(glm_full)

##### Age of Focal
DJL_follows_naomit_age <- DJL_follows %>% dplyr::select(ageFromDOB,DJL,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, ageOfCurrentOffspring, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount) %>% na.omit()
glm_full_age <-lmer(DJL ~ fai+  ageFromDOB  + ageOfCurrentOffspring +rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_age
  )
glm_only_age <-lmer(DJL ~ ageFromDOB*ageOfCurrentOffspring + (1 | monthYearDate) + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_age
  )
glm_randomEffects <- lmer(DJL~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_naomit_age)

anova(glm_full_age)
anova(glm_full_age,glm_only_age,glm_randomEffects)

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_full)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs



### Tortuosity: Turning Angle
glm_turningangle_full <-lmer(turningAngleSum ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageOfCurrentOffspring + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_mother
  )

glm_turningangle_empty <-lmer(turningAngleSum ~ (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_mother
  )
anova(glm_turningangle_full,glm_turningangle_empty)
drop1(glm_full)
vif.mer(glm_full)


### Analysing explanation of how many fruit trees are visited and RR of only fruit tree route
#### FRUITTREECOUNT: Female model ohne NA's in CurrentOffspring
DJL_follows_females_trees <- DJL_follows %>% dplyr::select(ageFromDOB,tree_RR,tree_DJL,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, ageOfCurrentOffspring, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount) %>% na.omit()

glm_full_fruittrees_females <-lmer(fruittreecount ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageFromDOB+ageOfCurrentOffspring  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_females_trees
  )
glm_significant_fruittrees_females <-lmer(fruittreecount ~ avg_temp_tot + ageFromDOB  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_females_trees
  )
glm_randomeffects_fruittrees_females <- lmer(fruittreecount~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_females_trees)

anova(glm_full_fruittrees_females,glm_significant_fruittrees_females,glm_randomeffects_fruittrees_females)
drop1(glm_full_fruittrees_females)
vif.mer(glm_full_fruittrees_females)

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_full_fruittrees_females)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

### TREE - DJL: Analysing explanation of how many fruit trees are visited and RR of only fruit tree route
### Female model ohne NA's in CurrentOffspring

glm_full_DJLtree_females <-lmer(tree_DJL ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageFromDOB+ageOfCurrentOffspring  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_females_trees
  )
glm_randomeffects_DJLtree_females <- lmer(tree_DJL~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_females_trees)

anova(glm_full_DJLtree_females,glm_randomeffects_DJLtree_females)
drop1(glm_full_DJLtree_females)
vif.mer(glm_full_DJLtree_females)

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_full_DJLtree_females)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

### TREE - RR: Analysing explanation of how many fruit trees are visited and RR of only fruit tree route
### Female model ohne NA's in CurrentOffspring

glm_full_RRtree_females <-lmer(tree_RR ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageFromDOB+ageOfCurrentOffspring  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_females_trees
  )
glm_randomeffects_RRtree_females <- lmer(tree_RR~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_females_trees)

anova(glm_full_RRtree_females,glm_randomeffects_RRtree_females)
drop1(glm_full_RRtree_females)
vif.mer(glm_full_RRtree_females)

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_full_RRtree_females)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs


#### FRUITTREECOUNT: Full model without currentOffspring
DJL_follows_trees <- DJL_follows %>% dplyr::select(ageFromDOB,tree_RR,tree_DJL,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount) %>% na.omit()

glm_full_fruittrees <-lmer(fruittreecount ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageFromDOB  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_trees
  )
glm_significant_fruittrees <-lmer(fruittreecount ~ avg_temp_tot + ageFromDOB  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_trees
  )
glm_randomeffects_fruittrees <- lmer(fruittreecount~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_trees)

anova(glm_full_fruittrees,glm_significant_fruittrees,glm_randomeffects_fruittrees)
drop1(glm_full_fruittrees)
vif.mer(glm_full_fruittrees)

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_full_fruittrees)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

### TREE - DJL: Analysing explanation of how many fruit trees are visited and RR of only fruit tree route
### Female model ohne NA's in CurrentOffspring

glm_full_DJLtree <-lmer(tree_DJL ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageFromDOB  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_trees
  )
glm_randomeffects_DJLtree <- lmer(tree_DJL~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_trees)

anova(glm_full_DJLtree,glm_randomeffects_DJLtree)
drop1(glm_full_DJLtree)
vif.mer(glm_full_DJLtree)

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_full_DJLtree)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

### TREE - RR: Analysing explanation of how many fruit trees are visited and RR of only fruit tree route
### Female model ohne NA's in CurrentOffspring

glm_full_RRtree <-lmer(tree_RR ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageFromDOB  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_trees
  )
glm_randomeffects_RRtree <- lmer(tree_RR~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_trees)
glm_significant_RRtree <-lmer(tree_RR ~ avg_temp_tot + ageFromDOB  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_trees
  )
anova(glm_full_RRtree,glm_significant_RRtree,glm_randomeffects_RRtree)
drop1(glm_full_RRtree_females)
vif.mer(glm_full_RRtree_females)

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_full_RRtree)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs


#### Fruitttreecount
```

```{r Final glm's DJL,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
###### ###### ###### ###### ###### ###### ###### ###### ###### ###### 
###### CLEAN AND FINAL LIST OF MODELS FOR SIMPLE DJL analysis ###### 
###### ###### ###### ###### ###### ###### ###### ###### ###### ###### 
DJL_follows_naomit_full<- DJL_follows %>% dplyr::select(DJL,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,monthname,rainyseason,tot_rain_before,mmax_temp_before,month) %>% na.omit()
DJL_follows_naomit_age<- DJL_follows %>% dplyr::select(DJL,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,monthname,rainyseason,ageFromDOB,tot_rain_before,mmax_temp_before,month) %>% na.omit()
DJL_follows_naomit_mother<- DJL_follows %>% dplyr::select(DJL,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,ageFromDOB, ageOfCurrentOffspring,monthname,rainyseason,tot_rain_before,mmax_temp_before,month) %>% na.omit()


###### DAY JOURNEY LENGTH
#### Check influence of sampling rate
lm_DJL_samplingrate <-lm(log(DJL) ~ meanTimelag , # random effects to correct for
  data = DJL_follows_naomit_full
  )
summary(lm_DJL_samplingrate)
autoplot(lm_DJL_samplingrate)
spearman_samplingrateONdjl<- cor.test(DJL_follows_naomit_full$DJL, DJL_follows_naomit_full$meanTimelag,  method = "spearman") # not normally distributed variables
spearman_samplingrateONdjl

#### Check influence of month
lm_DJL_month <-lmer(DJL ~  month + (1 |as.character(year(ym(monthYearDate)))), # random effects to correct for
  data = DJL_follows_naomit_full
  )
summary(lm_DJL_month)
r.squaredGLMM(lm_DJL_month)

#### Check influence of different random effects
lm_DJL_empty <-lm(DJL ~ 1, # random effects to correct for
  data = DJL_follows_naomit_full
  )
lmm_DJL_monthYearDate <-lmer(DJL ~ (1 | monthYearDate), # random effects to correct for
  data = DJL_follows_naomit_full
  )
lmm_DJL_month <-lmer(DJL ~ (1 | monthname), # random effects to correct for
  data = DJL_follows_naomit_full
  )
lmm_DJL_focal <-lmer(DJL ~ (1 | focal) , # random effects to correct for
  data = DJL_follows_naomit_full
  )

lmm_DJL_ClassFocal <-lmer(DJL ~ (1 | ClassFocal), # random effects to correct for
  data = DJL_follows_naomit_full
  )

lmm_DJL_focalANDmonthyear <-lmer(DJL ~ (1 | monthYearDate)+(1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )

lmm_DJL_focalANDClassFocal<-lmer(DJL ~ (1 | focal)+  (1 | ClassFocal), # random effects to correct for
  data = DJL_follows_naomit_full
  )

lmm_DJL_monthyearANDClassFocal<-lmer(DJL ~ (1 | monthYearDate)+  (1 | ClassFocal), # random effects to correct for
  data = DJL_follows_naomit_full
  )

lmm_DJL_allrandom<-lmer(DJL ~ (1 | monthYearDate)+  (1 | ClassFocal)+(1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )

lrtest(lm_DJL_empty,lmm_DJL_monthYearDate,lmm_DJL_focal,lmm_DJL_ClassFocal,lmm_DJL_focalANDmonthyear,lmm_DJL_focalANDClassFocal,lmm_DJL_monthyearANDClassFocal,lmm_DJL_allrandom)
anova(lmm_DJL_monthYearDate,lmm_DJL_focal,lmm_DJL_ClassFocal,lmm_DJL_focalANDmonthyear,lmm_DJL_focalANDClassFocal,lmm_DJL_monthyearANDClassFocal,lmm_DJL_allrandom,lmm_DJL_month)

#### Collect monthyeardate and focal as random effects because of the lowest AIC
icc(lmm_DJL_focal) # 9% of correlation within focal follows.
icc(lmm_DJL_monthYearDate) # 11% of correlation within month year dates groups follows. 


#### Full models for all class focal
glm_DJL_full <-lmer(DJL ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo+ temp_max_eve + temp_max_mo + avg_temp_tot   + fai + ClassFocal+meanTimelag+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_DJL_selected <-lmer(DJL ~ rain_eve + walevel_eve +rain_mo +  avg_temp_tot   + fai + ClassFocal + meanTimelag+ (1 | focal) + (1 | monthYearDate) , # random effects to correct for
  data = DJL_follows_naomit_full
  )
summary(glm_DJL_selected)
glm_DJL_selected_noMonthCorrection <-lmer(DJL ~ rain_eve  + rain_mo +  avg_temp_tot   + fai + ClassFocal + meanTimelag  + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_DJL_selected_weatherbefore <-lmer(DJL ~ rain_eve  + rain_mo + tot_rain_before + mmax_temp_before+  avg_temp_tot   + fai + ClassFocal + meanTimelag + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  ) 
glm_DJL_selected_noCF <-lmer(DJL ~ rain_eve  + rain_mo +  avg_temp_tot   + fai  + meanTimelag + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_DJL_timelag <-lmer(DJL ~ meanTimelag+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_DJL_age <-lmer(DJL ~ ageFromDOB+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_age
  )
summary(glm_DJL_age)
glm_DJL_season <-lmer(DJL ~ rainyseason+ (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
summary(glm_DJL_season)
glm_DJL_selected_weather <-lmer(DJL ~ rain_eve +walevel_eve+  avg_temp_tot + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_DJL_selected_fullrandom <-lmer(DJL ~ rain_eve+walevel_eve  + rain_mo + temp_min_eve + temp_min_mo+  avg_temp_tot   + fai + (1|ClassFocal) + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_DJL_selected_waterlev <-lmer(DJL ~ walevel_eve + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_DJL_selected_backward <-lmer(DJL ~  walevel_eve + rain_mo + temp_min_eve + avg_temp_tot  + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_DJL_selected_weather <-lmer(DJL ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo+  avg_temp_tot   + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_DJL_selected_fai <-lmer(DJL ~  fai +(1|ClassFocal)+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_DJL_selected_ClassFocal <-lmer(DJL ~  ClassFocal+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_full_randomeffects <-lmer(log(DJL) ~ (1 | monthYearDate)+ (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
lmm_DJL_focalANDmonthyear <-lmer(DJL ~ (1 | focal)+  (1 | monthYearDate), # random effects to correct for
  data = DJL_follows_naomit_full
  )
lrtest(lmm_DJL_focalANDmonthyear,glm_DJL_selected)
anova( lmm_DJL_focalANDmonthyear,glm_DJL_full,glm_DJL_selected)
vif.mer(glm_DJL_selected)
summary(glm_DJL_selected)
summary(glm_DJL_selected_waterlev)
ranova(glm_DJL_selected)
icc(glm_DJL_selected_waterlev)
icc(glm_DJL_selected)
qqnorm(residuals(glm_full_randomeffects))

#### Quick automatic selection
step_result_backward<- step(glm_DJL_full)
glm_DJL_selected_backward<- get_model(step_result_backward,direction="forward")
summary(glm_DJL_selected_backward)
vif.mer(glm_DJL_selected_backward)

#### testing with transformations
glm_DJL_selected_test <-glmer(log(DJL) ~ walevel_eve*avg_temp_tot   + fai + ClassFocal + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_DJL_selected_log <-glmer(log(DJL) ~ rain_eve + walevel_eve  + rain_mo + temp_min_eve + temp_min_mo+  avg_temp_tot   + fai + ClassFocal + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
DJL_follows_naomit_full %>% ggplot(aes((1/2)*log(DJL_follows_naomit_full$DJL)))+geom_histogram()

plot(glm_DJL_selected)
qqnorm(residuals(glm_DJL_selected_log)) # residuals not very normally distributed !! Problem?

###### DJL: Full models for females
lmm_DJL_females_AgeAge <-lmer(DJL ~ ageFromDOB+ageOfCurrentOffspring+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_mother
  )
lmm_DJL_females_empty<-lmer(DJL ~ (1 | focal)+  (1 | monthYearDate), # random effects to correct for
  data = DJL_follows_naomit_mother
  )
glm_DJL_females_empty <-lmer(DJL ~ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_mother
  )
glm_DJL_females_selected <-lmer(DJL ~ rain_eve  + rain_mo + walevel_eve +  avg_temp_tot   + fai+ageOfCurrentOffspring+ageFromDOB  + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_mother
  )
anova(lmm_DJL_females_empty,glm_DJL_females_selected)
summary(glm_DJL_females_selected)

###### OVERVIEW OF MODEL RESULTS
screenreg(list(lmm_DJL_focalANDmonthyear,glm_DJL_full,glm_DJL_selected,glm_DJL_females_empty,glm_DJL_females_selected),digits=5)
qqnorm(residuals(glm_DJL_selected))
sjPlot::tab_model(glm_DJL_selected, 
                  show.re.var= TRUE, 
                  pred.labels =c("(Intercept)", "Urchins", "Fish", "Depth"),
                  dv.labels= "Effects of Herbivores on Coral Cover")

###### TEXTREG --> LATEX EXPORT
r.squaredGLMM(glm_DJL_selected)
r.squaredGLMM(glm_DJL_females_selected)
texreg(list(lmm_DJL_focalANDmonthyear,glm_DJL_full,glm_DJL_selected,glm_DJL_females_empty,glm_DJL_females_selected),
          custom.model.names = c("Only random","Full","Selected","Only random females","Selected only females"),
          custom.coef.names = c("intercept","day rain","waterlevel evening", "night rain","minimum °C evening","minimum °C morning","maximum °C evening","maximum °C morning","average temperature", "FAI", "Class: flanged male", "Class: infant","Class: juvenile","Class: unflanged male","mean timelag","age of offspring","age"),
          return.string=TRUE,
          use.packages=FALSE,
          single.row=TRUE)


```

```{r Final glm's RR,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
###### ###### ###### ###### ###### ###### ###### ###### ###### ###### 
###### CLEAN AND FINAL LIST OF MODELS FOR SIMPLE MOVEMENT ANALYSIS ##
###### ###### ###### ###### ###### ###### ###### ###### ###### ###### 
RR_follows_naomit_full<- DJL_follows %>% dplyr::select(RR,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,monthname,rainyseason,month) %>% na.omit()
RR_follows_naomit_full_age<- DJL_follows %>% dplyr::select(RR,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,monthname,rainyseason,ageFromDOB) %>% na.omit()
RR_follows_naomit_mother<- DJL_follows %>% dplyr::select(RR,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,ageFromDOB, ageOfCurrentOffspring,monthname,rainyseason,) %>% na.omit()
RR_follows_naomit_full_historyweather<- DJL_follows %>% dplyr::select(RR,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,monthname,rainyseason,tot_rain_before,mmax_temp_before) %>% na.omit()
RR_follows_naomit_mother_historyweather<- DJL_follows %>% dplyr::select(RR,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,ageFromDOB, ageOfCurrentOffspring,monthname,rainyseason,tot_rain_before,mmax_temp_before) %>% na.omit()


###### Tortuosity Straightness Index
#### Check influence of sampling rate
lm_RR_samplingrate <-lm(RR ~ meanTimelag , # random effects to correct for
  data = RR_follows_naomit_full
  )
summary(lm_RR_samplingrate)
autoplot(lm_RR_samplingrate)
spearman_samplingrateONdjl<- cor.test(RR_follows_naomit_full$RR, RR_follows_naomit_full$meanTimelag,  method = "spearman") # not normally distributed variables
spearman_samplingrateONdjl

#### Check influence of month
RR_follows_naomit_full <- RR_follows_naomit_full %>% mutate(year=as.character(year(ym(monthYearDate))))
lm_RR_month <-lmer(RR ~  month + (1 | year), # random effects to correct for
  data = RR_follows_naomit_full
  )
summary(lm_RR_month)
r.squaredGLMM(lm_RR_month)

#### Check influence of different random effects
lm_RR_empty <-lm(RR ~ 1, # random effects to correct for
  data = RR_follows_naomit_full
  )
lmm_RR_monthYearDate <-lmer(RR ~ (1 | monthYearDate), # random effects to correct for
  data = RR_follows_naomit_full
  )
lm_RR_monthYearDate <-lm(RR ~ monthYearDate, # random effects to correct for
  data = RR_follows_naomit_full
  )
lmm_RR_month <-lmer(RR ~ (1 | monthname), # random effects to correct for
  data = RR_follows_naomit_full
  )
lmm_RR_focal <-lmer(RR ~ (1 | focal) , # random effects to correct for
  data = RR_follows_naomit_full
  )

lmm_RR_ClassFocal <-lmer(RR ~ (1 | ClassFocal), # random effects to correct for
  data = RR_follows_naomit_full
  )

lmm_RR_focalANDmonthyear <-lmer(RR ~ (1 | focal)+  (1 | monthYearDate), # random effects to correct for
  data = RR_follows_naomit_full
  )

lmm_RR_focalANDClassFocal<-lmer(RR ~ (1 | focal)+  (1 | ClassFocal), # random effects to correct for
  data = RR_follows_naomit_full
  )

lmm_RR_monthyearANDClassFocal<-lmer(RR ~ (1 | monthYearDate)+  (1 | ClassFocal), # random effects to correct for
  data = RR_follows_naomit_full
  )

lmm_RR_allrandom<-lmer(RR ~ (1 | monthYearDate)+  (1 | ClassFocal)+(1 | focal), # random effects to correct for
  data = RR_follows_naomit_full
  )
hist(DJL_follows$trj_sinuosity)
lrtest(lm_RR_empty,lmm_RR_monthYearDate,lmm_RR_focal,lmm_RR_ClassFocal)
anova(lmm_RR_monthYearDate,lmm_RR_focal,lmm_RR_ClassFocal,lmm_RR_focalANDmonthyear,lmm_RR_focalANDClassFocal,lmm_RR_monthyearANDClassFocal,lmm_RR_allrandom,lmm_RR_month)

#### Collect monthyeardate and focal as random effects because of the lowest AIC
icc(lmm_RR_focal) # 9% of correlation within focal follows.
icc(lmm_RR_monthYearDate) # 11% of correlation within month year dates groups follows. 


#### Full models for all class focal
glm_RR_full <-lmer(RR ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo+ temp_max_eve + temp_max_mo + avg_temp_tot   + fai + ClassFocal+  (1 | monthYearDate)+ (1 | focal), # random effects to correct for
  data = RR_follows_naomit_full
  )
summary(glm_RR_full)
glm_RR_selected <-lmer(RR ~ rain_eve  + rain_mo +  avg_temp_tot  +walevel_eve + fai + ClassFocal  +  (1 | monthYearDate) +(1 | focal), # random effects to correct for
  data = RR_follows_naomit_full
  )
summary(glm_RR_selected)
glm_RR_selected_age <-lmer(RR ~ rain_eve  + rain_mo +  avg_temp_tot   + fai + ClassFocal  + ageFromDOB+ (1 | monthYearDate) +(1 | focal), # random effects to correct for
  data = RR_follows_naomit_full_age
  )
summary(glm_RR_selected_age)
glm_RR_timelag <-lmer(RR ~ meanTimelag+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = RR_follows_naomit_full
  )
summary(glm_RR_timelag)
glm_RR_season <-lmer(RR ~ rainyseason+ (1 | focal), # random effects to correct for
  data = RR_follows_naomit_full
  )
summary(glm_RR_season)
glm_RR_selected_weather <-lmer(RR ~ rain_eve +walevel_eve+  avg_temp_tot + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = RR_follows_naomit_full
  )
summary(glm_RR_selected_weather)
glm_RR_selected_weather_before <-lmer(RR ~ rain_eve +tot_rain_before+  mmax_temp_before + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = RR_follows_naomit_full_historyweather
  )
summary(glm_RR_selected_weather)
glm_RR_selected_fullrandom <-lmer(RR ~ rain_eve+walevel_eve  + rain_mo + temp_min_eve + temp_min_mo+  avg_temp_tot   + fai + (1|ClassFocal) + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = RR_follows_naomit_full
  )
summary(glm_RR_selected_fullrandom)
glm_RR_selected_waterlev <-lmer(RR ~ walevel_eve + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = RR_follows_naomit_full
  )
summary(glm_RR_selected_waterlev)
glm_RR_selected_backward <-lmer(RR ~  walevel_eve + rain_mo + temp_min_eve + avg_temp_tot  + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = RR_follows_naomit_full
  )
summary(glm_RR_selected_backward)
glm_RR_selected_weather <-lmer(RR ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo+  avg_temp_tot   + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = RR_follows_naomit_full
  )
summary(glm_RR_selected_weather)
glm_RR_selected_fai <-lmer(RR ~  fai +(1|ClassFocal)+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = RR_follows_naomit_full
  )
summary(glm_RR_selected_fai)
glm_RR_selected_ClassFocal <-lmer(RR ~  ClassFocal+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = RR_follows_naomit_full
  )
summary(glm_RR_selected_ClassFocal)
glm_full_randomeffects <-lmer(log(RR) ~ (1 | monthYearDate)+ (1 | focal), # random effects to correct for
  data = RR_follows_naomit_full
  )
summary(glm_full_randomeffects)
lmm_RR_focalANDmonthyear <-lmer(RR ~ (1 | focal)+  (1 | monthYearDate), # random effects to correct for
  data = RR_follows_naomit_full
  )
summary(lmm_RR_focalANDmonthyear)
anova(glm_RR_full,lmm_RR_focalANDmonthyear,glm_RR_selected_waterlev,glm_RR_selected)
vif.mer(glm_RR_selected)
summary(glm_RR_selected)
summary(glm_RR_selected_waterlev)
ranova(glm_RR_selected)
icc(glm_RR_selected_waterlev)
icc(glm_RR_selected)
qqnorm(residuals(glm_full_randomeffects))

#### Quick automatic selection
step_result_backward<- step(glm_RR_full)
glm_RR_selected_backward<- get_model(step_result_backward,direction="backward")
summary(glm_RR_selected_backward)
vif.mer(glm_RR_selected_backward)

#### testing with transformations
glm_DJL_selected_test <-glmer(log(DJL) ~ walevel_eve*avg_temp_tot   + fai + ClassFocal + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_DJL_selected_log <-glmer(log(DJL) ~ rain_eve + walevel_eve  + rain_mo + temp_min_eve + temp_min_mo+  avg_temp_tot   + fai + ClassFocal + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
DJL_follows_naomit_full %>% ggplot(aes((1/2)*log(DJL_follows_naomit_full$DJL)))+geom_histogram()

plot(glm_DJL_selected)
qqnorm(residuals(glm_DJL_selected_log)) # residuals not very normally distributed !! Problem?

###### RR: Full models for females
lmm_RR_females_AgeAge <-lmer(RR ~ ageFromDOB+ageOfCurrentOffspring+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = RR_follows_naomit_mother
  )
lmm_RR_females_empty<-lmer(RR ~ (1 | focal)+  (1 | monthYearDate), # random effects to correct for
  data = RR_follows_naomit_mother
  )
glm_RR_females_selected <-lmer(RR ~ rain_eve  + rain_mo + walevel_eve +  avg_temp_tot   + fai+ageOfCurrentOffspring+ageFromDOB  + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = RR_follows_naomit_mother
  )
anova(lmm_RR_females_empty,glm_RR_females_selected)
summary(glm_RR_females_selected)

r.squaredGLMM(glm_RR_selected)
r.squaredGLMM(glm_RR_females_selected)

###### OVERVIEW OF MODEL RESULTS
screenreg(list(lmm_RR_focalANDmonthyear,glm_RR_selected,lmm_RR_females_empty,glm_RR_females_selected),digits=5)
qqnorm(residuals(glm_RR_selected))
sjPlot::tab_model(glm_RR_selected, 
                  show.re.var= TRUE, 
                  pred.labels =c("(Intercept)", "Urchins", "Fish", "Depth"),
                  dv.labels= "Effects of Herbivores on Coral Cover")

###### TEXTREG --> LATEX EXPORT

texreg(list(lmm_RR_focalANDmonthyear,glm_RR_selected,lmm_RR_females_empty,glm_RR_females_selected),
       digits=5,
          custom.model.names = c("Only random","Selected","Only random females","Selected only females"),
          custom.coef.names = c("intercept","day rain", "night rain","average temperature", "FAI", "Class: flanged male", "Class: infant","Class: juvenile","Class: unflanged male","waterlevel evening","age of offspring","age"),
          return.string=TRUE,
          use.packages=FALSE,
          single.row=TRUE)


```

```{r Final glm's TDD,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
###### ###### ###### ###### ###### ###### ###### ###### ###### ###### 
###### CLEAN AND FINAL LIST OF MODELS FOR SIMPLE MOVEMENT ANALYSIS ##
###### ###### ###### ###### ###### ###### ###### ###### ###### ###### 
TDD_follows_naomit_full<- DJL_follows %>% dplyr::select(TDD,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,monthname,rainyseason,month) %>% na.omit()
TDD_follows_naomit_full_age<- DJL_follows %>% dplyr::select(TDD,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,monthname,rainyseason,ageFromDOB) %>% na.omit()
TDD_follows_naomit_mother<- DJL_follows %>% dplyr::select(TDD,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,ageFromDOB, ageOfCurrentOffspring,monthname,rainyseason,) %>% na.omit()
TDD_follows_naomit_full_historyweather<- DJL_follows %>% dplyr::select(TDD,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,monthname,rainyseason,tot_rain_before,mmax_temp_before) %>% na.omit()
TDD_follows_naomit_mother_historyweather<- DJL_follows %>% dplyr::select(TDD,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,ageFromDOB, ageOfCurrentOffspring,monthname,rainyseason,tot_rain_before,mmax_temp_before) %>% na.omit()


###### Tortuosity Straightness Index
#### Check influence of sampling rate
lm_TDD_samplingrate <-lm(TDD ~ meanTimelag , # random effects to correct for
  data = TDD_follows_naomit_full
  )
summary(lm_TDD_samplingrate)
autoplot(lm_TDD_samplingrate)
spearman_samplingrateONdjl<- cor.test(TDD_follows_naomit_full$TDD, TDD_follows_naomit_full$meanTimelag,  method = "spearman") # not normally distributed variables
spearman_samplingrateONdjl

#### Check influence of month
TDD_follows_naomit_full <- TDD_follows_naomit_full %>% mutate(year=as.character(year(ym(monthYearDate))))
lm_TDD_month <-lmer(TDD ~  year + (1 |  month), # random effects to correct for
  data = TDD_follows_naomit_full
  )
summary(lm_TDD_month)
r.squaredGLMM(lm_TDD_month)

#### Check influence of different random effects
lm_TDD_empty <-lm(TDD ~ 1, # random effects to correct for
  data = TDD_follows_naomit_full
  )
lmm_TDD_monthYearDate <-lmer(TDD ~ (1 | monthYearDate), # random effects to correct for
  data = TDD_follows_naomit_full
  )
lm_TDD_monthYearDate <-lm(TDD ~ monthYearDate, # random effects to correct for
  data = TDD_follows_naomit_full
  )
lmm_TDD_month <-lmer(TDD ~ (1 | monthname), # random effects to correct for
  data = TDD_follows_naomit_full
  )
lmm_TDD_focal <-lmer(TDD ~ (1 | focal) , # random effects to correct for
  data = TDD_follows_naomit_full
  )

lmm_TDD_ClassFocal <-lmer(TDD ~ (1 | ClassFocal), # random effects to correct for
  data = TDD_follows_naomit_full
  )

lmm_TDD_focalANDmonthyear <-lmer(TDD ~ (1 | focal)+  (1 | monthYearDate), # random effects to correct for
  data = TDD_follows_naomit_full
  )

lmm_TDD_focalANDClassFocal<-lmer(TDD ~ (1 | focal)+  (1 | ClassFocal), # random effects to correct for
  data = TDD_follows_naomit_full
  )

lmm_TDD_monthyearANDClassFocal<-lmer(TDD ~ (1 | monthYearDate)+  (1 | ClassFocal), # random effects to correct for
  data = TDD_follows_naomit_full
  )

lmm_TDD_allrandom<-lmer(TDD ~ (1 | monthYearDate)+  (1 | ClassFocal)+(1 | focal), # random effects to correct for
  data = TDD_follows_naomit_full
  )
hist(DJL_follows$trj_sinuosity)
lrtest(lm_TDD_empty,lmm_TDD_monthYearDate,lmm_TDD_focal,lmm_TDD_ClassFocal)
anova(lmm_TDD_monthYearDate,lmm_TDD_focal,lmm_TDD_ClassFocal,lmm_TDD_focalANDmonthyear,lmm_TDD_focalANDClassFocal,lmm_TDD_monthyearANDClassFocal,lmm_TDD_allrandom,lmm_TDD_month)

#### Collect monthyeardate and focal as random effects because of the lowest AIC
icc(lmm_TDD_focal) # 9% of correlation within focal follows.
icc(lmm_TDD_monthYearDate) # 11% of correlation within month year dates groups follows. 


#### Full models for all class focal
glm_TDD_full <-lmer(TDD ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo+ temp_max_eve + temp_max_mo + avg_temp_tot   + fai + ClassFocal+  (1 | monthYearDate)+ (1 | focal), # random effects to correct for
  data = TDD_follows_naomit_full
  )
summary(glm_TDD_full)
glm_TDD_selected <-lmer(TDD ~ rain_eve  + rain_mo +  avg_temp_tot   + fai + ClassFocal  +  (1 | monthYearDate) +(1 | focal), # random effects to correct for
  data = TDD_follows_naomit_full
  )
summary(glm_TDD_selected)
glm_TDD_selected_age <-lmer(TDD ~ rain_eve  + rain_mo +  avg_temp_tot   + fai + ClassFocal  + ageFromDOB+ (1 | monthYearDate) +(1 | focal), # random effects to correct for
  data = TDD_follows_naomit_full_age
  )
summary(glm_TDD_selected_age)
glm_TDD_timelag <-lmer(TDD ~ meanTimelag+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = TDD_follows_naomit_full
  )
summary(glm_TDD_timelag)
glm_TDD_season <-lmer(TDD ~ rainyseason+ (1 | focal), # random effects to correct for
  data = TDD_follows_naomit_full
  )
summary(glm_TDD_season)
glm_TDD_selected_weather <-lmer(TDD ~ rain_eve +walevel_eve+  avg_temp_tot + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = TDD_follows_naomit_full
  )
summary(glm_TDD_selected_weather)
glm_TDD_selected_weather_before <-lmer(TDD ~ rain_eve +tot_rain_before+  mmax_temp_before + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = TDD_follows_naomit_full_historyweather
  )
summary(glm_TDD_selected_weather)
glm_TDD_selected_fullrandom <-lmer(TDD ~ rain_eve+walevel_eve  + rain_mo + temp_min_eve + temp_min_mo+  avg_temp_tot   + fai + (1|ClassFocal) + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = TDD_follows_naomit_full
  )
summary(glm_TDD_selected_fullrandom)
glm_TDD_selected_waterlev <-lmer(TDD ~ walevel_eve + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = TDD_follows_naomit_full
  )
summary(glm_TDD_selected_waterlev)
glm_TDD_selected_backward <-lmer(TDD ~  walevel_eve + rain_mo + temp_min_eve + avg_temp_tot  + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = TDD_follows_naomit_full
  )
summary(glm_TDD_selected_backward)
glm_TDD_selected_weather <-lmer(TDD ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo+  avg_temp_tot   + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = TDD_follows_naomit_full
  )
summary(glm_TDD_selected_weather)
glm_TDD_selected_fai <-lmer(TDD ~  fai +(1|ClassFocal)+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = TDD_follows_naomit_full
  )
summary(glm_TDD_selected_fai)
glm_TDD_selected_ClassFocal <-lmer(TDD ~  ClassFocal+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = TDD_follows_naomit_full
  )
summary(glm_TDD_selected_ClassFocal)
glm_full_randomeffects <-lmer(log(TDD) ~ (1 | monthYearDate)+ (1 | focal), # random effects to correct for
  data = TDD_follows_naomit_full
  )
summary(glm_full_randomeffects)
lmm_TDD_focalANDmonthyear <-lmer(TDD ~ (1 | focal)+  (1 | monthYearDate), # random effects to correct for
  data = TDD_follows_naomit_full
  )
lmm_TDD_focal <-lmer(TDD ~ focal+  (1 | monthYearDate), # random effects to correct for
  data = TDD_follows_naomit_full
  )
summary(lmm_TDD_focalANDmonthyear)
anova(glm_TDD_full,lmm_TDD_focalANDmonthyear,glm_TDD_selected)
vif.mer(glm_TDD_selected)
summary(lmm_TDD_focal)
summary(glm_TDD_selected_waterlev)
ranova(glm_TDD_selected)
icc(glm_TDD_selected_waterlev)
icc(glm_TDD_selected)
qqnorm(residuals(glm_full_randomeffects))

#### Quick automatic selection
step_result_backward<- step(glm_TDD_full)
glm_TDD_selected_backward<- get_model(step_result_backward,direction="backward")
summary(glm_TDD_selected_backward)
vif.mer(glm_TDD_selected_backward)

#### testing with transformations
glm_DJL_selected_test <-glmer(log(DJL) ~ walevel_eve*avg_temp_tot   + fai + ClassFocal + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_DJL_selected_log <-glmer(log(DJL) ~ rain_eve + walevel_eve  + rain_mo + temp_min_eve + temp_min_mo+  avg_temp_tot   + fai + ClassFocal + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
DJL_follows_naomit_full %>% ggplot(aes((1/2)*log(DJL_follows_naomit_full$DJL)))+geom_histogram()

plot(glm_DJL_selected)
qqnorm(residuals(glm_DJL_selected_log)) # residuals not very normally distributed !! Problem?

###### TDD: Full models for females
lmm_TDD_females_AgeAge <-lmer(TDD ~ ageFromDOB+ageOfCurrentOffspring+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = TDD_follows_naomit_mother
  )
lmm_TDD_females_empty<-lmer(TDD ~ (1 | focal)+  (1 | monthYearDate), # random effects to correct for
  data = TDD_follows_naomit_mother
  )
glm_TDD_females_selected <-lmer(TDD ~ ageOfCurrentOffspring  + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = TDD_follows_naomit_mother
  )
anova(lmm_TDD_females_empty,glm_TDD_females_selected)
summary(glm_TDD_females_selected)

r.squaredGLMM(glm_TDD_selected)
r.squaredGLMM(glm_TDD_females_selected)

###### OVERVIEW OF MODEL RESULTS
screenreg(list(lmm_TDD_focalANDmonthyear,glm_TDD_selected,lmm_TDD_females_empty,glm_TDD_females_selected),digits=5)
qqnorm(residuals(glm_TDD_selected))
sjPlot::tab_model(glm_TDD_selected, 
                  show.re.var= TRUE, 
                  pred.labels =c("(Intercept)", "Urchins", "Fish", "Depth"),
                  dv.labels= "Effects of Herbivores on Coral Cover")

###### TEXTREG --> LATEX EXPORT

texreg(list(lmm_TDD_focalANDmonthyear,glm_TDD_selected,lmm_TDD_females_empty,glm_TDD_females_selected),
       digits=5,
          custom.model.names = c("Only random","Selected","Only random females","Selected only females"),
          custom.coef.names = c("intercept","day rain", "night rain","average temperature", "FAI", "Class: flanged male", "Class: infant","Class: juvenile","Class: unflanged male","age of offspring","age"),
          return.string=TRUE,
          use.packages=FALSE,
          single.row=TRUE)


```

```{r Final glm's SIN,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
###### ###### ###### ###### ###### ###### ###### ###### ###### ###### 
###### CLEAN AND FINAL LIST OF MODELS FOR SIMPLE MOVEMENT ANALYSIS ##
###### ###### ###### ###### ###### ###### ###### ###### ###### ###### 
SIN_follows_naomit_full<- DJL_follows %>% dplyr::select(DJL,follow,trj_sinuosity,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,monthname,rainyseason,month,RR) %>% na.omit() 
SIN_follows_naomit_mother<- DJL_follows %>% dplyr::select(DJL,trj_sinuosity,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,ageFromDOB, ageOfCurrentOffspring,monthname,rainyseason,) %>% na.omit()
SIN_follows_naomit_full_historyweather<- DJL_follows %>% dplyr::select(DJL,trj_sinuosity,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,monthname,rainyseason,tot_rain_before,mmax_temp_before) %>% na.omit()
SIN_follows_naomit_mother_historyweather<- DJL_follows %>% dplyr::select(DJL,trj_sinuosity,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,ageFromDOB, ageOfCurrentOffspring,monthname,rainyseason,tot_rain_before,mmax_temp_before) %>% na.omit()


###### Tortuosity Straightness Index
#### Check influence of sampling rate
lm_SIN_samplingrate <-lm(trj_sinuosity~ meanTimelag , # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(lm_SIN_samplingrate)
autoplot(lm_SIN_samplingrate)
spearman_samplingrateONdjl<- cor.test(SIN_follows_naomit_full$meanTimelag,SIN_follows_naomit_full$trj_sinuosity,  method = "spearman") # not normally distributed variables
spearman_samplingrateONdjl

#### Check influence of month
SIN_follows_naomit_full <- SIN_follows_naomit_full %>% mutate(year=as.character(year(ym(monthYearDate))))
lm_SIN_month <-lmer(trj_sinuosity ~  month  + (1 | year), # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(lm_TDD_month)
r.squaredGLMM(lm_TDD_month)

#### Check influence of age sex classes
lm_SIN_samplingrate <-lm(trj_sinuosity~ ClassFocal , # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(lm_SIN_samplingrate)
SUAQ_treedirectness_stats_naomit %>% ggplot(aes(ClassFocal,trj_sinuosity))+geom_boxplot()
aov_treedirectness_class<- kruskal.test(SIN_follows_naomit_full$trj_sinuosity~SIN_follows_naomit_full$ClassFocal)
aov_treedirectness_class


#### Comparison to SI
lm_SIN_RR <-lm(trj_sinuosity~ RR , # random effects to correct for
  data = SIN_follows_naomit_full
  )
autoplot(lm_SIN_RR)
summary(lm_SIN_RR)
r.squaredGLMM(lm_SIN_RR)

#### Check influence of different random effects
lm_SIN_empty <-lm(trj_sinuosity~ 1, # random effects to correct for
  data = SIN_follows_naomit_full
  )
lmm_SIN_monthYearDate <-lmer(trj_sinuosity~ (1 | monthYearDate), # random effects to correct for
  data = SIN_follows_naomit_full
  )
lm_SIN_monthYearDate <-lm(trj_sinuosity~ monthYearDate, # random effects to correct for
  data = SIN_follows_naomit_full
  )
lmm_SIN_month <-lmer(trj_sinuosity~ (1 | monthname), # random effects to correct for
  data = SIN_follows_naomit_full
  )
lmm_SIN_focal <-lmer(trj_sinuosity~ (1 | focal) , # random effects to correct for
  data = SIN_follows_naomit_full
  )

lmm_SIN_ClassFocal <-lmer(trj_sinuosity~ (1 | ClassFocal), # random effects to correct for
  data = SIN_follows_naomit_full
  )

lmm_SIN_focalANDmonthyear <-lmer(trj_sinuosity~ (1 | focal)+  (1 | monthYearDate), # random effects to correct for
  data = SIN_follows_naomit_full
  )

lmm_SIN_focalANDClassFocal<-lmer(trj_sinuosity~ (1 | focal)+  (1 | ClassFocal), # random effects to correct for
  data = SIN_follows_naomit_full
  )

lmm_SIN_monthyearANDClassFocal<-lmer(trj_sinuosity~ (1 | monthYearDate)+  (1 | ClassFocal), # random effects to correct for
  data = SIN_follows_naomit_full
  )

lmm_SIN_allrandom<-lmer(trj_sinuosity~ (1 | monthYearDate)+  (1 | ClassFocal)+(1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
hist(DJL_follows$trj_sinuosity)
lrtest(lm_SIN_empty,lmm_SIN_monthYearDate,lmm_SIN_focal,lmm_SIN_ClassFocal)
anova(lmm_SIN_monthYearDate,lmm_SIN_focal,lmm_SIN_ClassFocal,lmm_SIN_focalANDmonthyear,lmm_SIN_focalANDClassFocal,lmm_SIN_monthyearANDClassFocal,lmm_SIN_allrandom,lmm_SIN_month)

#### Collect monthyeardate and focal as random effects because of the lowest AIC
icc(lmm_SIN_focal) # 9% of correlation within focal follows.
icc(lmm_SIN_monthYearDate) # 11% of correlation within month year dates groups follows. 


#### Full models for all class focal
glm_SIN_full <-lmer(trj_sinuosity~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo+ temp_max_eve + temp_max_mo + avg_temp_tot   + fai + ClassFocal+fruittreecount+  (1 | monthYearDate)+ (1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(glm_SIN_selected)
glm_SIN_selected <-lmer(trj_sinuosity~ rain_eve  + rain_mo +  avg_temp_tot   + fai + ClassFocal + DJL+ (1 | monthYearDate) +(1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
glm_SIN_selected_low <-lmer(trj_sinuosity~ fruittreecount + DJL + meanTimelag + (1 | monthYearDate) +(1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
glm_SIN_selected_fruittrees <-lmer(trj_sinuosity~ fruittreecount+ (1 | monthYearDate) +(1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
glm_SIN_selected_withfruittree <-lmer(trj_sinuosity~ rain_eve  + rain_mo +  avg_temp_tot   + fai + ClassFocal  + fruittreecount+meanTimelag+ (1 | monthYearDate) +(1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(glm_SIN_selected_withfruittree)
glm_SIN_timelag <-lmer(trj_sinuosity~ meanTimelag+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(glm_SIN_timelag)
glm_SIN_season <-lmer(trj_sinuosity~ rainyseason+ (1 | monthYearDate)+ (1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(glm_SIN_season)
glm_SIN_fruittree <-lmer(trj_sinuosity~ fruittreecount+meanTimelag+ (1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(glm_SIN_fruittree)
glm_SIN_selected_weather <-lmer(trj_sinuosity~ rain_eve*avg_temp_tot + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(glm_SIN_selected_weather)
glm_SIN_selected_weather_before <-lmer(trj_sinuosity~ rain_eve +tot_rain_before+  mmax_temp_before + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full_historyweather
  )
summary(glm_SIN_selected_weather)
glm_SIN_selected_fullrandom <-lmer(trj_sinuosity~ rain_eve+walevel_eve  + rain_mo + temp_min_eve + temp_min_mo+  avg_temp_tot   + fai + (1|ClassFocal) + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(glm_SIN_selected_fullrandom)
glm_SIN_selected_waterlev <-lmer(trj_sinuosity~ walevel_eve + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(glm_SIN_selected_waterlev)
glm_SIN_selected_backward <-lmer(trj_sinuosity~  walevel_eve + rain_mo + temp_min_eve + avg_temp_tot  + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(glm_SIN_selected_backward)
glm_SIN_selected_weather <-lmer(trj_sinuosity~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo+  avg_temp_tot   + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(glm_SIN_selected_weather)
glm_SIN_selected_fai <-lmer(trj_sinuosity~  fai +(1|ClassFocal)+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(glm_SIN_selected_fai)
glm_SIN_selected_ClassFocal <-lmer(trj_sinuosity~  ClassFocal+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(glm_SIN_selected_ClassFocal)
glm_full_randomeffects <-lmer(log(SIN) ~ (1 | monthYearDate)+ (1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(glm_full_randomeffects)
lmm_SIN_focalANDmonthyear <-lmer(trj_sinuosity~ (1 | focal)+  (1 | monthYearDate), # random effects to correct for
  data = SIN_follows_naomit_full
  )
lmm_SIN_monthyear <-lmer(trj_sinuosity~ (1 | monthYearDate), # random effects to correct for
  data = SIN_follows_naomit_full
  )
lmm_SIN_focal <-lmer(trj_sinuosity~ (1 | focal), # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(lmm_SIN_focalANDmonthyear)
anova(glm_SIN_selected_withfruittree,glm_SIN_full,lmm_SIN_focalANDmonthyear,glm_SIN_selected_waterlev,glm_SIN_selected)
vif.mer(glm_SIN_selected)
summary(glm_SIN_selected)
summary(glm_SIN_selected_waterlev)
ranova(glm_SIN_selected)
icc(lmm_SIN_monthyear)
icc(lmm_SIN_focal)
qqnorm(residuals(glm_full_randomeffects))

#### Quick automatic selection
step_result_backward<- step(glm_SIN_full)
glm_SIN_selected_backward<- get_model(step_result_backward,direction="forward")
summary(glm_SIN_selected_backward)
vif.mer(glm_SIN_selected_backward)
anova(lmm_SIN_focalANDmonthyear,glm_SIN_selected_backward,glm_SIN_selected_withfruittree)
r.squaredGLMM(glm_SIN_selected_withfruittree)
#### testing with transformations
glm_DJL_selected_interactionweather <-glmer(log(DJL) ~ walevel_eve*avg_temp_tot   + fai + ClassFocal + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
summary(glm_DJL_selected_interactionweather)
glm_DJL_selected_log <-glmer(log(DJL) ~ rain_eve + walevel_eve  + rain_mo + temp_min_eve + temp_min_mo+  avg_temp_tot   + fai + ClassFocal + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
summary(glm_DJL_selected_log)
DJL_follows_naomit_full %>% ggplot(aes((1/2)*log(DJL_follows_naomit_full$DJL)))+geom_histogram()

plot(glm_DJL_selected_log)
qqnorm(residuals(glm_DJL_selected_log)) # residuals not very normally distributed !! Problem?

###### SIN: Full models for females
lmm_SIN_females_AgeAge <-lmer(trj_sinuosity~ ageFromDOB+ageOfCurrentOffspring+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = SIN_follows_naomit_mother
  )
lmm_SIN_females_empty<-lmer(trj_sinuosity~ (1 | focal)+  (1 | monthYearDate), # random effects to correct for
  data = SIN_follows_naomit_mother
  )
glm_SIN_females_selected <-lmer(trj_sinuosity~ rain_eve  + rain_mo  +  avg_temp_tot   + fai+ageOfCurrentOffspring+ageFromDOB+fruittreecount +DJL+meanTimelag + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = SIN_follows_naomit_mother
  )
glm_SIN_females_selected_low <-lmer(trj_sinuosity~ ageOfCurrentOffspring  + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = SIN_follows_naomit_mother
  )
anova(lmm_SIN_females_empty,glm_SIN_females_selected_low)
summary(glm_SIN_females_selected_low)


r.squaredGLMM(glm_SIN_selected)
r.squaredGLMM(glm_SIN_females_selected)
#### Quick automatic selection
step_result_backward<- step(glm_SIN_females_selected)
glm_SIN_selected_backward<- get_model(step_result_backward,direction="forward")
summary(glm_SIN_selected_backward)
vif.mer(glm_SIN_selected_backward)
anova(lmm_SIN_focalANDmonthyear,glm_SIN_selected_backward,glm_SIN_selected_withfruittree)
r.squaredGLMM(glm_SIN_selected_withfruittree)



###### OVERVIEW OF MODEL RESULTS
screenreg(list(lmm_SIN_focalANDmonthyear,glm_SIN_selected,glm_SIN_selected_low,lmm_SIN_females_empty,glm_SIN_females_selected_low),digits=5)
qqnorm(residuals(glm_SIN_selected))
sjPlot::tab_model(glm_SIN_selected, 
                  show.re.var= TRUE, 
                  pred.labels =c("(Intercept)", "Urchins", "Fish", "Depth"),
                  dv.labels= "Effects of Herbivores on Coral Cover")

###### TEXTREG --> LATEX EXPORT
?r.squaredGLMM()
r.squaredGLMM(glm_SIN_selected)
r.squaredGLMM(glm_SIN_selected_fruittrees)
texreg(list(lmm_SIN_focalANDmonthyear,glm_SIN_selected,glm_SIN_selected_low,lmm_SIN_females_empty,glm_SIN_females_selected_low),
       digits=5,
          custom.model.names = c("Only random","Selected","Selected adj.","Only random females","Selected only females"),
          custom.coef.names = c("intercept","day rain", "night rain","average temperature", "FAI", "Class: flanged male", "Class: infant","Class: juvenile","Class: unflanged male","fruit tree count","DJL","age of offspring"),
          return.string=TRUE,
          use.packages=FALSE,
          single.row=TRUE)


```

```{r Final glm's FRUITTREECOUNT,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
###### ###### ###### ###### ###### ###### ###### ###### ###### ###### 
###### CLEAN AND FINAL LIST OF MODELS FOR SIMPLE MOVEMENT ANALYSIS ##
###### ###### ###### ###### ###### ###### ###### ###### ###### ###### 
FTC_follows_naomit_full<- DJL_follows %>% dplyr::select(follow,trj_sinuosity,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,monthname,rainyseason,month,RR,trj_sinuosity) %>% na.omit() %>% mutate(year=as.character(year(ym(monthYearDate))))
FTC_follows_naomit_mother<- DJL_follows %>% dplyr::select(trj_sinuosity,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai,RR,trj_sinuosity, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,ageFromDOB, ageOfCurrentOffspring,monthname,rainyseason,) %>% na.omit()%>% mutate(year=as.character(year(ym(monthYearDate))))
FTC_follows_naomit_full_historyweather<- DJL_follows %>% dplyr::select(trj_sinuosity,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai,RR,trj_sinuosity, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,monthname,rainyseason,tot_rain_before,mmax_temp_before) %>% na.omit()%>% mutate(year=as.character(year(ym(monthYearDate))))
FTC_follows_naomit_mother_historyweather<- DJL_follows %>% dplyr::select(trj_sinuosity,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo,temp_max_eve, temp_max_mo, avg_temp_tot, ClassFocal, fai,RR,trj_sinuosity,RR,trj_sinuosity, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount,ageFromDOB, ageOfCurrentOffspring,monthname,rainyseason,tot_rain_before,mmax_temp_before) %>% na.omit()%>% mutate(year=as.character(year(ym(monthYearDate))))



###### Tortuosity Straightness Index
#### Check influence of sampling rate
lm_SIN_samplingrate <-lm(fruittreecount~ meanTimelag , # random effects to correct for
  data = SIN_follows_naomit_full
  )
summary(lm_SIN_samplingrate)
autoplot(lm_SIN_samplingrate)
spearman_samplingrateONdjl<- cor.test(SIN_follows_naomit_full$meanTimelag,SIN_follows_naomit_full$fruittreecount,  method = "spearman") # not normally distributed variables
spearman_samplingrateONdjl

#### Check influence of month
FTC_follows_naomit_full <- FTC_follows_naomit_full %>% mutate(year=as.character(year(ym(monthYearDate))))
lm_FTC_month <-lmer(fruittreecount ~   month + (1 |  year), # random effects to correct for
  data = FTC_follows_naomit_full
  )
aov(fruittreecount~   month,data=FTC_follows_naomit_full)
summary(aov(fruittreecount~   month,data=FTC_follows_naomit_full))
summary(lm_FTC_month)
r.squaredGLMM(lm_FTC_month)
anova(lm_FTC_month)

#### Check Fai
lmm_FAI<-lmer(fai~ (1 | monthYearDate), # random effects to correct for
  data = FTC_follows_naomit_full
  )
summary(lmm_FAI)
r.squaredGLMM(lmm_FAI)


#### Check influence of different random effects
lm_FTC_empty <-lm(fruittreecount~ 1, # random effects to correct for
  data = FTC_follows_naomit_full
  )
lmm_FTC_monthYearDate <-lmer(fruittreecount~ (1 | monthYearDate), # random effects to correct for
  data = FTC_follows_naomit_full
  )
lm_FTC_monthYearDate <-lm(fruittreecount~ monthYearDate, # random effects to correct for
  data = FTC_follows_naomit_full
  )
lmm_FTC_month <-lmer(fruittreecount~ (1 | monthname), # random effects to correct for
  data = FTC_follows_naomit_full
  )
lmm_FTC_year <-lmer(fruittreecount~ (1 | year), # random effects to correct for
  data = FTC_follows_naomit_full
  )
lmm_FTC_focal <-lmer(fruittreecount~ (1 | focal) , # random effects to correct for
  data = FTC_follows_naomit_full
  )

lmm_FTC_ClassFocal <-lmer(fruittreecount~ (1 | ClassFocal), # random effects to correct for
  data = FTC_follows_naomit_full
  )

lmm_FTC_focalANDmonthyear <-lmer(fruittreecount~ (1 | focal)+  (1 | monthYearDate), # random effects to correct for
  data = FTC_follows_naomit_full
  )
lmm_FTC_focalANDyear <-lmer(fruittreecount~ (1 | focal)+  (1 | year), # random effects to correct for
  data = FTC_follows_naomit_full
  )
lmm_FTC_focalANDClassFocal<-lmer(fruittreecount~ (1 | focal)+  (1 | ClassFocal), # random effects to correct for
  data = FTC_follows_naomit_full
  )

lmm_FTC_monthyearANDClassFocal<-lmer(fruittreecount~ (1 | monthYearDate)+  (1 | ClassFocal), # random effects to correct for
  data = FTC_follows_naomit_full
  )

lmm_FTC_allrandom<-lmer(fruittreecount~ (1 | monthYearDate)+  (1 | ClassFocal)+(1 | focal), # random effects to correct for
  data = FTC_follows_naomit_full
  )

hist(DJL_follows$fruittreecount)
lrtest(lm_FTC_empty,lmm_FTC_monthYearDate,lmm_FTC_focal,lmm_FTC_ClassFocal)
anova(lmm_FTC_focalANDyear,lmm_FTC_monthYearDate,lmm_FTC_year,lmm_FTC_focal,lmm_FTC_ClassFocal,lmm_FTC_focalANDmonthyear,lmm_FTC_focalANDClassFocal,lmm_FTC_monthyearANDClassFocal,lmm_FTC_allrandom,lmm_FTC_month)
ranova(lmm_FTC_focalANDyear)
#### Collect monthyeardate and focal as random effects because of the lowest AIC
icc(lmm_FTC_focal) # 20% of correlation within focal follows.
icc(lmm_FTC_monthYearDate) # 61% of correlation within month year dates groups follows. 
r.squaredGLMM(lmm_FTC_focal)
r.squaredGLMM(lmm_FTC_year)
r.squaredGLMM(lmm_FTC_monthYearDate)

#### Full models for all class focal
glm_FTC_full <-lmer(fruittreecount~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo+ temp_max_eve + temp_max_mo + avg_temp_tot   + fai + ClassFocal+ RR + trj_sinuosity+  (1 | year), # random effects to correct for
  data = FTC_follows_naomit_full
  )
summary(glm_FTC_full)
glm_FTC_selected <-lmer(fruittreecount~ rain_eve  + rain_mo +  avg_temp_tot   + fai + ClassFocal  + RR +trj_sinuosity+  (1 | monthYearDate), # random effects to correct for
  data = FTC_follows_naomit_full
  )
summary(glm_FTC_selected)
glm_FTC_timelag <-lmer(fruittreecount~ meanTimelag+ (1 | monthYearDate), # random effects to correct for
  data = FTC_follows_naomit_full
  )
summary(glm_FTC_timelag)
glm_FTC_season <-lmer(fruittreecount~ rainyseason+ (1 | year), # random effects to correct for
  data = FTC_follows_naomit_full
  )
summary(glm_FTC_season)
glm_FTC_selected_weather <-lmer(fruittreecount~ rain_eve +walevel_eve+  avg_temp_tot + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = FTC_follows_naomit_full
  )
summary(glm_FTC_selected_weather)
glm_FTC_selected_weather_before <-lmer(fruittreecount~ rain_eve +tot_rain_before+  mmax_temp_before + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = FTC_follows_naomit_full_historyweather
  )
summary(glm_FTC_selected_weather_before)
glm_FTC_selected_fullrandom <-lmer(fruittreecount~ rain_eve+walevel_eve  + rain_mo + temp_min_eve + temp_min_mo+  avg_temp_tot   + fai + (1|ClassFocal) + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = FTC_follows_naomit_full
  )
summary(glm_FTC_selected_fullrandom)
glm_FTC_selected_waterlev <-lmer(fruittreecount~ walevel_eve + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = FTC_follows_naomit_full
  )
summary(glm_FTC_selected_waterlev)
glm_FTC_selected_backward <-lmer(fruittreecount~  walevel_eve + rain_mo + temp_min_eve + avg_temp_tot  + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = FTC_follows_naomit_full
  )
summary(glm_FTC_selected_backward)
glm_FTC_selected_weather <-lmer(fruittreecount~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo+  avg_temp_tot   + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = FTC_follows_naomit_full
  )
summary(glm_FTC_selected_weather)
glm_FTC_selected_fai <-lmer(fruittreecount~  trj_sinuosity+(1 | monthYearDate), # random effects to correct for
  data = FTC_follows_naomit_full
  )
summary(glm_FTC_selected_fai)
glm_FTC_selected_ClassFocal <-lmer(fruittreecount~  ClassFocal+ (1 | monthYearDate), # random effects to correct for
  data = FTC_follows_naomit_full
  )
summary(glm_FTC_selected_ClassFocal)

lmm_FTC_focalANDmonthyear <-lmer(fruittreecount~ (1 | focal)+  (1 | monthYearDate), # random effects to correct for
  data = FTC_follows_naomit_full
  )
summary(lmm_FTC_focalANDmonthyear)
anova(lmm_FTC_focalANDmonthyear,glm_FTC_selected_fai)
vif.mer(glm_FTC_selected)
summary(glm_FTC_selected)
summary(glm_FTC_selected_waterlev)
ranova(glm_FTC_selected)
icc(glm_FTC_selected_waterlev)
icc(glm_FTC_selected_fai)
qqnorm(residuals(glm_full_randomeffects))

#### Quick automatic selection
step_result_backward<- step(glm_FTC_full)
glm_FTC_selected_backward<- get_model(step_result_backward,direction="backward")
summary(glm_FTC_selected_backward)
vif.mer(glm_FTC_selected_backward)

#### testing with transformations
glm_DJL_selected_interactionweather <-glmer(log(DJL) ~ walevel_eve*avg_temp_tot   + fai + ClassFocal + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
summary(glm_DJL_selected_interactionweather)
glm_DJL_selected_log <-glmer(log(DJL) ~ rain_eve + walevel_eve  + rain_mo + temp_min_eve + temp_min_mo+  avg_temp_tot   + fai + ClassFocal + (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = DJL_follows_naomit_full
  )
summary(glm_DJL_selected_log)
DJL_follows_naomit_full %>% ggplot(aes((1/2)*log(DJL_follows_naomit_full$DJL)))+geom_histogram()

plot(glm_DJL_selected_log)
qqnorm(residuals(glm_DJL_selected_log)) # residuals not very normally distributed !! Problem?

###### FTC: Full models for females
lmm_FTC_females_AgeAge <-lmer(fruittreecount~ ageFromDOB+ageOfCurrentOffspring+ (1 | monthYearDate) + (1 | focal), # random effects to correct for
  data = FTC_follows_naomit_mother
  )
lmm_FTC_females_empty<-lmer(fruittreecount~ (1 | monthYearDate), # random effects to correct for
  data = FTC_follows_naomit_mother
  )
glm_FTC_females_selected <-lmer(fruittreecount~  trj_sinuosity+ageOfCurrentOffspring  + (1 | monthYearDate), # random effects to correct for
  data = FTC_follows_naomit_mother
  )
test <- FTC_follows_naomit_mother %>% mutate(logftc=log(fruittreecount)) %>% filter(is.finite(logftc))%>% filter(!is.na(logftc))

anova(lmm_FTC_females_empty,glm_FTC_females_selected)
summary(glm_FTC_females_selected)
ranova(glm_FTC_selected)

###### OVERVIEW OF MODEL RESULTS
screenreg(list(lmm_FTC_monthYearDate,glm_FTC_selected,glm_FTC_selected_fai,lmm_FTC_females_empty,glm_FTC_females_selected),digits=5)
qqnorm(residuals(glm_FTC_selected))
sjPlot::tab_model(glm_FTC_selected, 
                  show.re.var= TRUE, 
                  pred.labels =c("(Intercept)", "Urchins", "Fish", "Depth"),
                  dv.labels= "Effects of Herbivores on Coral Cover")

###### TEXTREG --> LATEX EXPORT
r.squaredGLMM(glm_FTC_selected_fai)
r.squaredGLMM(glm_FTC_selected)
texreg(list(lmm_FTC_monthYearDate,glm_FTC_selected,glm_FTC_selected_fai,lmm_FTC_females_empty,glm_FTC_females_selected),
       digits=5,
          custom.model.names = c("Only random","Selected","Adj. selected","Only random females","Selected only females"),
          custom.coef.names = c("intercept","day rain", "night rain","average temperature", "FAI", "Class: flanged male", "Class: infant","Class: juvenile","Class: unflanged male","straightness index","sinuosity index","age of offspring"),
          return.string=TRUE,
          use.packages=FALSE,
          single.row=TRUE)


```


```{r Subsampling: higher frequency analysis}
##### Plot DJL and mean timelag
plot_DJLxMeanTimelag<- DJL_follows %>% ggplot(aes(DJL, meanTimelag)) +
  geom_point() + 
  labs(title = "DJL X Mean Timelag (Mean sampling interval per follow)", x = "DJL [m]", y = "mean sampling interval [s]")

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_DJLxMeanTimelag",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_DJLxMeanTimelag)


specs_timelag <- SUAQ_rangepoints_11all20_loc %>% group_by(timelag_lead) %>% summarise(count=n())

temp<- SUAQ_rangepoints_11all20_loc %>% group_by(follow) %>% summarise(meanTimelag=median(timelag_lead,na.rm=TRUE),count=n())
sample_FN_5min<- c("661","663","671","682","685","687","689","718","719","733","735","738","743","745","746","748","751","753","754","765","767","773","805","807","808","810","816")

sample_frequencyAnalaysis_5min <- SUAQ_rangepoints_11all20_loc[order(SUAQ_rangepoints_11all20_loc$focal,SUAQ_rangepoints_11all20_loc$manualDatetime , decreasing = TRUE ),] %>% filter(follow %in% c("661","663","671","682","685","687","689","718","719","733","735","738","743","745","746","748","751","753","754","765","767","773","805","807","808","810","816"))  %>% filter(followtype=="NN")

sample_frequencyAnalaysis_5min <- sample_frequencyAnalaysis_5min %>% mutate(cumsumTimelag=cumsum(timelag_lead)) %>%  dplyr::select(c("identification","focal","follow","followtype","automaticDatetime","manualDatetime","manualDate","manualTime","automaticDate","automaticTime","timelag_lead","cumsumTimelag","manual_distToNext","speed_next","turningAngle","altitudediff_next","PtType","currentOffspring","ageFromDOB","ageOfCurrentOffspring","infantname","altitude","followername","E","N","gpsextraction"))
colnames_subsample<- c("identification","focal","follow","followtype","automaticDatetime","manualDatetime","manualDate","manualTime","automaticDate","automaticTime","timelag_lead","cumsumTimelag","manual_distToNext","speed_next","turningAngle","altitudediff_next","PtType","currentOffspring","ageFromDOB","ageOfCurrentOffspring","infantname","altitude","followername","E","N","gpsextraction")
##### Get two dataframes one with start and ending and another with all the points in between
subsample_frequencyAnalaysis_start <- sample_frequencyAnalaysis_5min %>% group_by(follow) %>% dplyr::top_n(1,manualDatetime)
subsample_frequencyAnalaysis_end <- sample_frequencyAnalaysis_5min %>% group_by(follow) %>% dplyr::top_n(-1,manualDatetime)
subsample_frequencyAnalaysis_start_end <- subsample_frequencyAnalaysis_start %>% rbind(subsample_frequencyAnalaysis_end)
sample_frequencyAnalaysis_rest<- setdiff(sample_frequencyAnalaysis_5min,subsample_frequencyAnalaysis_start_end)

##### Create a Dataframe with subsamplings
subsample_frequencyAnalaysis15min <- sample_frequencyAnalaysis_rest %>% group_by(follow) %>%
  slice(seq(2, n(), by = 2))
subsample_frequencyAnalaysis15min <- subsample_frequencyAnalaysis15min %>% rbind(subsample_frequencyAnalaysis_start_end)

##### Create a Dataframe with subsamplings
subsample_frequencyAnalaysis30min <- sample_frequencyAnalaysis_rest %>% group_by(follow) %>%
  slice(seq(4, n(), by = 4))
subsample_frequencyAnalaysis30min <- subsample_frequencyAnalaysis30min %>% rbind(subsample_frequencyAnalaysis_start_end)

##### Create a Dataframe with subsamplings
subsample_frequencyAnalaysis6point <- sample_frequencyAnalaysis_rest %>% group_by(follow) %>%
  slice(seq(6, n(), by = 6))
subsample_frequencyAnalaysis6point <- subsample_frequencyAnalaysis6point %>% rbind(subsample_frequencyAnalaysis_start_end)

##### Create a Dataframe with subsamplings
subsample_frequencyAnalaysis8point <- sample_frequencyAnalaysis_rest %>% group_by(follow) %>%
  slice(seq(8, n(), by = 8))
subsample_frequencyAnalaysis8point <- subsample_frequencyAnalaysis8point %>% rbind(subsample_frequencyAnalaysis_start_end)

##### Create a Dataframe with subsamplings
subsample_frequencyAnalaysis10point <- sample_frequencyAnalaysis_rest %>% group_by(follow) %>%
  slice(seq(10, n(), by = 10))
subsample_frequencyAnalaysis10point <- subsample_frequencyAnalaysis10point %>% rbind(subsample_frequencyAnalaysis_start_end)

##### Create a Dataframe with subsamplings
subsample_frequencyAnalaysis12point <- sample_frequencyAnalaysis_rest %>% group_by(follow) %>%
  slice(seq(12, n(), by = 12))
subsample_frequencyAnalaysis12point <- subsample_frequencyAnalaysis12point %>% rbind(subsample_frequencyAnalaysis_start_end)

##### Create a Dataframe with subsamplings
subsample_frequencyAnalaysis14point <- sample_frequencyAnalaysis_rest %>% group_by(follow) %>%
  slice(seq(14, n(), by = 14))
subsample_frequencyAnalaysis14point <- subsample_frequencyAnalaysis14point %>% rbind(subsample_frequencyAnalaysis_start_end)

##### Create a Dataframe with subsamplings
subsample_frequencyAnalaysis20point <- sample_frequencyAnalaysis_rest %>% group_by(follow) %>%
  slice(seq(20, n(), by = 20))
subsample_frequencyAnalaysis20point <- subsample_frequencyAnalaysis20point %>% rbind(subsample_frequencyAnalaysis_start_end)

##### Create analysis DF #####
subsample_frequencyAnalaysis15min<- subsample_frequencyAnalaysis15min %>% 
  group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
  mutate(timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         speed_last = manual_distTolast/timelag,
         speed_next = manual_distToNext/timelag_lead,
         turningAngle=turning_angle(E,N),
         altitudediff_next=altitude-lead(altitude),
         )
subsample_frequencyAnalaysis30min<- subsample_frequencyAnalaysis30min %>% 
  group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
  mutate(timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         speed_last = manual_distTolast/timelag,
         speed_next = manual_distToNext/timelag_lead,
         turningAngle=turning_angle(E,N),
         altitudediff_next=altitude-lead(altitude),
         )
subsample_frequencyAnalaysis6point<- subsample_frequencyAnalaysis6point %>% 
  group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
  mutate(timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         speed_last = manual_distTolast/timelag,
         speed_next = manual_distToNext/timelag_lead,
         turningAngle=turning_angle(E,N),
         altitudediff_next=altitude-lead(altitude),
         )
subsample_frequencyAnalaysis8point<- subsample_frequencyAnalaysis8point %>% 
  group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
  mutate(timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         speed_last = manual_distTolast/timelag,
         speed_next = manual_distToNext/timelag_lead,
         turningAngle=turning_angle(E,N),
         altitudediff_next=altitude-lead(altitude),
         )
subsample_frequencyAnalaysis10point<- subsample_frequencyAnalaysis10point %>% 
  group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
  mutate(timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         speed_last = manual_distTolast/timelag,
         speed_next = manual_distToNext/timelag_lead,
         turningAngle=turning_angle(E,N),
         altitudediff_next=altitude-lead(altitude),
         )
subsample_frequencyAnalaysis12point<- subsample_frequencyAnalaysis12point %>% 
  group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
  mutate(timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         speed_last = manual_distTolast/timelag,
         speed_next = manual_distToNext/timelag_lead,
         turningAngle=turning_angle(E,N),
         altitudediff_next=altitude-lead(altitude),
         )
subsample_frequencyAnalaysis14point<- subsample_frequencyAnalaysis14point %>% 
  group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
  mutate(timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         speed_last = manual_distTolast/timelag,
         speed_next = manual_distToNext/timelag_lead,
         turningAngle=turning_angle(E,N),
         altitudediff_next=altitude-lead(altitude),
         )
subsample_frequencyAnalaysis20point<- subsample_frequencyAnalaysis20point %>% 
  group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
  mutate(timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         speed_last = manual_distTolast/timelag,
         speed_next = manual_distToNext/timelag_lead,
         turningAngle=turning_angle(E,N),
         altitudediff_next=altitude-lead(altitude),
         )
subsample_frequencyAnalaysis_start_end<- subsample_frequencyAnalaysis_start_end %>% 
  group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
  mutate(timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         speed_last = manual_distTolast/timelag,
         speed_next = manual_distToNext/timelag_lead,
         turningAngle=turning_angle(E,N),
         altitudediff_next=altitude-lead(altitude),
         )

DJL_follows_subsample_StartEnd <- subsample_frequencyAnalaysis_start_end %>%
  filter(followtype == "NN") %>%
  group_by(
    follow
  ) %>%
  summarise(DJL_SE = sum(as.numeric(manual_distTolast), na.rm = TRUE), count_SE =
              n(), turningAngleSum_SE=sum(as.numeric(turningAngle), na.rm = TRUE), meanTimelag_SE=mean(timelag_lead,na.rm=TRUE), medianTimelag_SE=median(timelag_lead,na.rm=TRUE))
DJL_follows_subsample_StartEnd <- DJL_follows_subsample_StartEnd %>% left_join(TDD_follows,by=c("follow"="follow")) %>% mutate(RR_SE=TDD/DJL_SE)%>% dplyr::select(-firstE,-firstN,-lastE,-lastN,-TDD)

DJL_follows_subsample_15min <- subsample_frequencyAnalaysis15min %>%
  filter(followtype == "NN") %>%
  group_by(
    follow
  ) %>%
  summarise(DJL_15min = sum(as.numeric(manual_distTolast), na.rm = TRUE), count_15min =
              n(), turningAngleSum_15min=sum(as.numeric(turningAngle), na.rm = TRUE), meanTimelag_15min=mean(timelag_lead,na.rm=TRUE), medianTimelag_15min=median(timelag_lead,na.rm=TRUE))
DJL_follows_subsample_15min <- DJL_follows_subsample_15min %>% left_join(TDD_follows,by=c("follow"="follow")) %>% mutate(RR_15min=TDD/DJL_15min)%>% dplyr::select(-firstE,-firstN,-lastE,-lastN,-TDD)

DJL_follows_subsample_30min <- subsample_frequencyAnalaysis30min %>%
  filter(followtype == "NN") %>%
  group_by(
    follow,
  ) %>%
  summarise(DJL_30min = sum(as.numeric(manual_distTolast), na.rm = TRUE), count_30min =
              n(), turningAngleSum_30min=sum(as.numeric(turningAngle), na.rm = TRUE), meanTimelag_30min=mean(timelag_lead,na.rm=TRUE), medianTimelag_30min=median(timelag_lead,na.rm=TRUE))
DJL_follows_subsample_30min <- DJL_follows_subsample_30min %>% left_join(TDD_follows,by=c("follow"="follow")) %>% mutate(RR_30min=TDD/DJL_30min) %>% dplyr::select(-firstE,-firstN,-lastE,-lastN,-TDD)

DJL_follows_subsample_6point <- subsample_frequencyAnalaysis6point %>%
  filter(followtype == "NN") %>%
  group_by(
    follow
  ) %>%
  summarise(DJL_6points = sum(as.numeric(manual_distTolast), na.rm = TRUE), count_6points =
              n(), turningAngleSum_6points=sum(as.numeric(turningAngle), na.rm = TRUE), meanTimelag_6points=mean(timelag_lead,na.rm=TRUE), medianTimelag_6points=median(timelag_lead,na.rm=TRUE))
DJL_follows_subsample_6point <- DJL_follows_subsample_6point %>% left_join(TDD_follows,by=c("follow"="follow")) %>% mutate(RR_6points=TDD/DJL_6points)%>% dplyr::select(-firstE,-firstN,-lastE,-lastN,-TDD)

DJL_follows_subsample_8point <- subsample_frequencyAnalaysis8point %>%
  filter(followtype == "NN") %>%
  group_by(
    follow
  ) %>%
  summarise(DJL_8points = sum(as.numeric(manual_distTolast), na.rm = TRUE), count_8points =
              n(), turningAngleSum_8points=sum(as.numeric(turningAngle), na.rm = TRUE), meanTimelag_8points=mean(timelag_lead,na.rm=TRUE), medianTimelag_8points=median(timelag_lead,na.rm=TRUE))
DJL_follows_subsample_8point <- DJL_follows_subsample_8point %>% left_join(TDD_follows,by=c("follow"="follow")) %>% mutate(RR_8points=TDD/DJL_8points)%>% dplyr::select(-firstE,-firstN,-lastE,-lastN,-TDD)

DJL_follows_subsample_10point <- subsample_frequencyAnalaysis10point %>%
  filter(followtype == "NN") %>%
  group_by(
    follow
  ) %>%
  summarise(DJL_10points = sum(as.numeric(manual_distTolast), na.rm = TRUE), count_10points =
              n(), turningAngleSum_10points=sum(as.numeric(turningAngle), na.rm = TRUE), meanTimelag_10points=mean(timelag_lead,na.rm=TRUE), medianTimelag_10points=median(timelag_lead,na.rm=TRUE))
DJL_follows_subsample_10point <- DJL_follows_subsample_10point %>% left_join(TDD_follows,by=c("follow"="follow")) %>% mutate(RR_10points=TDD/DJL_10points)%>% dplyr::select(-firstE,-firstN,-lastE,-lastN,-TDD)

DJL_follows_subsample_12point <- subsample_frequencyAnalaysis12point %>%
  filter(followtype == "NN") %>%
  group_by(
    follow
  ) %>%
  summarise(DJL_12points = sum(as.numeric(manual_distTolast), na.rm = TRUE), count_12points =
              n(), turningAngleSum_12points=sum(as.numeric(turningAngle), na.rm = TRUE), meanTimelag_12points=mean(timelag_lead,na.rm=TRUE), medianTimelag_12points=median(timelag_lead,na.rm=TRUE))
DJL_follows_subsample_12point <- DJL_follows_subsample_12point %>% left_join(TDD_follows,by=c("follow"="follow")) %>% mutate(RR_12points=TDD/DJL_12points)%>% dplyr::select(-firstE,-firstN,-lastE,-lastN,-TDD)

DJL_follows_subsample_14point <- subsample_frequencyAnalaysis14point %>%
  filter(followtype == "NN") %>%
  group_by(
    follow
  ) %>%
  summarise(DJL_14points = sum(as.numeric(manual_distTolast), na.rm = TRUE), count_14points =
              n(), turningAngleSum_14points=sum(as.numeric(turningAngle), na.rm = TRUE), meanTimelag_14points=mean(timelag_lead,na.rm=TRUE), medianTimelag_14points=median(timelag_lead,na.rm=TRUE))
DJL_follows_subsample_14point <- DJL_follows_subsample_14point %>% left_join(TDD_follows,by=c("follow"="follow")) %>% mutate(RR_14points=TDD/DJL_14points)%>% dplyr::select(-firstE,-firstN,-lastE,-lastN,-TDD)

DJL_follows_subsample_20point <- subsample_frequencyAnalaysis20point %>%
  filter(followtype == "NN") %>%
  group_by(
    follow
  ) %>%
  summarise(DJL_20points = sum(as.numeric(manual_distTolast), na.rm = TRUE), count_20points =
              n(), turningAngleSum_20points=sum(as.numeric(turningAngle), na.rm = TRUE), meanTimelag_20points=mean(timelag_lead,na.rm=TRUE), medianTimelag_20points=median(timelag_lead,na.rm=TRUE))
DJL_follows_subsample_20point <- DJL_follows_subsample_20point %>% left_join(TDD_follows,by=c("follow"="follow")) %>% mutate(RR_20points=TDD/DJL_20points)%>% dplyr::select(-firstE,-firstN,-lastE,-lastN,-TDD)

DJL_follows <- DJL_follows %>% left_join(DJL_follows_subsample_15min,by=c("follow"="follow"))
DJL_follows <- DJL_follows %>% left_join(DJL_follows_subsample_30min,by=c("follow"="follow"))
DJL_follows <- DJL_follows %>% left_join(DJL_follows_subsample_6point,by=c("follow"="follow"))
DJL_follows <- DJL_follows %>% left_join(DJL_follows_subsample_8point,by=c("follow"="follow"))
DJL_follows <- DJL_follows %>% left_join(DJL_follows_subsample_StartEnd,by=c("follow"="follow"))
DJL_follows <- DJL_follows %>% left_join(DJL_follows_subsample_10point,by=c("follow"="follow"))
DJL_follows <- DJL_follows %>% left_join(DJL_follows_subsample_12point,by=c("follow"="follow"))
DJL_follows <- DJL_follows %>% left_join(DJL_follows_subsample_14point,by=c("follow"="follow"))
DJL_follows <- DJL_follows %>% left_join(DJL_follows_subsample_20point,by=c("follow"="follow"))


DJL_follows_sample_long <- DJL_follows %>% ungroup() %>% 
  dplyr::select(follow,DJL,count,turningAngleSum,meanTimelag,medianTimelag,RR) %>% filter(follow %in% sample_FN_5min) %>% mutate(samplingrate="every")  

DJL_follows_subsample_15min <- DJL_follows_subsample_15min %>% mutate(samplingrate="every 2nd")
DJL_follows_subsample_30min <- DJL_follows_subsample_30min %>% mutate(samplingrate="every 4th")
DJL_follows_subsample_6point <- DJL_follows_subsample_6point %>% mutate(samplingrate="every 6th")
DJL_follows_subsample_8point <- DJL_follows_subsample_8point %>% mutate(samplingrate="every 8th")
DJL_follows_subsample_10point <- DJL_follows_subsample_10point %>% mutate(samplingrate="every 10th")
DJL_follows_subsample_12point <- DJL_follows_subsample_12point %>% mutate(samplingrate="every 12th")
DJL_follows_subsample_14point <- DJL_follows_subsample_14point %>% mutate(samplingrate="every 14th")
DJL_follows_subsample_20point <- DJL_follows_subsample_20point %>% mutate(samplingrate="every 20th")
DJL_follows_subsample_StartEnd <- DJL_follows_subsample_StartEnd %>% mutate(samplingrate="Start End")

colnames(DJL_follows_subsample_15min) <- colnames(DJL_follows_sample_long)
colnames(DJL_follows_subsample_30min) <- colnames(DJL_follows_sample_long)
colnames(DJL_follows_subsample_6point) <- colnames(DJL_follows_sample_long)
colnames(DJL_follows_subsample_8point) <- colnames(DJL_follows_sample_long)
colnames(DJL_follows_subsample_10point) <- colnames(DJL_follows_sample_long)
colnames(DJL_follows_subsample_12point) <- colnames(DJL_follows_sample_long)
colnames(DJL_follows_subsample_14point) <- colnames(DJL_follows_sample_long)
colnames(DJL_follows_subsample_20point) <- colnames(DJL_follows_sample_long)
colnames(DJL_follows_subsample_StartEnd) <- colnames(DJL_follows_sample_long)

DJL_follows_sample_long <- DJL_follows_sample_long %>% rbind(DJL_follows_subsample_15min) 
DJL_follows_sample_long <- DJL_follows_sample_long %>% rbind(DJL_follows_subsample_30min)
DJL_follows_sample_long_extra <- DJL_follows_sample_long %>% rbind(DJL_follows_subsample_6point)
DJL_follows_sample_long_extra <- DJL_follows_sample_long_extra %>% rbind(DJL_follows_subsample_8point)
DJL_follows_sample_long_extra <- DJL_follows_sample_long_extra %>% rbind(DJL_follows_subsample_10point)
DJL_follows_sample_long_extra <- DJL_follows_sample_long_extra %>% rbind(DJL_follows_subsample_12point)
DJL_follows_sample_long_extra <- DJL_follows_sample_long_extra %>% rbind(DJL_follows_subsample_14point)
DJL_follows_sample_long_extra <- DJL_follows_sample_long_extra %>% rbind(DJL_follows_subsample_20point)

DJL_follows_sample_long_extra <- DJL_follows_sample_long_extra %>% rbind(DJL_follows_subsample_StartEnd)

##### Visiualize
DJL_follows %>% filter(follow %in% sample_FN_5min) %>% ggplot(aes(DJL,meanTimelag))+
  geom_point(colour="black")+
  geom_point(data=DJL_follows,aes(DJL_15min,meanTimelag_15min),colour="blue")+
  geom_point(data=DJL_follows,aes(DJL_30min,meanTimelag_30min),colour="red")

DJL_follows_sample<- DJL_follows %>% filter(follow %in% sample_FN_5min) 
DJL_follows_sample%>% ggplot(aes(DJL,meanTimelag,colour=as.factor(follow)))+
  geom_point(size=5)+
  geom_point(data=DJL_follows_sample,aes(DJL_15min,meanTimelag_15min),shape=17,size=5)+
  geom_point(data=DJL_follows_sample,aes(DJL_30min,meanTimelag_30min),shape=15,size=5)+
  geom_path()+
  theme(legend.title = element_blank())

plot_DJLxTimelagxSubsampling<- DJL_follows_sample_long%>% ggplot(aes(DJL,meanTimelag,colour=as.factor(follow)))+
  geom_point(size=5,shape=as.factor(DJL_follows_sample_long$samplingrate))+
  geom_path(size=0.2)+
  theme(legend.position = "none")+labs(title = "Subsampling of 18 high frequency follows \n (triangle = every 2nd, cross= every 4th point)",x="DJL [m]",y="mean timelag [s]")+theme(plot.title = element_text(hjust = 0.5))
plot_DJLxTimelagxSubsampling
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_DJLxTimelagxSubsampling",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_DJLxTimelagxSubsampling)

plot_RRxTimelagxSubsampling<- DJL_follows_sample_long%>% ggplot(aes(RR,meanTimelag,colour=as.factor(follow)))+
  geom_point(size=5,shape=as.factor(DJL_follows_sample_long$samplingrate))+
  geom_path(size=0.2)+
  theme(legend.position = "none")+labs(title = "Subsampling of 18 high frequency follows \n (triangle = every 2nd, cross= every 4th point)",x="SI",y="mean timelag [s]")+theme(plot.title = element_text(hjust = 0.5))
plot_RRxTimelagxSubsampling

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_RRxTimelagxSubsampling",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_RRxTimelagxSubsampling)


means <- aggregate(meanTimelag ~  samplingrate, DJL_follows_sample_long, mean)
means <- means %>% mutate(meanTimelag=paste0("mean timelag [s]: ",round(meanTimelag,digits = 0)))
plot_DJLxTimelagxSubsampling_boxplot<- DJL_follows_sample_long %>% ggplot(aes(DJL,samplingrate,colour=as.factor(samplingrate),alpha=0.8))+
  geom_violin(alpha=0.5)+
  geom_boxplot(size=1)+
  theme(legend.position = "none")+labs(title = "Subsampling of 18 high frequency follows",x="DJL [m]",y="subsampling rate")+theme(plot.title = element_text(hjust = 0.5),axis.title.y = element_blank())+
  geom_text(data = means, aes(label = meanTimelag, x = 2000),hjust = 0.9,vjust=-7,color="black")
plot_DJLxTimelagxSubsampling_boxplot
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_DJLxTimelagxSubsampling_boxplot",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_DJLxTimelagxSubsampling_boxplot,dpi=150,width = 25.6,height = 1,units="cm")




### Visualize follows with higher and lower frequncy
follow_selected <- 687
follow_5min <- sample_frequencyAnalaysis_5min %>% filter(follow==follow_selected)
follow_5min<- follow_5min[order(follow_5min$manualTime , decreasing = FALSE ),]

follow_15min<- subsample_frequencyAnalaysis15min %>% filter(follow==follow_selected)
follow_15min<- follow_15min[order(follow_15min$manualTime , decreasing = FALSE ),]
follow_30min <- subsample_frequencyAnalaysis30min %>% filter(follow==follow_selected)
follow_30min<- follow_30min[order(follow_30min$manualTime , decreasing = FALSE ),]
follow_8 <- subsample_frequencyAnalaysis8point %>% filter(follow==follow_selected)
follow_8<- follow_8[order(follow_8$manualTime , decreasing = FALSE ),]
follow_10 <- subsample_frequencyAnalaysis10point %>% filter(follow==follow_selected)
follow_10<- follow_10[order(follow_10$manualTime , decreasing = FALSE ),]
follow_12 <- subsample_frequencyAnalaysis12point %>% filter(follow==follow_selected)
follow_12<- follow_12[order(follow_12$manualTime , decreasing = FALSE ),]
follow_14 <- subsample_frequencyAnalaysis14point %>% filter(follow==follow_selected)
follow_14<- follow_14[order(follow_14$manualTime , decreasing = FALSE ),]
follow_20 <- subsample_frequencyAnalaysis20point %>% filter(follow==follow_selected)
follow_20<- follow_20[order(follow_20$manualTime , decreasing = FALSE ),]


plot_subsample_freqanalysis<-follow_30min %>%
  group_by(follow)  %>% mutate(follow=as.factor(follow)) %>% 
  ggplot()+
  # geom_point(aes(E,N,color=paste0("every 4th (mean timelag: ",round(mean(follow_30min$timelag_lead,na.rm=TRUE),0),")"), group=follow),size=1)+
  # geom_path(aes(E,N, color=paste0("every 4th (mean timelag: ",round(mean(follow_30min$timelag_lead,na.rm=TRUE),0),")"), group=follow), alpha = 1,size=0.5)+
  geom_point(data = follow_15min,aes(E,N,color=paste0("every 2nd (mean timelag: ",round(mean(follow_15min$timelag_lead,na.rm=TRUE),0),")"), group=follow),size=1)+
  geom_path(data = follow_15min,aes(E,N, color=paste0("every 2nd (mean timelag: ",round(mean(follow_15min$timelag_lead,na.rm=TRUE),0),")"), group=follow), alpha = 0.5,size=0.5)+
  # geom_point(data = follow_8,aes(E,N,color="~8 points", group=follow),size=1)+
  # geom_path(data = follow_8,aes(E,N, color="~8 points", group=follow), alpha = 0.5,size=0.5)+
  # geom_point(data = follow_10,aes(E,N,color="~10 points", group=follow),size=1)+
  # geom_path(data = follow_10,aes(E,N, color="~10 points", group=follow), alpha = 0.5,size=0.5)+
  # geom_point(data = follow_12,aes(E,N,color="~12 points", group=follow),size=1)+
  # geom_path(data = follow_12,aes(E,N, color="~12 points", group=follow), alpha = 0.5,size=0.5)+
  # geom_point(data = follow_14,aes(E,N,color="~14 points", group=follow),size=1)+
  # geom_path(data = follow_14,aes(E,N, color="~14 points", group=follow), alpha = 0.5,size=0.5)+
  geom_point(data = follow_20,aes(E,N,color=paste0("every 20th (mean timelag: ",round(mean(follow_20$timelag_lead,na.rm=TRUE),0),")"), group=follow),size=1)+
  geom_path(data = follow_20,aes(E,N, color=paste0("every 20th (mean timelag: ",round(mean(follow_20$timelag_lead,na.rm=TRUE),0),")"), group=follow), alpha = 0.5,size=0.5)+
  geom_point(data = follow_5min,aes(E,N,color=paste0("every point (mean timelag: ",round(mean(follow_5min$timelag_lead,na.rm=TRUE),0),")"), group=follow),size=1)+
  geom_path(data = follow_5min,aes(E,N, color=paste0("every point (mean timelag: ",round(mean(follow_5min$timelag_lead,na.rm=TRUE),0),")"), group=follow), alpha = 0.5,size=0.5)+
  geom_sf(data = SUAQ_pathnetwork_sf_loc,
                                               aes(colour = "black", alpha = 1),
                                               fill = NA,colour = "black")+
  scale_y_continuous(breaks = seq(336500,337500,10)) +
  scale_x_continuous(breaks = seq(324000,326000,10)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.7))+
  coord_cartesian()
plot_subsample_freqanalysis
ggplotly(plot_subsample_freqanalysis,crs = sf::st_crs(23867))



plot_DJLxSmooth<- DJL_follows_sample_long_extra %>% mutate(follow=as.character(follow)) %>% ggplot(aes(DJL,meanTimelag,alpha=0.8))+
  geom_point(size=3,aes(color=follow),shape=as.factor(DJL_follows_sample_long_extra$samplingrate))+
  geom_path(size=0.5,aes(color=follow))+
  theme(legend.position = "none")+labs(title = "Subsampling of 18 high frequency follows", subtitle="For subsamples of [every x point]: 2,4,6,8,10,12,14,20,TDD",x="DJL [m]",y="subsampling rate")+
  xlim(0,2000)+
  scale_y_log10(labels=fancy_scientific)
plot_DJLxSmooth

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_DJLxSmooth",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_DJLxSmooth,dpi=150,width = (29.7)/1.5,height = 21,units="cm")

plot_RRxSmooth<- DJL_follows_sample_long_extra %>% mutate(follow=as.character(follow)) %>% ggplot(aes(RR,meanTimelag,alpha=0.8))+
  geom_point(size=3,aes(color=follow),shape=as.factor(DJL_follows_sample_long_extra$samplingrate))+
  geom_path(size=0.5,aes(color=follow))+
  theme(legend.position = "none")+labs(title = "Subsampling of 18 high frequency follows", subtitle="For subsamples of [every x point]: 2,4,6,8,10,12,14,20,TDD",x="SI",y="subsampling rate")+

  scale_y_log10(labels=fancy_scientific)
plot_RRxSmooth

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_RRxSmooth",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_RRxSmooth,dpi=150,width = (29.7)/1.5,height = 21,units="cm")


#### get overview stats of subsampling
decrease_djl<- DJL_follows_sample %>% mutate(decrease_skip2_DJL=DJL_15min/DJL,decrease_skip4_DJL=DJL_30min/DJL_15min)
summary(decrease_djl$decrease_skip2_DJL)
summary(decrease_djl$decrease_skip4_DJL)

DJL_follows_sample_long %>% group_by(samplingrate) %>% summarise(mean=mean(DJL,na.rm=TRUE)) 
group_by(samplingrate) %>% summary()
repeated
aov_repeated<- aov(DJL~samplingrate,DJL_follows_sample_long)
summary(aov_repeated)
autoplot(aov_repeated)
friedman.test(DJL~samplingrate,data=DJL_follows_sample_long)
?friedman.test()
summary(DJL_follows_sample_long[DJL_follows_sample_long$samplingrate=="every",]$DJL)


DJL_follows_sample %>% ggplot(aes(DJL,DJL_30min)) +geom_point()+geom_smooth()+labs(x="DJL 5 min sampling",y="DJL 30 min sampling")
DJL_follows_sample %>% ggplot(aes(RR,RR_30min)) +geom_point()+geom_smooth()+labs(x="RR 5 min sampling",y="RR 30 min sampling")

subsampling_explanation_RR<- lm(RR~ RR_30min,data=DJL_follows_sample)
subsampling_explanation_DJL<- lm(DJL~ DJL_30min,data=DJL_follows_sample)
summary(subsampling_explanation_DJL)$coefficients
summary(subsampling_explanation_RR)


autoplot(subsampling_explanation_RR)

#### Testing subsampling areas of path when do we get shortenings of more than 20m
result <- data.frame()
selected_freqanalysis_5min<- sample_frequencyAnalaysis_5min %>% filter(followtype=="NN")
follows <- as.vector(levels(as.factor(selected_freqanalysis_5min$follow)))
for(foll in follows){
  print(foll)
  subsamp_5min<- st_as_sf(selected_freqanalysis_5min,coords = c("E","N")) %>% filter(follow==foll)
  subsamp_5min_line<- subsamp_5min %>% st_coordinates() %>% st_linestring()
  subsamp_5min_buffered<- st_buffer(subsamp_5min_line,10)
  follows<- as.vector(subsamp_5min$follow)
  for(i in c(1,seq(2,nrow(subsamp_5min),1))){
    print(i)
    subsample <- sample_frequencyAnalaysis_rest %>% group_by() %>% filter(follow==foll)  %>% slice(seq(i, n(), by = i))
    subsample_frequencyAnalaysis_start_end_temp <- subsample_frequencyAnalaysis_start_end%>% filter(follow==foll) 
    subsample <- subsample %>%   
      rbind(subsample_frequencyAnalaysis_start_end_temp) %>% arrange(desc(manualTime))
    
    subsample<- subsample %>% 
        group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
         mutate(timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         speed_last = manual_distTolast/timelag,
         speed_next = manual_distToNext/timelag_lead,
         turningAngle=turning_angle(E,N),
         altitudediff_next=altitude-lead(altitude),
         )
    
    
    
    
    subsample_sf<- st_as_sf(subsample, 
                          coords = c("E","N"), 
                          crs = 23867)
    subsample_sf_line<- subsample_sf %>% st_coordinates() %>% st_linestring()
    subsample_sf_line <- st_buffer(subsample_sf_line,10) 
    area_of_intersection<- st_area(st_intersection(subsamp_5min_buffered,subsample_sf_line))/st_area(subsamp_5min_buffered)
    result<-result %>% rbind(data.frame(follow=foll,subsamplingrate=i,overlap_perc=area_of_intersection,meanTimelag=mean(subsample$timelag_lead,na.rm=TRUE),DJL=sum(as.numeric(subsample$manual_distTolast),na.rm = TRUE)))
    
  }
}

##### Create a Dataframe with subsamplings
subsamp_5min_buffered %>% ggplot(aes()) + geom_sf(fill="darkgreen")+geom_sf(data=subsample_sf_line, fill="blue",alpha=0.3)

plot_area_bootstrapped <- result %>% mutate(follow=as.character(follow))%>%   ggplot(aes(meanTimelag,overlap_perc,color=follow,group=follow)) + geom_point()+scale_x_log10()+labs(x="mean timealag [s]",y="overlap of path")+geom_path()+theme(legend.position = "none")
plot_area_bootstrapped
result_mean <- result %>% group_by(subsamplingrate) %>% summarise(mtimelag=mean(meanTimelag,na.rm=TRUE),meanoverlap=mean(overlap_perc,na.rm=TRUE))

summary(result[result$subsamplingrate==3,]$overlap_perc)

plot_DJL_bootstrapped<- result %>% ggplot(aes(meanTimelag,DJL,color=follow,group=follow)) + geom_point()+ geom_path()+scale_x_log10()+labs(x="mean timelag [s]",y="DJL [m]")+geom_path()+theme(legend.position = "none")
plot_DJL_bootstrapped

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),
    "_plot_area_bootstrapped",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_area_bootstrapped)

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),
    "_plot_DJL_bootstrapped",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_DJL_bootstrapped)


print(xtable(result_mean, type = "latex"), file = "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/tables/subsampling_meanoverlapXsubsamplingrate")
```

```{r analysis with move/ ctmm, further methods to calculate DJL}
#### Must replace all duplicates where focal and timestamp is the same --> See SUAQr script implemented there.
### CTMM online
SUAQ_rangepoints_11all20_loc_wgs <- SUAQ_rangepoints_11all20_loc_wgs[order(SUAQ_rangepoints_11all20_loc_wgs$focal,SUAQ_rangepoints_11all20_loc_wgs$manualDatetime , decreasing = TRUE ),] %>% rename(
    c("event-id"="identification","timestamp"="manualDatetime","location-long"="long","location-lat"="lat","Animal ID"="focal","Tag No"="follow")
  ) %>% filter(`Animal ID`%in% c("lisa","friska","ellie","cissy","lilly","yulia","raffi","sarabi","trident","alice","mocca","cinnamon")) %>% mutate("sensor-type"="gps")
write_csv(SUAQ_rangepoints_11all20_loc_wgs, path = paste(
  paste(
    "/Users/stefgr/Nextcloud/UZH/12_Semester/20200313_Masterthesis/R/data/Processed_data/",
    "SUAQ_rangepoints_11all20_loc_wgs",
    sep = ""
  ),
  "csv",
  sep = "."
))

### Move
SUAQ_move_stack <-
  move(
    x = SUAQ_rangepoints_11all20_loc_wgs$`location-long`,
    y = SUAQ_rangepoints_11all20_loc_wgs$`location-lat`,
    as.POSIXct(
      SUAQ_rangepoints_11all20_loc_wgs$timestamp,
      format = "%Y-%m-%d %H:%M:%OS",
      tz = "Asia/Pontianak"
    ),
    proj = CRS("+proj=utm +zone=47 +ellps=WGS84 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs "),
    data = SUAQ_rangepoints_11all20_loc_wgs,
    animal = SUAQ_rangepoints_11all20_loc_wgs$`Animal ID`,
    sensor = "gps"
  )
SUAQ_move_unstacked_list <- split(SUAQ_move_stack)
SUAQ_move_unstacked_selection <- moveStack(list(SUAQ_move_unstacked_list$lilly,SUAQ_move_unstacked_list$cissy))

SUAQ_telemetry_cissy<- as.telemetry(SUAQ_move_unstacked_list$cissy,drop=FALSE)

#### Semivariogram analysis
SVF <- variogram(SUAQ_telemetry_cinnamon[[1]])
plot(SVF)

#### daily travel distance analysis
uere(SUAQ_telemetry_cissy) <- 10 ### GPS accuracy of 10m see manual of noonan and fleming paper
par(mfrow=c(1,3))
plot(SUAQ_telemetry_cissy, error = 2,level.UD = 0.50) 
OUTLIERS <- ctmm::outlie(SUAQ_telemetry_cissy,UERE=10)
#SUAQ_telemetry_cissy <- SUAQ_telemetry_cissy[-(which(OUTLIERS[[1]] >= 0.6)),]
plot(OUTLIERS)

# automated guestimate for uncalibrated data (with 10 meter RMS UERE guess)
GUESS <- ctmm.guess(SUAQ_telemetry_cissy[[1]],CTMM=ctmm(error=10),interactive=FALSE)
# fit and select models # CRAN policy limits us to 2 cores
FIT <- ctmm.select(SUAQ_telemetry_cissy[[1]],GUESS,trace=TRUE,cores=2)
summary(FIT)

gps_speed <- speed(SUAQ_telemetry_cissy[[1]], FIT)

test <- SUAQ_telemetry_cissy[[1]]
GUESS <- ctmm.guess(SUAQ_telemetry_cissy[[1]], interactive = FALSE,CTMM = ctmm(tau = c(Inf, 2 %#% 'hours'), range = FALSE))
GUESS$error <- TRUE
GPS_FIT <- ctmm.select(SUAQ_telemetry_cissy,GUESS)
summary(GPS_FIT)


ellie<- SUAQ_telemetry[1]
SVF <- variogram(SUAQ_telemetry_adoloscent[1])

#### With ctmm
data("buffalo")
Cilla <- buffalo
plot(Cilla)
title("1 Buffalo")
plot(buffalo,col=rainbow(length(buffalo)))
title("5 Buffalo")

SUAQ_move_ellie <- SUAQ_rangepoints_11all20_loc_wgs[order(SUAQ_rangepoints_11all20_loc_wgs$focal,SUAQ_rangepoints_11all20_loc_wgs$manualDatetime , decreasing = FALSE ),] %>% filter(focal=="saruman") %>% ungroup()
SUAQ_move_ellie <- move(x=SUAQ_move_ellie$E, y=SUAQ_move_ellie$N, 
              time=as.POSIXct(SUAQ_move_ellie$manualDatetime, format="%Y-%m-%d %H:%M:%OS", tz="Asia/Pontianak"),
              proj=CRS("+proj=utm +zone=47 +ellps=WGS84 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs "), 
              data=SUAQ_move_ellie, animal=SUAQ_move_ellie$focal, sensor="gps")

SUAQ_telemetry<- as.telemetry(SUAQ_move_ellie,drop=FALSE)
SUAQ_telemetry
ellie<- SUAQ_telemetry[1]
SVF <- variogram(SUAQ_telemetry[[1]])
level <- c(0.5,0.95) # 50% and 95% CIs
xlim <- c(0,12 %#% "hour") # 0-12 hour window
plot(SVF,xlim=xlim,level=level)
title("zoomed in")
plot(SVF,fraction=0.65,level=level)
title("zoomed out")

```

```{r errorsearching}
##### ##### TO DELETE Inspecting strange distances in follows geometrically##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
###### Long edge lengths
specs_meanEdgeLengthFollows <- SUAQ_rangepoints_11all20_loc %>%
  group_by(
    follow,
    focal,
    ClassFocal,
    SUAQ_weather.rainfall_ml_evening,
    SUAQ_weather.river_waterlevel_morning,
    SUAQ_weather.river_waterlevel_evening,
    SUAQ_weather.rainfall_ml_morning,
    SUAQ_weather.avg_temperature_tot,
    SUAQ_weather.max_temp_average,
    SUAQ_weather.min_temp_average,
    SUAQ_weather.temperature_max_morning,
    SUAQ_weather.temperature_min_morning,
    SUAQ_fai.fai,
    ageOfCurrentOffspring,
    monthYearDate
  ) %>%
  summarise(meanEdgeLength = mean(as.numeric(manual_distTolast), na.rm = TRUE), count =
              n())

plot_histoMeanEdgeLength <-
  specs_meanEdgeLengthFollows %>% ggplot(aes(meanEdgeLength)) + geom_histogram(binwidth = 10) +
  labs(title = "Mean distance to next point (edge length) per follow histogram", x = "distance [m]", y = "count")
plot_histoMeanEdgeLength


specs_numOfGPSatSameLoc <-
  SUAQ_rangepoints_11all20_loc %>% group_by(E, N) %>% summarise(
    count = n(),
    follow = as.character(list(follow)),
    fileN = as.character(list(fileN)),
    automaticDate = as.character(list(automaticDate)),
    manualDate = as.character(list(as.character(manualDate))),
    automaticTime = as.character(list(as.character(automaticTime))),
    manualTime = as.character(list(as.character(manualTime)))
  )
specs_numOfGPSatSameLoc <- specs_numOfGPSatSameLoc %>% filter(count>1) 
specs_GPSatSameLoc_reoccurringFollowNpairs <- specs_numOfGPSatSameLoc %>% filter(count<3) %>% group_by(follow) %>% summarise(nDoubleGPS=n())

write_delim(delim=";",specs_numOfGPSatSameLoc, path = paste(
  paste(
    "/Users/stefgr/Nextcloud/UZH/12_Semester/20200313_Masterthesis/R/data/Processed_data/",
    "specs_numOfGPSatSameLoc",
    sep = ""
  ),
  "csv",
  sep = "."
))


#### DJL of all visualized
### Visualize all follows over time
SUAQ_rangepoints_11all20_loc$ClassFocal = with(SUAQ_rangepoints_11all20_loc,reorder(ClassFocal,orangutan_tot_num_of_gps, length))
darkcols <- brewer.pal(5, "Dark2")
names(darkcols) <- levels(as.factor(SUAQ_rangepoints_11all20_loc$ClassFocal))
colours_focal<- SUAQ_rangepoints_11all20_loc %>% filter(followtype=="NN") %>% group_by(focal,orangutan_tot_num_of_gps) %>% summarise(ClassFocal=Mode(ClassFocal))
colours_focal <- colours_focal %>%mutate(colorClass=darkcols[ClassFocal]) %>% mutate(colorClass=ifelse(is.na(colorClass),"grey",colorClass))
colours_focal<-colours_focal[order(colours_focal$focal , decreasing = TRUE ),]
colours_focal<-colours_focal[order(colours_focal$orangutan_tot_num_of_gps , decreasing = TRUE ),]
p1plus <- SUAQ_rangepoints_11all20_loc %>%
  left_join(colours_focal,by=c("focal"="focal")) %>% 
  filter(!is.na(focal)) %>%
  #filter(SUAQ_orangutans.Sex=="female") %>% 
  filter(followtype=="NN") %>%
  group_by(focal,manualDate,follow,colorClass) %>% summarise() %>%
  ggplot(aes(manualDate, focal)) +
  annotate("rect", xmin=as.Date("2010-01-01"), xmax=as.Date("2010-12-31"), ymin=-Inf, ymax=Inf, alpha=0.1, fill="coral4")+
  annotate("rect", xmin=as.Date("2012-01-01"), xmax=as.Date("2012-12-31"), ymin=-Inf, ymax=Inf, alpha=0.1, fill="coral4")+
  annotate("rect", xmin=as.Date("2014-01-01"), xmax=as.Date("2014-12-31"), ymin=-Inf, ymax=Inf, alpha=0.1, fill="coral4")+
  annotate("rect", xmin=as.Date("2016-01-01"), xmax=as.Date("2016-12-31"), ymin=-Inf, ymax=Inf, alpha=0.1, fill="coral4")+
  annotate("rect", xmin=as.Date("2018-01-01"), xmax=as.Date("2018-12-31"), ymin=-Inf, ymax=Inf, alpha=0.1, fill="coral4")+
  annotate("rect", xmin=as.Date("2020-01-01"), xmax=as.Date("2020-12-31"), ymin=-Inf, ymax=Inf, alpha=0.1, fill="coral4")+
  geom_point(aes(colour=colorClass,stroke=0.3),shape =4,size=1.5) +
  labs( x = "date", y =
         "orangutan name") +
  theme(legend.position = "none",
        plot.margin = unit(c(1,0.05,0.02,1), "cm"))+
  theme(#axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 0.6, hjust=0),
        axis.title.y = element_blank())+
  scale_x_date(position = "top",breaks = scales::pretty_breaks(n = 10))+
  theme(axis.text.y = element_text(colour=rev(colours_focal$colorClass)))+
  scale_colour_manual(values = levels(as.factor(colours_focal$colorClass)))+
  labs(x="")
p1plus

result_totnumfollows_all <- SUAQ_waypoints_11all20 %>% group_by(follow) %>% summarise(follow_totNumOfGPSpoints=n()) 


p2plus <- SUAQ_rangepoints_11all20_loc %>% # Prozent von follows rechts
  left_join(colours_focal,by=c("focal"="focal")) %>% 
  filter(!is.na(focal)) %>%
  filter(followtype=="NN") %>% 
  mutate(orangutan_num_of_follows_log=log10(orangutan_num_of_follows),
         orangutan_num_of_follows_percentage=(orangutan_num_of_follows/nrow(result_totnumfollows)),
         orangutan_num_of_follows_percentage_females=(orangutan_num_of_follows/nrow(result_totnumfollows_all))) %>%  # if i want log scales
  group_by(focal,orangutan_num_of_follows,orangutan_num_of_follows_percentage_females,orangutan_num_of_follows_log,colorClass) %>% summarise() %>% 
  ggplot() +
  geom_bar(aes(x=orangutan_num_of_follows_percentage_females ,y=focal,fill = colorClass),stat= "identity",na.rm = TRUE,width = 0.4)+
  geom_text(aes(label = scales::percent(orangutan_num_of_follows_percentage_females,accuracy = .001), # show two decimals
                   x=orangutan_num_of_follows_percentage_females ,y=focal),size=2, stat= "identity", hjust = -0.5, alpha=0.7, fill="black") +
  theme(legend.position = "none")+
  theme_minimal()+
  theme(axis.text.y = element_blank(),
        #axis.text.x = element_text(angle = 90,size=12),
        axis.text.x = element_blank(),
        #axis.ticks.y = element_blank(),
        #axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        plot.background = element_blank(),
        #axis.title.x= element_text(angle = -45,hjust = 1.2))+
        axis.title.x= element_blank())+
  scale_x_continuous(labels = percent_format(),position = "top")+
  scale_colour_manual(values = levels(as.factor(colours_focal$colorClass)))+
  labs(y="# Follows") +
  theme(legend.position = "none",
        plot.margin = unit(c(0,1,3.27,0), "cm"))+
  xlim(0,0.5)
p2plus

p3plus <- SUAQ_rangepoints_11all20_loc %>% # Histogram unten
  filter(!is.na(focal)) %>%
  filter(followtype=="NN") %>% 
  ggplot(aes(x=manualDate)) +
  geom_histogram(bins = 120)+ # bins for every 3 month
  theme_minimal()+
  annotate("rect", xmin=as.Date("2010-01-01"), xmax=as.Date("2010-12-31"), ymin=-Inf, ymax=Inf, alpha=0.1, fill="coral4")+
  annotate("rect", xmin=as.Date("2012-01-01"), xmax=as.Date("2012-12-31"), ymin=-Inf, ymax=Inf, alpha=0.1, fill="coral4")+
  annotate("rect", xmin=as.Date("2014-01-01"), xmax=as.Date("2014-12-31"), ymin=-Inf, ymax=Inf, alpha=0.1, fill="coral4")+
  annotate("rect", xmin=as.Date("2016-01-01"), xmax=as.Date("2016-12-31"), ymin=-Inf, ymax=Inf, alpha=0.1, fill="coral4")+
  annotate("rect", xmin=as.Date("2018-01-01"), xmax=as.Date("2018-12-31"), ymin=-Inf, ymax=Inf, alpha=0.1, fill="coral4")+
  annotate("rect", xmin=as.Date("2020-01-01"), xmax=as.Date("2020-12-31"), ymin=-Inf, ymax=Inf, alpha=0.1, fill="coral4")+
  theme(legend.position = "none")+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.background = element_blank(),
        axis.text.y = element_text(size=5),
        legend.position = "none",
        plot.margin = unit(c(0,-1,1,0.56), "cm"))+
  scale_y_continuous()+
  scale_x_date(breaks = scales::pretty_breaks(n = 10))+
  theme(plot.margin = margin(t=4,b=20,unit = "pt"))# add margin on top between plot 1
  #scale_y_reverse()
p3plus

blank <- grid.rect(gp=gpar(col="white")) # create empty white plots to make margins afterwards
p<- arrangeGrob( # Use only grobs to save it
  arrangeGrob(
    p1plus,
    arrangeGrob(blank, p3plus, ncol = 2, widths = c(5.8 / 40, 35.2 / 40)),
    heights = c(6.5 / 8, 1.5 / 8),
    nrow = 2
  ),
  arrangeGrob(blank, p2plus, heights = c(2.1 / 16, 13.9 / 16), nrow = 2),
  ncol = 2,
  widths = c(3, 1)
) 
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),
    "_Data_OrangutansFollowDensityTemporal",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = p)

##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 

##### Analayzing edge lengths Visualizations
plot_histgoramEdgeLengths <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(manual_distToNext)) + 
  geom_histogram(aes(y=..density..),colour="darkgrey",binwidth = 0.003) +  
  scale_x_log10(labels=fancy_scientific) +
  labs( x = "distance [m]", y = "count")+
  geom_vline(aes(xintercept=mean(SUAQ_rangepoints_11all20_loc$manual_distToNext,na.rm = TRUE)),color="blue", linetype="dashed", size=1,alpha=0.4)+
  geom_vline(aes(xintercept=quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[1]),color="red", linetype="dashed", size=1,alpha=0.4)+
  geom_vline(aes(xintercept=quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[2]),color="red", linetype="dashed", size=1,alpha=0.4)+
  geom_density(alpha=.2, fill="#FF6666",colour=NA)+
  geom_text(aes(mean(as.numeric(SUAQ_rangepoints_11all20_loc$manual_distToNext),na.rm = TRUE), 4, label = paste("mean: ",round(mean(as.numeric(SUAQ_rangepoints_11all20_loc$manual_distToNext),na.rm = TRUE),2),"m")),colour="blue",alpha=0.9, data.frame())+
  geom_text(aes(round(quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[1],2), 3.5, label = paste("2.5%:",round(quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[1],2),"m")),colour="darkred",alpha=0.9, data.frame())+
  geom_text(aes(round(quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[2],2), 3.5, label = paste("97.5%:",round(quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[2],2),"m")),colour="darkred",alpha=0.9, data.frame())
plot_histgoramEdgeLengths

plot_scatterDistanceTimelag <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(manual_distToNext, timelag_lead)) +
  scale_y_log10() +
  geom_point() + labs(title = "Manual distance X Timelag to next point (edge length) scatterplot", x = "distance [m]", y = "timelag")


plot_scatterDistanceSpeed <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(manual_distToNext, speed_next)) +
  scale_y_log10(labels=fancy_scientific) +
  geom_point() + labs(title = "Manual distance X Speed to next point (edge length) scatterplot", x = "distance [m]", y = "speed [m/s]")
plot_scatterDistanceSpeed

plot_scatterDistanceSpeed <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(manual_distToNext, speed_next)) +
  scale_y_log10(labels=fancy_scientific) +
  geom_point() + labs(title = "Manual distance X Speed to next point (edge length) scatterplot", x = "distance [m]", y = "speed [m/s]")
plot_scatterDistanceSpeed

plot_scatterTimelagSpeed <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(timelag_lead, speed_next)) +
  scale_y_log10(labels=fancy_scientific) +
  geom_point() + labs(title = "Manual timelag X Speed to next point (edge length) scatterplot", x = "timelag [s]", y = "speed [m/s]")
plot_scatterTimelagSpeed


plot_histoAltitudeDiff <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(altitudediff_next)) +
  scale_y_log10(labels=fancy_scientific) +
  geom_histogram(binwidth = 1) + labs(title = "Histogram of altitude differences of edges", x = "altitude difference [m]", y = "count")
plot_histoAltitudeDiff

plot_scatterAltitudeDiffXSpeed <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(altitudediff_next, speed_next)) +
  scale_y_log10(labels=fancy_scientific) +
  geom_point(size=0.2) + labs(title = "Altitude difference X Speed to next point (edge length) scatterplot", x = "altitude diff [feet]", y = "speed [m/s]")
plot_scatterAltitudeDiffXSpeed


ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),
    "_plot_histgoramEdgeLengths",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_histgoramEdgeLengths)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_scatterDistanceTimelag",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_scatterDistanceTimelag)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_scatterDistanceSpeed_log",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_scatterDistanceSpeed)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_scatterTimelagSpeed",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_scatterTimelagSpeed)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_histoAltitudeDiff",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_histoAltitudeDiff)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_scatterAltitudeDiffXSpeed",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_scatterAltitudeDiffXSpeed)


##### FOLLOW vis
temp<-SUAQ_rangepoints_11all20_loc %>% 
  filter(follow %in% c("1089"))


plot_gps_pttype<-SUAQ_rangepoints_11all20_loc[order(SUAQ_rangepoints_11all20_loc$manualTime , decreasing = TRUE ),] %>% 
  #filter(PtType!="abnormal off point") %>% 
  #filter(follow %in% c("1089","1777","1822","1951","1805","1780","2876","2841","2020","1825","1501","663","2209","745","1759","2227","2183","2284","1776","687","671","1865","743","746","2938","2594","1874")) %>% 
  filter(follow %in%c(1082,2682,1822,745,2591,2284)) %>% 
  group_by(follow) %>%
  ggplot()+
  geom_point(aes(E,N,color=as.factor(follow)),size=1)+
  #geom_point(data = SUAQ_locationnetwork_loc,aes(E,N,fill="black"),size=2)+
  geom_path(aes(E,N,color=as.factor(follow)), alpha = 0.7,size=0.5)
ggplotly(plot_gps_pttype)



#### To delete testing how the function for sinuosity behaves
sincalc<- function(x){
    x <- as.numeric(x)
    a1 <- (1-c^2-s^2)
    b1 <- (1-c)^2+s^2
    result<- 2*((x*((a1/b1)+(b^2)))^(-0.5))
    return(result)
  }
x <- 10000
c <- 0.8
s <- 0.6
b <- 0.6
test<- data.frame("step1"=sample(x = 4:40, size = 1000, replace = TRUE),
                  "step2"=sample(x = 4:40, size = 1000, replace = TRUE),
                  "step3"=sample(x = 4:40, size = 1000, replace = TRUE),
                  "step4"=sample(x = 4:40, size = 1000, replace = TRUE),
                  "step5"=sample(x = 4:40, size = 1000, replace = TRUE),
                  "step6"=sample(x = 4:40, size = 1000, replace = TRUE),
                  "step7"=sample(x = 4:40, size = 1000, replace = TRUE),
                  "step8"=sample(x = 4:40, size = 1000, replace = TRUE)) %>% rowwise() %>% mutate(djl=sum(step1,step2,step3,step4,step5,step6,step7,step8)) 
test<- test%>%rowwise() %>%  mutate(sin=sincalc(djl))
test %>% ggplot(aes(sin,djl))+ geom_point()
#####

```






---
title: "Projekt"
author: "Stefan Graf"
date: "28 3 2020"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Markings:
#### Quality check: --> are quality checks of chunks executed before
########### DELETE ############--> are chunks to delete
## Title --> are titles for sections
### explanations of the following chunk
##### SUAQ TRACKS 2018 & 2019 ##### --> Code sections to understand code better

```{r import, echo= 'F',results='hide'}
# CLASSICAL PACKAGE IMPORTER (Stefan Graf & Tobias Frey)
packages_checker <- function(packages_list){
  for (package in packages_list){
    if (!require(package, character.only = T)) {
      install.packages(package)
    }
    library(package, character.only = T)
  }
}
packages_checker(
  c('viridis', # function pal
    'ctmm',
    'tmaptools',# read_gpx function
    'plotKML',# read GPX to dataframe
    'lubridate',
    'zoo',
    'data.tree',
    'hR',# making realtionships of orangutans
    'dbplyr',
    'plyr',
    'dplyr',
    'tidyr',
    'tidyverse',
    'sf', # Simple feature --> super spatial data handling structure
    'raster', # For raster data
    'ggspatial',
    'rgdal',
    'data.table',
    'RColorBrewer', # color schemas from color brewer web
    'ggraph', # visualization
    'igraph',
    'tmap',
    'vioplot',
    'scales',
    'trajr',
    'plotly', # zoomable, pannable ggplot
    'mapview',
    'ggmap', # easier interactive ggmaps 
    'leaflet', # Javascript library (originally) for plotting on a maptile interactive map
    'tmap',
    'stringr',
    'remotes', # geom_convexhull function
    'magrittr',
    'ggridges',
    'forcats',
    'move',# Brownian Bridge Movement Model
    'adehabitatHR',
    'ggpubr',
    'htmlwidgets',
    'gridExtra',# additional to ggplot, can add a density plot on the side of a histogram "marginal plot"
    'grid',
    'ggExtra',
    'lme4',
    'nlme',
    'ggfortify',
    'readr',
    'dplyr',
    'ggplot2',
    'tidyr',
    'tidyverse',
    'skimr',
    'viridis',
    'ggstatsplot',
    'ggpubr',
    'GGally',
    'ggfortify', #check linear regression assumptions
    'lindia', # linear regression tools z.b gg_rehist()
    'MuMIn',
    'MASS',
    'GGally', # usefull pairs function to create many scatterplots
    'maptools',# used in move package
    'circular', # used in move package
    'hrbrthemes',
    'viridis',
    'lmerTest'
    ))
rm(list = ls())
getwd()



### CUSTOM FUNCTIONS ###

# Function for displaying scale labels in ggplot not as f.e. 4e+05
fancy_scientific <- function(l) {
     # turn in to character string in scientific notation
     l <- format(l, scientific = TRUE)
     # quote the part before the exponent to keep all the digits
     l <- gsub("^(.*)e", "'\\1'e", l)
     # turn the 'e+' into plotmath format
     l <- gsub("e", "%*%10^", l)
     # return this as an expression
     parse(text=l)
}


clockS = function(t){hour(t)*3600+minute(t)*60+second(t)}
st_kde <- function(points,cellsize, bandwith, extent = NULL){
  require(MASS)
  require(raster)
  require(sf)
  if(is.null(extent)){
    extent_vec <- st_bbox(points)[c(1,3,2,4)]
  } else{
    extent_vec <- st_bbox(extent)[c(1,3,2,4)]
  }
  
  n_y <- ceiling((extent_vec[4]-extent_vec[3])/cellsize)
  n_x <- ceiling((extent_vec[2]-extent_vec[1])/cellsize)
  
  extent_vec[2] <- extent_vec[1]+(n_x*cellsize)-cellsize
  extent_vec[4] <- extent_vec[3]+(n_y*cellsize)-cellsize
  
  coords <- st_coordinates(points)
  matrix <- kde2d(coords[,1],coords[,2],h = bandwith,n = c(n_x,n_y),lims = extent_vec)
  raster(matrix)
}




#### Custom functions for analysis
clockS = function(t){hour(t)*3600+minute(t)*60+second(t)}


euclid <- function(x1,y1,x2,y2){
  return(sqrt((x1-x2)^2+(y1-y2)^2))
}

turning_angle <- function(x,y,lead_lag = 1){ 
  if(length(x) < 3){return(NA)}
  if(length(x) != length(y)){stop("x and y must be of the same length")}
  p1x <- lag(x,lead_lag)
  p1y <- lag(y,lead_lag)
  p2x <- x
  p2y <- y
  p3x <- lead(x,lead_lag)
  p3y <- lead(y,lead_lag)
  p12 <- euclid(p1x,p1y,p2x,p2y)
  p13 <- euclid(p1x,p1y,p3x,p3y)
  p23 <- euclid(p2x,p2y,p3x,p3y)
  rad <- acos((p12^2+p23^2-p13^2)/(2*p12*p23))
  grad <- (rad*180)/pi
  grad[p12 == 0 | p23 == 0] <- NA
  d <-  (p3x-p1x)*(p2y-p1y)-(p3y-p1y)*(p2x-p1x)
  d <- ifelse(d == 0,1,d)
  d[d>0] <- 1
  d[d<0] <- -1
  d[d==0] <- 1
  turning <- grad*d*-1+180
  return(turning)
}

# Source https://exploratory.io/note/kanaugust/1701090969905358
calculate_mode <- function(x) {
  uniqx <- unique(na.omit(x))
  uniqx[which.max(tabulate(match(x, uniqx)))]
}


# Statistics from here: https://github.com/aufrank/R-hacks/blob/master/mer-utils.R
vif.mer <- function (fit) {
    ## adapted from rms::vif

    v <- vcov(fit)
    nam <- names(fixef(fit))

    ## exclude intercepts
    ns <- sum(1 * (nam == "Intercept" | nam == "(Intercept)"))
    if (ns > 0) {
        v <- v[-(1:ns), -(1:ns), drop = FALSE]
        nam <- nam[-(1:ns)]
    }

    d <- diag(v)^0.5
    v <- diag(solve(v/(d %o% d)))
    names(v) <- nam
    v
}




setwd("/Users/stefgr/Nextcloud/UZH/12_Semester/20200313_Masterthesis/R/")

```

#### SUAQ research site
## Preprocessing
1. Getting data from excel/csv files
2. Getting data from gpx files, clean and order it
3. Merge Files

```{r GPS Loader,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}

### Load Project variables ### 
##### waypoints ##### "data/Processed_data/SUAQ_waypoints_11all20.csv"
##### find newest written dataset
mostrecent <- list.files(path = "data/Processed_data/", full.names = FALSE, recursive = FALSE)
mostrecent <- as.data.frame(mostrecent)
mostrecent <- mostrecent %>% filter(grepl("SUAQ_waypoints_11all20",mostrecent)) %>% 
  mutate(date=as.numeric(str_extract(mostrecent,"\\d{8}"))) %>% arrange(desc(date)) %>% top_n(1,date)

##### Load data
SUAQ_waypoints_11all20_loc <-
  read_csv(paste0("data/Processed_data/",mostrecent$date[1],"_SUAQ_waypoints_11all20.csv"),guess_max = min(10000, 30000))
SUAQ_waypoints_11all20_loc <- SUAQ_waypoints_11all20_loc %>% mutate(monthYearDate=format(as.Date(manualDate), "%Y-%m"))
SUAQ_waypoints_11all20_loc <- SUAQ_waypoints_11all20_loc %>% mutate(automaticDatetime=with_tz(automaticDatetime,tz = "Asia/Pontianak"))
SUAQ_waypoints_11all20_loc <- SUAQ_waypoints_11all20_loc %>% mutate(manualDatetime=with_tz(manualDatetime,tz = "Asia/Pontianak"))

SUAQ_waypoints_11all20_loc_test <- SUAQ_waypoints_11all20_loc %>% filter(focal!=SUAQ_followlog.FocalName)
SUAQ_waypoints_11all20_loc_test2 <- SUAQ_waypoints_11all20_loc %>% filter((ClassFocal!="mother")&!is.na(ageOfCurrentOffspring))


##### Weather and FAI #####
SUAQ_weather <- read_csv("data/Processed_data/SUAQ_weather.csv")
SUAQ_fai <- read_csv("data/Processed_data/SUAQ_fai.csv")

SUAQ_weather_monthly<-SUAQ_weather %>% 
  group_by(SUAQ_weather.year,SUAQ_weather.month) %>% 
  summarise_all(funs(mean))
SUAQ_weather_monthly<- SUAQ_weather_monthly%>% dplyr::select(-SUAQ_weather.weather_id,-SUAQ_weather.day,-SUAQ_weather.daymonthyear)

##### path network ##### 
SUAQ_pathnetwork<- as.data.frame(read_GPX(file="data/SUAQ_Peta_WithLines.GPX",layers = c("routes")))
colnames(SUAQ_pathnetwork)[15]<- "geometry"
SUAQ_pathnetwork_sf_wgs<- st_as_sf(SUAQ_pathnetwork,crs=4326)

##### location network ##### 
SUAQ_locationnetwork_sf_wgs <- st_read("data/20201201_StudyBalimbingStudyArea_points.GPX")
SUAQ_locationnetwork_sf_loc <- st_transform(SUAQ_locationnetwork_sf_wgs,crs = 23847)

##### for locale coordinate system
coordinates_tmp <- st_coordinates(SUAQ_locationnetwork_sf_loc)
colnames(coordinates_tmp) <- c("E","N")
SUAQ_locationnetwork_sf_loc <- cbind(SUAQ_locationnetwork_sf_loc,coordinates_tmp)
SUAQ_locationnetwork_loc <- st_drop_geometry(SUAQ_locationnetwork_sf_loc)

##### Selection only pointtypes which are taken on the orangutan way? is this true for all? ##### 
SUAQ_rangepoints_11all20_loc <- SUAQ_waypoints_11all20_loc %>% filter(PtType %in% c("daynest","found","lost","mornnest","nightnest","range","tree")) # get rid of lcg lch points and

##### Change trackpoint_id and total num of GPS per follow
###### trackpoint ID 
SUAQ_rangepoints_11all20_loc <- SUAQ_rangepoints_11all20_loc %>% group_by(follow) %>% dplyr::select(-trackpoint_id) %>% mutate(trackpoint_id = row_number())
###### Definitive number of gps per follow
result_totnumfollows <- SUAQ_rangepoints_11all20_loc %>% 
  group_by(follow) %>% summarise(follow_totNumOfGPSpoints=n()) # 1323 Follows
SUAQ_rangepoints_11all20_loc <- SUAQ_rangepoints_11all20_loc %>%dplyr::select(-follow_totNumOfGPSpoints) %>% left_join(result_totnumfollows,by=c("follow"="follow"))
###### orangutan number of points ID 
result_numoffollows<- SUAQ_rangepoints_11all20_loc %>% group_by(follow,focal) %>% summarize(count=n()) %>% group_by(focal) %>% summarize(count=n())
specs_orangutan_tot_num_of_gps <-SUAQ_rangepoints_11all20_loc %>% 
  group_by(focal) %>%
  summarise(n()) %>% left_join(result_numoffollows,by=c('focal'='focal'))
colnames(specs_orangutan_tot_num_of_gps) <- c("focal",
                                           "orangutan_tot_num_of_gps","orangutan_num_of_follows")
tmp<- specs_orangutan_tot_num_of_gps
SUAQ_rangepoints_11all20_loc <-SUAQ_rangepoints_11all20_loc %>% dplyr::select(-orangutan_num_of_follows,-orangutan_tot_num_of_gps) %>% 
  left_join(tmp,by = c("focal" = "focal"))

##### Recalculate edge lengths etc. based on new point selection for rangepoints dataframe
SUAQ_rangepoints_11all20_loc<- SUAQ_rangepoints_11all20_loc %>% 
  group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
  mutate(timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         speed_last = manual_distTolast/timelag,
         speed_next = manual_distToNext/timelag_lead,
         turningAngle=turning_angle(E,N),
         altitudediff_next=altitude-lead(altitude),
         )





##### WGS84 file
SUAQ_rangepoints_11all20_loc_sf <-  st_as_sf(SUAQ_rangepoints_11all20_loc, 
                          coords = c("E","N"), 
                          crs = 23847) # can also do that in the new sricpts
SUAQ_rangepoints_11all20_loc_sf_wgs <- st_transform(SUAQ_rangepoints_11all20_loc_sf,4326)
coordinates_tmp <- st_coordinates(SUAQ_rangepoints_11all20_loc_sf_wgs)
colnames(coordinates_tmp) <- c("long","lat")
SUAQ_rangepoints_11all20_loc_wgs <- cbind(SUAQ_rangepoints_11all20_loc_sf_wgs,coordinates_tmp)
SUAQ_rangepoints_11all20_loc_wgs<- st_drop_geometry(SUAQ_rangepoints_11all20_loc_wgs)


##### Selection only females / most tracked females ##### 
SUAQ_rangepoints_11all20_loc_females <-
  SUAQ_rangepoints_11all20_loc %>%   filter(!(SUAQ_orangutans.Sex == "male"))
SUAQ_rangepoints_11all20_loc_females_12 <-
  SUAQ_rangepoints_11all20_loc %>%   filter(!(SUAQ_orangutans.Sex == "male")) %>% filter(
    focal %in% c(
      "lisa",
      "friska",
      "ellie",
      "cissy",
      "lilly",
      "yulia",
      "raffi",
      "sarabi",
      "trident",
      "alice",
      "mocca",
      "cinnamon"
    )
  )
```

### Analysis
## Statistics

```{r Static analysis DJL RR,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
##### Create analysis DF #####
DJL_follows <- SUAQ_rangepoints_11all20_loc %>%
  filter(followtype == "NN") %>%
  group_by(
    follow,
    focal,
    ageFromDOB,
    ClassFocal,
    SUAQ_weather.rainfall_ml_evening,
    SUAQ_weather.river_waterlevel_morning,
    SUAQ_weather.river_waterlevel_evening,
    SUAQ_weather.rainfall_ml_morning,
    SUAQ_weather.avg_temperature_tot,
    SUAQ_weather.max_temp_average,
    SUAQ_weather.min_temp_average,
    SUAQ_weather.temperature_max_morning,
    SUAQ_weather.temperature_min_morning,
    SUAQ_weather.temperature_max_evening,
    SUAQ_weather.temperature_min_evening,
    SUAQ_fai.fai,
    ageOfCurrentOffspring,
    monthYearDate,
    follow_totNumOfGPSpoints
  ) %>%
  summarise(DJL = sum(as.numeric(manual_distTolast), na.rm = TRUE), count =
              n(), turningAngleSum=sum(as.numeric(turningAngle), na.rm = TRUE), meanTimelag=mean(timelag_lead,na.rm=TRUE), medianTimelag=median(timelag_lead,na.rm=TRUE)) %>% ungroup() 

colnames(DJL_follows) <- c("follow","focal","ageFromDOB","ClassFocal","rain_eve","watlevel_mo","walevel_eve","rain_mo","avg_temp_tot","max_temp_average","min_temp_average","temp_max_mo","temp_min_mo","temp_max_eve","temp_min_eve","fai","ageOfCurrentOffspring","monthYearDate","numOfPoints","DJL","count","turningAngleSum","meanTimelag","medianTimelag")


##### Adding total displacement distance
TDD_follows <- SUAQ_rangepoints_11all20_loc[order(SUAQ_rangepoints_11all20_loc$manualDatetime , decreasing = TRUE ),] %>% 
  filter(followtype == "NN") %>% 
  group_by(follow) %>% 
  summarize(firstE=first(E),firstN=first(N),lastE=last(E),lastN=last(N)) %>% 
  mutate(TDD=sqrt((firstE-lastE)^2+(firstN-lastN)^2))


DJL_follows <- DJL_follows %>% 
  left_join(TDD_follows,by=c("follow"="follow")) %>%
  mutate(RR=TDD/DJL) %>% 
  ungroup()

# ##### Adding category number
# DJL_follows<- DJL_follows%>%
#   mutate(ClassFocalID=if_else(ClassFocal=="juvenile",1,1))%>% 
#   mutate(ClassFocalID=if_else(ClassFocal=="adult female",2,ClassFocalID))%>% 
#   mutate(ClassFocalID=if_else(ClassFocal=="mother",3,ClassFocalID))%>% 
#   mutate(ClassFocalID=if_else(ClassFocal=="unflanged male",4,ClassFocalID))%>% 
#   mutate(ClassFocalID=if_else(ClassFocal=="flanged male",5,ClassFocalID))


##### TESTING
DJL_follows %>%  ggplot(aes(DJL)) + geom_histogram(bins = 60)
# sind ok follows c(2284, 745)
# sind nicht ok follows c(1874)

### New variables f.e. other Tortuosity  variables

##### Adding total number of fruit trees
Tree_rangepoints<- SUAQ_rangepoints_11all20_loc %>%
  filter(PtType%in%c("mornnest","nightnest","tree")) %>% 
  group_by(follow)%>% 
  arrange(manualDatetime,.by_group = TRUE) %>% 
  mutate(tree_timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         tree_timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         tree_manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         tree_manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         tree_speed_last = manual_distTolast/timelag,
         tree_speed_next = manual_distToNext/timelag_lead,
         tree_turningAngle=turning_angle(E,N))

Tree_follows <- Tree_rangepoints %>%
  filter(followtype == "NN") %>%
  group_by(
    follow,
    focal,
    ageFromDOB,
    ClassFocal,
    SUAQ_weather.rainfall_ml_evening,
    SUAQ_weather.river_waterlevel_morning,
    SUAQ_weather.river_waterlevel_evening,
    SUAQ_weather.rainfall_ml_morning,
    SUAQ_weather.avg_temperature_tot,
    SUAQ_weather.max_temp_average,
    SUAQ_weather.min_temp_average,
    SUAQ_weather.temperature_max_morning,
    SUAQ_weather.temperature_min_morning,
    SUAQ_weather.temperature_max_evening,
    SUAQ_weather.temperature_min_evening,
    SUAQ_fai.fai,
    ageOfCurrentOffspring,
    monthYearDate,
    follow_totNumOfGPSpoints
  ) %>%
  summarise(tree_DJL = sum(as.numeric(tree_manual_distTolast), na.rm = TRUE), tree_GPScount =
              n(), tree_turningAngleSum=sum(as.numeric(tree_turningAngle), na.rm = TRUE), tree_meanTimelag=mean(tree_timelag_lead,na.rm=TRUE), tree_medianTimelag=median(tree_timelag_lead,na.rm=TRUE)) %>% ungroup() 

colnames(Tree_follows) <- c("follow","focal","ageFromDOB","ClassFocal","rain_eve","watlevel_mo","walevel_eve","rain_mo","avg_temp_tot","max_temp_average","min_temp_average","temp_max_mo","temp_min_mo","temp_max_eve","temp_min_eve","fai","ageOfCurrentOffspring","monthYearDate","tree_numOfPoints","tree_DJL","tree_GPScount","tree_turningAngleSum","tree_meanTimelag","tree_medianTimelag")

Tree_follows_count <- SUAQ_rangepoints_11all20_loc[order(SUAQ_rangepoints_11all20_loc$manualDatetime , decreasing = TRUE ),] %>%
  filter(followtype == "NN") %>% 
  filter(PtType=="tree") %>% 
  group_by(follow) %>% 
  summarize(fruittreecount=n())

TDD_tree_follows <- SUAQ_rangepoints_11all20_loc[order(SUAQ_rangepoints_11all20_loc$manualDatetime , decreasing = TRUE ),] %>% 
  filter(followtype == "NN") %>%
  filter(PtType%in%c("mornnest","nightnest","tree")) %>% 
  group_by(follow) %>% 
  summarize(firstE=first(E),firstN=first(N),lastE=last(E),lastN=last(N)) %>% 
  mutate(tree_TDD=sqrt((firstE-lastE)^2+(firstN-lastN)^2)) %>% 
  dplyr::select(-firstE,-firstN,-lastE,-lastN)


Tree_follows <- Tree_follows %>% 
  left_join(TDD_tree_follows,by=c("follow"="follow")) %>%
  mutate(tree_RR=tree_TDD/tree_DJL) %>%
  ungroup() %>% 
  left_join(Tree_follows_count,by=c("follow"="follow")) %>% 
  dplyr::select(c("follow","tree_numOfPoints","tree_DJL","tree_RR","tree_GPScount","tree_turningAngleSum","tree_meanTimelag","tree_medianTimelag"))

DJL_follows <- DJL_follows %>% 
  left_join(Tree_follows,by=c("follow"="follow")) %>% 
  left_join(Tree_follows_count,by=c("follow"="follow")) %>% 
  mutate(fruittreecount=if_else(is.na(fruittreecount),as.integer(0),fruittreecount))



```

```{r RR level 3 distance/movement per day-hour,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
SUAQ_rangepoints_11all20_loc_tree<- SUAQ_rangepoints_11all20_loc[order(SUAQ_rangepoints_11all20_loc$manualDatetime , decreasing = TRUE ),] %>% 
  filter(PtType=="tree")
SUAQ_rangepoints_11all20_loc_tree %>% ggplot(aes(manualTime))+geom_histogram()

SUAQ_rangepoints_11all20_loc %>% filter(SUAQ_weather.rainfall_ml_morning>0) %>% ggplot(aes(manualTime))+geom_histogram()
SUAQ_rangepoints_11all20_loc %>% filter(SUAQ_weather.rainfall_ml_morning==0) %>% ggplot(aes(manualTime))+geom_histogram()

SUAQ_rangepoints_11all20_loc %>% filter(SUAQ_weather.rainfall_ml_evening>0) %>% ggplot(aes(manualTime))+geom_histogram()
SUAQ_rangepoints_11all20_loc %>% filter(SUAQ_weather.rainfall_ml_evening==0) %>% ggplot(aes(manualTime))+geom_histogram()

SUAQ_rangepoints_11all20_loc_tree %>% ggplot(aes(trackpoint_id))+geom_histogram()


#### Movememnt and weather on level 3. Resampling by hourly time

#### Find points every full hour. (Attention timezone is UTC used!! add 5 hours but only works if time is not before. traj uses the locale of the used machine so change if not in CET zone)
levels(as.factor(SUAQ_rangepoints_11all20_loc$ClassFocal))
follows <- SUAQ_rangepoints_11all20_loc %>% group_by(follow) %>% summarise()
SUAQ_hourly_dist <- data.frame()
timeinterval <- 
for(j in c("unfl. male","fl. male","mother")){
  data_split<- SUAQ_rangepoints_11all20_loc %>% mutate(manualDatetime=force_tz(manualDatetime,tzone = Sys.timezone()))
  if(j=="fl. male"){data_split <- data_split %>% filter(ClassFocal=="flanged male")}
  if(j=="unfl. male"){data_split <- data_split %>% filter(ClassFocal=="unflanged male")}
  if(j=="mother"){data_split <- data_split %>% filter(ClassFocal=="mother")}
  
  for(i in as_vector(follows)){
    data<- data_split %>% filter(follow%in%c(i)) 
    print(i)
    if(nrow(data)>1){
      data_follow_simple <- data %>% dplyr::select(x=E,y=N,manualDatetime) %>% 
      mutate(time=TrajConvertTime(strftime(manualDatetime, format="%H:%M:%S"), sep = ":", factors = c(60 * 60, 60, 1))) %>% 
      ungroup() %>%  
      dplyr::select(-follow,-manualDatetime)
      trj <- TrajFromCoords(data_follow_simple)
      resampled <- TrajResampleTime(trj, 1)
      for(hours in c(900*c(1:96))){
        if((hours %in% resampled$time)&((hours+900) %in% resampled$time)){
          indexfirst<- match(c(hours),resampled$time)
          indexsecond<- match(c(hours+900),resampled$time)
          distance<- TrajDistance(resampled, startIndex = indexfirst, endIndex = indexsecond)
          SUAQ_hourly_dist <- SUAQ_hourly_dist %>% bind_rows(c(Start_E=resampled$x[indexfirst],Start_N=resampled$y[indexfirst],End_E=resampled$x[indexsecond],End_N=resampled$y[indexsecond],from=hms::as_hms(hours), to=hms::as_hms(hours+900), distance=distance, follow=i,class=j))
        }
        
      }
    }
  }
}
ref_date <- ymd("2017-01-01", tz = "UTC")
SUAQ_hourly_dist_mean <- SUAQ_hourly_dist %>%  group_by(from,class) %>% summarise(meandist=mean(as.numeric(distance),na.rm=TRUE), sample_n=n()) %>% mutate(from=format(ref_date + as.numeric(from), "%H:%M")) 

plot_SUAQ_hourlydistmean_class<- SUAQ_hourly_dist_mean %>% ggplot(aes(x=from,y=as.numeric(meandist),colour=class)) + geom_point()+ 
  theme(axis.text.x = element_text(angle = 60,vjust = 0.5)) +
  labs(x="daytime", y="average distance [m]")
plot_SUAQ_hourlydistmean_class
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_SUAQ_hourlydistmean_class_quarterly",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_SUAQ_hourlydistmean_class)



```

```{r RR level 3 tree directness + visuals + stats,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
##### Adding total number of fruit trees
SUAQ_treedirectness<- SUAQ_rangepoints_11all20_loc %>%
  filter(PtType%in%c("tree")) %>% 
  group_by(follow)%>% 
  arrange(manualDatetime,.by_group = TRUE) %>% 
  mutate(
         tree_DD_last=sqrt((E-lag(E))^2+(N-lag(N))^2),
         tree_DD_next=sqrt((E-lead(E))^2+(N-lead(N))^2))
temp_morethanonetree <- SUAQ_treedirectness %>% group_by(follow) %>% summarise(tot=n()) %>% filter(tot>1)
SUAQ_treedirectness <- SUAQ_treedirectness %>% filter(follow%in%temp_morethanonetree$follow) # filter only follows with multiple trees to calculated inbetween tree directness

### Calculate all the distance travelled between trees.
##### Progressbar
pb <-  txtProgressBar(min = 0, max = NROW(temp_morethanonetree), initial = 0) 
stepi <-0
follows<- pull(temp_morethanonetree,follow)
SUAQ_treedirectness$tree_betweentravelled <- NA_real_
SUAQ_treedirectness$tree_betweennumgps <- NA_integer_
SUAQ_treedirectness_calc <- data.frame()
i <- 617
tree <- 1
test<- SUAQ_rangepoints_11all20_loc %>% filter(follow==617)
for (i in follows){
  followdf <- SUAQ_treedirectness[SUAQ_treedirectness$follow==i,]
  for (tree in c(1:(nrow(followdf)-1))){
    temp_gpsdf<-SUAQ_rangepoints_11all20_loc[((SUAQ_rangepoints_11all20_loc$follow == i)&(SUAQ_rangepoints_11all20_loc$trackpoint_id %in% c(followdf$trackpoint_id[tree]:followdf$trackpoint_id[tree+1]))), "manual_distToNext"]
    
    temp_gpsdf <- temp_gpsdf[1:(nrow(temp_gpsdf)-1),] # delete distance to next from the last element/tree
    tree_row <- followdf[tree,]
    tree_row$tree_betweentravelled[1] <- sum(temp_gpsdf)
    tree_row$tree_betweennumgps[1] <- nrow(temp_gpsdf)-1 # anzahl GPS between plus start & endtree, therefire subtract start end tree because end tree already deleted only minus 1
    tree_row <- tree_row %>% ungroup()
    SUAQ_treedirectness_calc <-  rbind(SUAQ_treedirectness_calc,tree_row)
  }
  setTxtProgressBar(pb,stepi) # change progress bar
  stepi <-  stepi + 1
}

SUAQ_treedirectness <- SUAQ_treedirectness_calc %>% mutate(rr_treedirectness=tree_DD_next/tree_betweentravelled)
SUAQ_treedirectness_calc <- NA

### renaming and selecting for stats analysis
SUAQ_treedirectness_stats <- SUAQ_treedirectness %>%
  dplyr::select(follow,focal,ageFromDOB,ClassFocal,SUAQ_weather.rainfall_ml_evening,SUAQ_weather.river_waterlevel_morning,SUAQ_weather.river_waterlevel_evening,SUAQ_weather.rainfall_ml_morning,SUAQ_weather.avg_temperature_tot,SUAQ_weather.max_temp_average,SUAQ_weather.min_temp_average,SUAQ_weather.temperature_max_morning,SUAQ_weather.temperature_min_morning,SUAQ_weather.temperature_max_evening,SUAQ_weather.temperature_min_evening,SUAQ_fai.fai,ageOfCurrentOffspring,monthYearDate,follow_totNumOfGPSpoints,rr_treedirectness,tree_betweennumgps,manualDate)
colnames(SUAQ_treedirectness_stats) <-
  c("follow","focal","ageFromDOB","ClassFocal","rain_eve","watlevel_mo","walevel_eve","rain_mo","avg_temp_tot","max_temp_average","min_temp_average","temp_max_mo","temp_min_mo","temp_max_eve","temp_min_eve","fai","ageOfCurrentOffspring","monthYearDate","tree_numOfPoints","rr_treedirectness","tree_betweennumgps","manualDate")

## take a random sample with same "gps" distances as the between tree gps points.
### Calculate all the distance travelled between trees.
##### Adding total number of fruit trees
pb <-  txtProgressBar(min = 0, max = NROW(random_window_sizes), initial = 0) 
stepi <-0
SUAQ_randomdirectness <- data.frame()
random_window_sizes<- SUAQ_treedirectness %>% pull(tree_betweennumgps)
for(i in random_window_sizes){
  windowsize <- i+2 # plus two because thats the window size (Start end tree is not counted in the tree_betweennumgps)
  points_available<- SUAQ_rangepoints_11all20_loc %>% ungroup() %>% 
    filter(as.numeric(follow_totNumOfGPSpoints)>as.numeric(windowsize)) 
  points_available_start_anti<- points_available %>% arrange(desc(trackpoint_id)) %>% 
    group_by(follow) %>% 
    top_n((windowsize-1),trackpoint_id) # select last i+1 or windowsize-1 objects these are not appropriate startpoints because they are too short till followend
  points_available_start<- setdiff(points_available,points_available_start_anti)
    # find follwos which have enough elements
  random_start <- points_available_start %>%ungroup() %>%  sample_n(1)
  random_startid<- pull(random_start,trackpoint_id)
  random_end <- points_available %>% filter(follow%in%c(random_start$follow)) %>%  filter(trackpoint_id==(random_startid+i+1)) # adding one because of indexing
  random_endid<- pull(random_end,trackpoint_id)
  windowselected <- points_available %>% filter(follow%in%c(random_start$follow)) %>% 
    filter(trackpoint_id%in%c(random_startid:random_endid))
  random_start$random_betweentravelled <- sum(windowselected[1:(nrow(windowselected)-1),]$manual_distToNext,na.rm = TRUE)
  random_start$DD <- sqrt((random_start$E-random_end$E)^2+(random_start$N-random_end$N)^2)
  random_start$random_betweennumgps <- i
  SUAQ_randomdirectness <- SUAQ_randomdirectness %>% rbind(random_start)
  # change progress bar
  setTxtProgressBar(pb,stepi) 
  stepi <-  stepi + 1
}
SUAQ_randomdirectness <- SUAQ_randomdirectness %>% mutate(rr_randomdirectness=DD/random_betweentravelled)



### renaming and selecting for stats analysis
SUAQ_randomdirectness_stats <- SUAQ_treedirectness %>%
  dplyr::select(follow,focal,ageFromDOB,ClassFocal,SUAQ_weather.rainfall_ml_evening,SUAQ_weather.river_waterlevel_morning,SUAQ_weather.river_waterlevel_evening,SUAQ_weather.rainfall_ml_morning,SUAQ_weather.avg_temperature_tot,SUAQ_weather.max_temp_average,SUAQ_weather.min_temp_average,SUAQ_weather.temperature_max_morning,SUAQ_weather.temperature_min_morning,SUAQ_weather.temperature_max_evening,SUAQ_weather.temperature_min_evening,SUAQ_fai.fai,ageOfCurrentOffspring,monthYearDate,follow_totNumOfGPSpoints,rr_treedirectness,tree_betweennumgps,manualDate)
colnames(SUAQ_randomdirectness_stats) <-
  c("follow","focal","ageFromDOB","ClassFocal","rain_eve","watlevel_mo","walevel_eve","rain_mo","avg_temp_tot","max_temp_average","min_temp_average","temp_max_mo","temp_min_mo","temp_max_eve","temp_min_eve","fai","ageOfCurrentOffspring","monthYearDate","tree_numOfPoints","rr_treedirectness","tree_betweennumgps","manualDate")




## Visuals
plot_BetweenTreeDirectnessxClassFocal<- SUAQ_treedirectness %>% 
  ggplot( aes(x=SUAQ_fai.fai, y=tree_betweentravelled)) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="blue", size=2, alpha=0.2) +
    geom_jitter(data=SUAQ_randomdirectness,aes(SUAQ_fai.fai,random_betweentravelled),color="red", size=2, alpha=1) +
    theme_ipsum() +
    theme(
      #legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("Class focal and directness between food tree sources") +
    ylab("Directness index [DD / travelled distance]")
  #ylim(0,1)
plot_BetweenTreeDirectnessxClassFocal



### Statistics
#### Filter NA's for different stats
SUAQ_treedirectness_stats_naomit_minimum <- SUAQ_treedirectness_stats %>% dplyr::select(tree_betweennumgps,ClassFocal,manualDate,rr_treedirectness,fai) %>% na.omit()
SUAQ_treedirectness_stats_naomit_mother <- SUAQ_treedirectness_stats %>% dplyr::select(tree_betweennumgps,ClassFocal,manualDate,rr_treedirectness,rain_eve,walevel_eve,rain_mo,temp_min_eve,temp_min_mo,avg_temp_tot,fai,ageOfCurrentOffspring,ageFromDOB) %>% na.omit()
SUAQ_treedirectness_stats_naomit <- SUAQ_treedirectness_stats %>% dplyr::select(tree_betweennumgps,ClassFocal,manualDate,rr_treedirectness,rain_eve,walevel_eve,rain_mo,temp_min_eve,temp_min_mo,avg_temp_tot,fai) %>% na.omit()

#### Random effects day and number of gps between
glm_minimum <- lmer(rr_treedirectness~fai+ClassFocal +(1 | tree_betweennumgps)+ (1 | manualDate),data=SUAQ_treedirectness_stats_naomit_minimum)
glm_minimum_empty <- lmer(rr_treedirectness~ (1 | tree_betweennumgps)+ (1 | manualDate),data=SUAQ_treedirectness_stats_naomit_minimum)
lm_random_effect <- lm(rr_treedirectness~ tree_betweennumgps+ 
                           manualDate,data=SUAQ_treedirectness_stats_naomit_minimum)
anova(lm_random_effect)
anova(glm_minimum,glm_minimum_empty)
anova(glm_minimum)

#### looking at further explanatory variables
glm_full <- lmer(rr_treedirectness~ClassFocal+rr_treedirectness+rain_eve+walevel_eve+rain_mo+temp_min_eve+temp_min_mo+avg_temp_tot+fai +(1 | tree_betweennumgps)+ (1 | manualDate),data=SUAQ_treedirectness_stats_naomit)
glm_empty <- lmer(rr_treedirectness~ (1 | tree_betweennumgps)+ (1 | manualDate),data=SUAQ_treedirectness_stats_naomit)
anova(glm_full,glm_empty)
anova(glm_full)

SUAQ_treedirectness_stats_naomit_mother$ageOfCurrentOffspring
#### looking at females only
glm_mothers <- lmer(rr_treedirectness~ ageFromDOB+ageOfCurrentOffspring+(1 | tree_betweennumgps)+ (1 | manualDate),data=SUAQ_treedirectness_stats_naomit_mother)
glm_mothers_empty <- lmer(rr_treedirectness~ (1 | tree_betweennumgps)+ (1 | manualDate),data=SUAQ_treedirectness_stats_naomit_mother)
anova(glm_mothers,glm_mothers_empty)
anova(glm_mothers)

```

```{r visuals of DJL and explanatory variables ,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
##### Plot female DJL
DJL_follows_females_10<- SUAQ_rangepoints_11all20_loc_females_12 %>% 
  filter(followtype=="NN") %>% 
  group_by(follow,focal,SUAQ_followlog.ClassFocal) %>% 
  summarise(DJL=sum(as.numeric(manual_distTolast), na.rm = TRUE),count=n()) %>% 
  arrange(SUAQ_followlog.ClassFocal) %>% ungroup() %>% 
  mutate(focal = fct_reorder(focal, SUAQ_followlog.ClassFocal))

plot_FemaleDJL<- DJL_follows_females_10 %>% 
  ggplot( aes(x=focal, y=DJL)) +
    geom_jitter(color="coral4", size=0.7, alpha=0.9, shape = 4)+ # add  aes(x=focal, y=DJL) to see which follow it is on a plotly although colors are wrong then... little hack
    geom_boxplot(aes(x=focal, y=DJL, fill=focal),outlier.fill = focal,outlier.stroke= focal) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    ggtitle("Day journey length for Nest-to-Nest follows in Suaq grouped by orangutans") +
    xlab("")+
    ylab("DJL [m]")+
    coord_cartesian(ylim=c(0, 5000))+
    theme(legend.position = "none")+
    theme(axis.text.x = element_text(angle = 90))
ggplotly(plot_FemaleDJL)

##### Scatterplots #####
plot_ClassxDJL <-
  DJL_follows %>% ggplot(aes(ClassFocal,DJL,colour=ClassFocal)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(title = "Histogram of focal classes", x = "focal class", y = "DJL [m]")
plot_ClassxDJL

with(DJL_follows , vioplot( 
  DJL[ClassFocal=="flanged male"] , DJL[ClassFocal=="unflanged male"], DJL[ClassFocal=="infant"],DJL[ClassFocal=="mother"],DJL[ClassFocal=="adult female"],
  col=rgb(0.1,0.4,0.7,0.7) , names=c("flanged male","unflanged male","infant","mother","adult female") 
))

plot_DJLxClassFocal<- DJL_follows %>%
  ggplot( aes(x=ClassFocal, y=DJL, fill=ClassFocal)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="black", size=0.4, alpha=0.3) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("Class focal and day journey length") +
    ylab("DJL [m]")+
  ylim(0,2500)
plot_DJLxClassFocal

plot_RRxClassFocal<- DJL_follows %>%
  ggplot( aes(x=ClassFocal, y=RR, fill=ClassFocal)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="black", size=0.4, alpha=0.3) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("Class focal and day journey length") +
    ylab("RR")+
  ylim(0,10)
plot_RRxClassFocal


plot_FAIxDJL <-
  DJL_follows %>% ggplot(aes(fai,DJL)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(title = "Scatterplot of FAI and DJL", x = "FAI", y = "DJL [m]")+
  geom_smooth(method="lm")
plot_FAIxDJL


plot_AgeCurrentOffspringxDJL <-
  DJL_follows %>% ggplot(aes(ageOfCurrentOffspring,DJL,colour=as.character(meanTimelag))) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(title = "Scatterplot of DJL and Age of current offspring", x = "Age of current offspring [years]", y = "DJL [m]")+
  geom_smooth(method="lm")+theme(legend.position="none")
plot_AgeCurrentOffspringxDJL

plot_AgeFocalxDJL <-
  DJL_follows %>% ggplot(aes(ageFromDOB,DJL,colour=ClassFocal)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + labs(title = "Scatterplot of DJL and Age of focal", x = "Approximate Age [years]", y = "DJL [m]")
plot_AgeFocalxDJL


#### Random effects single
plot_monthYearDate_x_DJL_randomEffects <-
  DJL_follows %>% ggplot(aes(monthYearDate,DJL,colour=focal)) +
  #scale_y_log10(labels=fancy_scientific) +
  geom_point(binwidth = 1) + 
  labs(title = "Scatterplot of DJL and the random effect of months", x = "Year and Month", y = "DJL [m]")+
  theme(axis.text.x = element_text(angle = 45))+
  geom_smooth()
plot_monthYearDate_x_DJL_randomEffects

##### Save important plots
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_AgeFocalxDJL",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_AgeFocalxDJL)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_DJLxClassFocal",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_DJLxClassFocal)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_RRxClassFocal",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_RRxClassFocal)

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_FAIxDJL_ungrouped",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_FAIxDJL)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_AgeCurrentOffspringxDJL",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_AgeCurrentOffspringxDJL)

##### Plot all

plot_Allscatter <-
  DJL_follows %>% ungroup() %>% dplyr::select(
    follow,
    ageFromDOB,
    turningAngleSum,
    ClassFocal,
    watlevel_mo,
    walevel_eve,
    rain_mo,
    rain_eve,
    avg_temp_tot,
    max_temp_average,
    min_temp_average,
    temp_max_mo,
    temp_min_mo,
    temp_max_eve,
    temp_min_eve,
    fai,
    ageOfCurrentOffspring,
    DJL,
    TDD,
    RR,
    fruittreecount,
    tree_DJL,
    tree_RR)

plot_Allscatter<- plot_Allscatter%>% GGally::ggpairs(echo=FALSE, message=FALSE, cardinality_threshold = 62)

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_Allscatter",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_Allscatter,dpi=300,width = 60,height = 60,units="cm")


##### Plot all weather variables
plot_AllscatterWeather <- DJL_follows %>% ungroup() %>% 
  dplyr::select(rain_eve,watlevel_mo,walevel_eve,rain_mo,avg_temp_tot,max_temp_average,min_temp_average,temp_max_mo,temp_min_mo,temp_max_eve,temp_min_eve)
plot_AllscatterWeather<- plot_AllscatterWeather%>% GGally::ggpairs(echo=FALSE, message=FALSE)

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_AllscatterWeather",
    sep = ""
  ),
  "pdf",
  sep = "." 
), plot = plot_AllscatterWeather,dpi=300,width = 60,height = 60,units="cm")



```

```{r tree food sources analysis: }
#### On ggplot
plotly_treeAll <- SUAQ_rangepoints_11all20_loc[order(SUAQ_rangepoints_11all20_loc$manualDatetime , decreasing = TRUE ),] %>%
  filter(PtType=="tree") %>% 
  ggplot()+
  geom_point(aes(E,N,colour=focal),size=1)
  #geom_point(data = temp_duplicates,aes(E,N,fill=as.factor(follow)),size=2)+
  #geom_path(aes(E,N,color=as.factor(follow)), alpha = 0.7,size=0.5)
ggplotly(plotly_treeAll)

#### On a leaflet

SUAQ_rangepoints_11all20_loc_sf_wgs_treesonly<- SUAQ_rangepoints_11all20_loc_sf_wgs[order(SUAQ_rangepoints_11all20_loc_sf_wgs$manualDatetime , decreasing = TRUE ),] %>% filter(PtType=="tree") 
pal_pttype <- colorFactor(get_palette(palette = "default", 7), domain = SUAQ_rangepoints_11all20_loc_sf_wgs$PtType)
pal_focal <- colorFactor(get_palette(palette = "default", 109), domain = SUAQ_rangepoints_11all20_loc_sf_wgs_treesonly$focal)

leaflet_SUAQ_all_tree<- leaflet(data = st_transform(SUAQ_rangepoints_11all20_loc_sf_wgs_treesonly, crs = 4326)) %>% 
  addProviderTiles(providers$Esri.WorldImagery) %>% 
  addCircleMarkers(color = ~pal_focal(SUAQ_rangepoints_11all20_loc_sf_wgs_treesonly$focal),
                   fillOpacity = 1,
                   radius = 0.6,
                   opacity = 1) %>%
  addPolylines(weight = 1,
  opacity = 0.5,
    data = SUAQ_pathnetwork_sf_wgs
  ) 

leaflet_SUAQ_all_tree


```

```{r glm's DJL RR,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
## GLM #####
### DJL models


# lm see autoplot ?
lm<-
  lm(
    DJL ~ 
      ClassFocal,
    data = DJL_follows
  )
autoplot(lm)
summary(lm)

#### Random effects single glm
DJL_follows_naomit_mother <- DJL_follows %>% ungroup() %>%  dplyr::select(DJL,ageFromDOB,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, ageOfCurrentOffspring, monthYearDate,focal,meanTimelag,numOfPoints,turningAngleSum) %>% na.omit() # That should be only mothers

lm_monthYearDate <- lm(DJL~ monthYearDate,DJL_follows)
lm_ageOfCurrent <- lm(DJL~ ageOfCurrentOffspring,DJL_follows)
lm_meanTimelag <- lm(DJL~ meanTimelag,DJL_follows)


#### Testing significance of random effects
lmer_numOfPoints <- lmer(DJL~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot + fai + ageOfCurrentOffspring +(1 | numOfPoints),DJL_follows_naomit_mother,REML=FALSE)
lmer_meanTimelag <- lmer(DJL~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageOfCurrentOffspring +(1 | meanTimelag),DJL_follows_naomit_mother,REML=FALSE)
lmer_monthYearDate <- lmer(DJL~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot 
                           + fai + ageOfCurrentOffspring +(1 | monthYearDate),DJL_follows_naomit_mother,REML=FALSE)
lmer_focal <- lmer(DJL~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageOfCurrentOffspring +(1 | focal),DJL_follows_naomit_mother,REML=FALSE)

lm_selected <- lm(DJL~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageOfCurrentOffspring,DJL_follows_naomit_mother,REML=FALSE)
anova(lmer_numOfPoints,lmer_meanTimelag,lmer_monthYearDate,lmer_focal,lm_selected) ## two sequential tests


#### Testing full vs. empty model
glm_selected <- lmer(DJL~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageOfCurrentOffspring + ageFromDOB +(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_naomit_mother)
glm_selected_ageInteraction <- lmer(DJL~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot + ageFromDOB + fai + ageOfCurrentOffspring +(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_naomit_mother)
glm_randomEffects <- lmer(DJL~ (1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_naomit_mother)
anova(glm_selected,glm_randomEffects)
anova(glm_selected)
coefs <- data.frame(coef(summary(glm_selected)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

### Full model mit NA's
DJL_follows_naomit_full<- DJL_follows %>% dplyr::select(ageFromDOB,DJL,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount) %>% na.omit()
glm_full <-lmer(DJL ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ClassFocal + ageFromDOB+  (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_full_plusfruittreecount <-lmer(DJL ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai +ClassFocal + ageFromDOB+ fruittreecount + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_full
  )
glm_full_randomeffects <-lmer(DJL ~ (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_full
  )
anova(glm_full,glm_full_randomeffects)
drop1(glm_full)
vif.mer(glm_full)

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_full)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

##### Testing: Add Age of Focal
DJL_follows_naomit_age <- DJL_follows %>% dplyr::select(ageFromDOB,DJL,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, ageOfCurrentOffspring, monthYearDate,focal,meanTimelag,numOfPoints) %>% na.omit()
glm_full_age <-lmer(DJL ~ fai+ ClassFocal + ageFromDOB  + ageOfCurrentOffspring +rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_age
  )
glm_only_age <-lmer(DJL ~ ageFromDOB*ageOfCurrentOffspring + (1 | monthYearDate) + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_age
  )
glm_randomEffects <- lmer(DJL~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_naomit_age)

anova(glm_full_age)
anova(glm_only_age,glm_randomEffects)




### Stepwise selection
DJL_follows_naomit_step <- DJL_follows %>% dplyr::select(ageFromDOB,DJL,rain_eve, walevel_eve,watlevel_mo,max_temp_average,min_temp_average,temp_max_mo, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount) %>% na.omit()
glm_step <-lmer(DJL ~ rain_eve + rain_mo + watlevel_mo + walevel_eve + max_temp_average + min_temp_average 
                    +temp_max_mo+temp_min_mo+avg_temp_tot + ClassFocal + fai  +fruittreecount+ (1 | monthYearDate)
                    + (1 | focal) + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_step
  )

ranova(glm_step)
step_result_backward<- step(glm_step)
get_model(step_result_backward,direction="backward")

step_result_forward<- step(glm_step,direction="forward")
get_model(step_result_forward)

#### backward
glm_best_backward <-lmer(DJL ~ max_temp_average + min_temp_average + avg_temp_tot + ageOfCurrentOffspring + (1 | monthYearDate), # random effects to correct for
  data = DJL_follows
  )

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_best_backward)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

vif.mer(glm_best_backward)

#### forward
glm_best_forward <-lmer(DJL ~ max_temp_average + min_temp_average + avg_temp_tot + ageOfCurrentOffspring +      (1 | monthYearDate), # random effects to correct for
  data = DJL_follows
  )

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_best_backward)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs
vif.mer(glm_best_backward)

##### Best model plus fai
glm_best_plusFAI <-lmer(DJL ~ max_temp_average + min_temp_average + avg_temp_tot + ageOfCurrentOffspring + (1 | monthYearDate)
                    + (1 | focal), # random effects to correct for
  data = DJL_follows
  )


##### Create P values for lm
coefs <- data.frame(coef(summary(glm_best_plusFAI)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs
vif.mer(glm_best_plusFAI)


### Manual deletion of effects
glm3 <-lmer(DJL ~ rain_eve + rain_mo + watlevel_mo + walevel_eve + max_temp_average + min_temp_average 
                    +temp_max_mo+temp_min_mo+avg_temp_tot + ClassFocal + fai +ageOfCurrentOffspring + (1 | monthYearDate)
                    + (1 | focal), # random effects to correct for
  data = DJL_follows
  )
glm4 <-lmer(DJL ~ rain_eve*walevel_eve + rain_mo*watlevel_mo + max_temp_average + min_temp_average 
                    +temp_max_mo+temp_min_mo+avg_temp_tot + ClassFocal*ageOfCurrentOffspring + fai + (1 | monthYearDate)
                    + (1 | focal), # random effects to correct for
  data = DJL_follows
  )
anova(glm1,  glm4)



autoplot(glm_rainfall)

install.packages("mulcomp")
library(multcomp)
cftest
pt(q=2.361, df=315, lower.tail=FALSE)
df.residual(glm_rainfall)
summary(glm_rainfall)
anova(glm_rainfall)

ctable <- coef(summary(glm_rainfall))
pvals <- pt(abs(ctable[, "t value"]), df.residual(glm_rainfall), lower.tail = FALSE)
cbind(ctable, pvals)

qqnorm(resid(glm_rainfall))

##### Weather which variable is most explained by the other variables





### Tortuosity: Rambling Ratios
#### Random effects single glm
DJL_follows_naomit_rr <- DJL_follows %>% ungroup() %>%  dplyr::select(RR,ageFromDOB,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, ageOfCurrentOffspring, monthYearDate,focal,meanTimelag,numOfPoints) %>% na.omit() # only mothers are considered because they have offspring


#### Testing significance of random effects
lmer_RR_numOfPoints <- lmer(RR~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageOfCurrentOffspring +(1 | numOfPoints),DJL_follows_naomit_rr,REML=FALSE)

lmer_RR_meanTimelag <- lmer(RR~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageOfCurrentOffspring +(1 | meanTimelag),DJL_follows_naomit_rr,REML=FALSE)

lmer_RR_monthYearDate <- lmer(RR~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot + fai + ageOfCurrentOffspring +(1 | monthYearDate),DJL_follows_naomit_rr,REML=FALSE)

lmer_RR_focal <- lmer(RR~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot +  fai + ageOfCurrentOffspring +(1 | focal),DJL_follows_naomit_rr,REML=FALSE)

lm_RR_selected <- lm(RR~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot +  fai + ageOfCurrentOffspring,DJL_follows_naomit_rr,REML=FALSE)

anova(lmer_RR_numOfPoints,lmer_RR_meanTimelag,lmer_RR_monthYearDate,lmer_RR_focal,lm_RR_selected) ## two sequential tests

#### Testing full vs. empty model
glm_RR_selected <- lmer(RR~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot +  fai + ageOfCurrentOffspring + ageFromDOB +(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_naomit_rr)
glm_RR_selected_ageInteraction <- lmer(RR~rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot +  fai + ageOfCurrentOffspring*ageFromDOB +(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_naomit_rr)
glm_RR_randomEffects <- lmer(RR~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_naomit_rr)
anova(glm_RR_selected,glm_RR_selected_ageInteraction,glm_RR_randomEffects)

### Full model mit NA's
glm_full <-lmer(RR ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot + ClassFocal + fai + ageOfCurrentOffspring + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows
  )
anova(glm_full)
drop1(glm_full)
vif.mer(glm_full)

##### Age of Focal
DJL_follows_naomit_age <- DJL_follows %>% dplyr::select(ageFromDOB,DJL,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, ageOfCurrentOffspring, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount) %>% na.omit()
glm_full_age <-lmer(DJL ~ fai+  ageFromDOB  + ageOfCurrentOffspring +rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_age
  )
glm_only_age <-lmer(DJL ~ ageFromDOB*ageOfCurrentOffspring + (1 | monthYearDate) + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_age
  )
glm_randomEffects <- lmer(DJL~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_naomit_age)

anova(glm_full_age)
anova(glm_full_age,glm_only_age,glm_randomEffects)

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_full)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs



### Tortuosity: Turning Angle
glm_turningangle_full <-lmer(turningAngleSum ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageOfCurrentOffspring + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_mother
  )

glm_turningangle_empty <-lmer(turningAngleSum ~ (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_naomit_mother
  )
anova(glm_turningangle_full,glm_turningangle_empty)
drop1(glm_full)
vif.mer(glm_full)


### Analysing explanation of how many fruit trees are visited and RR of only fruit tree route
#### FRUITTREECOUNT: Female model ohne NA's in CurrentOffspring
DJL_follows_females_trees <- DJL_follows %>% dplyr::select(ageFromDOB,tree_RR,tree_DJL,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, ageOfCurrentOffspring, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount) %>% na.omit()

glm_full_fruittrees_females <-lmer(fruittreecount ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageFromDOB+ageOfCurrentOffspring  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_females_trees
  )
glm_significant_fruittrees_females <-lmer(fruittreecount ~ avg_temp_tot + ageFromDOB  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_females_trees
  )
glm_randomeffects_fruittrees_females <- lmer(fruittreecount~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_females_trees)

anova(glm_full_fruittrees_females,glm_significant_fruittrees_females,glm_randomeffects_fruittrees_females)
drop1(glm_full_fruittrees_females)
vif.mer(glm_full_fruittrees_females)

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_full_fruittrees_females)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

### TREE - DJL: Analysing explanation of how many fruit trees are visited and RR of only fruit tree route
### Female model ohne NA's in CurrentOffspring

glm_full_DJLtree_females <-lmer(tree_DJL ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageFromDOB+ageOfCurrentOffspring  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_females_trees
  )
glm_randomeffects_DJLtree_females <- lmer(tree_DJL~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_females_trees)

anova(glm_full_DJLtree_females,glm_randomeffects_DJLtree_females)
drop1(glm_full_DJLtree_females)
vif.mer(glm_full_DJLtree_females)

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_full_DJLtree_females)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

### TREE - RR: Analysing explanation of how many fruit trees are visited and RR of only fruit tree route
### Female model ohne NA's in CurrentOffspring

glm_full_RRtree_females <-lmer(tree_RR ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageFromDOB+ageOfCurrentOffspring  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_females_trees
  )
glm_randomeffects_RRtree_females <- lmer(tree_RR~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_females_trees)

anova(glm_full_RRtree_females,glm_randomeffects_RRtree_females)
drop1(glm_full_RRtree_females)
vif.mer(glm_full_RRtree_females)

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_full_RRtree_females)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs


#### FRUITTREECOUNT: Full model without currentOffspring
DJL_follows_trees <- DJL_follows %>% dplyr::select(ageFromDOB,tree_RR,tree_DJL,rain_eve, walevel_eve, rain_mo, temp_min_eve, temp_min_mo, avg_temp_tot, ClassFocal, fai, monthYearDate,focal,meanTimelag,numOfPoints,fruittreecount) %>% na.omit()

glm_full_fruittrees <-lmer(fruittreecount ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageFromDOB  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_trees
  )
glm_significant_fruittrees <-lmer(fruittreecount ~ avg_temp_tot + ageFromDOB  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_trees
  )
glm_randomeffects_fruittrees <- lmer(fruittreecount~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_trees)

anova(glm_full_fruittrees,glm_significant_fruittrees,glm_randomeffects_fruittrees)
drop1(glm_full_fruittrees)
vif.mer(glm_full_fruittrees)

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_full_fruittrees)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

### TREE - DJL: Analysing explanation of how many fruit trees are visited and RR of only fruit tree route
### Female model ohne NA's in CurrentOffspring

glm_full_DJLtree <-lmer(tree_DJL ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageFromDOB  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_trees
  )
glm_randomeffects_DJLtree <- lmer(tree_DJL~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_trees)

anova(glm_full_DJLtree,glm_randomeffects_DJLtree)
drop1(glm_full_DJLtree)
vif.mer(glm_full_DJLtree)

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_full_DJLtree)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

### TREE - RR: Analysing explanation of how many fruit trees are visited and RR of only fruit tree route
### Female model ohne NA's in CurrentOffspring

glm_full_RRtree <-lmer(tree_RR ~ rain_eve + walevel_eve + rain_mo + temp_min_eve + temp_min_mo + avg_temp_tot  + fai + ageFromDOB  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_trees
  )
glm_randomeffects_RRtree <- lmer(tree_RR~(1 | monthYearDate)+ (1 | meanTimelag),data=DJL_follows_trees)
glm_significant_RRtree <-lmer(tree_RR ~ avg_temp_tot + ageFromDOB  + (1 | monthYearDate)
                    + (1 | meanTimelag), # random effects to correct for
  data = DJL_follows_trees
  )
anova(glm_full_RRtree,glm_significant_RRtree,glm_randomeffects_RRtree)
drop1(glm_full_RRtree_females)
vif.mer(glm_full_RRtree_females)

##### Create P values for lm
coefs <- data.frame(coef(summary(glm_full_RRtree)))
# use normal distribution to approximate p-value
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs


```

```{r Subsampling: higher frequency analysis}
##### Plot DJL and mean timelag
plot_DJLxMeanTimelag<- DJL_follows %>% ggplot(aes(DJL, meanTimelag)) +
  geom_point() + 
  labs(title = "DJL X Mean Timelag (Mean sampling interval per follow)", x = "DJL [m]", y = "mean sampling interval [s]")

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_DJLxMeanTimelag",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_DJLxMeanTimelag)


specs_timelag <- SUAQ_rangepoints_11all20_loc %>% group_by(timelag_lead) %>% summarise(count=n())

temp<- SUAQ_rangepoints_11all20_loc %>% group_by(follow) %>% summarise(meanTimelag=median(timelag_lead,na.rm=TRUE),count=n())
sample_FN_5min<- c("661","663","671","682","685","687","689","718","719","733","735","738","743","745","746","748","751","753","754","765","767","773","805","807","808","810","816")

sample_frequencyAnalaysis_5min <- SUAQ_rangepoints_11all20_loc[order(SUAQ_rangepoints_11all20_loc$focal,SUAQ_rangepoints_11all20_loc$manualDatetime , decreasing = TRUE ),] %>% filter(follow %in% c("661","663","671","682","685","687","689","718","719","733","735","738","743","745","746","748","751","753","754","765","767","773","805","807","808","810","816"))  %>% filter(followtype=="NN")

sample_frequencyAnalaysis_5min <- sample_frequencyAnalaysis_5min %>% mutate(cumsumTimelag=cumsum(timelag_lead)) %>%  dplyr::select(c("identification","focal","follow","followtype","automaticDatetime","manualDatetime","manualDate","manualTime","automaticDate","automaticTime","timelag_lead","cumsumTimelag","manual_distToNext","speed_next","turningAngle","altitudediff_next","PtType","currentOffspring","ageFromDOB","ageOfCurrentOffspring","infantname","altitude","followername","E","N","gpsextraction"))

##### Get two dataframes one with start and ending and another with all the points in between
subsample_frequencyAnalaysis_start <- sample_frequencyAnalaysis_5min %>% group_by(follow) %>% dplyr::top_n(1,manualDatetime)
subsample_frequencyAnalaysis_end <- sample_frequencyAnalaysis_5min %>% group_by(follow) %>% dplyr::top_n(-1,manualDatetime)
subsample_frequencyAnalaysis_start_end <- subsample_frequencyAnalaysis_start %>% rbind(subsample_frequencyAnalaysis_end)
sample_frequencyAnalaysis_rest<- setdiff(sample_frequencyAnalaysis_5min,subsample_frequencyAnalaysis_start_end)

##### Create a Dataframe with subsamplings
subsample_frequencyAnalaysis15min <- sample_frequencyAnalaysis_rest %>% group_by(follow) %>%
  slice(seq(2, n(), by = 2))
subsample_frequencyAnalaysis15min <- subsample_frequencyAnalaysis15min %>% rbind(subsample_frequencyAnalaysis_start_end)

##### Create a Dataframe with subsamplings
subsample_frequencyAnalaysis30min <- sample_frequencyAnalaysis_rest %>% group_by(follow) %>%
  slice(seq(4, n(), by = 4))
subsample_frequencyAnalaysis30min <- subsample_frequencyAnalaysis30min %>% rbind(subsample_frequencyAnalaysis_start_end)


##### Create analysis DF #####
subsample_frequencyAnalaysis15min<- subsample_frequencyAnalaysis15min %>% 
  group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
  mutate(timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         speed_last = manual_distTolast/timelag,
         speed_next = manual_distToNext/timelag_lead,
         turningAngle=turning_angle(E,N),
         altitudediff_next=altitude-lead(altitude),
         )
subsample_frequencyAnalaysis30min<- subsample_frequencyAnalaysis30min %>% 
  group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
  mutate(timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         speed_last = manual_distTolast/timelag,
         speed_next = manual_distToNext/timelag_lead,
         turningAngle=turning_angle(E,N),
         altitudediff_next=altitude-lead(altitude),
         )

DJL_follows_subsample_15min <- subsample_frequencyAnalaysis15min %>%
  filter(followtype == "NN") %>%
  group_by(
    follow
  ) %>%
  summarise(DJL_15min = sum(as.numeric(manual_distTolast), na.rm = TRUE), count_15min =
              n(), turningAngleSum_15min=sum(as.numeric(turningAngle), na.rm = TRUE), meanTimelag_15min=mean(timelag_lead,na.rm=TRUE), medianTimelag_15min=median(timelag_lead,na.rm=TRUE))
DJL_follows_subsample_15min <- DJL_follows_subsample_15min %>% left_join(TDD_follows,by=c("follow"="follow")) %>% mutate(RR_15min=DJL_15min/TDD)%>% dplyr::select(-firstE,-firstN,-lastE,-lastN,-TDD)

DJL_follows_subsample_30min <- subsample_frequencyAnalaysis30min %>%
  filter(followtype == "NN") %>%
  group_by(
    follow,
  ) %>%
  summarise(DJL_30min = sum(as.numeric(manual_distTolast), na.rm = TRUE), count_30min =
              n(), turningAngleSum_30min=sum(as.numeric(turningAngle), na.rm = TRUE), meanTimelag_30min=mean(timelag_lead,na.rm=TRUE), medianTimelag_30min=median(timelag_lead,na.rm=TRUE))
DJL_follows_subsample_30min <- DJL_follows_subsample_30min %>% left_join(TDD_follows,by=c("follow"="follow")) %>% mutate(RR_30min=DJL_30min/TDD) %>% dplyr::select(-firstE,-firstN,-lastE,-lastN,-TDD)

DJL_follows <- DJL_follows %>% left_join(DJL_follows_subsample_15min,by=c("follow"="follow"))
DJL_follows <- DJL_follows %>% left_join(DJL_follows_subsample_30min,by=c("follow"="follow"))

DJL_follows_sample_long <- DJL_follows %>% ungroup() %>% 
  dplyr::select(follow,DJL,count,turningAngleSum,meanTimelag,medianTimelag,RR) %>% filter(follow %in% sample_FN_5min) %>% mutate(samplingrate="every")  

DJL_follows_subsample_15min <- DJL_follows_subsample_15min %>% mutate(samplingrate="every 2nd")
DJL_follows_subsample_30min <- DJL_follows_subsample_30min %>% mutate(samplingrate="every 4th")
colnames(DJL_follows_subsample_15min) <- colnames(DJL_follows_sample_long)
colnames(DJL_follows_subsample_30min) <- colnames(DJL_follows_sample_long)

DJL_follows_sample_long <- DJL_follows_sample_long %>% rbind(DJL_follows_subsample_15min) 
DJL_follows_sample_long <- DJL_follows_sample_long %>% rbind(DJL_follows_subsample_30min)

##### Visiualize
DJL_follows %>% filter(follow %in% sample_FN_5min) %>% ggplot(aes(DJL,meanTimelag))+
  geom_point(colour="black")+
  geom_point(data=DJL_follows,aes(DJL_15min,meanTimelag_15min),colour="blue")+
  geom_point(data=DJL_follows,aes(DJL_30min,meanTimelag_30min),colour="red")

DJL_follows_sample<- DJL_follows %>% filter(follow %in% sample_FN_5min) 
DJL_follows_sample%>% ggplot(aes(DJL,meanTimelag,colour=as.factor(follow)))+
  geom_point(size=5)+
  geom_point(data=DJL_follows_sample,aes(DJL_15min,meanTimelag_15min),shape=17,size=5)+
  geom_point(data=DJL_follows_sample,aes(DJL_30min,meanTimelag_30min),shape=15,size=5)+
  geom_path()+
  theme(legend.title = element_blank())

plot_DJLxTimelagxSubsampling<- DJL_follows_sample_long%>% ggplot(aes(DJL,meanTimelag,colour=as.factor(follow)))+
  geom_point(size=5,shape=as.factor(DJL_follows_sample_long$samplingrate))+
  geom_path(size=0.2)+
  theme(legend.position = "none")+labs(title = "Subsampling of 18 high frequency follows \n (triangle = every 2nd, cross= every 4th point)",x="DJL [m]",y="mean timelag [s]")+theme(plot.title = element_text(hjust = 0.5))
plot_DJLxTimelagxSubsampling
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_DJLxTimelagxSubsampling",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_DJLxTimelagxSubsampling)

plot_RRxTimelagxSubsampling<- DJL_follows_sample_long%>% ggplot(aes(RR,meanTimelag,colour=as.factor(follow)))+
  geom_point(size=5,shape=as.factor(DJL_follows_sample_long$samplingrate))+
  geom_path(size=0.2)+
  theme(legend.position = "none")+labs(title = "Subsampling of 18 high frequency follows \n (triangle = every 2nd, cross= every 4th point)",x="RR [m]",y="mean timelag [s]")+theme(plot.title = element_text(hjust = 0.5))
plot_RRxTimelagxSubsampling

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_RRxTimelagxSubsampling",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_RRxTimelagxSubsampling)


```

```{r analysis with move/ ctmm, further methods to calculate DJL}
#### Must replace all duplicates where focal and timestamp is the same --> See SUAQr script implemented there.
### CTMM online
SUAQ_rangepoints_11all20_loc_wgs <- SUAQ_rangepoints_11all20_loc_wgs[order(SUAQ_rangepoints_11all20_loc_wgs$focal,SUAQ_rangepoints_11all20_loc_wgs$manualDatetime , decreasing = TRUE ),] %>% rename(
    c("event-id"="identification","timestamp"="manualDatetime","location-long"="long","location-lat"="lat","Animal ID"="focal","Tag No"="follow")
  ) %>% filter(`Animal ID`%in% c("lisa","friska","ellie","cissy","lilly","yulia","raffi","sarabi","trident","alice","mocca","cinnamon")) %>% mutate("sensor-type"="gps")
write_csv(SUAQ_rangepoints_11all20_loc_wgs, path = paste(
  paste(
    "/Users/stefgr/Nextcloud/UZH/12_Semester/20200313_Masterthesis/R/data/Processed_data/",
    "SUAQ_rangepoints_11all20_loc_wgs",
    sep = ""
  ),
  "csv",
  sep = "."
))

### Move
SUAQ_move_stack <-
  move(
    x = SUAQ_rangepoints_11all20_loc_wgs$`location-long`,
    y = SUAQ_rangepoints_11all20_loc_wgs$`location-lat`,
    as.POSIXct(
      SUAQ_rangepoints_11all20_loc_wgs$timestamp,
      format = "%Y-%m-%d %H:%M:%OS",
      tz = "Asia/Pontianak"
    ),
    proj = CRS("+proj=utm +zone=47 +a=6378160 +b=6356774.50408554 +towgs84=-24,-15,5,0,0,0,0 +units=m +no_defs"),
    data = SUAQ_rangepoints_11all20_loc_wgs,
    animal = SUAQ_rangepoints_11all20_loc_wgs$`Animal ID`,
    sensor = "gps"
  )
SUAQ_move_unstacked_list <- split(SUAQ_move_stack)
SUAQ_move_unstacked_selection <- moveStack(list(SUAQ_move_unstacked_list$lilly,SUAQ_move_unstacked_list$cissy))

SUAQ_telemetry_cissy<- as.telemetry(SUAQ_move_unstacked_list$cissy,drop=FALSE)

#### Semivariogram analysis
SVF <- variogram(SUAQ_telemetry_cinnamon[[1]])
plot(SVF)

#### daily travel distance analysis
uere(SUAQ_telemetry_cissy) <- 10 ### GPS accuracy of 10m see manual of noonan and fleming paper
par(mfrow=c(1,3))
plot(SUAQ_telemetry_cissy, error = 2,level.UD = 0.50) 
OUTLIERS <- ctmm::outlie(SUAQ_telemetry_cissy,UERE=10)
#SUAQ_telemetry_cissy <- SUAQ_telemetry_cissy[-(which(OUTLIERS[[1]] >= 0.6)),]
plot(OUTLIERS)

# automated guestimate for uncalibrated data (with 10 meter RMS UERE guess)
GUESS <- ctmm.guess(SUAQ_telemetry_cissy[[1]],CTMM=ctmm(error=10),interactive=FALSE)
# fit and select models # CRAN policy limits us to 2 cores
FIT <- ctmm.select(SUAQ_telemetry_cissy[[1]],GUESS,trace=TRUE,cores=2)
summary(FIT)

gps_speed <- speed(SUAQ_telemetry_cissy[[1]], FIT)

test <- SUAQ_telemetry_cissy[[1]]
GUESS <- ctmm.guess(SUAQ_telemetry_cissy[[1]], interactive = FALSE,CTMM = ctmm(tau = c(Inf, 2 %#% 'hours'), range = FALSE))
GUESS$error <- TRUE
GPS_FIT <- ctmm.select(SUAQ_telemetry_cissy,GUESS)
summary(GPS_FIT)


ellie<- SUAQ_telemetry[1]
SVF <- variogram(SUAQ_telemetry_adoloscent[1])

#### With ctmm
data("buffalo")
Cilla <- buffalo
plot(Cilla)
title("1 Buffalo")
plot(buffalo,col=rainbow(length(buffalo)))
title("5 Buffalo")

SUAQ_move_ellie <- SUAQ_rangepoints_11all20_loc_wgs[order(SUAQ_rangepoints_11all20_loc_wgs$focal,SUAQ_rangepoints_11all20_loc_wgs$manualDatetime , decreasing = FALSE ),] %>% filter(focal=="saruman") %>% ungroup()
SUAQ_move_ellie <- move(x=SUAQ_move_ellie$E, y=SUAQ_move_ellie$N, 
              time=as.POSIXct(SUAQ_move_ellie$manualDatetime, format="%Y-%m-%d %H:%M:%OS", tz="Asia/Pontianak"),
              proj=CRS("+proj=utm +zone=47 +a=6378160 +b=6356774.50408554 +towgs84=-24,-15,5,0,0,0,0 +units=m +no_defs"), 
              data=SUAQ_move_ellie, animal=SUAQ_move_ellie$focal, sensor="gps")

SUAQ_telemetry<- as.telemetry(SUAQ_move_ellie,drop=FALSE)
SUAQ_telemetry
ellie<- SUAQ_telemetry[1]
SVF <- variogram(SUAQ_telemetry[[1]])
level <- c(0.5,0.95) # 50% and 95% CIs
xlim <- c(0,12 %#% "hour") # 0-12 hour window
plot(SVF,xlim=xlim,level=level)
title("zoomed in")
plot(SVF,fraction=0.65,level=level)
title("zoomed out")

```

```{r errorsearching}
##### ##### TO DELETE Inspecting strange distances in follows geometrically##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
###### Long edge lengths
specs_meanEdgeLengthFollows <- SUAQ_rangepoints_11all20_loc %>%
  group_by(
    follow,
    focal,
    ClassFocal,
    SUAQ_weather.rainfall_ml_evening,
    SUAQ_weather.river_waterlevel_morning,
    SUAQ_weather.river_waterlevel_evening,
    SUAQ_weather.rainfall_ml_morning,
    SUAQ_weather.avg_temperature_tot,
    SUAQ_weather.max_temp_average,
    SUAQ_weather.min_temp_average,
    SUAQ_weather.temperature_max_morning,
    SUAQ_weather.temperature_min_morning,
    SUAQ_fai.fai,
    ageOfCurrentOffspring,
    monthYearDate
  ) %>%
  summarise(meanEdgeLength = mean(as.numeric(manual_distTolast), na.rm = TRUE), count =
              n())

plot_histoMeanEdgeLength <-
  specs_meanEdgeLengthFollows %>% ggplot(aes(meanEdgeLength)) + geom_histogram(binwidth = 10) +
  labs(title = "Mean distance to next point (edge length) per follow histogram", x = "distance [m]", y = "count")
plot_histoMeanEdgeLength


specs_numOfGPSatSameLoc <-
  SUAQ_rangepoints_11all20_loc %>% group_by(E, N) %>% summarise(
    count = n(),
    follow = as.character(list(follow)),
    fileN = as.character(list(fileN)),
    automaticDate = as.character(list(automaticDate)),
    manualDate = as.character(list(as.character(manualDate))),
    automaticTime = as.character(list(as.character(automaticTime))),
    manualTime = as.character(list(as.character(manualTime)))
  )
specs_numOfGPSatSameLoc <- specs_numOfGPSatSameLoc %>% filter(count>1) 
specs_GPSatSameLoc_reoccurringFollowNpairs <- specs_numOfGPSatSameLoc %>% filter(count<3) %>% group_by(follow) %>% summarise(nDoubleGPS=n())

write_delim(delim=";",specs_numOfGPSatSameLoc, path = paste(
  paste(
    "/Users/stefgr/Nextcloud/UZH/12_Semester/20200313_Masterthesis/R/data/Processed_data/",
    "specs_numOfGPSatSameLoc",
    sep = ""
  ),
  "csv",
  sep = "."
))

##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 

##### Analayzing edge lengths Visualizations
plot_histgoramEdgeLengths <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(manual_distToNext)) + 
  geom_histogram(aes(y=..density..),colour="darkgrey",binwidth = 0.003) +  
  scale_x_log10(labels=fancy_scientific) +
  labs(title = "Manual distance to next point (edge length) histogram", x = "distance [10 m per bin]", y = "count")+
  geom_vline(aes(xintercept=mean(SUAQ_rangepoints_11all20_loc$manual_distToNext,na.rm = TRUE)),color="blue", linetype="dashed", size=1,alpha=0.4)+
  geom_vline(aes(xintercept=quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[1]),color="red", linetype="dashed", size=1,alpha=0.4)+
  geom_vline(aes(xintercept=quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[2]),color="red", linetype="dashed", size=1,alpha=0.4)+
  geom_density(alpha=.2, fill="#FF6666",colour=NA)+
  geom_text(aes(mean(SUAQ_rangepoints_11all20_loc$manual_distToNext,na.rm = TRUE), 4, label = paste("mean: ",round(mean(SUAQ_waypoints_11all20_loc$manual_distToNext,na.rm = TRUE),2)," m")),colour="blue",alpha=0.7, data.frame())+
  geom_text(aes(round(quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[1],2), 3.5, label = paste("2.5%:  ",round(quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[1],2)," m")),colour="red",alpha=0.7, data.frame())+
  geom_text(aes(round(quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[2],2), 3.5, label = paste("97.5%:  ",round(quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[2],2)," m")),colour="red",alpha=0.7, data.frame())
plot_histgoramEdgeLengths

plot_scatterDistanceTimelag <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(manual_distToNext, timelag_lead)) +
  scale_y_log10() +
  geom_point() + labs(title = "Manual distance X Timelag to next point (edge length) scatterplot", x = "distance [m]", y = "timelag")


plot_scatterDistanceSpeed <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(manual_distToNext, speed_next)) +
  scale_y_log10(labels=fancy_scientific) +
  geom_point() + labs(title = "Manual distance X Speed to next point (edge length) scatterplot", x = "distance [m]", y = "speed [m/s]")
plot_scatterDistanceSpeed

plot_scatterDistanceSpeed <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(manual_distToNext, speed_next)) +
  scale_y_log10(labels=fancy_scientific) +
  geom_point() + labs(title = "Manual distance X Speed to next point (edge length) scatterplot", x = "distance [m]", y = "speed [m/s]")
plot_scatterDistanceSpeed

plot_scatterTimelagSpeed <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(timelag_lead, speed_next)) +
  scale_y_log10(labels=fancy_scientific) +
  geom_point() + labs(title = "Manual timelag X Speed to next point (edge length) scatterplot", x = "timelag [s]", y = "speed [m/s]")
plot_scatterTimelagSpeed


plot_histoAltitudeDiff <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(altitudediff_next)) +
  scale_y_log10(labels=fancy_scientific) +
  geom_histogram(binwidth = 1) + labs(title = "Histogram of altitude differences of edges", x = "altitude difference [m]", y = "count")
plot_histoAltitudeDiff

plot_scatterAltitudeDiffXSpeed <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(altitudediff_next, speed_next)) +
  scale_y_log10(labels=fancy_scientific) +
  geom_point(size=0.2) + labs(title = "Altitude difference X Speed to next point (edge length) scatterplot", x = "altitude diff [feet]", y = "speed [m/s]")
plot_scatterAltitudeDiffXSpeed


ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),
    "_plot_histgoramEdgeLengths",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_histgoramEdgeLengths)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_scatterDistanceTimelag",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_scatterDistanceTimelag)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_scatterDistanceSpeed_log",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_scatterDistanceSpeed)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_scatterTimelagSpeed",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_scatterTimelagSpeed)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_histoAltitudeDiff",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_histoAltitudeDiff)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_scatterAltitudeDiffXSpeed",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_scatterAltitudeDiffXSpeed)


##### FOLLOW vis
temp<-SUAQ_rangepoints_11all20_loc %>% 
  filter(follow %in% c("1089"))

c("1089","1759","1771","1776","1822","1874","1777","1819","671","1501","1761","1780")
plot_gps_pttype<-SUAQ_rangepoints_11all20_loc[order(SUAQ_rangepoints_11all20_loc$manualTime , decreasing = TRUE ),] %>% filter(PtType!="abnormal off point") %>% 
  filter(follow %in% c("1089","1777","1822","1951","1805","1780","2876","2841","2020","1825","1501","663","2209","745","1759","2227","2183","2284","1776","687","671","1865","743","746","2938","2594","1874")) %>% 
  group_by(follow) %>%
  ggplot()+
  geom_point(aes(E,N,color=as.factor(follow)),size=1)+
  #geom_point(data = SUAQ_locationnetwork_loc,aes(E,N,fill="black"),size=2)+
  geom_path(aes(E,N,color=as.factor(follow)), alpha = 0.7,size=0.5)
ggplotly(plot_gps_pttype)

```

## First visuals SUAQ
```{r Weather Visuals}
##### Visualization of Weather ######
plot_weather_avgRainfall<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= rainfall_avg))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="steelblue",na.value = NA) +
  labs(title = "Average rainfall total",x="",y="") + labs(fill='rainfall [ml]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_moRainfall<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather.rainfall_ml_morning))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="steelblue",na.value = NA) +
  labs(title = "Average rainfall morning",x="",y="") + labs(fill='rainfall [ml]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_eveRainfall<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather_monthly$SUAQ_weather.rainfall_ml_evening))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="steelblue",na.value = NA) +
  labs(title = "Average rainfall evening",x="",y="") + labs(fill='rainfall [ml]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_moWaterLevel<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather_monthly$SUAQ_weather.river_waterlevel_morning))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="steelblue",na.value = NA) +
  labs(title = "Waterlevel morning",x="",y="") + labs(fill='waterlevel [cm?]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_eveWaterLevel<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather_monthly$SUAQ_weather.river_waterlevel_evening))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="steelblue",na.value = NA) +
  labs(title = "Waterlevel evening",x="",y="") + labs(fill='waterlevel [cm?]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_Avgtemp<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>%
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= avg_temperature_tot))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="deeppink3",na.value = NA) +
  labs(title = "Average temperature",x="",y="") + labs(fill='temperature [C°]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))

plot_weather_AvgMaxtemp<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>%
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather.max_temp_average))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="deeppink3",na.value = NA) +
  labs(title = "Average maximum temperature",x="",y="") + labs(fill='temperature [C°]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_AvgMintemp<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather.min_temp_average))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="deeppink3",na.value = NA) +
  labs(title = "Average minimum temperature",x="",y="") + labs(fill='temperature [C°]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_avgRainfall
plot_weather_moRainfall
plot_weather_eveRainfall
plot_weather_moWaterLevel
plot_weather_eveWaterLevel
plot_weather_AvgMaxtemp
plot_weather_AvgMintemp
plot_weather_Avgtemp

##### Visualization of FAI ######

plot_weather_AvgMintemp<-SUAQ_fai %>% 
  mutate(SUAQ_fai.month = fct_relevel(SUAQ_fai.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_fai, as.factor(SUAQ_fai.year), fill= SUAQ_fai$SUAQ_fai.fai))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="deeppink3",na.value = NA) +
  labs(title = "Average minimum temperature",x="",y="") + labs(fill='temperature [C°]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))

##### Visualization of FAI ######
SUAQ_fai <- SUAQ_fai %>% mutate(SUAQ_fai.fai=if_else((SUAQ_fai.year==2011)&(SUAQ_fai.monthnum==10),0.0,as.double(SUAQ_fai.fai)))
plot_FAI<-SUAQ_fai %>% 
  mutate(SUAQ_fai.month = fct_relevel(SUAQ_fai.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(as.factor(SUAQ_fai.month), as.factor(SUAQ_fai.year), fill= SUAQ_fai$SUAQ_fai.fai))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="chartreuse4",na.value = NA) +
  labs(title = "Fruit availability index",x="",y="") + labs(fill='FAI')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))
plot_FAI


```




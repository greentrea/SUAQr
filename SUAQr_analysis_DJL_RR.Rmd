---
title: "Projekt"
author: "Stefan Graf"
date: "28 3 2020"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Markings:
#### Quality check: --> are quality checks of chunks executed before
########### DELETE ############--> are chunks to delete
## Title --> are titles for sections
### explanations of the following chunk
##### SUAQ TRACKS 2018 & 2019 ##### --> Code sections to understand code better

```{r import, echo= 'F',results='hide'}
# CLASSICAL PACKAGE IMPORTER (Stefan Graf & Tobias Frey)
packages_checker <- function(packages_list){
  for (package in packages_list){
    if (!require(package, character.only = T)) {
      install.packages(package)
    }
    library(package, character.only = T)
  }
}
packages_checker(
  c('tmaptools',# read_gpx function
    'plotKML',# read GPX to dataframe
    'lubridate',
    'zoo',
    'data.tree',
    'hR',# making realtionships of orangutans
    'dbplyr',
    'plyr',
    'dplyr',
    'tidyr',
    'tidyverse',
    'sf', # Simple feature --> super spatial data handling structure
    'raster', # For raster data
    'ggspatial',
    'rgdal',
    'data.table',
    'RColorBrewer', # color schemas from color brewer web
    'ggraph', # visualization
    'igraph',
    'tmap',
    'scales',
    'trajr',
    'plotly', # zoomable, pannable ggplot
    'mapview',
    'ggmap', # easier interactive ggmaps 
    'leaflet', # Javascript library (originally) for plotting on a maptile interactive map
    'tmap',
    'stringr',
    'remotes', # geom_convexhull function
    'magrittr',
    'ggridges',
    'forcats',
    'move',# Brownian Bridge Movement Model
    'adehabitatHR',
    'ggpubr',
    'htmlwidgets',
    'gridExtra',# additional to ggplot, can add a density plot on the side of a histogram "marginal plot"
    'grid',
    'ggExtra',
    'lme4',
    'nlme',
    'ggfortify',
    'readr',
    'dplyr',
    'ggplot2',
    'tidyr',
    'tidyverse',
    'skimr',
    'viridis',
    'ggstatsplot',
    'ggpubr',
    'GGally',
    'ggfortify', #check linear regression assumptions
    'lindia', # linear regression tools z.b gg_rehist()
    'MuMIn',
    'MASS',
    'GGally' # usefull pairs function to create many scatterplots
    ))
rm(list = ls())
getwd()


### CUSTOM FUNCTIONS ###

# Function for displaying scale labels in ggplot not as f.e. 4e+05
fancy_scientific <- function(l) {
     # turn in to character string in scientific notation
     l <- format(l, scientific = TRUE)
     # quote the part before the exponent to keep all the digits
     l <- gsub("^(.*)e", "'\\1'e", l)
     # turn the 'e+' into plotmath format
     l <- gsub("e", "%*%10^", l)
     # return this as an expression
     parse(text=l)
}


clockS = function(t){hour(t)*3600+minute(t)*60+second(t)}
st_kde <- function(points,cellsize, bandwith, extent = NULL){
  require(MASS)
  require(raster)
  require(sf)
  if(is.null(extent)){
    extent_vec <- st_bbox(points)[c(1,3,2,4)]
  } else{
    extent_vec <- st_bbox(extent)[c(1,3,2,4)]
  }
  
  n_y <- ceiling((extent_vec[4]-extent_vec[3])/cellsize)
  n_x <- ceiling((extent_vec[2]-extent_vec[1])/cellsize)
  
  extent_vec[2] <- extent_vec[1]+(n_x*cellsize)-cellsize
  extent_vec[4] <- extent_vec[3]+(n_y*cellsize)-cellsize
  
  coords <- st_coordinates(points)
  matrix <- kde2d(coords[,1],coords[,2],h = bandwith,n = c(n_x,n_y),lims = extent_vec)
  raster(matrix)
}




#### Custom functions for analysis
clockS = function(t){hour(t)*3600+minute(t)*60+second(t)}


euclid <- function(x1,y1,x2,y2){
  return(sqrt((x1-x2)^2+(y1-y2)^2))
}

turning_angle <- function(x,y,lead_lag = 1){ 
  if(length(x) < 3){return(NA)}
  if(length(x) != length(y)){stop("x and y must be of the same length")}
  p1x <- lag(x,lead_lag)
  p1y <- lag(y,lead_lag)
  p2x <- x
  p2y <- y
  p3x <- lead(x,lead_lag)
  p3y <- lead(y,lead_lag)
  p12 <- euclid(p1x,p1y,p2x,p2y)
  p13 <- euclid(p1x,p1y,p3x,p3y)
  p23 <- euclid(p2x,p2y,p3x,p3y)
  rad <- acos((p12^2+p23^2-p13^2)/(2*p12*p23))
  grad <- (rad*180)/pi
  grad[p12 == 0 | p23 == 0] <- NA
  d <-  (p3x-p1x)*(p2y-p1y)-(p3y-p1y)*(p2x-p1x)
  d <- ifelse(d == 0,1,d)
  d[d>0] <- 1
  d[d<0] <- -1
  d[d==0] <- 1
  turning <- grad*d*-1+180
  return(turning)
}

# Source https://exploratory.io/note/kanaugust/1701090969905358
calculate_mode <- function(x) {
  uniqx <- unique(na.omit(x))
  uniqx[which.max(tabulate(match(x, uniqx)))]
}

```

#### SUAQ research site
## Preprocessing
1. Getting data from excel/csv files
2. Getting data from gpx files, clean and order it
3. Merge Files
```{r GPS Loader}

### Load Project variables ### 
##### waypoints ##### "data/Processed_data/SUAQ_waypoints_11all20.csv"
SUAQ_waypoints_11all20_loc <- read_csv(paste0("data/Processed_data/",str_remove_all(Sys.Date(), "-"),"_SUAQ_waypoints_11all20.csv"))
SUAQ_waypoints_11all20_loc <- SUAQ_waypoints_11all20_loc %>% mutate(monthYearDate=format(as.Date(manualDate), "%Y-%m"))

##### Weather and FAI #####
SUAQ_weather <- read_csv("data/Processed_data/SUAQ_weather.csv")
SUAQ_fai <- read_csv("data/Processed_data/SUAQ_fai.csv")

SUAQ_weather_monthly<-SUAQ_weather %>% 
  group_by(SUAQ_weather.year,SUAQ_weather.month) %>% 
  summarise_all(funs(mean))
SUAQ_weather_monthly<- SUAQ_weather_monthly%>% dplyr::select(-SUAQ_weather.weather_id,-SUAQ_weather.day,-SUAQ_weather.daymonthyear)


##### location network ##### 
SUAQ_locationnetwork_sf <- st_read("data/20201201_StudyBalimbingStudyArea_points.GPX")
SUAQ_locationnetwork_sf_loc <- st_transform(SUAQ_locationnetwork_sf,crs = 32647)
##### for locale coordinate system
coordinates_tmp <- st_coordinates(SUAQ_locationnetwork_sf_loc)
colnames(coordinates_tmp) <- c("E","N")
SUAQ_locationnetwork_sf_loc <- cbind(SUAQ_locationnetwork_sf_loc,coordinates_tmp)
SUAQ_locationnetwork_loc <- st_drop_geometry(SUAQ_locationnetwork_sf_loc)



##### Project attributes to calculate DJL ##### 
#### Create timelag to last waypoints in not spatial dataframe #### 
SUAQ_waypoints_11all20_loc<- SUAQ_waypoints_11all20_loc %>% 
  group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
  mutate(timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         speed_last = manual_distTolast/timelag,
         speed_next = manual_distToNext/timelag_lead,
         turningAngle=turning_angle(E,N),
         altitudediff_next=altitude-lead(altitude),
         )
SUAQ_waypoints_11all20_loc<- SUAQ_waypoints_11all20_loc %>% 
  group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
  mutate(timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         speed_last = manual_distTolast/timelag,
         speed_next = manual_distToNext/timelag_lead,
         turningAngle=turning_angle(E,N)
         )

##### Delete all points around Research camp if edges are longer than 60m thats in the upper quartile of manual distances of edges
summary(SUAQ_waypoints_11all20_loc)
SUAQ_waypoints_11all20_loc<- SUAQ_waypoints_11all20_loc %>% mutate(PtType=if_else(((manual_distTolast>40)|(manual_distToNext>40)|(manual_distToNext==0))&((N>336992)&(N<337052))&((E>324023)&(E<324083)),"potentially campside",PtType)) # these follows have a campsite point "1113","1730","1805","1805","1949","1951","2841","2841"

##### Selection only pointtypes which are taken on the orangutan way? is this true for all? ##### 
SUAQ_rangepoints_11all20_loc <- SUAQ_waypoints_11all20_loc %>% filter(PtType %in% c("daynest","found","lost","mornnest","nightnest","range","tree","party")) # get rid of lcg lch points and 



##### Selection only females ##### 
SUAQ_waypoints_11all20_loc_females <-
  SUAQ_waypoints_11all20_loc %>%   filter(!(SUAQ_orangutans.Sex == "male"))
SUAQ_rangepoints_11all20_loc_females <-
  SUAQ_rangepoints_11all20_loc %>%   filter(!(SUAQ_orangutans.Sex == "male"))
SUAQ_rangepoints_11all20_loc_females_10 <-
  SUAQ_waypoints_11all20_loc %>%   filter(!(SUAQ_orangutans.Sex == "male")) %>% filter(
    focal %in% c(
      "lisa",
      "friska",
      "ellie",
      "cissy",
      "lilly",
      "yulia",
      "raffi",
      "sarabi",
      "trident",
      "alice",
      "mocca",
      "cinnamon"
    )
  )
SUAQ_waypoints_11all20_loc_females_10 <-
  SUAQ_waypoints_11all20_loc %>%   filter(!(SUAQ_orangutans.Sex == "male")) %>% filter(
    focal %in% c(
      "lisa",
      "friska",
      "ellie",
      "cissy",
      "lilly",
      "yulia",
      "raffi",
      "sarabi",
      "trident",
      "alice",
      "mocca",
      "cinnamon"
    )
  )


```


### Analysis
## Statistics
```{r Static analysis DJL RR,echo=FALSE, message=FALSE,comment=FALSE, warning=FALSE}
##### Create analysis DF #####
DJL_follows <- SUAQ_rangepoints_11all20_loc %>%
  filter(followtype == "NN") %>%
  group_by(
    follow,
    focal,
    SUAQ_followlog.ClassFocal,
    SUAQ_weather.rainfall_ml_evening,
    SUAQ_weather.river_waterlevel_morning,
    SUAQ_weather.river_waterlevel_evening,
    SUAQ_weather.rainfall_ml_morning,
    SUAQ_weather.avg_temperature_tot,
    SUAQ_weather.max_temp_average,
    SUAQ_weather.min_temp_average,
    SUAQ_weather.temperature_max_morning,
    SUAQ_weather.temperature_min_morning,
    SUAQ_fai.fai,
    ageOfCurrentOffspring,
    monthYearDate
  ) %>%
  summarise(DJL = sum(as.numeric(manual_distTolast), na.rm = TRUE), count =
              n(), turningAngleSum=sum(as.numeric(turningAngle), na.rm = TRUE), meanTimelag=mean(timelag_lead,na.rm=TRUE), medianTimelag=median(timelag_lead,na.rm=TRUE))

colnames(DJL_follows) <- c("follow","focal","ClassFocal","rain_eve","watlevel_mo","walevel_eve","rain_mo","avg_temp_tot","max_temp_average","min_temp_average","temp_max_mo","temp_min_mo","fai","ageOfCurrentOffspring","monthYearDate","DJL","count","turningAngleSum","meanTimelag","medianTimelag")




##### Adding total displacement distance
TDD_follows <- SUAQ_rangepoints_11all20_loc[order(SUAQ_rangepoints_11all20_loc$manualTime , decreasing = TRUE ),] %>% filter(followtype == "NN") %>% group_by(follow) %>% summarize(firstE=first(E),firstN=first(N),lastE=last(E),lastN=last(N)) %>% mutate(TDD=sqrt((firstE-lastE)^2+(firstN-lastN)^2))

DJL_follows <- DJL_follows %>% left_join(TDD_follows,by=c("follow"="follow")) %>% mutate(RR=DJL/TDD)

# ##### Adding category number
# DJL_follows<- DJL_follows%>%
#   mutate(ClassFocalID=if_else(ClassFocal=="juvenile",1,1))%>% 
#   mutate(ClassFocalID=if_else(ClassFocal=="adult female",2,ClassFocalID))%>% 
#   mutate(ClassFocalID=if_else(ClassFocal=="mother",3,ClassFocalID))%>% 
#   mutate(ClassFocalID=if_else(ClassFocal=="unflanged male",4,ClassFocalID))%>% 
#   mutate(ClassFocalID=if_else(ClassFocal=="flanged male",5,ClassFocalID))


##### TESTING
DJL_follows %>%  ggplot(aes(DJL)) + geom_histogram(bins = 60)
# sind ok follows c(2284, 745)
# sind nicht ok follows c(1874)

##### Scatters #####
plot_Allscatter <- SUAQ_rangepoints_11all20_loc %>%dplyr::select(c("id","focal","follow","followtype","automaticDatetime","manualDatetime","manualDate","manualTime","automaticDate","automaticTime","timelag_lead","manual_distToNext","speed_next","turningAngle","altitudediff_next","PtType","currentOffspring","ageFromDOB","ageOfCurrentOffspring","SUAQ_followlog.ClassFocal","infantname","altitude","followername","E","N","gpsextraction"))
plot_Allscatter <- DJL_follows %>% ungroup() %>% dplyr::select(follow,ClassFocal,rain_eve,watlevel_mo,walevel_eve,rain_mo,avg_temp_tot,max_temp_average,min_temp_average,temp_max_mo,temp_min_mo,fai,ageOfCurrentOffspring,DJL,RR)
plot_Allscatter<- plot_Allscatter%>% GGally::ggpairs(echo=FALSE, message=FALSE)

ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_Allscatter",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_Allscatter,dpi=300,width = 60,height = 60,units="cm")


##### GLM #####

# lm see autoplot ?
lm<-
  lm(
    DJL ~ 
      ClassFocal,
    data = DJL_follows
  )

autoplot(lm)
summary(lm)

glm_rainfall <-
  lmer(
    DJL ~ 
      rain_eve + 
      rain_mo + 
      watlevel_mo + 
      walevel_eve + 
      max_temp_average + 
      min_temp_average +
      temp_max_mo+
      temp_min_mo+
      avg_temp_tot + 
      ClassFocalID + 
      fai +
      ageOfCurrentOffspring + (1 | monthYearDate) + (1 | focal), # random effects to correct for
    data = DJL_follows
  )
autoplot(glm_rainfall)
install.packages("mulcomp")
library(multcomp)
cftest
pt(q=2.361, df=315, lower.tail=FALSE)
df.residual(glm_rainfall)
summary(glm_rainfall)
anova(glm_rainfall)

ctable <- coef(summary(glm_rainfall))
pvals <- pt(abs(ctable[, "t value"]), df.residual(glm_rainfall), lower.tail = FALSE)
cbind(ctable, pvals)

qqnorm(resid(glm_rainfall))






```


```{r higher frequency analysis}
DJL_follows %>% ggplot(aes(DJL,meanTimelag))+geom_point()+geom_smooth(method="lm")


specs_timelag <- SUAQ_rangepoints_11all20_loc %>% group_by(timelag_lead) %>% summarise(count=n())

temp<- SUAQ_rangepoints_11all20_loc %>% group_by(follow) %>% summarise(meanTimelag=median(timelag_lead,na.rm=TRUE),count=n())
temp2<- SUAQ_rangepoints_11all20_loc %>% group_by(follow,timelag_lead) %>% summarise(count=n()) %>% filter(follow %in% c("661","663","671","682","685","687","689","718","719","733","735","738","743","745","746","748","751","753","754","765","767","773","805","807","808","810","816"))
temp3 <- SUAQ_rangepoints_11all20_loc[c("A", "B", "C")]
sample_frequencyAnalaysis <- SUAQ_rangepoints_11all20_loc %>% filter(follow %in% c("661","663","671","682","685","687","689","718","719","733","735","738","743","745","746","748","751","753","754","765","767","773","805","807","808","810","816")) %>%mutate(cumsumTimelag=cumsum(timelag_lead)) %>%  dplyr::select(c("id","focal","follow","followtype","automaticDatetime","manualDatetime","manualDate","manualTime","automaticDate","automaticTime","timelag_lead","cumsumTimelag","manual_distToNext","speed_next","turningAngle","altitudediff_next","PtType","currentOffspring","ageFromDOB","ageOfCurrentOffspring","infantname","altitude","followername","E","N","gpsextraction"))


subsample_frequencyAnalaysis <- sample_frequencyAnalaysis %>% top_n(follow,1,manualTime)

test <- sample_frequencyAnalaysis %>% group_by(follow) %>% sample_n(500)

sample_frequencyAnalaysis<- sample_frequencyAnalaysis %>% 
  group_by(follow)%>% arrange(manualTime,.by_group = TRUE) %>% 
  mutate(timelag=as.numeric(difftime(as.POSIXlt(manualTime),
                                     as.POSIXlt(lag(manualTime)),units 
                                     ="secs")),
         # calculate distance with approach number 1 --> st_distance but to do that we need to calculate lead first because the lead function doesnt work within st distance (not same datatype (df))
         timelag_lead=as.numeric(difftime(as.POSIXlt(lead(manualTime)),
                                          as.POSIXlt(manualTime),units ="secs")),
         manual_distTolast=sqrt((E-lag(E))^2+(N-lag(N))^2),
         manual_distToNext=sqrt((E-lead(E))^2+(N-lead(N))^2),
         speed_last = manual_distTolast/timelag,
         speed_next = manual_distToNext/timelag_lead,
         turningAngle=turning_angle(E,N),
         altitudediff_next=altitude-lead(altitude),
         )


```

```{r analysis with move}
temp <-
  SUAQ_rangepoints_11all20_loc %>%
  group_by(E, N, follow, focal, manualDatetime) %>%
  summarise(
    count = n(),
    follow = as.character(list(follow)),
    fileN = as.character(list(fileN)),
    automaticDate = as.character(list(automaticDate)),
    manualDate = as.character(list(as.character(manualDate))),
    automaticTime = as.character(list(as.character(automaticTime))),
    manualTime = as.character(list(as.character(manualTime)))
  )
SUAQ_move <- move(x=SUAQ_rangepoints_11all20_loc$E, y=SUAQ_rangepoints_11all20_loc$N, 
              time=as.POSIXct(SUAQ_rangepoints_11all20_loc$manualDatetime, format="%Y-%m-%d %H:%M:%OS", tz="Asia/Pontianak"),
              proj=CRS("+proj=utm +zone=47 +datum=WGS84 +units=m +no_defs"), 
              data=SUAQ_rangepoints_11all20_loc, animal=SUAQ_rangepoints_11all20_loc$focal, sensor="gps")
```

```{r errorsearching}
##### ##### TO DELETE Inspecting strange distances in follows geometrically##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
###### Long edge lengths
specs_meanEdgeLengthFollows <- SUAQ_rangepoints_11all20_loc %>%
  group_by(
    follow,
    focal,
    SUAQ_followlog.ClassFocal,
    SUAQ_weather.rainfall_ml_evening,
    SUAQ_weather.river_waterlevel_morning,
    SUAQ_weather.river_waterlevel_evening,
    SUAQ_weather.rainfall_ml_morning,
    SUAQ_weather.avg_temperature_tot,
    SUAQ_weather.max_temp_average,
    SUAQ_weather.min_temp_average,
    SUAQ_weather.temperature_max_morning,
    SUAQ_weather.temperature_min_morning,
    SUAQ_fai.fai,
    ageOfCurrentOffspring,
    monthYearDate
  ) %>%
  summarise(meanEdgeLength = mean(as.numeric(manual_distTolast), na.rm = TRUE), count =
              n())

plot_histoMeanEdgeLength <-
  specs_meanEdgeLengthFollows %>% ggplot(aes(meanEdgeLength)) + geom_histogram(binwidth = 10) +
  labs(title = "Mean distance to next point (edge length) per follow histogram", x = "distance [m]", y = "count")
plot_histoMeanEdgeLength


specs_numOfGPSatSameLoc <-
  SUAQ_rangepoints_11all20_loc %>% group_by(E, N) %>% summarise(
    count = n(),
    follow = as.character(list(follow)),
    fileN = as.character(list(fileN)),
    automaticDate = as.character(list(automaticDate)),
    manualDate = as.character(list(as.character(manualDate))),
    automaticTime = as.character(list(as.character(automaticTime))),
    manualTime = as.character(list(as.character(manualTime)))
  )
specs_numOfGPSatSameLoc <- specs_numOfGPSatSameLoc %>% filter(count>1) 
specs_GPSatSameLoc_reoccurringFollowNpairs <- specs_numOfGPSatSameLoc %>% filter(count<3) %>% group_by(follow) %>% summarise(nDoubleGPS=n())

write_delim(delim=";",specs_numOfGPSatSameLoc, path = paste(
  paste(
    "/Users/stefgr/Nextcloud/UZH/12_Semester/20200313_Masterthesis/R/data/Processed_data/",
    "specs_numOfGPSatSameLoc",
    sep = ""
  ),
  "csv",
  sep = "."
))

##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 
##### ##### TO DELETE ##### ##### ##### ##### 

##### Analayzing edge lengths Visualizations
plot_histgoramEdgeLengths <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(manual_distToNext)) + 
  geom_histogram(aes(y=..density..),colour="darkgrey",binwidth = 0.003) +  
  scale_x_log10(labels=fancy_scientific) +
  labs(title = "Manual distance to next point (edge length) histogram", x = "distance [10 m per bin]", y = "count")+
  geom_vline(aes(xintercept=mean(SUAQ_rangepoints_11all20_loc$manual_distToNext,na.rm = TRUE)),color="blue", linetype="dashed", size=1,alpha=0.4)+
  geom_vline(aes(xintercept=quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[1]),color="red", linetype="dashed", size=1,alpha=0.4)+
  geom_vline(aes(xintercept=quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[2]),color="red", linetype="dashed", size=1,alpha=0.4)+
  geom_density(alpha=.2, fill="#FF6666",colour=NA)+
  geom_text(aes(mean(SUAQ_rangepoints_11all20_loc$manual_distToNext,na.rm = TRUE), 4, label = paste("mean: ",round(mean(SUAQ_waypoints_11all20_loc$manual_distToNext,na.rm = TRUE),2)," m")),colour="blue",alpha=0.7, data.frame())+
  geom_text(aes(round(quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[1],2), 3.5, label = paste("2.5%:  ",round(quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[1],2)," m")),colour="red",alpha=0.7, data.frame())+
  geom_text(aes(round(quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[2],2), 3.5, label = paste("97.5%:  ",round(quantile(SUAQ_rangepoints_11all20_loc$manual_distToNext,probs=c(.025,.975),na.rm = TRUE)[2],2)," m")),colour="red",alpha=0.7, data.frame())
plot_histgoramEdgeLengths

plot_scatterDistanceTimelag <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(manual_distToNext, timelag_lead)) +
  scale_y_log10() +
  geom_point() + labs(title = "Manual distance X Timelag to next point (edge length) scatterplot", x = "distance [m]", y = "timelag")
plot_scatterEdgeLengths

plot_scatterDistanceSpeed <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(manual_distToNext, speed_next)) +
  scale_y_log10(labels=fancy_scientific) +
  geom_point() + labs(title = "Manual distance X Speed to next point (edge length) scatterplot", x = "distance [m]", y = "speed [m/s]")
plot_scatterDistanceSpeed

plot_scatterDistanceSpeed <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(manual_distToNext, speed_next)) +
  scale_y_log10(labels=fancy_scientific) +
  geom_point() + labs(title = "Manual distance X Speed to next point (edge length) scatterplot", x = "distance [m]", y = "speed [m/s]")
plot_scatterDistanceSpeed

plot_scatterTimelagSpeed <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(timelag_lead, speed_next)) +
  scale_y_log10(labels=fancy_scientific) +
  geom_point() + labs(title = "Manual timelag X Speed to next point (edge length) scatterplot", x = "timelag [s]", y = "speed [m/s]")
plot_scatterTimelagSpeed


plot_histoAltitudeDiff <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(altitudediff_next)) +
  scale_y_log10(labels=fancy_scientific) +
  geom_histogram(binwidth = 1) + labs(title = "Histogram of altitude differences of edges", x = "altitude difference [m]", y = "count")
plot_histoAltitudeDiff

plot_scatterAltitudeDiffXSpeed <-
  SUAQ_rangepoints_11all20_loc %>% ggplot(aes(altitudediff_next, speed_next)) +
  scale_y_log10(labels=fancy_scientific) +
  geom_point(size=0.2) + labs(title = "Altitude difference X Speed to next point (edge length) scatterplot", x = "altitude diff [feet]", y = "speed [m/s]")
plot_scatterAltitudeDiffXSpeed


ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),
    "_plot_histgoramEdgeLengths",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_histgoramEdgeLengths)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_scatterDistanceTimelag",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_scatterDistanceTimelag)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_scatterDistanceSpeed_log",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_scatterDistanceSpeed)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_scatterTimelagSpeed",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_scatterTimelagSpeed)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_histoAltitudeDiff",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_histoAltitudeDiff)
ggsave(filename = paste(
  paste(
    "/Users/stefgr/Dropbox/Apps/Overleaf/Msc_Thesis/figures/",
    format(Sys.Date(), "%Y%m%d"),"_",
    "plot_scatterAltitudeDiffXSpeed",
    sep = ""
  ),
  "pdf",
  sep = "."
), plot = plot_scatterAltitudeDiffXSpeed)


##### FOLLOW vis
temp<-SUAQ_rangepoints_11all20_loc %>% 
  filter(follow %in% c("1089"))

c("1089","1759","1771","1776","1822","1874","1777","1819","671","1501","1761","1780")
plot_gps_pttype<-SUAQ_rangepoints_11all20_loc[order(SUAQ_rangepoints_11all20_loc$manualTime , decreasing = TRUE ),] %>% filter(PtType!="abnormal off point") %>% 
  filter(follow %in% c("1089","1777","1822","1951","1805","1780","2876","2841","2020","1825","1501","663","2209","745","1759","2227","2183","2284","1776","687","671","1865","743","746","2938","2594","1874")) %>% 
  group_by(follow) %>%
  ggplot()+
  geom_point(aes(E,N,color=as.factor(follow)),size=1)+
  #geom_point(data = SUAQ_locationnetwork_loc,aes(E,N,fill="black"),size=2)+
  geom_path(aes(E,N,color=as.factor(follow)), alpha = 0.7,size=0.5)
ggplotly(plot_gps_pttype)

```


## First visuals SUAQ
```{r AnalysisDJL}
##### DJL ######
DJL_follows<- SUAQ_waypoints_11all20_loc_females_10 %>% 
  filter(followtype=="NN") %>% 
  group_by(follow,focal,SUAQ_followlog.ClassFocal) %>% 
  summarise(DJL=sum(as.numeric(manual_distTolast), na.rm = TRUE),count=n()) %>% 
  arrange(SUAQ_followlog.ClassFocal) %>% ungroup() %>% 
  mutate(focal = fct_reorder(focal, SUAQ_followlog.ClassFocal))

plot1<- DJL_follows %>% 
  ggplot( aes(x=focal, y=DJL)) +
    geom_jitter(color="coral4", size=0.7, alpha=0.9, shape = 4)+ # add  aes(x=focal, y=DJL) to see which follow it is on a plotly although colors are wrong then... little hack
    geom_boxplot(aes(x=focal, y=DJL, fill=focal),outlier.fill = focal,outlier.stroke= focal) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    ggtitle("Day journey length for Nest-to-Nest follows in Suaq grouped by orangutans") +
    xlab("")+
    ylab("DJL [m]")+
    coord_cartesian(ylim=c(0, 5000))+
    theme(legend.position = "none")+
    theme(axis.text.x = element_text(angle = 90))
ggplotly(plot1)
view(SUAQ_waypoints_11all20_loc_females_10[SUAQ_waypoints_11all20_loc_females_10$follow==1822,])


##### Visualization of Weather ######
plot_weather_avgRainfall<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= rainfall_avg))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="steelblue",na.value = NA) +
  labs(title = "Average rainfall total",x="",y="") + labs(fill='rainfall [ml]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_moRainfall<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather.rainfall_ml_morning))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="steelblue",na.value = NA) +
  labs(title = "Average rainfall morning",x="",y="") + labs(fill='rainfall [ml]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_eveRainfall<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather_monthly$SUAQ_weather.rainfall_ml_evening))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="steelblue",na.value = NA) +
  labs(title = "Average rainfall evening",x="",y="") + labs(fill='rainfall [ml]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_moWaterLevel<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather_monthly$SUAQ_weather.river_waterlevel_morning))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="steelblue",na.value = NA) +
  labs(title = "Waterlevel morning",x="",y="") + labs(fill='waterlevel [cm?]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_eveWaterLevel<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather_monthly$SUAQ_weather.river_waterlevel_evening))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="steelblue",na.value = NA) +
  labs(title = "Waterlevel evening",x="",y="") + labs(fill='waterlevel [cm?]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_Avgtemp<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>%
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= avg_temperature_tot))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="deeppink3",na.value = NA) +
  labs(title = "Average temperature",x="",y="") + labs(fill='temperature [C°]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))

plot_weather_AvgMaxtemp<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>%
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather.max_temp_average))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="deeppink3",na.value = NA) +
  labs(title = "Average maximum temperature",x="",y="") + labs(fill='temperature [C°]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_AvgMintemp<-SUAQ_weather_monthly %>% 
  mutate(SUAQ_weather.month = fct_relevel(SUAQ_weather.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_weather.month, as.factor(SUAQ_weather.year), fill= SUAQ_weather.min_temp_average))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="deeppink3",na.value = NA) +
  labs(title = "Average minimum temperature",x="",y="") + labs(fill='temperature [C°]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


plot_weather_avgRainfall
plot_weather_moRainfall
plot_weather_eveRainfall
plot_weather_moWaterLevel
plot_weather_eveWaterLevel
plot_weather_AvgMaxtemp
plot_weather_AvgMintemp
plot_weather_Avgtemp

##### Visualization of FAI ######

plot_weather_AvgMintemp<-SUAQ_fai %>% 
  mutate(SUAQ_fai.month = fct_relevel(SUAQ_fai.month, 
            "January", "February", "March", 
            "April", "May", "June", 
            "July", "August", "September", "October","November", "December")) %>% 
  ggplot()+
  geom_tile(aes(SUAQ_fai, as.factor(SUAQ_fai.year), fill= SUAQ_fai$SUAQ_fai.fai))+
  scale_fill_distiller() +
  theme_ipsum() +
  scale_fill_gradient(low="mintcream", high="deeppink3",na.value = NA) +
  labs(title = "Average minimum temperature",x="",y="") + labs(fill='temperature [C°]')+
    theme(axis.text.x = element_text(angle = 45, vjust = 0.7))


```



